using System;
using System.Collections.Generic;
using System.Data;
using System.Globalization;
using System.Linq;
using Dapper;
using GBA.Common.Helpers;
using GBA.Domain.Entities;
using GBA.Domain.Entities.Agreements;
using GBA.Domain.Entities.Clients;
using GBA.Domain.Entities.Clients.PackingMarkings;
using GBA.Domain.Entities.Consumables;
using GBA.Domain.Entities.Consumables.Orders;
using GBA.Domain.Entities.Delivery;
using GBA.Domain.Entities.PaymentOrders;
using GBA.Domain.Entities.PaymentOrders.PaymentMovements;
using GBA.Domain.Entities.Pricings;
using GBA.Domain.Entities.Regions;
using GBA.Domain.Entities.Supplies;
using GBA.Domain.Entities.Supplies.ActProvidingServices;
using GBA.Domain.Entities.Supplies.DeliveryProductProtocols;
using GBA.Domain.Entities.Supplies.Documents;
using GBA.Domain.Entities.Supplies.HelperServices;
using GBA.Domain.Entities.Supplies.Protocols;
using GBA.Domain.Entities.Supplies.Ukraine;
using GBA.Domain.EntityHelpers;
using GBA.Domain.EntityHelpers.Accounting;
using GBA.Domain.EntityHelpers.Supplies;
using GBA.Domain.Repositories.Supplies.Contracts;

namespace GBA.Domain.Repositories.Supplies;

public sealed class GroupedPaymentTasksRepository : IGroupedPaymentTasksRepository {
    private readonly IDbConnection _connection;

    private readonly IDbConnection _currencyExchangeConnection;

    public GroupedPaymentTasksRepository(IDbConnection connection, IDbConnection currencyExchangeConnection) {
        _connection = connection;

        _currencyExchangeConnection = currencyExchangeConnection;
    }

    public IEnumerable<GroupedPaymentTask> GetGroupedPaymentTasksForCurrentDate(int limit) {
        IEnumerable<GroupedPaymentTask> groupedTasks = _connection.Query<GroupedPaymentTask>(
            "WITH " +
            "[SupplyPaymentTasks_TodayAndFuture_NotPaid_CTE] " +
            "AS " +
            "( " +
            "SELECT TOP(@Limit) [SupplyPaymentTask].PayToDate " +
            ",[SupplyPaymentTask].TaskStatus " +
            ",1 AS [IsFutureTask] " +
            "FROM [SupplyPaymentTask] " +
            "WHERE [SupplyPaymentTask].Deleted = 0 " +
            "AND [SupplyPaymentTask].TaskStatus <> 1 " +
            "AND [SupplyPaymentTask].PayToDate >= @FromDate " +
            "GROUP BY [SupplyPaymentTask].PayToDate " +
            ",[SupplyPaymentTask].TaskStatus " +
            "), " +
            "[SupplyPaymentTasks_Past_NotPaid_CTE] " +
            "AS " +
            "( " +
            "SELECT [SupplyPaymentTask].PayToDate " +
            ",[SupplyPaymentTask].TaskStatus " +
            ",0 AS [IsFutureTask] " +
            "FROM [SupplyPaymentTask] " +
            "WHERE [SupplyPaymentTask].Deleted = 0 " +
            "AND [SupplyPaymentTask].TaskStatus <> 1 " +
            "AND [SupplyPaymentTask].PayToDate < @FromDate " +
            "GROUP BY [SupplyPaymentTask].PayToDate " +
            ",[SupplyPaymentTask].TaskStatus " +
            "), " +
            "[SupplyPaymentTasks_All_Paid_CTE] " +
            "AS " +
            "( " +
            "SELECT [SupplyPaymentTask].PayToDate " +
            ",[SupplyPaymentTask].TaskStatus " +
            ",0 AS [IsFutureTask] " +
            "FROM [SupplyPaymentTask] " +
            "WHERE [SupplyPaymentTask].Deleted = 0 " +
            "AND [SupplyPaymentTask].TaskStatus = 1 " +
            "GROUP BY [SupplyPaymentTask].PayToDate " +
            ",[SupplyPaymentTask].TaskStatus " +
            "), " +
            "[SupplyPaymentTasks_PastNotPaid_Paid_Combined_CTE] " +
            "AS " +
            "( " +
            "SELECT TOP(@Limit) [SupplyPaymentTasks_Past_NotPaid_CTE].PayToDate " +
            ",[SupplyPaymentTasks_Past_NotPaid_CTE].TaskStatus " +
            ",[SupplyPaymentTasks_Past_NotPaid_CTE].[IsFutureTask] " +
            "FROM [SupplyPaymentTasks_Past_NotPaid_CTE] " +
            "ORDER BY [SupplyPaymentTasks_Past_NotPaid_CTE].PayToDate DESC " +
            "UNION ALL " +
            "SELECT TOP(@Limit) [SupplyPaymentTasks_All_Paid_CTE].PayToDate " +
            ",[SupplyPaymentTasks_All_Paid_CTE].TaskStatus " +
            ",[SupplyPaymentTasks_All_Paid_CTE].[IsFutureTask] " +
            "FROM [SupplyPaymentTasks_All_Paid_CTE] " +
            "ORDER BY [SupplyPaymentTasks_All_Paid_CTE].PayToDate DESC " +
            "), " +
            "[SupplyPaymentTasks_PastNotPaid_Paid_Combined_With_Row_Numbers_CTE] " +
            "AS " +
            "( " +
            "SELECT TOP(@Limit) [SupplyPaymentTasks_PastNotPaid_Paid_Combined_CTE].PayToDate " +
            ",[SupplyPaymentTasks_PastNotPaid_Paid_Combined_CTE].TaskStatus " +
            ",[SupplyPaymentTasks_PastNotPaid_Paid_Combined_CTE].[IsFutureTask] " +
            ",ROW_NUMBER() OVER (ORDER BY [SupplyPaymentTasks_PastNotPaid_Paid_Combined_CTE].TaskStatus) AS [RowNumber] " +
            "FROM [SupplyPaymentTasks_PastNotPaid_Paid_Combined_CTE] " +
            "), " +
            "[SupplyPaymentTasks_All_Combined] " +
            "AS " +
            "( " +
            "SELECT TOP(@Limit) [SupplyPaymentTasks_PastNotPaid_Paid_Combined_With_Row_Numbers_CTE].PayToDate " +
            ",[SupplyPaymentTasks_PastNotPaid_Paid_Combined_With_Row_Numbers_CTE].TaskStatus " +
            ",[SupplyPaymentTasks_PastNotPaid_Paid_Combined_With_Row_Numbers_CTE].[IsFutureTask] " +
            "FROM [SupplyPaymentTasks_PastNotPaid_Paid_Combined_With_Row_Numbers_CTE] " +
            "ORDER BY [SupplyPaymentTasks_PastNotPaid_Paid_Combined_With_Row_Numbers_CTE].RowNumber DESC " +
            "UNION ALL " +
            "SELECT [SupplyPaymentTasks_TodayAndFuture_NotPaid_CTE].PayToDate " +
            ",[SupplyPaymentTasks_TodayAndFuture_NotPaid_CTE].TaskStatus " +
            ",[SupplyPaymentTasks_TodayAndFuture_NotPaid_CTE].[IsFutureTask] " +
            "FROM [SupplyPaymentTasks_TodayAndFuture_NotPaid_CTE] " +
            ") " +
            "SELECT [SupplyPaymentTasks_All_Combined].PayToDate " +
            ",[SupplyPaymentTasks_All_Combined].TaskStatus " +
            ",[SupplyPaymentTasks_All_Combined].[IsFutureTask] " +
            "FROM [SupplyPaymentTasks_All_Combined]",
            new { FromDate = DateTime.Now.Date, Limit = limit }
        );

        Type[] types = new[] {
            typeof(SupplyPaymentTask),
            typeof(User),
            typeof(SupplyOrderPaymentDeliveryProtocol),
            typeof(SupplyOrderPolandPaymentDeliveryProtocol),
            typeof(ContainerService),
            typeof(CustomService),
            typeof(PortWorkService),
            typeof(TransportationService),
            typeof(PortCustomAgencyService),
            typeof(CustomAgencyService),
            typeof(PlaneDeliveryService),
            typeof(VehicleDeliveryService),
            typeof(ConsumablesOrder),
            typeof(MergedService)
        };

        bool mappingPaid = true;

        Func<object[], SupplyPaymentTask> mapper = objects => {
            SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[0];
            User user = (User)objects[1];

            supplyPaymentTask.User = user;

            if (mappingPaid)
                groupedTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate) && t.TaskStatus.Equals(TaskStatus.Done)).SupplyPaymentTasks.Add(supplyPaymentTask);
            else
                groupedTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate) && t.TaskStatus.Equals(TaskStatus.NotDone)).SupplyPaymentTasks.Add(supplyPaymentTask);

            return supplyPaymentTask;
        };

        _connection.Query(
            "SELECT * " +
            "FROM [SupplyPaymentTask] " +
            "LEFT JOIN [User] " +
            "ON [User].ID = [SupplyPaymentTask].UserID " +
            "LEFT JOIN [SupplyOrderPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrderPolandPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPolandPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [ContainerService] " +
            "ON [ContainerService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [CustomService] " +
            "ON [CustomService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PortWorkService] " +
            "ON [PortWorkService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [TransportationService] " +
            "ON [TransportationService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PortCustomAgencyService] " +
            "ON [PortCustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [CustomAgencyService] " +
            "ON [CustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PlaneDeliveryService] " +
            "ON [PlaneDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [VehicleDeliveryService] " +
            "ON [VehicleDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [ConsumablesOrder] " +
            "ON [ConsumablesOrder].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [MergedService] " +
            "ON [MergedService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "WHERE [SupplyPaymentTask].Deleted = 0 " +
            "AND [SupplyPaymentTask].TaskStatus = 1 " +
            "AND [SupplyPaymentTask].PayToDate IN @Dates",
            types,
            mapper,
            new { Dates = groupedTasks.Where(t => t.TaskStatus.Equals(TaskStatus.Done)).Select(t => t.PayToDate) }
        );

        mappingPaid = false;

        _connection.Query(
            "SELECT * " +
            "FROM [SupplyPaymentTask] " +
            "LEFT JOIN [User] " +
            "ON [User].ID = [SupplyPaymentTask].UserID " +
            "LEFT JOIN [SupplyOrderPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrderPolandPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPolandPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [ContainerService] " +
            "ON [ContainerService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [CustomService] " +
            "ON [CustomService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PortWorkService] " +
            "ON [PortWorkService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [TransportationService] " +
            "ON [TransportationService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PortCustomAgencyService] " +
            "ON [PortCustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [CustomAgencyService] " +
            "ON [CustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PlaneDeliveryService] " +
            "ON [PlaneDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [VehicleDeliveryService] " +
            "ON [VehicleDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [ConsumablesOrder] " +
            "ON [ConsumablesOrder].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [MergedService] " +
            "ON [MergedService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "WHERE [SupplyPaymentTask].Deleted = 0 " +
            "AND [SupplyPaymentTask].TaskStatus <> 1 " +
            "AND [SupplyPaymentTask].PayToDate IN @Dates",
            types,
            mapper,
            new { Dates = groupedTasks.Where(t => t.TaskStatus.Equals(TaskStatus.NotDone)).Select(t => t.PayToDate) }
        );

        return groupedTasks;
    }

    public IEnumerable<GroupedPaymentTask> GetGroupedPaymentTasksForPastFromDate(int limit, DateTime fromDate) {
        IEnumerable<GroupedPaymentTask> groupedTasks = _connection.Query<GroupedPaymentTask>(
            "WITH " +
            "[SupplyPaymentTasks_Past_NotPaid_CTE] " +
            "AS " +
            "( " +
            "SELECT [SupplyPaymentTask].PayToDate " +
            ",[SupplyPaymentTask].TaskStatus " +
            ",0 AS [IsFutureTask] " +
            "FROM [SupplyPaymentTask] " +
            "WHERE [SupplyPaymentTask].Deleted = 0 " +
            "AND [SupplyPaymentTask].TaskStatus <> 1 " +
            "AND [SupplyPaymentTask].PayToDate < @FromDate " +
            "GROUP BY [SupplyPaymentTask].PayToDate " +
            ",[SupplyPaymentTask].TaskStatus " +
            "), " +
            "[SupplyPaymentTasks_TodayAndPast_Paid_CTE] " +
            "AS " +
            "( " +
            "SELECT [SupplyPaymentTask].PayToDate " +
            ",[SupplyPaymentTask].TaskStatus " +
            ",0 AS [IsFutureTask] " +
            "FROM [SupplyPaymentTask] " +
            "WHERE [SupplyPaymentTask].Deleted = 0 " +
            "AND [SupplyPaymentTask].TaskStatus = 1 " +
            "AND [SupplyPaymentTask].PayToDate < @FromDate " +
            "GROUP BY [SupplyPaymentTask].PayToDate " +
            ",[SupplyPaymentTask].TaskStatus " +
            "), " +
            "[SupplyPaymentTasks_PastNotPaid_Paid_Combined_CTE] " +
            "AS " +
            "( " +
            "SELECT TOP(@Limit) [SupplyPaymentTasks_Past_NotPaid_CTE].PayToDate " +
            ",[SupplyPaymentTasks_Past_NotPaid_CTE].TaskStatus " +
            ",[SupplyPaymentTasks_Past_NotPaid_CTE].[IsFutureTask] " +
            "FROM [SupplyPaymentTasks_Past_NotPaid_CTE] " +
            "ORDER BY [SupplyPaymentTasks_Past_NotPaid_CTE].PayToDate DESC " +
            "UNION ALL " +
            "SELECT TOP(@Limit) [SupplyPaymentTasks_TodayAndPast_Paid_CTE].PayToDate " +
            ",[SupplyPaymentTasks_TodayAndPast_Paid_CTE].TaskStatus " +
            ",[SupplyPaymentTasks_TodayAndPast_Paid_CTE].[IsFutureTask] " +
            "FROM [SupplyPaymentTasks_TodayAndPast_Paid_CTE] " +
            "ORDER BY [SupplyPaymentTasks_TodayAndPast_Paid_CTE].PayToDate DESC " +
            "), " +
            "[SupplyPaymentTasks_PastNotPaid_Paid_Combined_With_Row_Numbers_CTE] " +
            "AS " +
            "( " +
            "SELECT TOP(@Limit) [SupplyPaymentTasks_PastNotPaid_Paid_Combined_CTE].PayToDate " +
            ",[SupplyPaymentTasks_PastNotPaid_Paid_Combined_CTE].TaskStatus " +
            ",[SupplyPaymentTasks_PastNotPaid_Paid_Combined_CTE].[IsFutureTask] " +
            ",ROW_NUMBER() OVER (ORDER BY [SupplyPaymentTasks_PastNotPaid_Paid_Combined_CTE].TaskStatus) AS [RowNumber] " +
            "FROM [SupplyPaymentTasks_PastNotPaid_Paid_Combined_CTE] " +
            ") " +
            "SELECT [SupplyPaymentTasks_PastNotPaid_Paid_Combined_With_Row_Numbers_CTE].PayToDate " +
            ",[SupplyPaymentTasks_PastNotPaid_Paid_Combined_With_Row_Numbers_CTE].TaskStatus " +
            ",[SupplyPaymentTasks_PastNotPaid_Paid_Combined_With_Row_Numbers_CTE].[IsFutureTask] " +
            "FROM [SupplyPaymentTasks_PastNotPaid_Paid_Combined_With_Row_Numbers_CTE]",
            new { FromDate = fromDate.Date, Limit = limit }
        );

        Type[] types = new[] {
            typeof(SupplyPaymentTask),
            typeof(User),
            typeof(SupplyOrderPaymentDeliveryProtocol),
            typeof(SupplyOrderPolandPaymentDeliveryProtocol),
            typeof(ContainerService),
            typeof(CustomService),
            typeof(PortWorkService),
            typeof(TransportationService),
            typeof(PortCustomAgencyService),
            typeof(CustomAgencyService),
            typeof(PlaneDeliveryService),
            typeof(VehicleDeliveryService),
            typeof(ConsumablesOrder),
            typeof(MergedService),
            typeof(BillOfLadingService)
        };

        bool mappingPaid = true;

        Func<object[], SupplyPaymentTask> mapper = objects => {
            SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[0];
            User user = (User)objects[1];

            supplyPaymentTask.User = user;

            if (mappingPaid)
                groupedTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate) && t.TaskStatus.Equals(TaskStatus.Done)).SupplyPaymentTasks.Add(supplyPaymentTask);
            else
                groupedTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate) && t.TaskStatus.Equals(TaskStatus.NotDone)).SupplyPaymentTasks.Add(supplyPaymentTask);

            return supplyPaymentTask;
        };

        _connection.Query(
            "SELECT * " +
            "FROM [SupplyPaymentTask] " +
            "LEFT JOIN [User] " +
            "ON [User].ID = [SupplyPaymentTask].UserID " +
            "LEFT JOIN [SupplyOrderPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrderPolandPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPolandPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [ContainerService] " +
            "ON [ContainerService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [CustomService] " +
            "ON [CustomService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PortWorkService] " +
            "ON [PortWorkService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [TransportationService] " +
            "ON [TransportationService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PortCustomAgencyService] " +
            "ON [PortCustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [CustomAgencyService] " +
            "ON [CustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PlaneDeliveryService] " +
            "ON [PlaneDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [VehicleDeliveryService] " +
            "ON [VehicleDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [ConsumablesOrder] " +
            "ON [ConsumablesOrder].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [MergedService] " +
            "ON [MergedService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [BillOfLadingService] " +
            "ON [BillOfLadingService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "WHERE [SupplyPaymentTask].Deleted = 0 " +
            "AND [SupplyPaymentTask].TaskStatus = 1 " +
            "AND [SupplyPaymentTask].PayToDate IN @Dates",
            types,
            mapper,
            new { Dates = groupedTasks.Where(t => t.TaskStatus.Equals(TaskStatus.Done)).Select(t => t.PayToDate) }
        );

        mappingPaid = false;

        _connection.Query(
            "SELECT * " +
            "FROM [SupplyPaymentTask] " +
            "LEFT JOIN [User] " +
            "ON [User].ID = [SupplyPaymentTask].UserID " +
            "LEFT JOIN [SupplyOrderPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrderPolandPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPolandPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [ContainerService] " +
            "ON [ContainerService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [CustomService] " +
            "ON [CustomService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PortWorkService] " +
            "ON [PortWorkService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [TransportationService] " +
            "ON [TransportationService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PortCustomAgencyService] " +
            "ON [PortCustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [CustomAgencyService] " +
            "ON [CustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PlaneDeliveryService] " +
            "ON [PlaneDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [VehicleDeliveryService] " +
            "ON [VehicleDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [ConsumablesOrder] " +
            "ON [ConsumablesOrder].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [MergedService] " +
            "ON [MergedService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "WHERE [SupplyPaymentTask].Deleted = 0 " +
            "AND [SupplyPaymentTask].TaskStatus <> 1 " +
            "AND [SupplyPaymentTask].PayToDate IN @Dates",
            types,
            mapper,
            new { Dates = groupedTasks.Where(t => t.TaskStatus.Equals(TaskStatus.NotDone)).Select(t => t.PayToDate) }
        );

        return groupedTasks;
    }

    public IEnumerable<GroupedPaymentTask> GetGroupedPaymentTasksForFutureFromDate(int limit, DateTime fromDate) {
        IEnumerable<GroupedPaymentTask> groupedTasks = _connection.Query<GroupedPaymentTask>(
            "SELECT TOP(@Limit) [SupplyPaymentTask].PayToDate " +
            ",[SupplyPaymentTask].TaskStatus " +
            ",1 AS [IsFutureTask] " +
            "FROM [SupplyPaymentTask] " +
            "WHERE [SupplyPaymentTask].Deleted = 0 " +
            "AND [SupplyPaymentTask].TaskStatus <> 1 " +
            "AND [SupplyPaymentTask].PayToDate > @FromDate " +
            "GROUP BY [SupplyPaymentTask].PayToDate " +
            ",[SupplyPaymentTask].TaskStatus",
            new { FromDate = fromDate.Date, Limit = limit }
        );

        Type[] types = new[] {
            typeof(SupplyPaymentTask),
            typeof(User),
            typeof(SupplyOrderPaymentDeliveryProtocol),
            typeof(SupplyOrderPolandPaymentDeliveryProtocol),
            typeof(ContainerService),
            typeof(CustomService),
            typeof(PortWorkService),
            typeof(TransportationService),
            typeof(PortCustomAgencyService),
            typeof(CustomAgencyService),
            typeof(PlaneDeliveryService),
            typeof(VehicleDeliveryService),
            typeof(ConsumablesOrder),
            typeof(MergedService)
        };

        bool mappingPaid = true;

        Func<object[], SupplyPaymentTask> mapper = objects => {
            SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[0];
            User user = (User)objects[1];

            supplyPaymentTask.User = user;

            if (mappingPaid)
                groupedTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate) && t.TaskStatus.Equals(TaskStatus.Done)).SupplyPaymentTasks.Add(supplyPaymentTask);
            else
                groupedTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate) && t.TaskStatus.Equals(TaskStatus.NotDone)).SupplyPaymentTasks.Add(supplyPaymentTask);

            return supplyPaymentTask;
        };

        _connection.Query(
            "SELECT * " +
            "FROM [SupplyPaymentTask] " +
            "LEFT JOIN [User] " +
            "ON [User].ID = [SupplyPaymentTask].UserID " +
            "LEFT JOIN [SupplyOrderPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrderPolandPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPolandPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [ContainerService] " +
            "ON [ContainerService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [CustomService] " +
            "ON [CustomService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PortWorkService] " +
            "ON [PortWorkService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [TransportationService] " +
            "ON [TransportationService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PortCustomAgencyService] " +
            "ON [PortCustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [CustomAgencyService] " +
            "ON [CustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PlaneDeliveryService] " +
            "ON [PlaneDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [VehicleDeliveryService] " +
            "ON [VehicleDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [ConsumablesOrder] " +
            "ON [ConsumablesOrder].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [MergedService] " +
            "ON [MergedService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "WHERE [SupplyPaymentTask].Deleted = 0 " +
            "AND [SupplyPaymentTask].TaskStatus = 1 " +
            "AND [SupplyPaymentTask].PayToDate IN @Dates",
            types,
            mapper,
            new { Dates = groupedTasks.Where(t => t.TaskStatus.Equals(TaskStatus.Done)).Select(t => t.PayToDate) }
        );

        mappingPaid = false;

        _connection.Query(
            "SELECT * " +
            "FROM [SupplyPaymentTask] " +
            "LEFT JOIN [User] " +
            "ON [User].ID = [SupplyPaymentTask].UserID " +
            "LEFT JOIN [SupplyOrderPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrderPolandPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPolandPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [ContainerService] " +
            "ON [ContainerService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [CustomService] " +
            "ON [CustomService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PortWorkService] " +
            "ON [PortWorkService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [TransportationService] " +
            "ON [TransportationService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PortCustomAgencyService] " +
            "ON [PortCustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [CustomAgencyService] " +
            "ON [CustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [PlaneDeliveryService] " +
            "ON [PlaneDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [VehicleDeliveryService] " +
            "ON [VehicleDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [ConsumablesOrder] " +
            "ON [ConsumablesOrder].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [MergedService] " +
            "ON [MergedService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "WHERE [SupplyPaymentTask].Deleted = 0 " +
            "AND [SupplyPaymentTask].TaskStatus = 0 " +
            "AND [SupplyPaymentTask].PayToDate IN @Dates",
            types,
            mapper,
            new { Dates = groupedTasks.Where(t => t.TaskStatus.Equals(TaskStatus.NotDone)).Select(t => t.PayToDate) }
        );

        return groupedTasks;
    }

    public GroupedPaymentTaskWithTotals GetGroupedPaymentTasksFiltered(DateTime from, DateTime to, Guid? organizationNetId, long limit, long offset,
        TypePaymentTask typePaymentTask) {
        GroupedPaymentTaskWithTotals groupedPaymentTaskWithTotals = new();

        string totalsSqlExpression =
            ";WITH [GroupedTaskPriceWithCurrency_CTE] " +
            "AS ( " +
            "SELECT [SupplyPaymentTask].ID " +
            ",ROUND( " +
            "[SupplyPaymentTask].GrossPrice " +
            "- " +
            "( " +
            "SELECT ISNULL(SUM([OutcomePaymentOrderSupplyPaymentTask].Amount), 0) " +
            "FROM [OutcomePaymentOrderSupplyPaymentTask] " +
            "WHERE [OutcomePaymentOrderSupplyPaymentTask].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "AND [OutcomePaymentOrderSupplyPaymentTask].Deleted = 0 " +
            ") " +
            ", 2) AS [GrossPrice] " +
            ",( " +
            "CASE " +
            "WHEN [SupplyOrderPolandPaymentDeliveryProtocol].ID IS NOT NULL " +
            "THEN (SELECT [Currency].ID FROM [Currency] WHERE [Currency].Deleted = 0 AND [Currency].Code = 'pln') " +
            "WHEN [SupplyOrderPaymentDeliveryProtocol].ID IS NOT NULL " +
            "THEN [Agreement].CurrencyID " +
            "WHEN [ContainerService].ID IS NOT NULL " +
            "THEN [ContainerAgreement].CurrencyID " +
            "WHEN [VehicleService].ID IS NOT NULL " +
            "THEN [VehicleAgreement].CurrencyID " +
            "WHEN [CustomService].ID IS NOT NULL " +
            "THEN [CustomAgreement].CurrencyID " +
            "WHEN [PortWorkService].ID IS NOT NULL " +
            "THEN [PortWorkAgreement].CurrencyID " +
            "WHEN [TransportationService].ID IS NOT NULL " +
            "THEN [TransportationAgreement].CurrencyID " +
            "WHEN [PortCustomAgencyService].ID IS NOT NULL " +
            "THEN [PortCustomAgencyAgreement].CurrencyID " +
            "WHEN [CustomAgencyService].ID IS NOT NULL " +
            "THEN [CustomAgencyAgreement].CurrencyID " +
            "WHEN [PlaneDeliveryService].ID IS NOT NULL " +
            "THEN [PlaneDeliveryAgreement].CurrencyID " +
            "WHEN [VehicleDeliveryService].ID IS NOT NULL " +
            "THEN [VehicleDeliveryAgreement].CurrencyID " +
            "WHEN [ConsumablesOrder].ID IS NOT NULL " +
            "THEN [ConsumablesAgreement].CurrencyID " +
            "WHEN [MergedService].ID IS NOT NULL " +
            "THEN [MergedAgreement].CurrencyID " +
            "WHEN [BillOfLadingService].ID IS NOT NULL " +
            "THEN [BillOfLadingServiceAgreement].CurrencyID " +
            "WHEN [SupplyOrderUkrainePaymentDeliveryProtocol].ID IS NOT NULL " +
            "THEN [SupplyOrderUkraineAgreement].CurrencyID " +
            "END " +
            ") AS [CurrencyID] " +
            "FROM [SupplyPaymentTask] " +
            "LEFT JOIN [SupplyOrderPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyInvoice] " +
            "ON [SupplyInvoice].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyInvoiceID " +
            "LEFT JOIN [SupplyProForm] " +
            "ON [SupplyProForm].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyProFormID " +
            "LEFT JOIN [SupplyOrderPolandPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPolandPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrder] " +
            "ON ( " +
            "( " +
            "[SupplyInvoice].ID IS NOT NULL " +
            "AND " +
            "[SupplyOrder].ID = [SupplyInvoice].SupplyOrderID " +
            ") " +
            "OR " +
            "( " +
            "[SupplyProForm].ID IS NOT NULL " +
            "AND " +
            "[SupplyProForm].ID = [SupplyOrder].SupplyProFormID " +
            ") " +
            "OR " +
            "( " +
            "[SupplyOrderPolandPaymentDeliveryProtocol].ID IS NOT NULL " +
            "AND " +
            "[SupplyOrder].ID = [SupplyOrderPolandPaymentDeliveryProtocol].SupplyOrderID " +
            ") " +
            ") " +
            "LEFT JOIN [ClientAgreement] " +
            "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
            "LEFT JOIN [Agreement] " +
            "ON [Agreement].ID = [ClientAgreement].AgreementID " +
            "LEFT JOIN [Organization] AS [AgreementOrganization] " +
            "ON [AgreementOrganization].ID = [Agreement].OrganizationID ";

        if (typePaymentTask.Equals(TypePaymentTask.PaymentTask))
            totalsSqlExpression += "LEFT JOIN [ContainerService] " +
                                   "ON [ContainerService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [ContainerOrganization] " +
                                   "ON [ContainerService].ContainerOrganizationID = [ContainerOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [ContainerAgreement] " +
                                   "ON [ContainerAgreement].ID = [ContainerService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [ContainerOrganizationOrganization] " +
                                   "ON [ContainerOrganizationOrganization].ID = [ContainerAgreement].OrganizationID " +
                                   "LEFT JOIN [VehicleService] " +
                                   "ON [VehicleService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [VehicleOrganization] " +
                                   "ON [VehicleService].VehicleOrganizationID = [VehicleOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleAgreement] " +
                                   "ON [VehicleAgreement].ID = [VehicleService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [VehicleOrganizationOrganization] " +
                                   "ON [VehicleOrganizationOrganization].ID = [VehicleAgreement].OrganizationID " +
                                   "LEFT JOIN [CustomService] " +
                                   "ON [CustomService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [CustomOrganization] " +
                                   "ON [CustomService].CustomOrganizationID = [CustomOrganization].ID " +
                                   "OR [CustomService].ExciseDutyOrganizationID = [CustomOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomAgreement] " +
                                   "ON [CustomAgreement].ID = [CustomService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [CustomOrganizationOrganization] " +
                                   "ON [CustomOrganizationOrganization].ID = [CustomAgreement].OrganizationID " +
                                   "LEFT JOIN [PortWorkService] " +
                                   "ON [PortWorkService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [PortWorkOrganization] " +
                                   "ON [PortWorkService].PortWorkOrganizationID = [PortWorkOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [PortWorkAgreement] " +
                                   "ON [PortWorkAgreement].ID = [PortWorkService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [PortWorkOrganizationOrganization] " +
                                   "ON [PortWorkOrganizationOrganization].ID = [PortWorkAgreement].OrganizationID " +
                                   "LEFT JOIN [TransportationService] " +
                                   "ON [TransportationService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [TransportationOrganization] " +
                                   "ON [TransportationService].TransportationOrganizationID = [TransportationOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [TransportationAgreement] " +
                                   "ON [TransportationAgreement].ID = [TransportationService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [TransportationOrganizationOrganization] " +
                                   "ON [TransportationOrganizationOrganization].ID = [TransportationAgreement].OrganizationID " +
                                   "LEFT JOIN [PortCustomAgencyService] " +
                                   "ON [PortCustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [PortCustomAgencyOrganization] " +
                                   "ON [PortCustomAgencyService].PortCustomAgencyOrganizationID = [PortCustomAgencyOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [PortCustomAgencyAgreement] " +
                                   "ON [PortCustomAgencyAgreement].ID = [PortCustomAgencyService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [PortCustomAgencyOrganizationOrganization] " +
                                   "ON [PortCustomAgencyOrganizationOrganization].ID = [PortCustomAgencyAgreement].OrganizationID " +
                                   "LEFT JOIN [CustomAgencyService] " +
                                   "ON [CustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [CustomAgencyOrganization] " +
                                   "ON [CustomAgencyService].CustomAgencyOrganizationID = [CustomAgencyOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomAgencyAgreement] " +
                                   "ON [CustomAgencyAgreement].ID = [CustomAgencyService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [CustomAgencyOrganizationOrganization] " +
                                   "ON [CustomAgencyOrganizationOrganization].ID = [CustomAgencyAgreement].OrganizationID " +
                                   "LEFT JOIN [PlaneDeliveryService] " +
                                   "ON [PlaneDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [PlaneDeliveryOrganization] " +
                                   "ON [PlaneDeliveryService].PlaneDeliveryOrganizationID = [PlaneDeliveryOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [PlaneDeliveryAgreement] " +
                                   "ON [PlaneDeliveryAgreement].ID = [PlaneDeliveryService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [PlaneDeliveryOrganizationOrganization] " +
                                   "ON [PlaneDeliveryOrganizationOrganization].ID = [PlaneDeliveryAgreement].OrganizationID " +
                                   "LEFT JOIN [VehicleDeliveryService] " +
                                   "ON [VehicleDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [VehicleDeliveryOrganization] " +
                                   "ON [VehicleDeliveryService].VehicleDeliveryOrganizationID = [VehicleDeliveryOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleDeliveryAgreement] " +
                                   "ON [VehicleDeliveryAgreement].ID = [VehicleDeliveryService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [VehicleDeliveryOrganizationOrganization] " +
                                   "ON [VehicleDeliveryOrganizationOrganization].ID = [VehicleDeliveryAgreement].OrganizationID " +
                                   "LEFT JOIN [ConsumablesOrder] " +
                                   "ON [ConsumablesOrder].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [ConsumablesOrderItem] " +
                                   "ON [ConsumablesOrderItem].ConsumablesOrderID = [ConsumablesOrder].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [ConsumableProductOrganization] " +
                                   "ON [ConsumablesOrderItem].ConsumableProductOrganizationID = [ConsumableProductOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [ConsumablesAgreement] " +
                                   "ON [ConsumablesAgreement].ID = [ConsumablesOrderItem].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [ConsumableProductOrganizationOrganization] " +
                                   "ON [ConsumableProductOrganizationOrganization].ID = [ConsumablesAgreement].OrganizationID " +
                                   "LEFT JOIN [MergedService] " +
                                   "ON [MergedService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "AND [MergedService].[ActProvidingServiceID] IS NOT NULL " +
                                   "LEFT JOIN [SupplyOrganization] AS [MergedSupplyOrganization] " +
                                   "ON [MergedSupplyOrganization].ID = [MergedService].SupplyOrganizationID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [MergedAgreement] " +
                                   "ON [MergedAgreement].ID = [MergedService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [MergedOrganizationOrganization] " +
                                   "ON [MergedOrganizationOrganization].ID = [MergedAgreement].OrganizationID " +
                                   "LEFT JOIN [BillOfLadingService] " +
                                   "ON [BillOfLadingService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [BillOfLadingSupplyOrganization] " +
                                   "ON [BillOfLadingSupplyOrganization].ID = [BillOfLadingService].SupplyOrganizationID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [BillOfLadingServiceAgreement] " +
                                   "ON [BillOfLadingServiceAgreement].ID = [BillOfLadingService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [BillOfLadingServiceOrganizationOrganization] " +
                                   "ON [BillOfLadingServiceOrganizationOrganization].ID = [BillOfLadingServiceAgreement].OrganizationID ";
        else if (typePaymentTask.Equals(TypePaymentTask.AccountingPaymentTask))
            totalsSqlExpression += "LEFT JOIN [ContainerService] " +
                                   "ON [ContainerService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [ContainerOrganization] " +
                                   "ON [ContainerService].ContainerOrganizationID = [ContainerOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [ContainerAgreement] " +
                                   "ON [ContainerAgreement].ID = [ContainerService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [ContainerOrganizationOrganization] " +
                                   "ON [ContainerOrganizationOrganization].ID = [ContainerAgreement].OrganizationID " +
                                   "LEFT JOIN [VehicleService] " +
                                   "ON [VehicleService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [VehicleOrganization] " +
                                   "ON [VehicleService].VehicleOrganizationID = [VehicleOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleAgreement] " +
                                   "ON [VehicleAgreement].ID = [VehicleService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [VehicleOrganizationOrganization] " +
                                   "ON [VehicleOrganizationOrganization].ID = [VehicleAgreement].OrganizationID " +
                                   "LEFT JOIN [CustomService] " +
                                   "ON [CustomService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [CustomOrganization] " +
                                   "ON [CustomService].CustomOrganizationID = [CustomOrganization].ID " +
                                   "OR [CustomService].ExciseDutyOrganizationID = [CustomOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomAgreement] " +
                                   "ON [CustomAgreement].ID = [CustomService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [CustomOrganizationOrganization] " +
                                   "ON [CustomOrganizationOrganization].ID = [CustomAgreement].OrganizationID " +
                                   "LEFT JOIN [PortWorkService] " +
                                   "ON [PortWorkService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [PortWorkOrganization] " +
                                   "ON [PortWorkService].PortWorkOrganizationID = [PortWorkOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [PortWorkAgreement] " +
                                   "ON [PortWorkAgreement].ID = [PortWorkService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [PortWorkOrganizationOrganization] " +
                                   "ON [PortWorkOrganizationOrganization].ID = [PortWorkAgreement].OrganizationID " +
                                   "LEFT JOIN [TransportationService] " +
                                   "ON [TransportationService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [TransportationOrganization] " +
                                   "ON [TransportationService].TransportationOrganizationID = [TransportationOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [TransportationAgreement] " +
                                   "ON [TransportationAgreement].ID = [TransportationService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [TransportationOrganizationOrganization] " +
                                   "ON [TransportationOrganizationOrganization].ID = [TransportationAgreement].OrganizationID " +
                                   "LEFT JOIN [PortCustomAgencyService] " +
                                   "ON [PortCustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [PortCustomAgencyOrganization] " +
                                   "ON [PortCustomAgencyService].PortCustomAgencyOrganizationID = [PortCustomAgencyOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [PortCustomAgencyAgreement] " +
                                   "ON [PortCustomAgencyAgreement].ID = [PortCustomAgencyService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [PortCustomAgencyOrganizationOrganization] " +
                                   "ON [PortCustomAgencyOrganizationOrganization].ID = [PortCustomAgencyAgreement].OrganizationID " +
                                   "LEFT JOIN [CustomAgencyService] " +
                                   "ON [CustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [CustomAgencyOrganization] " +
                                   "ON [CustomAgencyService].CustomAgencyOrganizationID = [CustomAgencyOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomAgencyAgreement] " +
                                   "ON [CustomAgencyAgreement].ID = [CustomAgencyService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [CustomAgencyOrganizationOrganization] " +
                                   "ON [CustomAgencyOrganizationOrganization].ID = [CustomAgencyAgreement].OrganizationID " +
                                   "LEFT JOIN [PlaneDeliveryService] " +
                                   "ON [PlaneDeliveryService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [PlaneDeliveryOrganization] " +
                                   "ON [PlaneDeliveryService].PlaneDeliveryOrganizationID = [PlaneDeliveryOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [PlaneDeliveryAgreement] " +
                                   "ON [PlaneDeliveryAgreement].ID = [PlaneDeliveryService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [PlaneDeliveryOrganizationOrganization] " +
                                   "ON [PlaneDeliveryOrganizationOrganization].ID = [PlaneDeliveryAgreement].OrganizationID " +
                                   "LEFT JOIN [VehicleDeliveryService] " +
                                   "ON [VehicleDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [VehicleDeliveryOrganization] " +
                                   "ON [VehicleDeliveryService].VehicleDeliveryOrganizationID = [VehicleDeliveryOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleDeliveryAgreement] " +
                                   "ON [VehicleDeliveryAgreement].ID = [VehicleDeliveryService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [VehicleDeliveryOrganizationOrganization] " +
                                   "ON [VehicleDeliveryOrganizationOrganization].ID = [VehicleDeliveryAgreement].OrganizationID " +
                                   "LEFT JOIN [ConsumablesOrder] " +
                                   "ON [ConsumablesOrder].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [ConsumablesOrderItem] " +
                                   "ON [ConsumablesOrderItem].ConsumablesOrderID = [ConsumablesOrder].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [ConsumableProductOrganization] " +
                                   "ON [ConsumablesOrderItem].ConsumableProductOrganizationID = [ConsumableProductOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [ConsumablesAgreement] " +
                                   "ON [ConsumablesAgreement].ID = [ConsumablesOrderItem].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [ConsumableProductOrganizationOrganization] " +
                                   "ON [ConsumableProductOrganizationOrganization].ID = [ConsumablesAgreement].OrganizationID " +
                                   "LEFT JOIN [MergedService] " +
                                   "ON [MergedService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "AND [MergedService].[AccountingActProvidingServiceID] IS NOT NULL " +
                                   "LEFT JOIN [SupplyOrganization] AS [MergedSupplyOrganization] " +
                                   "ON [MergedSupplyOrganization].ID = [MergedService].SupplyOrganizationID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [MergedAgreement] " +
                                   "ON [MergedAgreement].ID = [MergedService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [MergedOrganizationOrganization] " +
                                   "ON [MergedOrganizationOrganization].ID = [MergedAgreement].OrganizationID " +
                                   "LEFT JOIN [BillOfLadingService] " +
                                   "ON [BillOfLadingService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [BillOfLadingSupplyOrganization] " +
                                   "ON [BillOfLadingSupplyOrganization].ID = [BillOfLadingService].SupplyOrganizationID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [BillOfLadingServiceAgreement] " +
                                   "ON [BillOfLadingServiceAgreement].ID = [BillOfLadingService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [BillOfLadingServiceOrganizationOrganization] " +
                                   "ON [BillOfLadingServiceOrganizationOrganization].ID = [BillOfLadingServiceAgreement].OrganizationID ";
        else
            totalsSqlExpression += "LEFT JOIN [ContainerService] " +
                                   "ON [ContainerService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "OR [ContainerService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [ContainerOrganization] " +
                                   "ON [ContainerService].ContainerOrganizationID = [ContainerOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [ContainerAgreement] " +
                                   "ON [ContainerAgreement].ID = [ContainerService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [ContainerOrganizationOrganization] " +
                                   "ON [ContainerOrganizationOrganization].ID = [ContainerAgreement].OrganizationID " +
                                   "LEFT JOIN [VehicleService] " +
                                   "ON [VehicleService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "OR [VehicleService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [VehicleOrganization] " +
                                   "ON [VehicleService].VehicleOrganizationID = [VehicleOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleAgreement] " +
                                   "ON [VehicleAgreement].ID = [VehicleService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [VehicleOrganizationOrganization] " +
                                   "ON [VehicleOrganizationOrganization].ID = [VehicleAgreement].OrganizationID " +
                                   "LEFT JOIN [CustomService] " +
                                   "ON [CustomService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "OR [CustomService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [CustomOrganization] " +
                                   "ON [CustomService].CustomOrganizationID = [CustomOrganization].ID " +
                                   "OR [CustomService].ExciseDutyOrganizationID = [CustomOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomAgreement] " +
                                   "ON [CustomAgreement].ID = [CustomService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [CustomOrganizationOrganization] " +
                                   "ON [CustomOrganizationOrganization].ID = [CustomAgreement].OrganizationID " +
                                   "LEFT JOIN [PortWorkService] " +
                                   "ON [PortWorkService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "OR [PortWorkService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [PortWorkOrganization] " +
                                   "ON [PortWorkService].PortWorkOrganizationID = [PortWorkOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [PortWorkAgreement] " +
                                   "ON [PortWorkAgreement].ID = [PortWorkService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [PortWorkOrganizationOrganization] " +
                                   "ON [PortWorkOrganizationOrganization].ID = [PortWorkAgreement].OrganizationID " +
                                   "LEFT JOIN [TransportationService] " +
                                   "ON [TransportationService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "OR [TransportationService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [TransportationOrganization] " +
                                   "ON [TransportationService].TransportationOrganizationID = [TransportationOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [TransportationAgreement] " +
                                   "ON [TransportationAgreement].ID = [TransportationService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [TransportationOrganizationOrganization] " +
                                   "ON [TransportationOrganizationOrganization].ID = [TransportationAgreement].OrganizationID " +
                                   "LEFT JOIN [PortCustomAgencyService] " +
                                   "ON [PortCustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "OR [PortCustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [PortCustomAgencyOrganization] " +
                                   "ON [PortCustomAgencyService].PortCustomAgencyOrganizationID = [PortCustomAgencyOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [PortCustomAgencyAgreement] " +
                                   "ON [PortCustomAgencyAgreement].ID = [PortCustomAgencyService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [PortCustomAgencyOrganizationOrganization] " +
                                   "ON [PortCustomAgencyOrganizationOrganization].ID = [PortCustomAgencyAgreement].OrganizationID " +
                                   "LEFT JOIN [CustomAgencyService] " +
                                   "ON [CustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "OR [CustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [CustomAgencyOrganization] " +
                                   "ON [CustomAgencyService].CustomAgencyOrganizationID = [CustomAgencyOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomAgencyAgreement] " +
                                   "ON [CustomAgencyAgreement].ID = [CustomAgencyService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [CustomAgencyOrganizationOrganization] " +
                                   "ON [CustomAgencyOrganizationOrganization].ID = [CustomAgencyAgreement].OrganizationID " +
                                   "LEFT JOIN [PlaneDeliveryService] " +
                                   "ON [PlaneDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "OR [PlaneDeliveryService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [PlaneDeliveryOrganization] " +
                                   "ON [PlaneDeliveryService].PlaneDeliveryOrganizationID = [PlaneDeliveryOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [PlaneDeliveryAgreement] " +
                                   "ON [PlaneDeliveryAgreement].ID = [PlaneDeliveryService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [PlaneDeliveryOrganizationOrganization] " +
                                   "ON [PlaneDeliveryOrganizationOrganization].ID = [PlaneDeliveryAgreement].OrganizationID " +
                                   "LEFT JOIN [VehicleDeliveryService] " +
                                   "ON [VehicleDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "OR [VehicleDeliveryService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [VehicleDeliveryOrganization] " +
                                   "ON [VehicleDeliveryService].VehicleDeliveryOrganizationID = [VehicleDeliveryOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleDeliveryAgreement] " +
                                   "ON [VehicleDeliveryAgreement].ID = [VehicleDeliveryService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [VehicleDeliveryOrganizationOrganization] " +
                                   "ON [VehicleDeliveryOrganizationOrganization].ID = [VehicleDeliveryAgreement].OrganizationID " +
                                   "LEFT JOIN [ConsumablesOrder] " +
                                   "ON [ConsumablesOrder].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [ConsumablesOrderItem] " +
                                   "ON [ConsumablesOrderItem].ConsumablesOrderID = [ConsumablesOrder].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [ConsumableProductOrganization] " +
                                   "ON [ConsumablesOrderItem].ConsumableProductOrganizationID = [ConsumableProductOrganization].ID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [ConsumablesAgreement] " +
                                   "ON [ConsumablesAgreement].ID = [ConsumablesOrderItem].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [ConsumableProductOrganizationOrganization] " +
                                   "ON [ConsumableProductOrganizationOrganization].ID = [ConsumablesAgreement].OrganizationID " +
                                   "LEFT JOIN [MergedService] " +
                                   "ON ([MergedService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "OR [MergedService].AccountingPaymentTaskID = [SupplyPaymentTask].ID) " +
                                   "AND ([MergedService].[ActProvidingServiceID] IS NOT NULL " +
                                   "OR [MergedService].[AccountingActProvidingServiceID] IS NOT NULL) " +
                                   "LEFT JOIN [SupplyOrganization] AS [MergedSupplyOrganization] " +
                                   "ON [MergedSupplyOrganization].ID = [MergedService].SupplyOrganizationID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [MergedAgreement] " +
                                   "ON [MergedAgreement].ID = [MergedService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [MergedOrganizationOrganization] " +
                                   "ON [MergedOrganizationOrganization].ID = [MergedAgreement].OrganizationID " +
                                   "LEFT JOIN [BillOfLadingService] " +
                                   "ON [BillOfLadingService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "OR [BillOfLadingService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                   "LEFT JOIN [SupplyOrganization] AS [BillOfLadingSupplyOrganization] " +
                                   "ON [BillOfLadingSupplyOrganization].ID = [BillOfLadingService].SupplyOrganizationID " +
                                   "LEFT JOIN [SupplyOrganizationAgreement] AS [BillOfLadingServiceAgreement] " +
                                   "ON [BillOfLadingServiceAgreement].ID = [BillOfLadingService].SupplyOrganizationAgreementID " +
                                   "LEFT JOIN [Organization] AS [BillOfLadingServiceOrganizationOrganization] " +
                                   "ON [BillOfLadingServiceOrganizationOrganization].ID = [BillOfLadingServiceAgreement].OrganizationID ";

        totalsSqlExpression += "LEFT JOIN [SupplyOrderUkrainePaymentDeliveryProtocol] " +
                               "ON [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                               "LEFT JOIN [SupplyOrderUkraine] " +
                               "ON [SupplyOrderUkraine].ID = [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyOrderUkraineID " +
                               "LEFT JOIN [ClientAgreement] AS [SupplyOrderUkraineClientAgreement] " +
                               "ON [SupplyOrderUkraineClientAgreement].ID = [SupplyOrderUkraine].ClientAgreementID " +
                               "LEFT JOIN [Agreement] AS [SupplyOrderUkraineAgreement] " +
                               "ON [SupplyOrderUkraineAgreement].ID = [SupplyOrderUkraineClientAgreement].AgreementID " +
                               "LEFT JOIN [Organization] AS [SupplyOrderUkraineAgreementOrganization] " +
                               "ON [SupplyOrderUkraineAgreementOrganization].ID = [SupplyOrderUkraineAgreement].OrganizationID " +
                               "WHERE [SupplyPaymentTask].[Deleted] = 0 " +
                               "AND [SupplyPaymentTask].[IsImportedFromOneC] = 0" +
                               "AND [SupplyPaymentTask].TaskStatus <> 1 " +
                               "AND CONVERT(date, [SupplyPaymentTask].[PayToDate]) >= @From " +
                               "AND CONVERT(date, [SupplyPaymentTask].[PayToDate]) <= @To " +
                               "AND (" +
                               "[SupplyOrderUkraine].ID IS NOT NULL " +
                               "OR " +
                               "[SupplyOrder].ID IS NOT NULL " +
                               "OR " +
                               "[ContainerService].ID IS NOT NULL " +
                               "OR " +
                               "[VehicleService].ID IS NOT NULL " +
                               "OR " +
                               "[CustomService].ID IS NOT NULL " +
                               "OR " +
                               "[PortWorkService].ID IS NOT NULL " +
                               "OR " +
                               "[TransportationService].ID IS NOT NULL " +
                               "OR " +
                               "[PortCustomAgencyService].ID IS NOT NULL " +
                               "OR " +
                               "[CustomAgencyService].ID IS NOT NULL " +
                               "OR " +
                               "[PlaneDeliveryService].ID IS NOT NULL " +
                               "OR " +
                               "[VehicleDeliveryService].ID IS NOT NULL " +
                               "OR " +
                               "[ConsumablesOrder].ID IS NOT NULL " +
                               "OR " +
                               "[MergedService].ID IS NOT NULL " +
                               "OR " +
                               "[BillOfLadingService].ID IS NOT NULL " +
                               ") " +
                               "AND ( " +
                               "[SupplyPaymentTask].GrossPrice " +
                               "- " +
                               "( " +
                               "SELECT ISNULL(SUM([OutcomePaymentOrderSupplyPaymentTask].Amount), 0) " +
                               "FROM [OutcomePaymentOrderSupplyPaymentTask] " +
                               "WHERE [OutcomePaymentOrderSupplyPaymentTask].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                               "AND [OutcomePaymentOrderSupplyPaymentTask].Deleted = 0 " +
                               ") " +
                               ") > 0 ";

        if (organizationNetId.HasValue)
            totalsSqlExpression +=
                "AND ( " +
                "([AgreementOrganization].NetUID = @OrganizationNetId AND [AgreementOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([ContainerOrganizationOrganization].NetUID = @OrganizationNetId AND [ContainerOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([VehicleOrganizationOrganization].NetUID = @OrganizationNetId AND [VehicleOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([CustomOrganizationOrganization].NetUID = @OrganizationNetId AND [CustomOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PortWorkOrganizationOrganization].NetUID = @OrganizationNetId AND [PortWorkOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([TransportationOrganizationOrganization].NetUID = @OrganizationNetId AND [TransportationOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PortCustomAgencyOrganizationOrganization].NetUID = @OrganizationNetId AND [PortCustomAgencyOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([CustomAgencyOrganizationOrganization].NetUID = @OrganizationNetId AND [CustomAgencyOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PlaneDeliveryOrganizationOrganization].NetUID = @OrganizationNetId AND [PlaneDeliveryOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([VehicleDeliveryOrganizationOrganization].NetUID = @OrganizationNetId AND [VehicleDeliveryOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([ConsumableProductOrganizationOrganization].NetUID = @OrganizationNetId AND [ConsumableProductOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([MergedOrganizationOrganization].NetUID = @OrganizationNetId AND [MergedOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([BillOfLadingServiceOrganizationOrganization].NetUID = @OrganizationNetId AND [BillOfLadingServiceOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([SupplyOrderUkraineAgreementOrganization].NetUID = @OrganizationNetId AND [SupplyOrderUkraineAgreementOrganization].NetUID IS NOT NULL) " +
                ") ";

        totalsSqlExpression +=
            "GROUP BY [SupplyPaymentTask].ID " +
            ",[SupplyPaymentTask].GrossPrice " +
            ",[SupplyOrderPolandPaymentDeliveryProtocol].ID " +
            ",[SupplyOrderPaymentDeliveryProtocol].ID " +
            ",[ContainerService].ID " +
            ",[VehicleService].ID " +
            ",[CustomService].ID " +
            ",[PortWorkService].ID " +
            ",[TransportationService].ID " +
            ",[PortCustomAgencyService].ID " +
            ",[CustomAgencyService].ID " +
            ",[PlaneDeliveryService].ID " +
            ",[VehicleDeliveryService].ID " +
            ",[ConsumablesOrder].ID " +
            ",[MergedService].ID " +
            ",[BillOfLadingService].ID " +
            ",[SupplyOrderUkrainePaymentDeliveryProtocol].ID " +
            ",[Agreement].CurrencyID " +
            ",[ContainerAgreement].CurrencyID " +
            ",[VehicleAgreement].CurrencyID " +
            ",[CustomAgreement].CurrencyID " +
            ",[PortWorkAgreement].CurrencyID " +
            ",[TransportationAgreement].CurrencyID " +
            ",[PortCustomAgencyAgreement].CurrencyID " +
            ",[CustomAgencyAgreement].CurrencyID " +
            ",[PlaneDeliveryAgreement].CurrencyID " +
            ",[VehicleDeliveryAgreement].CurrencyID " +
            ",[ConsumablesAgreement].CurrencyID " +
            ",[MergedAgreement].CurrencyID " +
            ",[BillOfLadingServiceAgreement].CurrencyID " +
            ",[SupplyOrderUkraineAgreement].CurrencyID " +
            ") " +
            "SELECT [Currency].* " +
            ",[GroupedTaskPriceWithCurrency_CTE].GrossPrice " +
            "FROM [GroupedTaskPriceWithCurrency_CTE] " +
            "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
            "ON [Currency].ID = [GroupedTaskPriceWithCurrency_CTE].CurrencyID " +
            "AND [Currency].CultureCode = @Culture ";

        IEnumerable<Currency> g = _connection.Query<Currency, decimal, Currency>(
            totalsSqlExpression,
            (currency, grossAmount) => {
                if (currency == null || currency.IsNew()) currency = GetEUR();

                if (currency.Code.ToLower().Equals("eur")) {
                    groupedPaymentTaskWithTotals.TotalGrossPrice = Math.Round(groupedPaymentTaskWithTotals.TotalGrossPrice + grossAmount, 2);

                    if (groupedPaymentTaskWithTotals.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                        PriceTotal totalFromList = groupedPaymentTaskWithTotals.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + grossAmount, 2);
                    } else {
                        groupedPaymentTaskWithTotals.PriceTotals.Add(new PriceTotal {
                            Currency = currency,
                            TotalPrice = Math.Round(grossAmount, 2)
                        });
                    }
                } else {
                    decimal exchangeRateAmount = 1;

                    exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                    if (exchangeRateAmount < decimal.Zero) {
                        exchangeRateAmount = 0 - exchangeRateAmount;

                        groupedPaymentTaskWithTotals.TotalGrossPrice = Math.Round(groupedPaymentTaskWithTotals.TotalGrossPrice + grossAmount / exchangeRateAmount, 2);
                    } else {
                        groupedPaymentTaskWithTotals.TotalGrossPrice = Math.Round(groupedPaymentTaskWithTotals.TotalGrossPrice + grossAmount * exchangeRateAmount, 2);
                    }

                    if (groupedPaymentTaskWithTotals.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                        PriceTotal totalFromList = groupedPaymentTaskWithTotals.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + grossAmount, 2);
                    } else {
                        groupedPaymentTaskWithTotals.PriceTotals.Add(new PriceTotal {
                            Currency = currency,
                            TotalPrice = Math.Round(grossAmount, 2)
                        });
                    }
                }

                return currency;
            },
            new { From = from, To = to, OrganizationNetId = organizationNetId ?? Guid.Empty, Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName },
            splitOn: "ID,GrossPrice"
        );

        List<JoinService> joinServices = new();

        string groupedTasksSqlExpression =
            ";WITH [Search_CTE] " +
            "AS " +
            "( " +
            "SELECT ROW_NUMBER() OVER (ORDER BY [PayToDate]) AS RowNumber " +
            ",CONVERT(date, [PayToDate]) [PayToDate] " +
            "FROM " +
            "( " +
            "SELECT DISTINCT CONVERT(date, [PayToDate]) [PayToDate] " +
            "FROM [SupplyPaymentTask] " +
            "LEFT JOIN [SupplyOrderPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyInvoice] " +
            "ON [SupplyInvoice].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyInvoiceID " +
            "LEFT JOIN [SupplyProForm] " +
            "ON [SupplyProForm].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyProFormID " +
            "LEFT JOIN [SupplyOrderPolandPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPolandPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrder] " +
            "ON ( " +
            "( " +
            "[SupplyInvoice].ID IS NOT NULL " +
            "AND " +
            "[SupplyOrder].ID = [SupplyInvoice].SupplyOrderID " +
            ") " +
            "OR " +
            "( " +
            "[SupplyProForm].ID IS NOT NULL " +
            "AND " +
            "[SupplyProForm].ID = [SupplyOrder].SupplyProFormID " +
            ") " +
            "OR " +
            "( " +
            "[SupplyOrderPolandPaymentDeliveryProtocol].ID IS NOT NULL " +
            "AND " +
            "[SupplyOrder].ID = [SupplyOrderPolandPaymentDeliveryProtocol].SupplyOrderID " +
            ") " +
            ") " +
            "LEFT JOIN [ClientAgreement] " +
            "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
            "LEFT JOIN [Agreement] " +
            "ON [Agreement].ID = [ClientAgreement].AgreementID " +
            "LEFT JOIN [Organization] AS [AgreementOrganization] " +
            "ON [AgreementOrganization].ID = [Agreement].OrganizationID ";

        if (typePaymentTask.Equals(TypePaymentTask.PaymentTask))
            groupedTasksSqlExpression += "LEFT JOIN [ContainerService] " +
                                         "ON [ContainerService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [ContainerOrganization] " +
                                         "ON [ContainerService].ContainerOrganizationID = [ContainerOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [ContainerOrganizationAgreement] " +
                                         "ON [ContainerOrganizationAgreement].[ID] = [ContainerService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [ContainerOrganizationOrganization] " +
                                         "ON [ContainerOrganizationOrganization].ID = [ContainerOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [VehicleService] " +
                                         "ON [VehicleService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [VehicleOrganization] " +
                                         "ON [VehicleService].VehicleOrganizationID = [VehicleOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleOrganizationAgreement] " +
                                         "ON [VehicleOrganizationAgreement].[ID] = [VehicleService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [VehicleOrganizationOrganization] " +
                                         "ON [VehicleOrganizationOrganization].ID = [VehicleOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [CustomService] " +
                                         "ON [CustomService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [CustomOrganization] " +
                                         "ON [CustomService].CustomOrganizationID = [CustomOrganization].ID " +
                                         "OR [CustomService].ExciseDutyOrganizationID = [CustomOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomOrganizationAgreement] " +
                                         "ON [CustomOrganizationAgreement].[ID] = [CustomService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [CustomOrganizationOrganization] " +
                                         "ON [CustomOrganizationOrganization].ID = [CustomOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [PortWorkService] " +
                                         "ON [PortWorkService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [PortWorkOrganization] " +
                                         "ON [PortWorkService].PortWorkOrganizationID = [PortWorkOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [PortWorkOrganizationAgreement] " +
                                         "ON [PortWorkOrganizationAgreement].[ID] = [PortWorkService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [PortWorkOrganizationOrganization] " +
                                         "ON [PortWorkOrganizationOrganization].ID = [PortWorkOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [TransportationService] " +
                                         "ON [TransportationService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [TransportationOrganization] " +
                                         "ON [TransportationService].TransportationOrganizationID = [TransportationOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [TransportationOrganizationAgreement] " +
                                         "ON [TransportationOrganizationAgreement].[ID] = [TransportationService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [TransportationOrganizationOrganization] " +
                                         "ON [TransportationOrganizationOrganization].ID = [TransportationOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [PortCustomAgencyService] " +
                                         "ON [PortCustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [PortCustomAgencyOrganization] " +
                                         "ON [PortCustomAgencyService].PortCustomAgencyOrganizationID = [PortCustomAgencyOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [PortCustomOrganizationAgreement] " +
                                         "ON [PortCustomOrganizationAgreement].[ID] = [PortCustomAgencyService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [PortCustomAgencyOrganizationOrganization] " +
                                         "ON [PortCustomAgencyOrganizationOrganization].ID = [PortCustomOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [CustomAgencyService] " +
                                         "ON [CustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [CustomAgencyOrganization] " +
                                         "ON [CustomAgencyService].CustomAgencyOrganizationID = [CustomAgencyOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomAgencyrganizationAgreement] " +
                                         "ON [CustomAgencyrganizationAgreement].[SupplyOrganizationID] = [CustomAgencyOrganization].[ID] " +
                                         "LEFT JOIN [Organization] AS [CustomAgencyOrganizationOrganization] " +
                                         "ON [CustomAgencyOrganizationOrganization].ID = [CustomAgencyrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [PlaneDeliveryService] " +
                                         "ON [PlaneDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [PlaneDeliveryOrganization] " +
                                         "ON [PlaneDeliveryService].PlaneDeliveryOrganizationID = [PlaneDeliveryOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [PlaneDeliveryOrganizationAgreement] " +
                                         "ON [PlaneDeliveryOrganizationAgreement].[SupplyOrganizationID] = [PlaneDeliveryOrganization].[ID] " +
                                         "LEFT JOIN [Organization] AS [PlaneDeliveryOrganizationOrganization] " +
                                         "ON [PlaneDeliveryOrganizationOrganization].ID = [PlaneDeliveryOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [VehicleDeliveryService] " +
                                         "ON [VehicleDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [VehicleDeliveryOrganization] " +
                                         "ON [VehicleDeliveryService].VehicleDeliveryOrganizationID = [VehicleDeliveryOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleDeliveryOrganizationAgreement] " +
                                         "ON [VehicleDeliveryOrganizationAgreement].[SupplyOrganizationID] = [VehicleDeliveryOrganization].[ID] " +
                                         "LEFT JOIN [Organization] AS [VehicleDeliveryOrganizationOrganization] " +
                                         "ON [VehicleDeliveryOrganizationOrganization].ID = [VehicleDeliveryOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [ConsumablesOrder] " +
                                         "ON [ConsumablesOrder].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [ConsumablesOrderItem] " +
                                         "ON [ConsumablesOrderItem].ConsumablesOrderID = [ConsumablesOrder].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [ConsumableProductOrganization] " +
                                         "ON [ConsumablesOrderItem].ConsumableProductOrganizationID = [ConsumableProductOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [ConsumableOrganizationAgreement] " +
                                         "ON [ConsumableOrganizationAgreement].[ID] = [ConsumablesOrderItem].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [ConsumableProductOrganizationOrganization] " +
                                         "ON [ConsumableProductOrganizationOrganization].ID = [ConsumableOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [MergedService] " +
                                         "ON [MergedService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "AND [MergedService].[ActProvidingServiceID] IS NOT NULL " +
                                         "LEFT JOIN [SupplyOrganization] AS [MergedSupplyOrganization] " +
                                         "ON [MergedSupplyOrganization].ID = [MergedService].SupplyOrganizationID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [MergedOrganizationAgreement] " +
                                         "ON [MergedOrganizationAgreement].[ID] = [MergedService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [MergedOrganizationOrganization] " +
                                         "ON [MergedOrganizationOrganization].ID = [MergedOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [BillOfLadingService] " +
                                         "ON [BillOfLadingService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [BillOfLadingServiceSupplyOrganization] " +
                                         "ON [BillOfLadingServiceSupplyOrganization].ID = [BillOfLadingService].SupplyOrganizationID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [BillOfLadingServiceOrganizationAgreement] " +
                                         "ON [BillOfLadingServiceOrganizationAgreement].[ID] = [BillOfLadingService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [BillOfLadingServiceOrganizationOrganization] " +
                                         "ON [BillOfLadingServiceOrganizationOrganization].ID = [BillOfLadingServiceOrganizationAgreement].OrganizationID ";
        else if (typePaymentTask.Equals(TypePaymentTask.AccountingPaymentTask))
            groupedTasksSqlExpression += "LEFT JOIN [ContainerService] " +
                                         "ON [ContainerService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [ContainerOrganization] " +
                                         "ON [ContainerService].ContainerOrganizationID = [ContainerOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [ContainerOrganizationAgreement] " +
                                         "ON [ContainerOrganizationAgreement].[ID] = [ContainerService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [ContainerOrganizationOrganization] " +
                                         "ON [ContainerOrganizationOrganization].ID = [ContainerOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [VehicleService] " +
                                         "ON [VehicleService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [VehicleOrganization] " +
                                         "ON [VehicleService].VehicleOrganizationID = [VehicleOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleOrganizationAgreement] " +
                                         "ON [VehicleOrganizationAgreement].[ID] = [VehicleService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [VehicleOrganizationOrganization] " +
                                         "ON [VehicleOrganizationOrganization].ID = [VehicleOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [CustomService] " +
                                         "ON [CustomService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [CustomOrganization] " +
                                         "ON [CustomService].CustomOrganizationID = [CustomOrganization].ID " +
                                         "OR [CustomService].ExciseDutyOrganizationID = [CustomOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomOrganizationAgreement] " +
                                         "ON [CustomOrganizationAgreement].[ID] = [CustomService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [CustomOrganizationOrganization] " +
                                         "ON [CustomOrganizationOrganization].ID = [CustomOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [PortWorkService] " +
                                         "ON [PortWorkService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [PortWorkOrganization] " +
                                         "ON [PortWorkService].PortWorkOrganizationID = [PortWorkOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [PortWorkOrganizationAgreement] " +
                                         "ON [PortWorkOrganizationAgreement].[ID] = [PortWorkService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [PortWorkOrganizationOrganization] " +
                                         "ON [PortWorkOrganizationOrganization].ID = [PortWorkOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [TransportationService] " +
                                         "ON [TransportationService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [TransportationOrganization] " +
                                         "ON [TransportationService].TransportationOrganizationID = [TransportationOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [TransportationOrganizationAgreement] " +
                                         "ON [TransportationOrganizationAgreement].[ID] = [TransportationService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [TransportationOrganizationOrganization] " +
                                         "ON [TransportationOrganizationOrganization].ID = [TransportationOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [PortCustomAgencyService] " +
                                         "ON [PortCustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [PortCustomAgencyOrganization] " +
                                         "ON [PortCustomAgencyService].PortCustomAgencyOrganizationID = [PortCustomAgencyOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [PortCustomAgencyOrganizationAgreement] " +
                                         "ON [PortCustomAgencyOrganizationAgreement].[ID] = [PortCustomAgencyService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [PortCustomAgencyOrganizationOrganization] " +
                                         "ON [PortCustomAgencyOrganizationOrganization].ID = [PortCustomAgencyOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [CustomAgencyService] " +
                                         "ON [CustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [CustomAgencyOrganization] " +
                                         "ON [CustomAgencyService].CustomAgencyOrganizationID = [CustomAgencyOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomAgencyOrganizationAgreement] " +
                                         "ON [CustomAgencyOrganizationAgreement].[ID] = [CustomAgencyService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [CustomAgencyOrganizationOrganization] " +
                                         "ON [CustomAgencyOrganizationOrganization].ID = [CustomAgencyOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [PlaneDeliveryService] " +
                                         "ON [PlaneDeliveryService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [PlaneDeliveryOrganization] " +
                                         "ON [PlaneDeliveryService].PlaneDeliveryOrganizationID = [PlaneDeliveryOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [PlaneDeliveryOrganizationAgreement] " +
                                         "ON [PlaneDeliveryOrganizationAgreement].[ID] = [PlaneDeliveryService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [PlaneDeliveryOrganizationOrganization] " +
                                         "ON [PlaneDeliveryOrganizationOrganization].ID = [PlaneDeliveryOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [VehicleDeliveryService] " +
                                         "ON [VehicleDeliveryService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [VehicleDeliveryOrganization] " +
                                         "ON [VehicleDeliveryService].VehicleDeliveryOrganizationID = [VehicleDeliveryOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleDeliveryOrganizationAgreement] " +
                                         "ON [VehicleDeliveryOrganizationAgreement].[ID] = [VehicleDeliveryService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [VehicleDeliveryOrganizationOrganization] " +
                                         "ON [VehicleDeliveryOrganizationOrganization].ID = [VehicleDeliveryOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [ConsumablesOrder] " +
                                         "ON [ConsumablesOrder].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [ConsumablesOrderItem] " +
                                         "ON [ConsumablesOrderItem].ConsumablesOrderID = [ConsumablesOrder].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [ConsumableProductOrganization] " +
                                         "ON [ConsumablesOrderItem].ConsumableProductOrganizationID = [ConsumableProductOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [ConsumableOrganizationAgreement] " +
                                         "ON [ConsumableOrganizationAgreement].[ID] = [ConsumablesOrderItem].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [ConsumableProductOrganizationOrganization] " +
                                         "ON [ConsumableProductOrganizationOrganization].ID = [ConsumableOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [MergedService] " +
                                         "ON [MergedService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "AND [MergedService].[AccountingActProvidingServiceID] IS NOT NULL " +
                                         "LEFT JOIN [SupplyOrganization] AS [MergedSupplyOrganization] " +
                                         "ON [MergedSupplyOrganization].ID = [MergedService].SupplyOrganizationID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [MergedOrganizationAgreement] " +
                                         "ON [MergedOrganizationAgreement].[ID] = [MergedService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [MergedOrganizationOrganization] " +
                                         "ON [MergedOrganizationOrganization].ID = [MergedOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [BillOfLadingService] " +
                                         "ON [BillOfLadingService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [BillOfLadingServiceSupplyOrganization] " +
                                         "ON [BillOfLadingServiceSupplyOrganization].ID = [BillOfLadingService].SupplyOrganizationID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [BillOfLadingServiceOrganizationAgreement] " +
                                         "ON [BillOfLadingServiceOrganizationAgreement].[ID] = [BillOfLadingService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [BillOfLadingServiceOrganizationOrganization] " +
                                         "ON [BillOfLadingServiceOrganizationOrganization].ID = [BillOfLadingServiceOrganizationAgreement].OrganizationID ";
        else
            groupedTasksSqlExpression += "LEFT JOIN [ContainerService] " +
                                         "ON [ContainerService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "OR [ContainerService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [ContainerOrganization] " +
                                         "ON [ContainerService].ContainerOrganizationID = [ContainerOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [ContainerOrganizationAgreement] " +
                                         "ON [ContainerOrganizationAgreement].[ID] = [ContainerService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [ContainerOrganizationOrganization] " +
                                         "ON [ContainerOrganizationOrganization].ID = [ContainerOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [VehicleService] " +
                                         "ON [VehicleService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "OR [VehicleService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [VehicleOrganization] " +
                                         "ON [VehicleService].VehicleOrganizationID = [VehicleOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleOrganizationAgreement] " +
                                         "ON [VehicleOrganizationAgreement].[ID] = [VehicleService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [VehicleOrganizationOrganization] " +
                                         "ON [VehicleOrganizationOrganization].ID = [VehicleOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [CustomService] " +
                                         "ON [CustomService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "OR [CustomService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [CustomOrganization] " +
                                         "ON [CustomService].CustomOrganizationID = [CustomOrganization].ID " +
                                         "OR [CustomService].ExciseDutyOrganizationID = [CustomOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomOrganizationAgreement] " +
                                         "ON [CustomOrganizationAgreement].[ID] = [CustomService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [CustomOrganizationOrganization] " +
                                         "ON [CustomOrganizationOrganization].ID = [CustomOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [PortWorkService] " +
                                         "ON [PortWorkService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "OR [PortWorkService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [PortWorkOrganization] " +
                                         "ON [PortWorkService].PortWorkOrganizationID = [PortWorkOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [PortWorkOrganizationAgreement] " +
                                         "ON [PortWorkOrganizationAgreement].[ID] = [PortWorkService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [PortWorkOrganizationOrganization] " +
                                         "ON [PortWorkOrganizationOrganization].ID = [PortWorkOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [TransportationService] " +
                                         "ON [TransportationService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "OR [TransportationService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [TransportationOrganization] " +
                                         "ON [TransportationService].TransportationOrganizationID = [TransportationOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [TransportationOrganizationAgreement] " +
                                         "ON [TransportationOrganizationAgreement].[ID] = [TransportationService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [TransportationOrganizationOrganization] " +
                                         "ON [TransportationOrganizationOrganization].ID = [TransportationOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [PortCustomAgencyService] " +
                                         "ON [PortCustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "OR [PortCustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [PortCustomAgencyOrganization] " +
                                         "ON [PortCustomAgencyService].PortCustomAgencyOrganizationID = [PortCustomAgencyOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [PortCustomAgencyOrganizationAgreement] " +
                                         "ON [PortCustomAgencyOrganizationAgreement].[ID] = [PortCustomAgencyService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [PortCustomAgencyOrganizationOrganization] " +
                                         "ON [PortCustomAgencyOrganizationOrganization].ID = [PortCustomAgencyOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [CustomAgencyService] " +
                                         "ON [CustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "OR [CustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [CustomAgencyOrganization] " +
                                         "ON [CustomAgencyService].CustomAgencyOrganizationID = [CustomAgencyOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomAgencyOrganizationAgreement] " +
                                         "ON [CustomAgencyOrganizationAgreement].[ID] = [CustomAgencyService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [CustomAgencyOrganizationOrganization] " +
                                         "ON [CustomAgencyOrganizationOrganization].ID = [CustomAgencyOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [PlaneDeliveryService] " +
                                         "ON [PlaneDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "OR [PlaneDeliveryService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [PlaneDeliveryOrganization] " +
                                         "ON [PlaneDeliveryService].PlaneDeliveryOrganizationID = [PlaneDeliveryOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [PlaneDeliveryOrganizationAgreement] " +
                                         "ON [PlaneDeliveryOrganizationAgreement].[ID] = [PlaneDeliveryService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [PlaneDeliveryOrganizationOrganization] " +
                                         "ON [PlaneDeliveryOrganizationOrganization].ID = [PlaneDeliveryOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [VehicleDeliveryService] " +
                                         "ON [VehicleDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "OR [VehicleDeliveryService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [VehicleDeliveryOrganization] " +
                                         "ON [VehicleDeliveryService].VehicleDeliveryOrganizationID = [VehicleDeliveryOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleDeliveryOrganizationAgreement] " +
                                         "ON [VehicleDeliveryOrganizationAgreement].[ID] = [VehicleDeliveryService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [VehicleDeliveryOrganizationOrganization] " +
                                         "ON [VehicleDeliveryOrganizationOrganization].ID = [VehicleDeliveryOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [ConsumablesOrder] " +
                                         "ON [ConsumablesOrder].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [ConsumablesOrderItem] " +
                                         "ON [ConsumablesOrderItem].ConsumablesOrderID = [ConsumablesOrder].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [ConsumableProductOrganization] " +
                                         "ON [ConsumablesOrderItem].ConsumableProductOrganizationID = [ConsumableProductOrganization].ID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [ConsumableOrganizationAgreement] " +
                                         "ON [ConsumableOrganizationAgreement].[ID] = [ConsumablesOrderItem].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [ConsumableProductOrganizationOrganization] " +
                                         "ON [ConsumableProductOrganizationOrganization].ID = [ConsumableOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [MergedService] " +
                                         "ON ([MergedService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "OR [MergedService].AccountingPaymentTaskID = [SupplyPaymentTask].ID) " +
                                         "AND ([MergedService].[ActProvidingServiceID] IS NOT NULL " +
                                         "OR [MergedService].[AccountingActProvidingServiceID] IS NOT NULL) " +
                                         "LEFT JOIN [SupplyOrganization] AS [MergedSupplyOrganization] " +
                                         "ON [MergedSupplyOrganization].ID = [MergedService].SupplyOrganizationID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [MergedOrganizationAgreement] " +
                                         "ON [MergedOrganizationAgreement].[ID] = [MergedService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [MergedOrganizationOrganization] " +
                                         "ON [MergedOrganizationOrganization].ID = [MergedOrganizationAgreement].OrganizationID " +
                                         "LEFT JOIN [BillOfLadingService] " +
                                         "ON [BillOfLadingService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "OR [BillOfLadingService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                         "LEFT JOIN [SupplyOrganization] AS [BillOfLadingServiceSupplyOrganization] " +
                                         "ON [BillOfLadingServiceSupplyOrganization].ID = [BillOfLadingService].SupplyOrganizationID " +
                                         "LEFT JOIN [SupplyOrganizationAgreement] AS [BillOfLadingServiceOrganizationAgreement] " +
                                         "ON [BillOfLadingServiceOrganizationAgreement].[ID] = [BillOfLadingService].[SupplyOrganizationAgreementID] " +
                                         "LEFT JOIN [Organization] AS [BillOfLadingServiceOrganizationOrganization] " +
                                         "ON [BillOfLadingServiceOrganizationOrganization].ID = [BillOfLadingServiceOrganizationAgreement].OrganizationID ";

        groupedTasksSqlExpression += "LEFT JOIN [SupplyOrderUkrainePaymentDeliveryProtocol] " +
                                     "ON [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                     "LEFT JOIN [SupplyOrderUkraine] " +
                                     "ON [SupplyOrderUkraine].ID = [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyOrderUkraineID " +
                                     "LEFT JOIN [ClientAgreement] AS [SupplyOrderUkraineClientAgreement] " +
                                     "ON [SupplyOrderUkraineClientAgreement].ID = [SupplyOrderUkraine].ClientAgreementID " +
                                     "LEFT JOIN [Agreement] AS [SupplyOrderUkraineAgreement] " +
                                     "ON [SupplyOrderUkraineAgreement].ID = [SupplyOrderUkraineClientAgreement].AgreementID " +
                                     "LEFT JOIN [Organization] AS [SupplyOrderUkraineAgreementOrganization]" +
                                     "ON [SupplyOrderUkraineAgreementOrganization].ID = [SupplyOrderUkraineAgreement].OrganizationID " +
                                     "WHERE [SupplyPaymentTask].[Deleted] = 0 " +
                                     "AND [SupplyPaymentTask].[IsImportedFromOneC] = 0 " +
                                     "AND CONVERT(date, [SupplyPaymentTask].[PayToDate]) >= @From " +
                                     "AND CONVERT(date, [SupplyPaymentTask].[PayToDate]) <= @To " +
                                     "AND (" +
                                     "[SupplyOrderUkraine].ID IS NOT NULL " +
                                     "OR " +
                                     "[SupplyOrder].ID IS NOT NULL " +
                                     "OR " +
                                     "[ContainerService].ID IS NOT NULL " +
                                     "OR " +
                                     "[VehicleService].ID IS NOT NULL " +
                                     "OR " +
                                     "[CustomService].ID IS NOT NULL " +
                                     "OR " +
                                     "[PortWorkService].ID IS NOT NULL " +
                                     "OR " +
                                     "[TransportationService].ID IS NOT NULL " +
                                     "OR " +
                                     "[PortCustomAgencyService].ID IS NOT NULL " +
                                     "OR " +
                                     "[CustomAgencyService].ID IS NOT NULL " +
                                     "OR " +
                                     "[PlaneDeliveryService].ID IS NOT NULL " +
                                     "OR " +
                                     "[VehicleDeliveryService].ID IS NOT NULL " +
                                     "OR " +
                                     "[ConsumablesOrder].ID IS NOT NULL " +
                                     "OR " +
                                     "[MergedService].ID IS NOT NULL " +
                                     "OR " +
                                     "[BillOfLadingService].ID IS NOT NULL " +
                                     ") ";

        if (organizationNetId.HasValue)
            groupedTasksSqlExpression +=
                "AND ( " +
                "([AgreementOrganization].NetUID = @OrganizationNetId AND [AgreementOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([ContainerOrganizationOrganization].NetUID = @OrganizationNetId AND [ContainerOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([VehicleOrganizationOrganization].NetUID = @OrganizationNetId AND [VehicleOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([CustomOrganizationOrganization].NetUID = @OrganizationNetId AND [CustomOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PortWorkOrganizationOrganization].NetUID = @OrganizationNetId AND [PortWorkOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([TransportationOrganizationOrganization].NetUID = @OrganizationNetId AND [TransportationOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PortCustomAgencyOrganizationOrganization].NetUID = @OrganizationNetId AND [PortCustomAgencyOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([CustomAgencyOrganizationOrganization].NetUID = @OrganizationNetId AND [CustomAgencyOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PlaneDeliveryOrganizationOrganization].NetUID = @OrganizationNetId AND [PlaneDeliveryOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([VehicleDeliveryOrganizationOrganization].NetUID = @OrganizationNetId AND [VehicleDeliveryOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([ConsumableProductOrganizationOrganization].NetUID = @OrganizationNetId AND [ConsumableProductOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([MergedOrganizationOrganization].NetUID = @OrganizationNetId AND [MergedOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([BillOfLadingServiceOrganizationOrganization].NetUID = @OrganizationNetId AND [BillOfLadingServiceOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([SupplyOrderUkraineAgreementOrganization].NetUID = @OrganizationNetId AND [SupplyOrderUkraineAgreementOrganization].NetUID IS NOT NULL) " +
                ") ";

        groupedTasksSqlExpression +=
            ") [Distincts] " +
            ") " +
            "SELECT CONVERT(date, [Search_CTE].[PayToDate]) AS [PayToDate] " +
            ",1 AS [TaskStatus] " +
            "FROM [Search_CTE] " +
            "WHERE [Search_CTE].RowNumber > @Offset " +
            "AND [Search_CTE].RowNumber <= @Limit + @Offset ";

        groupedPaymentTaskWithTotals.GroupedPaymentTasks =
            _connection.Query<GroupedPaymentTask>(
                groupedTasksSqlExpression,
                new {
                    From = from,
                    To = to,
                    OrganizationNetId = organizationNetId ?? Guid.Empty,
                    Limit = limit,
                    Offset = offset
                }).ToList();

        Type[] types = {
            typeof(SupplyPaymentTask),
            typeof(User),
            typeof(SupplyOrderPaymentDeliveryProtocol),
            typeof(SupplyOrderPolandPaymentDeliveryProtocol),
            typeof(ContainerService),
            typeof(VehicleService),
            typeof(CustomService),
            typeof(PortWorkService),
            typeof(TransportationService),
            typeof(PortCustomAgencyService),
            typeof(CustomAgencyService),
            typeof(PlaneDeliveryService),
            typeof(VehicleDeliveryService),
            typeof(ConsumablesOrder),
            typeof(SupplyPaymentTaskDocument),
            typeof(OutcomePaymentOrderSupplyPaymentTask),
            typeof(OutcomePaymentOrder),
            typeof(User),
            typeof(Organization),
            typeof(PaymentCurrencyRegister),
            typeof(PaymentRegister),
            typeof(Currency),
            typeof(PaymentMovementOperation),
            typeof(PaymentMovement),
            typeof(MergedService),
            typeof(BillOfLadingService),
            typeof(SupplyOrderUkrainePaymentDeliveryProtocol)
        };

        Func<object[], SupplyPaymentTask> mapper = objects => {
            SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[0];
            User user = (User)objects[1];
            SupplyOrderPaymentDeliveryProtocol supplyOrderPaymentDeliveryProtocol = (SupplyOrderPaymentDeliveryProtocol)objects[2];
            SupplyOrderPolandPaymentDeliveryProtocol supplyOrderPolandPaymentDeliveryProtocol = (SupplyOrderPolandPaymentDeliveryProtocol)objects[3];
            ContainerService containerService = (ContainerService)objects[4];
            VehicleService vehicleService = (VehicleService)objects[5];
            CustomService customService = (CustomService)objects[6];
            PortWorkService portWorkService = (PortWorkService)objects[7];
            TransportationService transportationService = (TransportationService)objects[8];
            PortCustomAgencyService portCustomAgencyService = (PortCustomAgencyService)objects[9];
            CustomAgencyService customAgencyService = (CustomAgencyService)objects[10];
            PlaneDeliveryService planeDeliveryService = (PlaneDeliveryService)objects[11];
            VehicleDeliveryService vehicleDeliveryService = (VehicleDeliveryService)objects[12];
            ConsumablesOrder consumablesOrder = (ConsumablesOrder)objects[13];
            SupplyPaymentTaskDocument document = (SupplyPaymentTaskDocument)objects[14];
            OutcomePaymentOrderSupplyPaymentTask junctionTask = (OutcomePaymentOrderSupplyPaymentTask)objects[15];
            OutcomePaymentOrder outcome = (OutcomePaymentOrder)objects[16];
            User outcomeUser = (User)objects[17];
            Organization organization = (Organization)objects[18];
            PaymentCurrencyRegister paymentCurrencyRegister = (PaymentCurrencyRegister)objects[19];
            PaymentRegister paymentRegister = (PaymentRegister)objects[20];
            Currency currency = (Currency)objects[21];
            PaymentMovementOperation paymentMovementOperation = (PaymentMovementOperation)objects[22];
            PaymentMovement paymentMovement = (PaymentMovement)objects[23];
            MergedService mergedService = (MergedService)objects[24];
            BillOfLadingService billOfLadingService = (BillOfLadingService)objects[25];
            SupplyOrderUkrainePaymentDeliveryProtocol protocol = (SupplyOrderUkrainePaymentDeliveryProtocol)objects[26];

            GroupedPaymentTask groupedTaskFromList = groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

            if (!groupedTaskFromList.SupplyPaymentTasks.Any(t => t.Id.Equals(supplyPaymentTask.Id))) {
                if (supplyOrderPaymentDeliveryProtocol != null)
                    joinServices.Add(new JoinService(supplyOrderPaymentDeliveryProtocol.Id, JoinServiceType.SupplyOrderPaymentDeliveryProtocol));

                if (supplyOrderPolandPaymentDeliveryProtocol != null)
                    joinServices.Add(new JoinService(supplyOrderPolandPaymentDeliveryProtocol.Id, JoinServiceType.SupplyOrderPolandPaymentDeliveryProtocol));

                if (containerService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(containerService.Id, JoinServiceType.AccountingContainerService));
                    else
                        joinServices.Add(new JoinService(containerService.Id, JoinServiceType.ContainerService));
                }

                if (vehicleService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(vehicleService.Id, JoinServiceType.AccountingVehicleService));
                    else
                        joinServices.Add(new JoinService(vehicleService.Id, JoinServiceType.VehicleService));
                }

                if (customService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(customService.Id, JoinServiceType.AccountingCustomService));
                    else
                        joinServices.Add(new JoinService(customService.Id, JoinServiceType.CustomService));
                }

                if (portWorkService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(portWorkService.Id, JoinServiceType.AccountingPortWorkService));
                    else
                        joinServices.Add(new JoinService(portWorkService.Id, JoinServiceType.PortWorkService));
                }

                if (transportationService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(transportationService.Id, JoinServiceType.AccountingTransportationService));
                    else
                        joinServices.Add(new JoinService(transportationService.Id, JoinServiceType.TransportationService));
                }

                if (portCustomAgencyService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(portCustomAgencyService.Id, JoinServiceType.AccountingPortCustomAgencyService));
                    else
                        joinServices.Add(new JoinService(portCustomAgencyService.Id, JoinServiceType.PortCustomAgencyService));
                }

                if (customAgencyService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(customAgencyService.Id, JoinServiceType.AccountingCustomAgencyService));
                    else
                        joinServices.Add(new JoinService(customAgencyService.Id, JoinServiceType.CustomAgencyService));
                }

                if (planeDeliveryService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(planeDeliveryService.Id, JoinServiceType.AccountingPlaneDeliveryService));
                    else
                        joinServices.Add(new JoinService(planeDeliveryService.Id, JoinServiceType.PlaneDeliveryService));
                }

                if (vehicleDeliveryService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(vehicleDeliveryService.Id, JoinServiceType.AccountingVehicleDeliveryService));
                    else
                        joinServices.Add(new JoinService(vehicleDeliveryService.Id, JoinServiceType.VehicleDeliveryService));
                }

                if (consumablesOrder != null) joinServices.Add(new JoinService(consumablesOrder.Id, JoinServiceType.ConsumablesOrder));

                if (mergedService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(mergedService.Id, JoinServiceType.AccountingMergedService));
                    else
                        joinServices.Add(new JoinService(mergedService.Id, JoinServiceType.MergedService));
                }

                if (billOfLadingService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(billOfLadingService.Id, JoinServiceType.AccountingBillOfLadingService));
                    else
                        joinServices.Add(new JoinService(billOfLadingService.Id, JoinServiceType.BillOfLadingService));
                }

                if (protocol != null) joinServices.Add(new JoinService(protocol.Id, JoinServiceType.SupplyOrderUkrainePaymentDeliveryProtocol));

                if (document != null) supplyPaymentTask.SupplyPaymentTaskDocuments.Add(document);

                if (junctionTask != null) {
                    if (paymentMovementOperation != null) paymentMovementOperation.PaymentMovement = paymentMovement;

                    paymentCurrencyRegister.PaymentRegister = paymentRegister;
                    paymentCurrencyRegister.Currency = currency;

                    outcome.User = outcomeUser;
                    outcome.PaymentCurrencyRegister = paymentCurrencyRegister;
                    outcome.PaymentMovementOperation = paymentMovementOperation;

                    junctionTask.OutcomePaymentOrder = outcome;

                    supplyPaymentTask.OutcomePaymentOrderSupplyPaymentTasks.Add(junctionTask);
                }

                supplyPaymentTask.User = user;

                if (!supplyPaymentTask.TaskStatus.Equals(TaskStatus.Done)) groupedTaskFromList.TaskStatus = TaskStatus.NotDone;

                groupedTaskFromList.SupplyPaymentTasks.Add(supplyPaymentTask);
            } else {
                if (containerService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(containerService.Id, JoinServiceType.AccountingContainerService));
                    else
                        joinServices.Add(new JoinService(containerService.Id, JoinServiceType.ContainerService));
                }

                if (vehicleService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(vehicleService.Id, JoinServiceType.AccountingVehicleService));
                    else
                        joinServices.Add(new JoinService(vehicleService.Id, JoinServiceType.VehicleService));
                }

                if (portWorkService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(portWorkService.Id, JoinServiceType.AccountingPortWorkService));
                    else
                        joinServices.Add(new JoinService(portWorkService.Id, JoinServiceType.PortWorkService));
                }

                if (billOfLadingService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(billOfLadingService.Id, JoinServiceType.AccountingBillOfLadingService));
                    else
                        joinServices.Add(new JoinService(billOfLadingService.Id, JoinServiceType.BillOfLadingService));
                }

                SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                if (document != null && !taskFromList.SupplyPaymentTaskDocuments.Any(d => d.Id.Equals(document.Id))) taskFromList.SupplyPaymentTaskDocuments.Add(document);

                if (junctionTask != null && !taskFromList.OutcomePaymentOrderSupplyPaymentTasks.Any(o => o.Id.Equals(junctionTask.Id))) {
                    if (paymentMovementOperation != null) paymentMovementOperation.PaymentMovement = paymentMovement;

                    paymentCurrencyRegister.PaymentRegister = paymentRegister;
                    paymentCurrencyRegister.Currency = currency;

                    outcome.User = outcomeUser;
                    outcome.PaymentCurrencyRegister = paymentCurrencyRegister;
                    outcome.PaymentMovementOperation = paymentMovementOperation;

                    junctionTask.OutcomePaymentOrder = outcome;

                    taskFromList.OutcomePaymentOrderSupplyPaymentTasks.Add(junctionTask);
                }
            }

            return supplyPaymentTask;
        };

        string tasksSqlExpression =
            "SELECT [SupplyPaymentTask].[ID] " +
            ",[SupplyPaymentTask].[Created] " +
            ",[SupplyPaymentTask].[Deleted] " +
            ",[SupplyPaymentTask].[NetUID] " +
            ",[SupplyPaymentTask].[Updated] " +
            ",[SupplyPaymentTask].[Comment] " +
            ",[SupplyPaymentTask].[UserID] " +
            ",[SupplyPaymentTask].[IsAccounting] " +
            ",CONVERT(date, [SupplyPaymentTask].[PayToDate]) [PayToDate] " +
            ",[SupplyPaymentTask].[TaskAssignedTo] " +
            ",[SupplyPaymentTask].[IsAvailableForPayment] " +
            ",[SupplyPaymentTask].[TaskStatus] " +
            ",[SupplyPaymentTask].[TaskStatusUpdated] " +
            ",( " +
            "CASE " +
            "WHEN [SupplyPaymentTask].TaskStatus = 1 " +
            "THEN [SupplyPaymentTask].[GrossPrice] " +
            "ELSE " +
            "( " +
            "[SupplyPaymentTask].[GrossPrice] " +
            "- " +
            "( " +
            "SELECT ISNULL(SUM([OutcomePaymentOrderSupplyPaymentTask].Amount), 0) " +
            "FROM [OutcomePaymentOrderSupplyPaymentTask] " +
            "WHERE [OutcomePaymentOrderSupplyPaymentTask].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            ") " +
            ") " +
            "END " +
            ") AS [GrossPrice] " +
            ",[SupplyPaymentTask].[NetPrice] " +
            ",[User].* " +
            ",[SupplyOrderPaymentDeliveryProtocol].* " +
            ",[SupplyOrderPolandPaymentDeliveryProtocol].* " +
            ",[ContainerService].* " +
            ",[VehicleService].* " +
            ",[CustomService].* " +
            ",[PortWorkService].* " +
            ",[TransportationService].* " +
            ",[PortCustomAgencyService].* " +
            ",[CustomAgencyService].* " +
            ",[PlaneDeliveryService].* " +
            ",[VehicleDeliveryService].* " +
            ",[ConsumablesOrder].* " +
            ",[SupplyPaymentTaskDocument].* " +
            ",[OutcomePaymentOrderSupplyPaymentTask].* " +
            ",[OutcomePaymentOrder].* " +
            ",[OutcomeUser].* " +
            ",[Organization].* " +
            ",[PaymentCurrencyRegister].* " +
            ",[PaymentRegister].* " +
            ",[Currency].* " +
            ",[PaymentMovementOperation].* " +
            ",[PaymentMovement].* " +
            ",[MergedService].* " +
            ",[BillOfLadingService].* " +
            ",[SupplyOrderUkrainePaymentDeliveryProtocol].* " +
            "FROM [SupplyPaymentTask] " +
            "LEFT JOIN [User] " +
            "ON [User].ID = [SupplyPaymentTask].UserID " +
            "LEFT JOIN [SupplyOrderPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyInvoice] " +
            "ON [SupplyInvoice].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyInvoiceID " +
            "LEFT JOIN [SupplyProForm] " +
            "ON [SupplyProForm].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyProFormID " +
            "LEFT JOIN [SupplyOrderPolandPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPolandPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrder] " +
            "ON ( " +
            "( " +
            "[SupplyInvoice].ID IS NOT NULL " +
            "AND " +
            "[SupplyOrder].ID = [SupplyInvoice].SupplyOrderID " +
            ") " +
            "OR " +
            "( " +
            "[SupplyProForm].ID IS NOT NULL " +
            "AND " +
            "[SupplyProForm].ID = [SupplyOrder].SupplyProFormID " +
            ") " +
            "OR " +
            "( " +
            "[SupplyOrderPolandPaymentDeliveryProtocol].ID IS NOT NULL " +
            "AND " +
            "[SupplyOrder].ID = [SupplyOrderPolandPaymentDeliveryProtocol].SupplyOrderID " +
            ") " +
            ") " +
            "LEFT JOIN [ClientAgreement] " +
            "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
            "LEFT JOIN [Agreement] " +
            "ON [Agreement].ID = [ClientAgreement].AgreementID " +
            "LEFT JOIN [Organization] AS [AgreementOrganization] " +
            "ON [AgreementOrganization].ID = [Agreement].OrganizationID ";

        if (typePaymentTask.Equals(TypePaymentTask.PaymentTask))
            tasksSqlExpression += "LEFT JOIN [ContainerService] " +
                                  "ON [ContainerService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [ContainerOrganization] " +
                                  "ON [ContainerService].ContainerOrganizationID = [ContainerOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [ContainerOrganizationAgreement] " +
                                  "ON [ContainerOrganizationAgreement].[ID] = [ContainerService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [ContainerOrganizationOrganization] " +
                                  "ON [ContainerOrganizationOrganization].ID = [ContainerOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [VehicleService] " +
                                  "ON [VehicleService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [VehicleOrganization] " +
                                  "ON [VehicleService].VehicleOrganizationID = [VehicleOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleOrganizationAgreement] " +
                                  "ON [VehicleOrganizationAgreement].[ID] = [VehicleService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [VehicleOrganizationOrganization] " +
                                  "ON [VehicleOrganizationOrganization].ID = [VehicleOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [CustomService] " +
                                  "ON [CustomService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [CustomOrganization] " +
                                  "ON [CustomService].CustomOrganizationID = [CustomOrganization].ID " +
                                  "OR [CustomService].ExciseDutyOrganizationID = [CustomOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomOrganizationAgreement] " +
                                  "ON [CustomOrganizationAgreement].[ID] = [CustomService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [CustomOrganizationOrganization] " +
                                  "ON [CustomOrganizationOrganization].ID = [CustomOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [PortWorkService] " +
                                  "ON [PortWorkService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [PortWorkOrganization] " +
                                  "ON [PortWorkService].PortWorkOrganizationID = [PortWorkOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [PortWorkOrganizationAgreement] " +
                                  "ON [PortWorkOrganizationAgreement].[ID] = [PortWorkService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [PortWorkOrganizationOrganization] " +
                                  "ON [PortWorkOrganizationAgreement].ID = [PortWorkOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [TransportationService] " +
                                  "ON [TransportationService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [TransportationOrganization] " +
                                  "ON [TransportationService].TransportationOrganizationID = [TransportationOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [TransportationOrganizationAgreement] " +
                                  "ON [TransportationOrganizationAgreement].[ID] = [TransportationService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [TransportationOrganizationOrganization] " +
                                  "ON [TransportationOrganizationOrganization].ID = [TransportationOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [PortCustomAgencyService] " +
                                  "ON [PortCustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [PortCustomAgencyOrganization] " +
                                  "ON [PortCustomAgencyService].PortCustomAgencyOrganizationID = [PortCustomAgencyOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [PortCustomAgencyOrganizationAgreement] " +
                                  "ON [PortCustomAgencyOrganizationAgreement].[ID] = [PortCustomAgencyService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [PortCustomAgencyOrganizationOrganization] " +
                                  "ON [PortCustomAgencyOrganizationOrganization].ID = [PortCustomAgencyOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [CustomAgencyService] " +
                                  "ON [CustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [CustomAgencyOrganization] " +
                                  "ON [CustomAgencyService].CustomAgencyOrganizationID = [CustomAgencyOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomAgencyOrganizationAgreement] " +
                                  "ON [CustomAgencyOrganizationAgreement].[ID] = [CustomAgencyService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [CustomAgencyOrganizationOrganization] " +
                                  "ON [CustomAgencyOrganizationOrganization].ID = [CustomAgencyOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [PlaneDeliveryService] " +
                                  "ON [PlaneDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [PlaneDeliveryOrganization] " +
                                  "ON [PlaneDeliveryService].PlaneDeliveryOrganizationID = [PlaneDeliveryOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [PlaneDeliveryOrganizationAgreement] " +
                                  "ON [PlaneDeliveryOrganizationAgreement].[ID] = [PlaneDeliveryService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [PlaneDeliveryOrganizationOrganization] " +
                                  "ON [PlaneDeliveryOrganizationOrganization].ID = [PlaneDeliveryOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [VehicleDeliveryService] " +
                                  "ON [VehicleDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [VehicleDeliveryOrganization] " +
                                  "ON [VehicleDeliveryService].VehicleDeliveryOrganizationID = [VehicleDeliveryOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleDeliveryOrganizationAgreement] " +
                                  "ON [VehicleDeliveryOrganizationAgreement].[ID] = [VehicleDeliveryService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [VehicleDeliveryOrganizationOrganization] " +
                                  "ON [VehicleDeliveryOrganizationOrganization].ID = [VehicleDeliveryOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [MergedService] " +
                                  "ON [MergedService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "AND [MergedService].[ActProvidingServiceID] IS NOT NULL " +
                                  "LEFT JOIN [SupplyOrganization] AS [MergedSupplyOrganization] " +
                                  "ON [MergedSupplyOrganization].ID = [MergedService].SupplyOrganizationID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [MergedOrganizationAgreement] " +
                                  "ON [MergedOrganizationAgreement].[ID] = [MergedService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [MergedOrganizationOrganization] " +
                                  "ON [MergedOrganizationOrganization].ID = [MergedOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [BillOfLadingService] " +
                                  "ON [BillOfLadingService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [BillOfLadingServiceSupplyOrganization] " +
                                  "ON [BillOfLadingServiceSupplyOrganization].ID = [BillOfLadingService].SupplyOrganizationID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [BillOfLadingServiceOrganizationAgreement] " +
                                  "ON [BillOfLadingServiceOrganizationAgreement].[ID] = [BillOfLadingService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [BillOfLadingServiceOrganizationOrganization] " +
                                  "ON [BillOfLadingServiceOrganizationOrganization].ID = [BillOfLadingServiceOrganizationAgreement].OrganizationID ";
        else if (typePaymentTask.Equals(TypePaymentTask.AccountingPaymentTask))
            tasksSqlExpression += "LEFT JOIN [ContainerService] " +
                                  "ON [ContainerService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [ContainerOrganization] " +
                                  "ON [ContainerService].ContainerOrganizationID = [ContainerOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [ContainerOrganizationAgreement] " +
                                  "ON [ContainerOrganizationAgreement].[ID] = [ContainerService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [ContainerOrganizationOrganization] " +
                                  "ON [ContainerOrganizationOrganization].ID = [ContainerOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [VehicleService] " +
                                  "ON [VehicleService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [VehicleOrganization] " +
                                  "ON [VehicleService].VehicleOrganizationID = [VehicleOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleOrganizationAgreement] " +
                                  "ON [VehicleOrganizationAgreement].[ID] = [VehicleService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [VehicleOrganizationOrganization] " +
                                  "ON [VehicleOrganizationOrganization].ID = [VehicleOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [CustomService] " +
                                  "ON [CustomService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [CustomOrganization] " +
                                  "ON [CustomService].CustomOrganizationID = [CustomOrganization].ID " +
                                  "OR [CustomService].ExciseDutyOrganizationID = [CustomOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomOrganizationAgreement] " +
                                  "ON [CustomOrganizationAgreement].[ID] = [CustomService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [CustomOrganizationOrganization] " +
                                  "ON [CustomOrganizationOrganization].ID = [CustomOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [PortWorkService] " +
                                  "ON [PortWorkService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [PortWorkOrganization] " +
                                  "ON [PortWorkService].PortWorkOrganizationID = [PortWorkOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [PortWorkOrganizationAgreement] " +
                                  "ON [PortWorkOrganizationAgreement].[ID] = [PortWorkService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [PortWorkOrganizationOrganization] " +
                                  "ON [PortWorkOrganizationOrganization].ID = [PortWorkOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [TransportationService] " +
                                  "ON [TransportationService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [TransportationOrganization] " +
                                  "ON [TransportationService].TransportationOrganizationID = [TransportationOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [TransportationOrganizationAgreement] " +
                                  "ON [TransportationOrganizationAgreement].[ID] = [TransportationService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [TransportationOrganizationOrganization] " +
                                  "ON [TransportationOrganizationOrganization].ID = [TransportationOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [PortCustomAgencyService] " +
                                  "ON [PortCustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [PortCustomAgencyOrganization] " +
                                  "ON [PortCustomAgencyService].PortCustomAgencyOrganizationID = [PortCustomAgencyOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [PortCustomAgencyOrganizationAgreement] " +
                                  "ON [PortCustomAgencyOrganizationAgreement].[ID] = [PortCustomAgencyService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [PortCustomAgencyOrganizationOrganization] " +
                                  "ON [PortCustomAgencyOrganizationOrganization].ID = [PortCustomAgencyOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [CustomAgencyService] " +
                                  "ON [CustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [CustomAgencyOrganization] " +
                                  "ON [CustomAgencyService].CustomAgencyOrganizationID = [CustomAgencyOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomAgencyOrganizationAgreement] " +
                                  "ON [CustomAgencyOrganizationAgreement].[ID] = [CustomAgencyService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [CustomAgencyOrganizationOrganization] " +
                                  "ON [CustomAgencyOrganizationOrganization].ID = [CustomAgencyOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [PlaneDeliveryService] " +
                                  "ON [PlaneDeliveryService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [PlaneDeliveryOrganization] " +
                                  "ON [PlaneDeliveryService].PlaneDeliveryOrganizationID = [PlaneDeliveryOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [PlaneDeliveryOrganizationAgreement] " +
                                  "ON [PlaneDeliveryOrganizationAgreement].[ID] = [PlaneDeliveryService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [PlaneDeliveryOrganizationOrganization] " +
                                  "ON [PlaneDeliveryOrganizationOrganization].ID = [PlaneDeliveryOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [VehicleDeliveryService] " +
                                  "ON [VehicleDeliveryService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [VehicleDeliveryOrganization] " +
                                  "ON [VehicleDeliveryService].VehicleDeliveryOrganizationID = [VehicleDeliveryOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleDeliveryOrganizationAgreement] " +
                                  "ON [VehicleDeliveryOrganizationAgreement].[ID] = [VehicleDeliveryService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [VehicleDeliveryOrganizationOrganization] " +
                                  "ON [VehicleDeliveryOrganizationOrganization].ID = [VehicleDeliveryOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [MergedService] " +
                                  "ON [MergedService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "AND [MergedService].[AccountingActProvidingServiceID] IS NOT NULL " +
                                  "LEFT JOIN [SupplyOrganization] AS [MergedSupplyOrganization] " +
                                  "ON [MergedSupplyOrganization].ID = [MergedService].SupplyOrganizationID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [MergedOrganizationAgreement] " +
                                  "ON [MergedOrganizationAgreement].[ID] = [MergedService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [MergedOrganizationOrganization] " +
                                  "ON [MergedOrganizationOrganization].ID = [MergedOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [BillOfLadingService] " +
                                  "ON [BillOfLadingService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [BillOfLadingServiceSupplyOrganization] " +
                                  "ON [BillOfLadingServiceSupplyOrganization].ID = [BillOfLadingService].SupplyOrganizationID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [BillOfLadingServiceOrganizationAgreement] " +
                                  "ON [BillOfLadingServiceOrganizationAgreement].[ID] = [BillOfLadingService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [BillOfLadingServiceOrganizationOrganization] " +
                                  "ON [BillOfLadingServiceOrganizationOrganization].ID = [BillOfLadingServiceOrganizationAgreement].OrganizationID ";
        else
            tasksSqlExpression += "LEFT JOIN [ContainerService] " +
                                  "ON [ContainerService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "OR [ContainerService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [ContainerOrganization] " +
                                  "ON [ContainerService].ContainerOrganizationID = [ContainerOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [ContainerOrganizationAgreement] " +
                                  "ON [ContainerOrganizationAgreement].[ID] = [ContainerService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [ContainerOrganizationOrganization] " +
                                  "ON [ContainerOrganizationOrganization].ID = [ContainerOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [VehicleService] " +
                                  "ON [VehicleService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "OR [VehicleService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [VehicleOrganization] " +
                                  "ON [VehicleService].VehicleOrganizationID = [VehicleOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleOrganizationAgreement] " +
                                  "ON [VehicleOrganizationAgreement].[ID] = [VehicleService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [VehicleOrganizationOrganization] " +
                                  "ON [VehicleOrganizationOrganization].ID = [VehicleOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [CustomService] " +
                                  "ON [CustomService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "OR [CustomService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [CustomOrganization] " +
                                  "ON [CustomService].CustomOrganizationID = [CustomOrganization].ID " +
                                  "OR [CustomService].ExciseDutyOrganizationID = [CustomOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomOrganizationAgreement] " +
                                  "ON [CustomOrganizationAgreement].[ID] = [CustomService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [CustomOrganizationOrganization] " +
                                  "ON [CustomOrganizationOrganization].ID = [CustomOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [PortWorkService] " +
                                  "ON [PortWorkService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "OR [PortWorkService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [PortWorkOrganization] " +
                                  "ON [PortWorkService].PortWorkOrganizationID = [PortWorkOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [PortWorkOrganizationAgreement] " +
                                  "ON [PortWorkOrganizationAgreement].[ID] = [PortWorkService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [PortWorkOrganizationOrganization] " +
                                  "ON [PortWorkOrganizationOrganization].ID = [PortWorkOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [TransportationService] " +
                                  "ON [TransportationService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "OR [TransportationService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [TransportationOrganization] " +
                                  "ON [TransportationService].TransportationOrganizationID = [TransportationOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [TransportationOrganizationAgreement] " +
                                  "ON [TransportationOrganizationAgreement].[ID] = [TransportationService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [TransportationOrganizationOrganization] " +
                                  "ON [TransportationOrganizationOrganization].ID = [TransportationOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [PortCustomAgencyService] " +
                                  "ON [PortCustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "OR [PortCustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [PortCustomAgencyOrganization] " +
                                  "ON [PortCustomAgencyService].PortCustomAgencyOrganizationID = [PortCustomAgencyOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [PortCustomAgencyOrganizationAgreement] " +
                                  "ON [PortCustomAgencyOrganizationAgreement].[ID] = [PortCustomAgencyService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [PortCustomAgencyOrganizationOrganization] " +
                                  "ON [PortCustomAgencyOrganizationOrganization].ID = [PortCustomAgencyOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [CustomAgencyService] " +
                                  "ON [CustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "OR [CustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [CustomAgencyOrganization] " +
                                  "ON [CustomAgencyService].CustomAgencyOrganizationID = [CustomAgencyOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomAgencyOrganizationAgreement] " +
                                  "ON [CustomAgencyOrganizationAgreement].[ID] = [CustomAgencyService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [CustomAgencyOrganizationOrganization] " +
                                  "ON [CustomAgencyOrganizationOrganization].ID = [CustomAgencyOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [PlaneDeliveryService] " +
                                  "ON [PlaneDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "OR [PlaneDeliveryService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [PlaneDeliveryOrganization] " +
                                  "ON [PlaneDeliveryService].PlaneDeliveryOrganizationID = [PlaneDeliveryOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [PlaneDeliveryOrganizationAgreement] " +
                                  "ON [PlaneDeliveryOrganizationAgreement].[ID] = [PlaneDeliveryService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [PlaneDeliveryOrganizationOrganization] " +
                                  "ON [PlaneDeliveryOrganizationOrganization].ID = [PlaneDeliveryOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [VehicleDeliveryService] " +
                                  "ON [VehicleDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "OR [VehicleDeliveryService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [VehicleDeliveryOrganization] " +
                                  "ON [VehicleDeliveryService].VehicleDeliveryOrganizationID = [VehicleDeliveryOrganization].ID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleDeliveryOrganizationAgreement] " +
                                  "ON [VehicleDeliveryOrganizationAgreement].[ID] = [VehicleDeliveryService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [VehicleDeliveryOrganizationOrganization] " +
                                  "ON [VehicleDeliveryOrganizationOrganization].ID = [VehicleDeliveryOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [MergedService] " +
                                  "ON ([MergedService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "OR [MergedService].AccountingPaymentTaskID = [SupplyPaymentTask].ID) " +
                                  "AND ([MergedService].[ActProvidingServiceID] IS NOT NULL " +
                                  "OR [MergedService].[AccountingActProvidingServiceID] IS NOT NULL ) " +
                                  "LEFT JOIN [SupplyOrganization] AS [MergedSupplyOrganization] " +
                                  "ON [MergedSupplyOrganization].ID = [MergedService].SupplyOrganizationID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [MergedOrganizationAgreement] " +
                                  "ON [MergedOrganizationAgreement].[ID] = [MergedService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [MergedOrganizationOrganization] " +
                                  "ON [MergedOrganizationOrganization].ID = [MergedOrganizationAgreement].OrganizationID " +
                                  "LEFT JOIN [BillOfLadingService] " +
                                  "ON [BillOfLadingService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "OR [BillOfLadingService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
                                  "LEFT JOIN [SupplyOrganization] AS [BillOfLadingServiceSupplyOrganization] " +
                                  "ON [BillOfLadingServiceSupplyOrganization].ID = [BillOfLadingService].SupplyOrganizationID " +
                                  "LEFT JOIN [SupplyOrganizationAgreement] AS [BillOfLadingServiceOrganizationAgreement] " +
                                  "ON [BillOfLadingServiceOrganizationAgreement].[ID] = [BillOfLadingService].[SupplyOrganizationAgreementID] " +
                                  "LEFT JOIN [Organization] AS [BillOfLadingServiceOrganizationOrganization] " +
                                  "ON [BillOfLadingServiceOrganizationOrganization].ID = [BillOfLadingServiceOrganizationAgreement].OrganizationID ";

        tasksSqlExpression += "LEFT JOIN [ConsumablesOrder] " +
                              "ON [ConsumablesOrder].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                              "LEFT JOIN [ConsumablesOrderItem] " +
                              "ON [ConsumablesOrderItem].ConsumablesOrderID = [ConsumablesOrder].ID " +
                              "LEFT JOIN [SupplyOrganization] AS [ConsumableProductOrganization] " +
                              "ON [ConsumablesOrderItem].ConsumableProductOrganizationID = [ConsumableProductOrganization].ID " +
                              "LEFT JOIN [SupplyOrganizationAgreement] AS [ConsumableProductOrganizationAgreement] " +
                              "ON [ConsumableProductOrganizationAgreement].[ID] = [ConsumablesOrderItem].[SupplyOrganizationAgreementID] " +
                              "LEFT JOIN [Organization] AS [ConsumableProductOrganizationOrganization] " +
                              "ON [ConsumableProductOrganizationOrganization].ID = [ConsumableProductOrganizationAgreement].OrganizationID " +
                              "LEFT JOIN [SupplyPaymentTaskDocument] " +
                              "ON [SupplyPaymentTaskDocument].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                              "LEFT JOIN [OutcomePaymentOrderSupplyPaymentTask] " +
                              "ON [OutcomePaymentOrderSupplyPaymentTask].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                              "LEFT JOIN [OutcomePaymentOrder] " +
                              "ON [OutcomePaymentOrder].ID = [OutcomePaymentOrderSupplyPaymentTask].OutcomePaymentOrderID " +
                              "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                              "ON [Organization].ID = [OutcomePaymentOrder].OrganizationID " +
                              "AND [Organization].CultureCode = @Culture " +
                              "LEFT JOIN [User] AS [OutcomeUser] " +
                              "ON [OutcomeUser].ID = [OutcomePaymentOrder].UserID " +
                              "LEFT JOIN [PaymentMovementOperation] " +
                              "ON [OutcomePaymentOrder].ID = [PaymentMovementOperation].OutcomePaymentOrderID " +
                              "LEFT JOIN ( " +
                              "SELECT [PaymentMovement].ID " +
                              ", [PaymentMovement].[Created] " +
                              ", [PaymentMovement].[Deleted] " +
                              ", [PaymentMovement].[NetUID] " +
                              ", (CASE WHEN [PaymentMovementTranslation].[Name] IS NOT NULL THEN [PaymentMovementTranslation].[Name] ELSE [PaymentMovement].[OperationName] END) AS [OperationName] " +
                              ", [PaymentMovement].[Updated] " +
                              "FROM [PaymentMovement] " +
                              "LEFT JOIN [PaymentMovementTranslation] " +
                              "ON [PaymentMovementTranslation].PaymentMovementID = [PaymentMovement].ID " +
                              "AND [PaymentMovementTranslation].CultureCode = @Culture " +
                              ") AS [PaymentMovement] " +
                              "ON [PaymentMovement].ID = [PaymentMovementOperation].PaymentMovementID " +
                              "LEFT JOIN [PaymentCurrencyRegister] " +
                              "ON [PaymentCurrencyRegister].ID = [OutcomePaymentOrder].PaymentCurrencyRegisterID " +
                              "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                              "ON [Currency].ID = [PaymentCurrencyRegister].CurrencyID " +
                              "AND [Currency].CultureCode = @Culture " +
                              "LEFT JOIN [PaymentRegister] " +
                              "ON [PaymentRegister].ID = [PaymentCurrencyRegister].PaymentRegisterID " +
                              "LEFT JOIN [SupplyOrderUkrainePaymentDeliveryProtocol] " +
                              "ON [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
                              "LEFT JOIN [SupplyOrderUkraine] " +
                              "ON [SupplyOrderUkraine].ID = [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyOrderUkraineID " +
                              "LEFT JOIN [ClientAgreement] AS [SupplyOrderUkraineClientAgreement] " +
                              "ON [SupplyOrderUkraineClientAgreement].ID = [SupplyOrderUkraine].ClientAgreementID " +
                              "LEFT JOIN [Agreement] AS [SupplyOrderUkraineAgreement] " +
                              "ON [SupplyOrderUkraineAgreement].ID = [SupplyOrderUkraineClientAgreement].AgreementID " +
                              "LEFT JOIN [Organization] AS [SupplyOrderUkraineAgreementOrganization] " +
                              "ON [SupplyOrderUkraineAgreementOrganization].ID = [SupplyOrderUkraineAgreement].OrganizationID " +
                              "WHERE [SupplyPaymentTask].[Deleted] = 0 " +
                              "AND [SupplyPaymentTask].[IsImportedFromOneC] = 0 " +
                              "AND CONVERT(date, [SupplyPaymentTask].[PayToDate]) IN @Dates " +
                              "AND ( " +
                              "[SupplyOrderUkraine].ID IS NOT NULL " +
                              "OR " +
                              "[SupplyOrder].ID IS NOT NULL " +
                              "OR " +
                              "[ContainerService].ID IS NOT NULL " +
                              "OR " +
                              "[VehicleService].ID IS NOT NULL " +
                              "OR " +
                              "[CustomService].ID IS NOT NULL " +
                              "OR " +
                              "[PortWorkService].ID IS NOT NULL " +
                              "OR " +
                              "[TransportationService].ID IS NOT NULL " +
                              "OR " +
                              "[PortCustomAgencyService].ID IS NOT NULL " +
                              "OR " +
                              "[CustomAgencyService].ID IS NOT NULL " +
                              "OR " +
                              "[PlaneDeliveryService].ID IS NOT NULL " +
                              "OR " +
                              "[VehicleDeliveryService].ID IS NOT NULL " +
                              "OR " +
                              "[ConsumablesOrder].ID IS NOT NULL " +
                              "OR " +
                              "[MergedService].ID IS NOT NULL " +
                              "OR " +
                              "[BillOfLadingService].ID IS NOT NULL " +
                              ") ";

        if (organizationNetId.HasValue)
            tasksSqlExpression +=
                "AND ( " +
                "([AgreementOrganization].NetUID = @OrganizationNetId AND [AgreementOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([ContainerOrganizationOrganization].NetUID = @OrganizationNetId AND [ContainerOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([VehicleOrganizationOrganization].NetUID = @OrganizationNetId AND [VehicleOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([CustomOrganizationOrganization].NetUID = @OrganizationNetId AND [CustomOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PortWorkOrganizationOrganization].NetUID = @OrganizationNetId AND [PortWorkOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([TransportationOrganizationOrganization].NetUID = @OrganizationNetId AND [TransportationOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PortCustomAgencyOrganizationOrganization].NetUID = @OrganizationNetId AND [PortCustomAgencyOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([CustomAgencyOrganizationOrganization].NetUID = @OrganizationNetId AND [CustomAgencyOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PlaneDeliveryOrganizationOrganization].NetUID = @OrganizationNetId AND [PlaneDeliveryOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([VehicleDeliveryOrganizationOrganization].NetUID = @OrganizationNetId AND [VehicleDeliveryOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([ConsumableProductOrganizationOrganization].NetUID = @OrganizationNetId AND [ConsumableProductOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([MergedOrganizationOrganization].NetUID = @OrganizationNetId AND [MergedOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([BillOfLadingServiceOrganizationOrganization].NetUID = @OrganizationNetId AND [BillOfLadingServiceOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([SupplyOrderUkraineAgreementOrganization].NetUID = @OrganizationNetId AND [SupplyOrderUkraineAgreementOrganization].NetUID IS NOT NULL) " +
                ") ";

        tasksSqlExpression += "ORDER BY [SupplyPaymentTask].[PayToDate]";

        _connection.Query(
            tasksSqlExpression,
            types,
            mapper,
            new {
                Dates = groupedPaymentTaskWithTotals.GroupedPaymentTasks.Select(t => t.PayToDate),
                OrganizationNetId = organizationNetId ?? Guid.Empty,
                Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
            }
        );

        if (joinServices.Any()) {
            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.SupplyOrderPaymentDeliveryProtocol))) {
                Type[] includesTypes = new[] {
                    typeof(SupplyOrderPaymentDeliveryProtocol),
                    typeof(SupplyOrderPaymentDeliveryProtocolKey),
                    typeof(SupplyPaymentTask),
                    typeof(User),
                    typeof(SupplyInvoice),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(InvoiceDocument),
                    typeof(SupplyInformationDeliveryProtocol),
                    typeof(SupplyInformationDeliveryProtocolKey),
                    typeof(SupplyProForm),
                    typeof(ProFormDocument),
                    typeof(SupplyInformationDeliveryProtocol),
                    typeof(SupplyInformationDeliveryProtocolKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(SupplyOrderNumber),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], SupplyOrderPaymentDeliveryProtocol> includesMapper = objects => {
                    SupplyOrderPaymentDeliveryProtocol supplyOrderPaymentDeliveryProtocol = (SupplyOrderPaymentDeliveryProtocol)objects[0];
                    SupplyOrderPaymentDeliveryProtocolKey supplyOrderPaymentDeliveryProtocolKey = (SupplyOrderPaymentDeliveryProtocolKey)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    User user = (User)objects[3];
                    SupplyInvoice supplyInvoice = (SupplyInvoice)objects[4];
                    SupplyOrder invoiceSupplyOrder = (SupplyOrder)objects[5];
                    Client invoiceClient = (Client)objects[6];
                    Region invoiceClientRegion = (Region)objects[7];
                    RegionCode invoiceClientRegionCode = (RegionCode)objects[8];
                    Country invoiceClientCountry = (Country)objects[9];
                    ClientBankDetails invoiceClientBankDetails = (ClientBankDetails)objects[10];
                    ClientBankDetailAccountNumber invoiceClientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[11];
                    Currency invoiceClientBankDetailAccountNumberCurrency = (Currency)objects[12];
                    ClientBankDetailIbanNo invoiceClientClientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[13];
                    Currency invoiceClientClientBankDetailIbanNoCurrency = (Currency)objects[14];
                    TermsOfDelivery invoiceClientTermsOfDelivery = (TermsOfDelivery)objects[15];
                    PackingMarking invoiceClientPackingMarking = (PackingMarking)objects[16];
                    PackingMarkingPayment invoiceClientPackingMarkingPayment = (PackingMarkingPayment)objects[17];
                    ClientAgreement invoiceClientClientAgreement = (ClientAgreement)objects[18];
                    Agreement invoiceClientAgreement = (Agreement)objects[19];
                    ProviderPricing invoiceClientProviderPricing = (ProviderPricing)objects[20];
                    Currency invoiceClientProviderPricingCurrency = (Currency)objects[21];
                    Pricing invoiceClientPricing = (Pricing)objects[22];
                    PriceType invoiceClientPricingPriceType = (PriceType)objects[23];
                    Organization invoiceClientAgreementOrganization = (Organization)objects[24];
                    Currency invoiceClientAgreementCurrency = (Currency)objects[25];
                    Organization invoiceOrganization = (Organization)objects[26];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[27];
                    SupplyInformationDeliveryProtocol invoiceInformationProtocol = (SupplyInformationDeliveryProtocol)objects[28];
                    SupplyInformationDeliveryProtocolKey invoiceInformationProtocolKey = (SupplyInformationDeliveryProtocolKey)objects[29];
                    SupplyProForm supplyProForm = (SupplyProForm)objects[30];
                    ProFormDocument proFormDocument = (ProFormDocument)objects[31];
                    SupplyInformationDeliveryProtocol proFormInformationProtocol = (SupplyInformationDeliveryProtocol)objects[32];
                    SupplyInformationDeliveryProtocolKey proFormInformationProtocolKey = (SupplyInformationDeliveryProtocolKey)objects[33];
                    SupplyOrder proFormSupplyOrder = (SupplyOrder)objects[34];
                    Client proFormClient = (Client)objects[35];
                    Region proFormClientRegion = (Region)objects[36];
                    RegionCode proFormClientRegionCode = (RegionCode)objects[37];
                    Country proFormClientCountry = (Country)objects[38];
                    ClientBankDetails proFormClientBankDetails = (ClientBankDetails)objects[39];
                    ClientBankDetailAccountNumber proFormClientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[40];
                    Currency proFormClientBankDetailAccountNumberCurrency = (Currency)objects[41];
                    ClientBankDetailIbanNo proFormClientClientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[42];
                    Currency proFormClientClientBankDetailIbanNoCurrency = (Currency)objects[43];
                    TermsOfDelivery proFormClientTermsOfDelivery = (TermsOfDelivery)objects[44];
                    PackingMarking proFormClientPackingMarking = (PackingMarking)objects[45];
                    PackingMarkingPayment proFormClientPackingMarkingPayment = (PackingMarkingPayment)objects[46];
                    ClientAgreement proFormClientClientAgreement = (ClientAgreement)objects[47];
                    Agreement proFormClientAgreement = (Agreement)objects[48];
                    ProviderPricing proFormClientProviderPricing = (ProviderPricing)objects[49];
                    Currency proFormClientProviderPricingCurrency = (Currency)objects[50];
                    Pricing proFormClientPricing = (Pricing)objects[51];
                    PriceType proFormClientPricingPriceType = (PriceType)objects[52];
                    Organization proFormClientAgreementOrganization = (Organization)objects[53];
                    Currency proFormClientAgreementCurrency = (Currency)objects[54];
                    Organization proFormOrganization = (Organization)objects[55];
                    SupplyOrderNumber invoiceSupplyOrderNumber = (SupplyOrderNumber)objects[56];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[57];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.PaymentDeliveryProtocols.Any()) {
                        SupplyOrderPaymentDeliveryProtocol protocolFromList = taskFromList.PaymentDeliveryProtocols.First();

                        if (supplyInvoice != null) {
                            if (invoiceDocument != null && !protocolFromList.SupplyInvoice.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                protocolFromList.SupplyInvoice.InvoiceDocuments.Add(invoiceDocument);

                            if (invoiceInformationProtocol != null &&
                                !protocolFromList.SupplyInvoice.InformationDeliveryProtocols.Any(p => p.Id.Equals(invoiceInformationProtocol.Id))) {
                                invoiceInformationProtocol.SupplyInformationDeliveryProtocolKey = invoiceInformationProtocolKey;

                                protocolFromList.SupplyInvoice.InformationDeliveryProtocols.Add(invoiceInformationProtocol);
                            }
                        }

                        if (supplyProForm == null) return supplyOrderPaymentDeliveryProtocol;

                        if (proFormDocument != null && !protocolFromList.SupplyProForm.ProFormDocuments.Any(d => d.Id.Equals(proFormDocument.Id)))
                            protocolFromList.SupplyProForm.ProFormDocuments.Add(proFormDocument);

                        if (proFormInformationProtocol != null &&
                            !protocolFromList.SupplyProForm.InformationDeliveryProtocols.Any(p => p.Id.Equals(proFormInformationProtocol.Id))) {
                            proFormInformationProtocol.SupplyInformationDeliveryProtocolKey = proFormInformationProtocolKey;

                            protocolFromList.SupplyProForm.InformationDeliveryProtocols.Add(proFormInformationProtocol);
                        }

                        if (proFormSupplyOrder == null || protocolFromList.SupplyProForm.SupplyOrders.Any(o => o.Id.Equals(proFormSupplyOrder.Id)))
                            return supplyOrderPaymentDeliveryProtocol;

                        proFormSupplyOrder.Client = proFormClient;
                        proFormSupplyOrder.SupplyOrderNumber = supplyOrderNumber;
                        proFormSupplyOrder.Organization = proFormOrganization;

                        protocolFromList.SupplyProForm.SupplyOrders.Add(proFormSupplyOrder);
                    } else {
                        if (supplyInvoice != null) {
                            if (invoiceDocument != null) supplyInvoice.InvoiceDocuments.Add(invoiceDocument);

                            if (invoiceInformationProtocol != null) {
                                invoiceInformationProtocol.SupplyInformationDeliveryProtocolKey = invoiceInformationProtocolKey;

                                supplyInvoice.InformationDeliveryProtocols.Add(invoiceInformationProtocol);
                            }

                            if (invoiceClient != null) {
                                if (invoiceClientBankDetails != null) {
                                    if (invoiceClientBankDetailAccountNumber != null) {
                                        invoiceClientBankDetailAccountNumber.Currency = invoiceClientBankDetailAccountNumberCurrency;

                                        invoiceClientBankDetails.AccountNumber = invoiceClientBankDetailAccountNumber;
                                    }

                                    if (invoiceClientClientBankDetailIbanNo != null) {
                                        invoiceClientClientBankDetailIbanNo.Currency = invoiceClientClientBankDetailIbanNoCurrency;

                                        invoiceClientBankDetails.ClientBankDetailIbanNo = invoiceClientClientBankDetailIbanNo;
                                    }
                                }

                                if (invoiceClientClientAgreement != null) {
                                    if (invoiceClientProviderPricing != null) {
                                        if (invoiceClientPricing != null) invoiceClientPricing.PriceType = invoiceClientPricingPriceType;

                                        invoiceClientProviderPricing.Currency = invoiceClientProviderPricingCurrency;
                                        invoiceClientProviderPricing.Pricing = invoiceClientPricing;
                                    }

                                    invoiceClientAgreement.Organization = invoiceClientAgreementOrganization;
                                    invoiceClientAgreement.Currency = invoiceClientAgreementCurrency;
                                    invoiceClientAgreement.ProviderPricing = invoiceClientProviderPricing;

                                    invoiceClientClientAgreement.Agreement = invoiceClientAgreement;

                                    invoiceClient.ClientAgreements.Add(invoiceClientClientAgreement);
                                }

                                invoiceClient.Region = invoiceClientRegion;
                                invoiceClient.RegionCode = invoiceClientRegionCode;
                                invoiceClient.Country = invoiceClientCountry;
                                invoiceClient.ClientBankDetails = invoiceClientBankDetails;
                                invoiceClient.TermsOfDelivery = invoiceClientTermsOfDelivery;
                                invoiceClient.PackingMarking = invoiceClientPackingMarking;
                                invoiceClient.PackingMarkingPayment = invoiceClientPackingMarkingPayment;
                            }

                            invoiceSupplyOrder.Client = invoiceClient;
                            invoiceSupplyOrder.ClientAgreement = invoiceClientClientAgreement;
                            invoiceSupplyOrder.SupplyOrderNumber = invoiceSupplyOrderNumber;
                            invoiceSupplyOrder.Organization = invoiceOrganization;

                            supplyInvoice.SupplyOrder = invoiceSupplyOrder;
                        }

                        if (supplyProForm != null) {
                            if (proFormDocument != null) supplyProForm.ProFormDocuments.Add(proFormDocument);

                            if (proFormInformationProtocol != null) {
                                proFormInformationProtocol.SupplyInformationDeliveryProtocolKey = proFormInformationProtocolKey;

                                supplyProForm.InformationDeliveryProtocols.Add(proFormInformationProtocol);
                            }

                            if (proFormSupplyOrder != null) {
                                if (proFormClient != null) {
                                    if (proFormClientBankDetails != null) {
                                        if (proFormClientBankDetailAccountNumber != null) {
                                            proFormClientBankDetailAccountNumber.Currency = proFormClientBankDetailAccountNumberCurrency;

                                            proFormClientBankDetails.AccountNumber = proFormClientBankDetailAccountNumber;
                                        }

                                        if (proFormClientClientBankDetailIbanNo != null) {
                                            proFormClientClientBankDetailIbanNo.Currency = proFormClientClientBankDetailIbanNoCurrency;

                                            proFormClientBankDetails.ClientBankDetailIbanNo = proFormClientClientBankDetailIbanNo;
                                        }
                                    }

                                    if (proFormClientClientAgreement != null) {
                                        if (proFormClientProviderPricing != null) {
                                            if (proFormClientPricing != null) proFormClientPricing.PriceType = proFormClientPricingPriceType;

                                            proFormClientProviderPricing.Currency = proFormClientProviderPricingCurrency;
                                            proFormClientProviderPricing.Pricing = proFormClientPricing;
                                        }

                                        proFormClientAgreement.Organization = proFormClientAgreementOrganization;
                                        proFormClientAgreement.Currency = proFormClientAgreementCurrency;
                                        proFormClientAgreement.ProviderPricing = proFormClientProviderPricing;

                                        proFormClientClientAgreement.Agreement = proFormClientAgreement;

                                        proFormClient.ClientAgreements.Add(proFormClientClientAgreement);
                                    }

                                    proFormClient.Region = proFormClientRegion;
                                    proFormClient.RegionCode = proFormClientRegionCode;
                                    proFormClient.Country = proFormClientCountry;
                                    proFormClient.ClientBankDetails = proFormClientBankDetails;
                                    proFormClient.TermsOfDelivery = proFormClientTermsOfDelivery;
                                    proFormClient.PackingMarking = proFormClientPackingMarking;
                                    proFormClient.PackingMarkingPayment = proFormClientPackingMarkingPayment;
                                }

                                proFormSupplyOrder.Client = proFormClient;
                                proFormSupplyOrder.ClientAgreement = proFormClientClientAgreement;
                                proFormSupplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                proFormSupplyOrder.Organization = proFormOrganization;

                                supplyProForm.SupplyOrders.Add(proFormSupplyOrder);
                            }
                        }

                        supplyOrderPaymentDeliveryProtocol.SupplyOrderPaymentDeliveryProtocolKey = supplyOrderPaymentDeliveryProtocolKey;
                        supplyOrderPaymentDeliveryProtocol.User = user;
                        supplyOrderPaymentDeliveryProtocol.SupplyInvoice = supplyInvoice;
                        supplyOrderPaymentDeliveryProtocol.SupplyProForm = supplyProForm;

                        taskFromList.PaymentDeliveryProtocols.Add(supplyOrderPaymentDeliveryProtocol);

                        decimal exchangeRateAmount = 1;

                        if (proFormClientAgreementCurrency != null) {
                            if (!proFormClientAgreementCurrency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(proFormClientAgreementCurrency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(proFormClientAgreementCurrency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(proFormClientAgreementCurrency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = proFormClientAgreementCurrency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        } else if (invoiceClientAgreementCurrency != null) {
                            if (!invoiceClientAgreementCurrency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(invoiceClientAgreementCurrency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(invoiceClientAgreementCurrency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(invoiceClientAgreementCurrency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = invoiceClientAgreementCurrency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return supplyOrderPaymentDeliveryProtocol;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [SupplyOrderPaymentDeliveryProtocol] " +
                    "LEFT JOIN [SupplyOrderPaymentDeliveryProtocolKey] " +
                    "ON [SupplyOrderPaymentDeliveryProtocolKey].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyOrderPaymentDeliveryProtocolKeyID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyPaymentTaskID " +
                    "LEFT JOIN [User] AS [SupplyOrderPaymentDeliveryProtocolUser] " +
                    "ON [SupplyOrderPaymentDeliveryProtocolUser].ID = [SupplyOrderPaymentDeliveryProtocol].UserID " +
                    "LEFT JOIN [SupplyInvoice] " +
                    "ON [SupplyInvoice].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyInvoiceID " +
                    "LEFT JOIN [SupplyOrder] AS [InvoiceSupplyOrder] " +
                    "ON [InvoiceSupplyOrder].ID = [SupplyInvoice].SupplyOrderID " +
                    "LEFT JOIN [Client] AS [InvoiceSupplyOrderClient] " +
                    "ON [InvoiceSupplyOrder].ClientID = [InvoiceSupplyOrderClient].ID " +
                    "LEFT JOIN [Region] AS [InvoiceSupplyOrderClientRegion] " +
                    "ON [InvoiceSupplyOrderClientRegion].ID = [InvoiceSupplyOrderClient].RegionID " +
                    "LEFT JOIN [RegionCode] AS [InvoiceSupplyOrderClientRegionCode] " +
                    "ON [InvoiceSupplyOrderClientRegionCode].ID = [InvoiceSupplyOrderClient].RegionCodeID " +
                    "LEFT JOIN [Country] AS [InvoiceSupplyOrderClientCountry] " +
                    "ON [InvoiceSupplyOrderClientCountry].ID = [InvoiceSupplyOrderClient].CountryID " +
                    "LEFT JOIN [ClientBankDetails] AS [InvoiceSupplyOrderClientBankDetails] " +
                    "ON [InvoiceSupplyOrderClientBankDetails].ID = [InvoiceSupplyOrderClient].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] AS [InvoiceSupplyOrderClientBankDetailsAccountNumber] " +
                    "ON [InvoiceSupplyOrderClientBankDetailsAccountNumber].ID = [InvoiceSupplyOrderClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [InvoiceSupplyOrderClientBankDetailsAccountNumberCurrency] " +
                    "ON [InvoiceSupplyOrderClientBankDetailsAccountNumberCurrency].ID = [InvoiceSupplyOrderClientBankDetailsAccountNumber].CurrencyID " +
                    "AND [InvoiceSupplyOrderClientBankDetailsAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] AS [InvoiceSupplyOrderClientBankDetailsIbanNo] " +
                    "ON [InvoiceSupplyOrderClientBankDetailsIbanNo].ID = [InvoiceSupplyOrderClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [InvoiceSupplyOrderClientBankDetailsIbanNoCurrency] " +
                    "ON [InvoiceSupplyOrderClientBankDetailsIbanNoCurrency].ID = [InvoiceSupplyOrderClientBankDetailsIbanNo].CurrencyID " +
                    "AND [InvoiceSupplyOrderClientBankDetailsIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] AS [InvoiceSupplyOrderClientTermsOfDelivery] " +
                    "ON [InvoiceSupplyOrderClientTermsOfDelivery].ID = [InvoiceSupplyOrderClient].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] AS [InvoiceSupplyOrderClientPackingMarking] " +
                    "ON [InvoiceSupplyOrderClientPackingMarking].ID = [InvoiceSupplyOrderClient].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] AS [InvoiceSupplyOrderClientPackingMarkingPayment] " +
                    "ON [InvoiceSupplyOrderClientPackingMarkingPayment].ID = [InvoiceSupplyOrderClient].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] AS [InvoiceSupplyOrderClientClientAgreement] " +
                    "ON [InvoiceSupplyOrderClientClientAgreement].ID = [InvoiceSupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] AS [InvoiceSupplyOrderClientAgreement] " +
                    "ON [InvoiceSupplyOrderClientAgreement].ID = [InvoiceSupplyOrderClientClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] AS [InvoiceSupplyOrderClientAgreementProviderPricing] " +
                    "ON [InvoiceSupplyOrderClientAgreementProviderPricing].ID = [InvoiceSupplyOrderClientAgreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [InvoiceSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [InvoiceSupplyOrderClientAgreementProviderPricingCurrency].ID = [InvoiceSupplyOrderClientAgreementProviderPricing].CurrencyID " +
                    "AND [InvoiceSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] AS [InvoiceSupplyOrderClientAgreementPricing] " +
                    "ON [InvoiceSupplyOrderClientAgreementProviderPricing].BasePricingID = [InvoiceSupplyOrderClientAgreementPricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [InvoiceSupplyOrderClientAgreementPricingPriceType] " +
                    "ON [InvoiceSupplyOrderClientAgreementPricing].PriceTypeID = [InvoiceSupplyOrderClientAgreementPricingPriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [InvoiceSupplyOrderClientAgreementOrganization] " +
                    "ON [InvoiceSupplyOrderClientAgreementOrganization].ID = [InvoiceSupplyOrderClientAgreement].OrganizationID " +
                    "AND [InvoiceSupplyOrderClientAgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [InvoiceSupplyOrderClientAgreementCurrency] " +
                    "ON [InvoiceSupplyOrderClientAgreementCurrency].ID = [InvoiceSupplyOrderClientAgreement].CurrencyID " +
                    "AND [InvoiceSupplyOrderClientAgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [InvoiceSupplyOrderOrganization] " +
                    "ON [InvoiceSupplyOrderOrganization].ID = [InvoiceSupplyOrder].OrganizationID " +
                    "AND [InvoiceSupplyOrderOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].SupplyInvoiceID = [SupplyInvoice].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [SupplyInformationDeliveryProtocol] AS [InvoiceSupplyInformationDeliveryProtocol] " +
                    "ON [InvoiceSupplyInformationDeliveryProtocol].SupplyInvoiceID = [SupplyInvoice].ID " +
                    "AND [InvoiceSupplyInformationDeliveryProtocol].Deleted = 0 " +
                    "LEFT JOIN [views].[SupplyInformationDeliveryProtocolKeyView] AS [InvoiceSupplyInformationDeliveryProtocolKey] " +
                    "ON [InvoiceSupplyInformationDeliveryProtocolKey].ID = [InvoiceSupplyInformationDeliveryProtocol].SupplyInformationDeliveryProtocolKeyID " +
                    "AND [InvoiceSupplyInformationDeliveryProtocolKey].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyProForm] " +
                    "ON [SupplyProForm].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyProFormID " +
                    "LEFT JOIN [ProFormDocument] " +
                    "ON [ProFormDocument].SupplyProFormID = [SupplyProForm].ID " +
                    "AND [ProFormDocument].Deleted = 0 " +
                    "LEFT JOIN [SupplyInformationDeliveryProtocol] AS [ProFormSupplyInformationDeliveryProtocol] " +
                    "ON [ProFormSupplyInformationDeliveryProtocol].SupplyProFormID = [SupplyProForm].ID " +
                    "AND [ProFormSupplyInformationDeliveryProtocol].Deleted = 0 " +
                    "LEFT JOIN [views].[SupplyInformationDeliveryProtocolKeyView] AS [ProFormSupplyInformationDeliveryProtocolKey] " +
                    "ON [ProFormSupplyInformationDeliveryProtocolKey].ID = [ProFormSupplyInformationDeliveryProtocol].SupplyInformationDeliveryProtocolKeyID " +
                    "AND [ProFormSupplyInformationDeliveryProtocolKey].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrder] AS [ProFormSupplyOrder] " +
                    "ON [ProFormSupplyOrder].SupplyProFormID = [SupplyProForm].ID " +
                    "LEFT JOIN [Client] AS [ProFormSupplyOrderClient] " +
                    "ON [ProFormSupplyOrder].ClientID = [ProFormSupplyOrderClient].ID " +
                    "LEFT JOIN [Region] AS [ProFormSupplyOrderClientRegion] " +
                    "ON [ProFormSupplyOrderClientRegion].ID = [ProFormSupplyOrderClient].RegionID " +
                    "LEFT JOIN [RegionCode] AS [ProFormSupplyOrderClientRegionCode] " +
                    "ON [ProFormSupplyOrderClientRegionCode].ID = [ProFormSupplyOrderClient].RegionCodeID " +
                    "LEFT JOIN [Country] AS [ProFormSupplyOrderClientCountry] " +
                    "ON [ProFormSupplyOrderClientCountry].ID = [ProFormSupplyOrderClient].CountryID " +
                    "LEFT JOIN [ClientBankDetails] AS [ProFormSupplyOrderClientBankDetails] " +
                    "ON [ProFormSupplyOrderClientBankDetails].ID = [ProFormSupplyOrderClient].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] AS [ProFormSupplyOrderClientBankDetailsAccountNumber] " +
                    "ON [ProFormSupplyOrderClientBankDetailsAccountNumber].ID = [ProFormSupplyOrderClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientBankDetailsAccountNumberCurrency] " +
                    "ON [ProFormSupplyOrderClientBankDetailsAccountNumberCurrency].ID = [ProFormSupplyOrderClientBankDetailsAccountNumber].CurrencyID " +
                    "AND [ProFormSupplyOrderClientBankDetailsAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] AS [ProFormSupplyOrderClientBankDetailsIbanNo] " +
                    "ON [ProFormSupplyOrderClientBankDetailsIbanNo].ID = [ProFormSupplyOrderClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientBankDetailsIbanNoCurrency] " +
                    "ON [ProFormSupplyOrderClientBankDetailsIbanNoCurrency].ID = [ProFormSupplyOrderClientBankDetailsIbanNo].CurrencyID " +
                    "AND [ProFormSupplyOrderClientBankDetailsIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] AS [ProFormSupplyOrderClientTermsOfDelivery] " +
                    "ON [ProFormSupplyOrderClientTermsOfDelivery].ID = [ProFormSupplyOrderClient].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] AS [ProFormSupplyOrderClientPackingMarking] " +
                    "ON [ProFormSupplyOrderClientPackingMarking].ID = [ProFormSupplyOrderClient].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] AS [ProFormSupplyOrderClientPackingMarkingPayment] " +
                    "ON [ProFormSupplyOrderClientPackingMarkingPayment].ID = [ProFormSupplyOrderClient].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] AS [ProFormSupplyOrderClientClientAgreement] " +
                    "ON [ProFormSupplyOrderClientClientAgreement].ID = [ProFormSupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] AS [ProFormSupplyOrderClientAgreement] " +
                    "ON [ProFormSupplyOrderClientAgreement].ID = [ProFormSupplyOrderClientClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] AS [ProFormSupplyOrderClientAgreementProviderPricing] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricing].ID = [ProFormSupplyOrderClientAgreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProFormSupplyOrderClientAgreementProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] AS [ProFormSupplyOrderClientAgreementPricing] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricing].BasePricingID = [ProFormSupplyOrderClientAgreementPricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [ProFormSupplyOrderClientAgreementPricingPriceType] " +
                    "ON [ProFormSupplyOrderClientAgreementPricing].PriceTypeID = [ProFormSupplyOrderClientAgreementPricingPriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [ProFormSupplyOrderClientAgreementOrganization] " +
                    "ON [ProFormSupplyOrderClientAgreementOrganization].ID = [ProFormSupplyOrderClientAgreement].OrganizationID " +
                    "AND [ProFormSupplyOrderClientAgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementCurrency].ID = [ProFormSupplyOrderClientAgreement].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [ProFormSupplyOrderOrganization] " +
                    "ON [ProFormSupplyOrderOrganization].ID = [ProFormSupplyOrder].OrganizationID " +
                    "AND [ProFormSupplyOrderOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] AS [InvoiceSupplyOrderNumber] " +
                    "ON [InvoiceSupplyOrderNumber].ID = [InvoiceSupplyOrder].SupplyOrderNumberID " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [ProFormSupplyOrder].SupplyOrderNumberID = [SupplyOrderNumber].ID " +
                    "WHERE [SupplyOrderPaymentDeliveryProtocol].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.SupplyOrderPaymentDeliveryProtocol)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.SupplyOrderPolandPaymentDeliveryProtocol))) {
                Type[] includesTypes = new[] {
                    typeof(SupplyOrderPolandPaymentDeliveryProtocol),
                    typeof(SupplyOrderPaymentDeliveryProtocolKey),
                    typeof(SupplyPaymentTask),
                    typeof(User),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(InvoiceDocument),
                    typeof(SupplyOrderNumber)
                };

                Currency pln = GetPLN();

                Func<object[], SupplyOrderPolandPaymentDeliveryProtocol> includesMapper = objects => {
                    SupplyOrderPolandPaymentDeliveryProtocol supplyOrderPolandPaymentDeliveryProtocol = (SupplyOrderPolandPaymentDeliveryProtocol)objects[0];
                    SupplyOrderPaymentDeliveryProtocolKey supplyOrderPaymentDeliveryProtocolKey = (SupplyOrderPaymentDeliveryProtocolKey)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    User user = (User)objects[3];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[4];
                    Client client = (Client)objects[5];
                    Region region = (Region)objects[6];
                    RegionCode regionCode = (RegionCode)objects[7];
                    Country country = (Country)objects[8];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[9];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[10];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[11];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[12];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[13];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[14];
                    PackingMarking packingMarking = (PackingMarking)objects[15];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[16];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[17];
                    Agreement agreement = (Agreement)objects[18];
                    ProviderPricing providerPricing = (ProviderPricing)objects[19];
                    Currency providerPricingCurrency = (Currency)objects[20];
                    Pricing pricing = (Pricing)objects[21];
                    PriceType priceType = (PriceType)objects[22];
                    Organization agreementOrganization = (Organization)objects[23];
                    Currency agreementCurrency = (Currency)objects[24];
                    Organization organization = (Organization)objects[25];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[26];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[27];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.SupplyOrderPolandPaymentDeliveryProtocols.Any()) {
                        SupplyOrderPolandPaymentDeliveryProtocol protocolFromList = taskFromList.SupplyOrderPolandPaymentDeliveryProtocols.First();

                        if (invoiceDocument != null && !protocolFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            protocolFromList.InvoiceDocuments.Add(invoiceDocument);
                    } else {
                        if (invoiceDocument != null) supplyOrderPolandPaymentDeliveryProtocol.InvoiceDocuments.Add(invoiceDocument);

                        if (client != null) {
                            if (clientBankDetails != null) {
                                if (clientBankDetailAccountNumber != null) {
                                    clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                    clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                }

                                if (clientBankDetailIbanNo != null) {
                                    clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                    clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                }
                            }

                            if (clientAgreement != null) {
                                if (providerPricing != null) {
                                    if (pricing != null) pricing.PriceType = priceType;

                                    providerPricing.Currency = providerPricingCurrency;
                                    providerPricing.Pricing = pricing;
                                }

                                agreement.Organization = agreementOrganization;
                                agreement.Currency = agreementCurrency;
                                agreement.ProviderPricing = providerPricing;

                                clientAgreement.Agreement = agreement;

                                client.ClientAgreements.Add(clientAgreement);
                            }

                            client.Region = region;
                            client.RegionCode = regionCode;
                            client.Country = country;
                            client.ClientBankDetails = clientBankDetails;
                            client.TermsOfDelivery = termsOfDelivery;
                            client.PackingMarking = packingMarking;
                            client.PackingMarkingPayment = packingMarkingPayment;
                        }

                        supplyOrder.Client = client;
                        supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                        supplyOrder.Organization = organization;

                        supplyOrderPolandPaymentDeliveryProtocol.SupplyOrderPaymentDeliveryProtocolKey = supplyOrderPaymentDeliveryProtocolKey;
                        supplyOrderPolandPaymentDeliveryProtocol.User = user;
                        supplyOrderPolandPaymentDeliveryProtocol.SupplyOrder = supplyOrder;

                        taskFromList.SupplyOrderPolandPaymentDeliveryProtocols.Add(supplyOrderPolandPaymentDeliveryProtocol);

                        decimal exchangeRateAmount = GetGovExchangeRateToEuroCurrency(pln);

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(pln.Id))) {
                                PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(pln.Id));

                                totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                            } else {
                                groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                    Currency = pln,
                                    TotalPrice = taskFromList.GrossPrice
                                });
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return supplyOrderPolandPaymentDeliveryProtocol;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [SupplyOrderPolandPaymentDeliveryProtocol] " +
                    "LEFT JOIN [SupplyOrderPaymentDeliveryProtocolKey] " +
                    "ON [SupplyOrderPaymentDeliveryProtocolKey].ID = [SupplyOrderPolandPaymentDeliveryProtocol].SupplyOrderPaymentDeliveryProtocolKeyID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [SupplyOrderPolandPaymentDeliveryProtocol].SupplyPaymentTaskID " +
                    "LEFT JOIN [User] AS [SupplyOrderPolandPaymentDeliveryProtocolUser] " +
                    "ON [SupplyOrderPolandPaymentDeliveryProtocolUser].ID = [SupplyOrderPolandPaymentDeliveryProtocol].UserID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [SupplyOrderPolandPaymentDeliveryProtocol].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [SupplyOrder].ClientID = [Client].ID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].SupplyOrderPolandPaymentDeliveryProtocolID = [SupplyOrderPolandPaymentDeliveryProtocol].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [SupplyOrderPolandPaymentDeliveryProtocol].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.SupplyOrderPolandPaymentDeliveryProtocol)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.ContainerService))) {
                Type[] includesTypes = new[] {
                    typeof(ContainerService),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(BillOfLadingDocument),
                    typeof(User),
                    typeof(InvoiceDocument),
                    typeof(SupplyOrderContainerService),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], ContainerService> includesMapper = objects => {
                    ContainerService containerService = (ContainerService)objects[0];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[1];
                    SupplyOrganization containerOrganization = (SupplyOrganization)objects[2];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[3];
                    Currency currency = (Currency)objects[4];
                    BillOfLadingDocument billOfLadingDocument = (BillOfLadingDocument)objects[5];
                    User user = (User)objects[6];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[7];
                    SupplyOrderContainerService supplyOrderContainerService = (SupplyOrderContainerService)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.ContainerServices.Any()) {
                        if (taskFromList.ContainerServices.Any(s => s.Id.Equals(containerService.Id))) {
                            ContainerService serviceFromList = taskFromList.ContainerServices.First(s => s.Id.Equals(containerService.Id));

                            if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                            if (supplyOrderContainerService != null && !serviceFromList.SupplyOrderContainerServices.Any(s => s.Id.Equals(supplyOrderContainerService.Id))) {
                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyOrderContainerService.SupplyOrder = supplyOrder;

                                serviceFromList.SupplyOrderContainerServices.Add(supplyOrderContainerService);
                            }
                        } else {
                            if (invoiceDocument != null) containerService.InvoiceDocuments.Add(invoiceDocument);

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            if (supplyOrderContainerService != null) {
                                if (client != null) {
                                    if (clientBankDetails != null) {
                                        if (clientBankDetailAccountNumber != null) {
                                            clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                            clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                        }

                                        if (clientBankDetailIbanNo != null) {
                                            clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                            clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                        }
                                    }

                                    if (clientAgreement != null) {
                                        if (providerPricing != null) {
                                            if (pricing != null) pricing.PriceType = priceType;

                                            providerPricing.Currency = providerPricingCurrency;
                                            providerPricing.Pricing = pricing;
                                        }

                                        agreement.Organization = agreementOrganization;
                                        agreement.Currency = agreementCurrency;
                                        agreement.ProviderPricing = providerPricing;

                                        clientAgreement.Agreement = agreement;

                                        client.ClientAgreements.Add(clientAgreement);
                                    }

                                    client.Region = region;
                                    client.RegionCode = regionCode;
                                    client.Country = country;
                                    client.ClientBankDetails = clientBankDetails;
                                    client.TermsOfDelivery = termsOfDelivery;
                                    client.PackingMarking = packingMarking;
                                    client.PackingMarkingPayment = packingMarkingPayment;
                                }

                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyOrderContainerService.SupplyOrder = supplyOrder;

                                containerService.SupplyOrderContainerServices.Add(supplyOrderContainerService);
                            }

                            containerService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            containerService.ContainerOrganization = containerOrganization;
                            containerService.BillOfLadingDocument = billOfLadingDocument;
                            containerService.User = user;

                            taskFromList.ContainerServices.Add(containerService);

                            decimal exchangeRateAmount = 1;

                            if (currency != null) {
                                if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                                if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                    if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                        PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                    } else {
                                        groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                            Currency = currency,
                                            TotalPrice = taskFromList.GrossPrice
                                        });
                                    }
                                }
                            }

                            if (exchangeRateAmount < decimal.Zero) {
                                exchangeRateAmount = 0 - exchangeRateAmount;

                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                            } else {
                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                            }

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                                groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                            }
                        }
                    } else {
                        if (invoiceDocument != null) containerService.InvoiceDocuments.Add(invoiceDocument);

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrderContainerService != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            supplyOrderContainerService.SupplyOrder = supplyOrder;

                            containerService.SupplyOrderContainerServices.Add(supplyOrderContainerService);
                        }

                        containerService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        containerService.ContainerOrganization = containerOrganization;
                        containerService.BillOfLadingDocument = billOfLadingDocument;
                        containerService.User = user;

                        taskFromList.ContainerServices.Add(containerService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return containerService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [ContainerService] " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [ContainerService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [ContainerOrganization] " +
                    "ON [ContainerOrganization].ID = [ContainerService].ContainerOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [ContainerService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [BillOfLadingDocument] " +
                    "ON [BillOfLadingDocument].ID = [ContainerService].BillOfLadingDocumentID " +
                    "LEFT JOIN [User] AS [ContainerServiceUser] " +
                    "ON [ContainerServiceUser].ID = [ContainerService].UserID " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].ContainerServiceID = [ContainerService].ID " +
                    "LEFT JOIN [SupplyOrderContainerService] " +
                    "ON [SupplyOrderContainerService].ContainerServiceID = [ContainerService].ID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [SupplyOrderContainerService].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [SupplyOrder].ClientID = [Client].ID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [ContainerService].ID IN @Ids " +
                    "AND [SupplyOrderContainerService].Deleted = 0 ",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.ContainerService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.VehicleService))) {
                Type[] includesTypes = new[] {
                    typeof(VehicleService),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(BillOfLadingDocument),
                    typeof(User),
                    typeof(InvoiceDocument),
                    typeof(SupplyOrderVehicleService),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], VehicleService> includesMapper = objects => {
                    VehicleService vehicleService = (VehicleService)objects[0];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[1];
                    SupplyOrganization vehicleOrganization = (SupplyOrganization)objects[2];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[3];
                    Currency currency = (Currency)objects[4];
                    BillOfLadingDocument billOfLadingDocument = (BillOfLadingDocument)objects[5];
                    User user = (User)objects[6];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[7];
                    SupplyOrderVehicleService supplyOrderVehicleService = (SupplyOrderVehicleService)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.VehicleServices.Any()) {
                        if (taskFromList.VehicleServices.Any(s => s.Id.Equals(vehicleService.Id))) {
                            VehicleService serviceFromList = taskFromList.VehicleServices.First(s => s.Id.Equals(vehicleService.Id));

                            if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                            if (supplyOrderVehicleService != null && !serviceFromList.SupplyOrderVehicleServices.Any(s => s.Id.Equals(supplyOrderVehicleService.Id))) {
                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyOrderVehicleService.SupplyOrder = supplyOrder;

                                serviceFromList.SupplyOrderVehicleServices.Add(supplyOrderVehicleService);
                            }
                        } else {
                            if (invoiceDocument != null) vehicleService.InvoiceDocuments.Add(invoiceDocument);

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            if (supplyOrderVehicleService != null) {
                                if (client != null) {
                                    if (clientBankDetails != null) {
                                        if (clientBankDetailAccountNumber != null) {
                                            clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                            clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                        }

                                        if (clientBankDetailIbanNo != null) {
                                            clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                            clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                        }
                                    }

                                    if (clientAgreement != null) {
                                        if (providerPricing != null) {
                                            if (pricing != null) pricing.PriceType = priceType;

                                            providerPricing.Currency = providerPricingCurrency;
                                            providerPricing.Pricing = pricing;
                                        }

                                        agreement.Organization = agreementOrganization;
                                        agreement.Currency = agreementCurrency;
                                        agreement.ProviderPricing = providerPricing;

                                        clientAgreement.Agreement = agreement;

                                        client.ClientAgreements.Add(clientAgreement);
                                    }

                                    client.Region = region;
                                    client.RegionCode = regionCode;
                                    client.Country = country;
                                    client.ClientBankDetails = clientBankDetails;
                                    client.TermsOfDelivery = termsOfDelivery;
                                    client.PackingMarking = packingMarking;
                                    client.PackingMarkingPayment = packingMarkingPayment;
                                }

                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyOrderVehicleService.SupplyOrder = supplyOrder;

                                vehicleService.SupplyOrderVehicleServices.Add(supplyOrderVehicleService);
                            }

                            vehicleService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            vehicleService.VehicleOrganization = vehicleOrganization;
                            vehicleService.BillOfLadingDocument = billOfLadingDocument;
                            vehicleService.User = user;

                            taskFromList.VehicleServices.Add(vehicleService);

                            decimal exchangeRateAmount = 1;

                            if (currency != null) {
                                if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                                if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                    if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                        PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                    } else {
                                        groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                            Currency = currency,
                                            TotalPrice = taskFromList.GrossPrice
                                        });
                                    }
                                }
                            }

                            if (exchangeRateAmount < decimal.Zero) {
                                exchangeRateAmount = 0 - exchangeRateAmount;

                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                            } else {
                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                            }

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                                groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                            }
                        }
                    } else {
                        if (invoiceDocument != null) vehicleService.InvoiceDocuments.Add(invoiceDocument);

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrderVehicleService != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            supplyOrderVehicleService.SupplyOrder = supplyOrder;

                            vehicleService.SupplyOrderVehicleServices.Add(supplyOrderVehicleService);
                        }

                        vehicleService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        vehicleService.VehicleOrganization = vehicleOrganization;
                        vehicleService.BillOfLadingDocument = billOfLadingDocument;
                        vehicleService.User = user;

                        taskFromList.VehicleServices.Add(vehicleService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return vehicleService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [VehicleService] " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [VehicleService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [VehicleOrganization] " +
                    "ON [VehicleOrganization].ID = [VehicleService].VehicleOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [VehicleService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [BillOfLadingDocument] " +
                    "ON [BillOfLadingDocument].ID = [VehicleService].BillOfLadingDocumentID " +
                    "LEFT JOIN [User] AS [VehicleServiceUser] " +
                    "ON [VehicleServiceUser].ID = [VehicleService].UserID " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].VehicleServiceID = [VehicleService].ID " +
                    "LEFT JOIN [SupplyOrderVehicleService] " +
                    "ON [SupplyOrderVehicleService].VehicleServiceID = [VehicleService].ID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [SupplyOrderVehicleService].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [SupplyOrder].ClientID = [Client].ID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [VehicleService].ID IN @Ids " +
                    "AND [SupplyOrderVehicleService].Deleted = 0 ",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.VehicleService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.CustomService))) {
                Type[] includesTypes = new[] {
                    typeof(CustomService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency)
                };

                Func<object[], CustomService> includesMapper = objects => {
                    CustomService customService = (CustomService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization exciseDutyOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganization customOrganization = (SupplyOrganization)objects[4];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[5];
                    Client client = (Client)objects[6];
                    Region region = (Region)objects[7];
                    RegionCode regionCode = (RegionCode)objects[8];
                    Country country = (Country)objects[9];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[10];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[11];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[12];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[13];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[14];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[15];
                    PackingMarking packingMarking = (PackingMarking)objects[16];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[17];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[18];
                    Agreement agreement = (Agreement)objects[19];
                    ProviderPricing providerPricing = (ProviderPricing)objects[20];
                    Currency providerPricingCurrency = (Currency)objects[21];
                    Pricing pricing = (Pricing)objects[22];
                    PriceType priceType = (PriceType)objects[23];
                    Organization agreementOrganization = (Organization)objects[24];
                    Currency agreementCurrency = (Currency)objects[25];
                    Organization organization = (Organization)objects[26];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[27];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[28];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[29];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[30];
                    SupplyOrganizationAgreement exciseDutyOrganizationAgreement = (SupplyOrganizationAgreement)objects[31];
                    Organization supplyOrganizationOrganization = (Organization)objects[32];
                    Organization customSupplyOrganizationOrganization = (Organization)objects[33];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[34];
                    Currency currency = (Currency)objects[35];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.BrokerServices.Any()) {
                        CustomService serviceFromList = taskFromList.BrokerServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }
                    } else {
                        if (exciseDutyOrganization != null && exciseDutyOrganizationAgreement != null) {
                            if (!exciseDutyOrganization.SupplyOrganizationAgreements.Any(x => x.Id == exciseDutyOrganizationAgreement.Id))
                                exciseDutyOrganization.SupplyOrganizationAgreements.Add(exciseDutyOrganizationAgreement);
                            else
                                exciseDutyOrganizationAgreement = exciseDutyOrganization.SupplyOrganizationAgreements.First(x => x.Id == exciseDutyOrganizationAgreement.Id);

                            exciseDutyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (invoiceDocument != null) customService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            customService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = customSupplyOrganizationOrganization;
                        }

                        if (client != null) {
                            if (clientBankDetails != null) {
                                if (clientBankDetailAccountNumber != null) {
                                    clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                    clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                }

                                if (clientBankDetailIbanNo != null) {
                                    clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                    clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                }
                            }

                            if (clientAgreement != null) {
                                if (providerPricing != null) {
                                    if (pricing != null) pricing.PriceType = priceType;

                                    providerPricing.Currency = providerPricingCurrency;
                                    providerPricing.Pricing = pricing;
                                }

                                agreement.Organization = agreementOrganization;
                                agreement.Currency = agreementCurrency;
                                agreement.ProviderPricing = providerPricing;

                                clientAgreement.Agreement = agreement;

                                client.ClientAgreements.Add(clientAgreement);
                            }

                            client.Region = region;
                            client.RegionCode = regionCode;
                            client.Country = country;
                            client.ClientBankDetails = clientBankDetails;
                            client.TermsOfDelivery = termsOfDelivery;
                            client.PackingMarking = packingMarking;
                            client.PackingMarkingPayment = packingMarkingPayment;
                        }

                        supplyOrder.Client = client;
                        supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                        supplyOrder.Organization = organization;

                        customService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        customService.SupplyOrder = supplyOrder;
                        customService.User = user;
                        customService.ExciseDutyOrganization = exciseDutyOrganization;
                        customService.CustomOrganization = customOrganization;

                        taskFromList.BrokerServices.Add(customService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return customService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [CustomService] " +
                    "LEFT JOIN [User] AS [CustomServiceUser] " +
                    "ON [CustomServiceUser].ID = [CustomService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [CustomService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [ExciseDutyOrganization] " +
                    "ON [ExciseDutyOrganization].ID = [CustomService].ExciseDutyOrganizationID " +
                    "LEFT JOIN [SupplyOrganization] AS [CustomOrganization] " +
                    "ON [CustomOrganization].ID = [CustomService].CustomOrganizationID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [CustomService].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].CustomServiceID = [CustomService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].CustomServiceID = [CustomService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [CustomService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] AS [ExciseDutyOrganizationAgreement] " +
                    "ON [ExciseDutyOrganizationAgreement].SupplyOrganizationID = [ExciseDutyOrganization].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [ExciseDutyOrganization].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [CustomSupplyOrganizationOrganization] " +
                    "ON [CustomSupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [CustomSupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "WHERE [CustomService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.CustomService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.PortWorkService))) {
                Type[] includesTypes = new[] {
                    typeof(PortWorkService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], PortWorkService> includesMapper = objects => {
                    PortWorkService portWorkService = (PortWorkService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization portWorkOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.PortWorkServices.Any()) {
                        if (taskFromList.PortWorkServices.Any(s => s.Id.Equals(portWorkService.Id))) {
                            PortWorkService serviceFromList = taskFromList.PortWorkServices.First();

                            if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                            if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                                serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                                serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                            }

                            if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                                supplyOrder.Client = client;
                                supplyOrder.Organization = organization;

                                serviceFromList.SupplyOrders.Add(supplyOrder);
                            }
                        } else {
                            if (invoiceDocument != null) portWorkService.InvoiceDocuments.Add(invoiceDocument);

                            if (serviceDetailItem != null) {
                                serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                                portWorkService.ServiceDetailItems.Add(serviceDetailItem);
                            }

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            if (supplyOrder != null) {
                                if (client != null) {
                                    if (clientBankDetails != null) {
                                        if (clientBankDetailAccountNumber != null) {
                                            clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                            clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                        }

                                        if (clientBankDetailIbanNo != null) {
                                            clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                            clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                        }
                                    }

                                    if (clientAgreement != null) {
                                        if (providerPricing != null) {
                                            if (pricing != null) pricing.PriceType = priceType;

                                            providerPricing.Currency = providerPricingCurrency;
                                            providerPricing.Pricing = pricing;
                                        }

                                        agreement.Organization = agreementOrganization;
                                        agreement.Currency = agreementCurrency;
                                        agreement.ProviderPricing = providerPricing;

                                        clientAgreement.Agreement = agreement;

                                        client.ClientAgreements.Add(clientAgreement);
                                    }

                                    client.Region = region;
                                    client.RegionCode = regionCode;
                                    client.Country = country;
                                    client.ClientBankDetails = clientBankDetails;
                                    client.TermsOfDelivery = termsOfDelivery;
                                    client.PackingMarking = packingMarking;
                                    client.PackingMarkingPayment = packingMarkingPayment;
                                }

                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                portWorkService.SupplyOrders.Add(supplyOrder);
                            }

                            portWorkService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            portWorkService.User = user;
                            portWorkService.PortWorkOrganization = portWorkOrganization;

                            taskFromList.PortWorkServices.Add(portWorkService);

                            decimal exchangeRateAmount = 1;

                            if (currency != null) {
                                if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                                if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                    if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                        PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                    } else {
                                        groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                            Currency = currency,
                                            TotalPrice = taskFromList.GrossPrice
                                        });
                                    }
                                }
                            }

                            if (exchangeRateAmount < decimal.Zero) {
                                exchangeRateAmount = 0 - exchangeRateAmount;

                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                            } else {
                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                            }

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                                groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                            }
                        }
                    } else {
                        if (invoiceDocument != null) portWorkService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            portWorkService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            portWorkService.SupplyOrders.Add(supplyOrder);
                        }

                        portWorkService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        portWorkService.User = user;
                        portWorkService.PortWorkOrganization = portWorkOrganization;

                        taskFromList.PortWorkServices.Add(portWorkService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return portWorkService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [PortWorkService] " +
                    "LEFT JOIN [User] AS [PortWorkServiceUser] " +
                    "ON [PortWorkServiceUser].ID = [PortWorkService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [PortWorkService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [PortWorkOrganization] " +
                    "ON [PortWorkOrganization].ID = [PortWorkService].PortWorkOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [PortWorkService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].PortWorkServiceID = [PortWorkService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].PortWorkServiceID = [PortWorkService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].PortWorkServiceID = [PortWorkService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [PortWorkService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.PortWorkService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.TransportationService))) {
                Type[] includesTypes = new[] {
                    typeof(TransportationService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], TransportationService> includesMapper = objects => {
                    TransportationService transportationService = (TransportationService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization transportationOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.TransportationServices.Any()) {
                        TransportationService serviceFromList = taskFromList.TransportationServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) transportationService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            transportationService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;
                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            transportationService.SupplyOrders.Add(supplyOrder);
                        }

                        transportationService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        transportationService.User = user;
                        transportationService.TransportationOrganization = transportationOrganization;

                        taskFromList.TransportationServices.Add(transportationService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return transportationService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [TransportationService] " +
                    "LEFT JOIN [User] AS [TransportationServiceUser] " +
                    "ON [TransportationServiceUser].ID = [TransportationService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [TransportationService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [TransportationOrganization] " +
                    "ON [TransportationOrganization].ID = [TransportationService].TransportationOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [TransportationService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].TransportationServiceID = [TransportationService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].TransportationServiceID = [TransportationService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].TransportationServiceID = [TransportationService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [TransportationService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.TransportationService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.PortCustomAgencyService))) {
                Type[] includesTypes = new[] {
                    typeof(PortCustomAgencyService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], PortCustomAgencyService> includesMapper = objects => {
                    PortCustomAgencyService portCustomAgencyService = (PortCustomAgencyService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization portCustomAgencyOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.PortCustomAgencyServices.Any()) {
                        PortCustomAgencyService serviceFromList = taskFromList.PortCustomAgencyServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) portCustomAgencyService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            portCustomAgencyService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;
                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            portCustomAgencyService.SupplyOrders.Add(supplyOrder);
                        }

                        portCustomAgencyService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        portCustomAgencyService.User = user;
                        portCustomAgencyService.PortCustomAgencyOrganization = portCustomAgencyOrganization;

                        taskFromList.PortCustomAgencyServices.Add(portCustomAgencyService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return portCustomAgencyService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [PortCustomAgencyService] " +
                    "LEFT JOIN [User] AS [PortCustomAgencyServiceUser] " +
                    "ON [PortCustomAgencyServiceUser].ID = [PortCustomAgencyService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [PortCustomAgencyService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [PortCustomAgencyOrganization] " +
                    "ON [PortCustomAgencyOrganization].ID = [PortCustomAgencyService].PortCustomAgencyOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [PortCustomAgencyService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].PortCustomAgencyServiceID = [PortCustomAgencyService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].PortCustomAgencyServiceID = [PortCustomAgencyService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].PortCustomAgencyServiceID = [PortCustomAgencyService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [PortCustomAgencyService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.PortCustomAgencyService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.CustomAgencyService))) {
                Type[] includesTypes = new[] {
                    typeof(CustomAgencyService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], CustomAgencyService> includesMapper = objects => {
                    CustomAgencyService customAgencyService = (CustomAgencyService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization customAgencyOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.CustomAgencyServices.Any()) {
                        CustomAgencyService serviceFromList = taskFromList.CustomAgencyServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) customAgencyService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            customAgencyService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            customAgencyService.SupplyOrders.Add(supplyOrder);
                        }

                        customAgencyService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        customAgencyService.User = user;
                        customAgencyService.CustomAgencyOrganization = customAgencyOrganization;

                        taskFromList.CustomAgencyServices.Add(customAgencyService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return customAgencyService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [CustomAgencyService] " +
                    "LEFT JOIN [User] AS [CustomAgencyServiceUser] " +
                    "ON [CustomAgencyServiceUser].ID = [CustomAgencyService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [CustomAgencyService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [CustomAgencyOrganization] " +
                    "ON [CustomAgencyOrganization].ID = [CustomAgencyService].CustomAgencyOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [CustomAgencyService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].CustomAgencyServiceID = [CustomAgencyService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].CustomAgencyServiceID = [CustomAgencyService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].CustomAgencyServiceID = [CustomAgencyService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [CustomAgencyService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.CustomAgencyService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.PlaneDeliveryService))) {
                Type[] includesTypes = new[] {
                    typeof(PlaneDeliveryService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], PlaneDeliveryService> includesMapper = objects => {
                    PlaneDeliveryService planeDeliveryService = (PlaneDeliveryService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization planeDeliveryOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.PlaneDeliveryServices.Any()) {
                        PlaneDeliveryService serviceFromList = taskFromList.PlaneDeliveryServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) planeDeliveryService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            planeDeliveryService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            planeDeliveryService.SupplyOrders.Add(supplyOrder);
                        }

                        planeDeliveryService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        planeDeliveryService.User = user;
                        planeDeliveryService.PlaneDeliveryOrganization = planeDeliveryOrganization;

                        taskFromList.PlaneDeliveryServices.Add(planeDeliveryService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return planeDeliveryService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [PlaneDeliveryService] " +
                    "LEFT JOIN [User] AS [PlaneDeliveryServiceUser] " +
                    "ON [PlaneDeliveryServiceUser].ID = [PlaneDeliveryService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [PlaneDeliveryService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [PlaneDeliveryOrganization] " +
                    "ON [PlaneDeliveryOrganization].ID = [PlaneDeliveryService].PlaneDeliveryOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [PlaneDeliveryService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].PlaneDeliveryServiceID = [PlaneDeliveryService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].PlaneDeliveryServiceID = [PlaneDeliveryService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].PlaneDeliveryServiceID = [PlaneDeliveryService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [PlaneDeliveryService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.PlaneDeliveryService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.VehicleDeliveryService))) {
                Type[] includesTypes = new[] {
                    typeof(VehicleDeliveryService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], VehicleDeliveryService> includesMapper = objects => {
                    VehicleDeliveryService vehicleDeliveryService = (VehicleDeliveryService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization vehicleDeliveryOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.VehicleDeliveryServices.Any()) {
                        VehicleDeliveryService serviceFromList = taskFromList.VehicleDeliveryServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) vehicleDeliveryService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            vehicleDeliveryService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            vehicleDeliveryService.SupplyOrders.Add(supplyOrder);
                        }

                        vehicleDeliveryService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        vehicleDeliveryService.User = user;
                        vehicleDeliveryService.VehicleDeliveryOrganization = vehicleDeliveryOrganization;

                        taskFromList.VehicleDeliveryServices.Add(vehicleDeliveryService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return vehicleDeliveryService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [VehicleDeliveryService] " +
                    "LEFT JOIN [User] AS [VehicleDeliveryServiceUser] " +
                    "ON [VehicleDeliveryServiceUser].ID = [VehicleDeliveryService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [VehicleDeliveryService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [VehicleDeliveryOrganization] " +
                    "ON [VehicleDeliveryOrganization].ID = [VehicleDeliveryService].VehicleDeliveryOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [VehicleDeliveryService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].VehicleDeliveryServiceID = [VehicleDeliveryService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].VehicleDeliveryServiceID = [VehicleDeliveryService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].VehicleDeliveryServiceID = [VehicleDeliveryService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [VehicleDeliveryService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.VehicleDeliveryService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.ConsumablesOrder))) {
                Type[] includesTypes = new[] {
                    typeof(ConsumablesOrder),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(ConsumablesOrderItem),
                    typeof(ConsumableProductCategory),
                    typeof(ConsumableProduct),
                    typeof(SupplyOrganization),
                    typeof(ConsumablesStorage),
                    typeof(PaymentCostMovementOperation),
                    typeof(PaymentCostMovement),
                    typeof(MeasureUnit),
                    typeof(ConsumablesOrderDocument),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Organization),
                    typeof(Currency)
                };

                Func<object[], ConsumablesOrder> includesMapper = objects => {
                    ConsumablesOrder consumablesOrder = (ConsumablesOrder)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    ConsumablesOrderItem consumablesOrderItem = (ConsumablesOrderItem)objects[3];
                    ConsumableProductCategory consumableProductCategory = (ConsumableProductCategory)objects[4];
                    ConsumableProduct consumableProduct = (ConsumableProduct)objects[5];
                    SupplyOrganization consumableProductOrganization = (SupplyOrganization)objects[6];
                    ConsumablesStorage consumablesStorage = (ConsumablesStorage)objects[7];
                    PaymentCostMovementOperation paymentCostMovementOperation = (PaymentCostMovementOperation)objects[8];
                    PaymentCostMovement paymentCostMovement = (PaymentCostMovement)objects[9];
                    MeasureUnit measureUnit = (MeasureUnit)objects[10];
                    ConsumablesOrderDocument consumablesOrderDocument = (ConsumablesOrderDocument)objects[11];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[12];
                    Organization supplyOrganizationOrganization = (Organization)objects[13];
                    Currency currency = (Currency)objects[14];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.ConsumablesOrder != null) {
                        if (consumablesOrderItem != null && !taskFromList.ConsumablesOrder.ConsumablesOrderItems.Any(i => i.Id.Equals(consumablesOrderItem.Id))) {
                            if (paymentCostMovementOperation != null) paymentCostMovementOperation.PaymentCostMovement = paymentCostMovement;

                            if (consumableProduct != null) consumableProduct.MeasureUnit = measureUnit;

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            consumablesOrderItem.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            consumablesOrderItem.ConsumableProductCategory = consumableProductCategory;
                            consumablesOrderItem.ConsumableProduct = consumableProduct;
                            consumablesOrderItem.ConsumableProductOrganization = consumableProductOrganization;
                            consumablesOrderItem.PaymentCostMovementOperation = paymentCostMovementOperation;

                            taskFromList.ConsumablesOrder.ConsumablesOrderItems.Add(consumablesOrderItem);

                            consumablesOrderItem.TotalPriceWithVAT = Math.Round(consumablesOrderItem.TotalPrice + consumablesOrderItem.VAT, 2);

                            taskFromList.ConsumablesOrder.TotalAmount =
                                Math.Round(taskFromList.ConsumablesOrder.TotalAmount + consumablesOrderItem.TotalPrice + consumablesOrderItem.VAT, 2);

                            taskFromList.ConsumablesOrder.TotalAmountWithoutVAT =
                                Math.Round(taskFromList.ConsumablesOrder.TotalAmountWithoutVAT + consumablesOrderItem.TotalPrice, 2);

                            decimal exchangeRateAmount = 1;

                            if (currency != null && !currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (exchangeRateAmount < decimal.Zero) {
                                    exchangeRateAmount = 0 - exchangeRateAmount;

                                    taskFromList.EuroNetPrice = Math.Round(taskFromList.EuroNetPrice + consumablesOrderItem.TotalPrice / exchangeRateAmount, 2);
                                    taskFromList.EuroGrossPrice =
                                        Math.Round(taskFromList.EuroGrossPrice + consumablesOrderItem.TotalPrice + consumablesOrderItem.VAT / exchangeRateAmount, 2);

                                    groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + consumablesOrderItem.TotalPrice, 2);
                                    groupedTaskFromList.TotalGrossAmount =
                                        Math.Round(groupedTaskFromList.TotalGrossAmount + consumablesOrderItem.TotalPrice + consumablesOrderItem.VAT, 2);
                                } else {
                                    taskFromList.EuroNetPrice = Math.Round(taskFromList.EuroNetPrice + consumablesOrderItem.TotalPrice / exchangeRateAmount, 2);
                                    taskFromList.EuroGrossPrice =
                                        Math.Round(taskFromList.EuroGrossPrice + consumablesOrderItem.TotalPrice + consumablesOrderItem.VAT / exchangeRateAmount, 2);

                                    groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + consumablesOrderItem.TotalPrice, 2);
                                    groupedTaskFromList.TotalGrossAmount =
                                        Math.Round(groupedTaskFromList.TotalGrossAmount + consumablesOrderItem.TotalPrice + consumablesOrderItem.VAT, 2);
                                }
                            }
                        }

                        if (consumablesOrderDocument != null && !taskFromList.ConsumablesOrder.ConsumablesOrderDocuments.Any(d => d.Id.Equals(consumablesOrderDocument.Id)))
                            taskFromList.ConsumablesOrder.ConsumablesOrderDocuments.Add(consumablesOrderDocument);
                    } else {
                        if (consumablesOrderItem != null) {
                            if (paymentCostMovementOperation != null) paymentCostMovementOperation.PaymentCostMovement = paymentCostMovement;

                            if (consumableProduct != null) consumableProduct.MeasureUnit = measureUnit;

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            consumablesOrderItem.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            consumablesOrderItem.ConsumableProductCategory = consumableProductCategory;
                            consumablesOrderItem.ConsumableProduct = consumableProduct;
                            consumablesOrderItem.ConsumableProductOrganization = consumableProductOrganization;
                            consumablesOrderItem.PaymentCostMovementOperation = paymentCostMovementOperation;

                            consumablesOrderItem.TotalPriceWithVAT = Math.Round(consumablesOrderItem.TotalPrice + consumablesOrderItem.VAT, 2);

                            consumablesOrder.ConsumablesOrderItems.Add(consumablesOrderItem);

                            consumablesOrder.TotalAmount = Math.Round(consumablesOrder.TotalAmount + consumablesOrderItem.TotalPrice + consumablesOrderItem.VAT, 2);

                            consumablesOrder.TotalAmountWithoutVAT = Math.Round(consumablesOrder.TotalAmountWithoutVAT + consumablesOrderItem.TotalPrice, 2);
                        }

                        if (consumablesOrderDocument != null) consumablesOrder.ConsumablesOrderDocuments.Add(consumablesOrderDocument);

                        consumablesOrder.User = user;
                        consumablesOrder.SupplyPaymentTask = supplyPaymentTask;
                        consumablesOrder.ConsumablesStorage = consumablesStorage;
                        consumablesOrder.ConsumableProductOrganization = consumableProductOrganization;
                        consumablesOrder.SupplyOrganizationAgreement = supplyOrganizationAgreement;

                        taskFromList.ConsumablesOrder = consumablesOrder;

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return consumablesOrder;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [ConsumablesOrder] " +
                    "LEFT JOIN [User] " +
                    "ON [User].ID = [ConsumablesOrder].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [ConsumablesOrder].SupplyPaymentTaskID " +
                    "LEFT JOIN [ConsumablesOrderItem] " +
                    "ON [ConsumablesOrderItem].ConsumablesOrderID = [ConsumablesOrder].ID " +
                    "AND [ConsumablesOrderItem].Deleted = 0 " +
                    "LEFT JOIN (" +
                    "SELECT [ConsumableProductCategory].ID " +
                    ", [ConsumableProductCategory].[Created] " +
                    ", [ConsumableProductCategory].[Deleted] " +
                    ", [ConsumableProductCategory].[NetUID] " +
                    ", (CASE WHEN [ConsumableProductCategoryTranslation].Name IS NOT NULL THEN [ConsumableProductCategoryTranslation].Name ELSE [ConsumableProductCategory].Name END) AS [Name] " +
                    ", (CASE WHEN [ConsumableProductCategoryTranslation].Description IS NOT NULL THEN [ConsumableProductCategoryTranslation].Description ELSE [ConsumableProductCategory].Description END) AS [Description] " +
                    ", [ConsumableProductCategory].[Updated] " +
                    "FROM [ConsumableProductCategory] " +
                    "LEFT JOIN [ConsumableProductCategoryTranslation] " +
                    "ON [ConsumableProductCategoryTranslation].ConsumableProductCategoryID = [ConsumableProductCategory].ID " +
                    "AND [ConsumableProductCategoryTranslation].CultureCode = @Culture" +
                    ") AS [ConsumableProductCategory] " +
                    "ON [ConsumableProductCategory].ID = [ConsumablesOrderItem].ConsumableProductCategoryID " +
                    "LEFT JOIN (" +
                    "SELECT [ConsumableProduct].ID " +
                    ", [ConsumableProduct].[ConsumableProductCategoryID] " +
                    ", [ConsumableProduct].[Created] " +
                    ", [ConsumableProduct].[VendorCode] " +
                    ", [ConsumableProduct].[Deleted] " +
                    ", (CASE WHEN [ConsumableProductTranslation].Name IS NOT NULL THEN [ConsumableProductTranslation].Name ELSE [ConsumableProduct].Name END) AS [Name] " +
                    ", [ConsumableProduct].[NetUID] " +
                    ", [ConsumableProduct].[MeasureUnitID] " +
                    ", [ConsumableProduct].[Updated] " +
                    "FROM [ConsumableProduct] " +
                    "LEFT JOIN [ConsumableProductTranslation] " +
                    "ON [ConsumableProductTranslation].ConsumableProductID = [ConsumableProduct].ID " +
                    "AND [ConsumableProductTranslation].CultureCode = @Culture" +
                    ") AS [ConsumableProduct] " +
                    "ON [ConsumableProduct].ID = [ConsumablesOrderItem].ConsumableProductID " +
                    "LEFT JOIN [SupplyOrganization] AS [ConsumableProductOrganization] " +
                    "ON [ConsumableProductOrganization].ID = [ConsumablesOrderItem].ConsumableProductOrganizationID " +
                    "LEFT JOIN [ConsumablesStorage] " +
                    "ON [ConsumablesStorage].ID = [ConsumablesOrder].ConsumablesStorageID " +
                    "LEFT JOIN [PaymentCostMovementOperation] " +
                    "ON [PaymentCostMovementOperation].ConsumablesOrderItemID = [ConsumablesOrderItem].ID " +
                    "LEFT JOIN (" +
                    "SELECT [PaymentCostMovement].ID " +
                    ", [PaymentCostMovement].[Created] " +
                    ", [PaymentCostMovement].[Deleted] " +
                    ", [PaymentCostMovement].[NetUID] " +
                    ", (CASE WHEN [PaymentCostMovementTranslation].[OperationName] IS NOT NULL THEN [PaymentCostMovementTranslation].[OperationName] ELSE [PaymentCostMovement].[OperationName] END) AS [OperationName] " +
                    ", [PaymentCostMovement].[Updated] " +
                    "FROM [PaymentCostMovement] " +
                    "LEFT JOIN [PaymentCostMovementTranslation] " +
                    "ON [PaymentCostMovementTranslation].PaymentCostMovementID = [PaymentCostMovement].ID " +
                    "AND [PaymentCostMovementTranslation].CultureCode = @Culture " +
                    ") AS [PaymentCostMovement] " +
                    "ON [PaymentCostMovement].ID = [PaymentCostMovementOperation].PaymentCostMovementID " +
                    "LEFT JOIN [views].[MeasureUnitView] AS [MeasureUnit] " +
                    "ON [MeasureUnit].ID = [ConsumableProduct].MeasureUnitID " +
                    "AND [MeasureUnit].CultureCode = @Culture " +
                    "LEFT JOIN [ConsumablesOrderDocument] " +
                    "ON [ConsumablesOrderDocument].ConsumablesOrderID = [ConsumablesOrder].ID " +
                    "AND [ConsumablesOrderDocument].Deleted = 0 " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [ConsumablesOrderItem].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "WHERE [ConsumablesOrder].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.ConsumablesOrder)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.MergedService))) {
                Type[] includesTypes = new[] {
                    typeof(MergedService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber),
                    typeof(SupplyOrderUkraine),
                    typeof(User),
                    typeof(Organization),
                    typeof(Client),
                    typeof(RegionCode),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(DeliveryProductProtocol),
                    typeof(ConsumableProduct),
                    typeof(ActProvidingService)
                };

                Func<object[], MergedService> includesMapper = objects => {
                    MergedService mergedService = (MergedService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization supplyOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];
                    SupplyOrderUkraine supplyOrderUkraine = (SupplyOrderUkraine)objects[33];
                    User responsible = (User)objects[34];
                    Organization ukOrganization = (Organization)objects[35];
                    Client supplier = (Client)objects[36];
                    RegionCode supplierRegionCode = (RegionCode)objects[37];
                    ClientAgreement supplierClientAgreement = (ClientAgreement)objects[38];
                    Agreement supplierAgreement = (Agreement)objects[39];
                    Organization supplierAgreementOrganization = (Organization)objects[40];
                    Currency supplierAgreementCurrency = (Currency)objects[41];
                    DeliveryProductProtocol protocol = (DeliveryProductProtocol)objects[42];
                    ConsumableProduct consumableProduct = (ConsumableProduct)objects[43];
                    ActProvidingService actProvidingService = (ActProvidingService)objects[44];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.MergedServices.Any()) {
                        MergedService serviceFromList = taskFromList.MergedServices.First();
                        serviceFromList.ConsumableProduct = consumableProduct;
                        serviceFromList.ActProvidingService = actProvidingService;
                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }
                    } else {
                        mergedService.ConsumableProduct = consumableProduct;
                        mergedService.ActProvidingService = actProvidingService;

                        if (invoiceDocument != null) mergedService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            mergedService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrderUkraine != null) {
                            supplierAgreement.Organization = supplierAgreementOrganization;
                            supplierAgreement.Currency = supplierAgreementCurrency;

                            supplierClientAgreement.Agreement = supplierAgreement;

                            supplier.RegionCode = supplierRegionCode;

                            supplyOrderUkraine.Supplier = supplier;
                            supplyOrderUkraine.Responsible = responsible;
                            supplyOrderUkraine.Organization = ukOrganization;
                            supplyOrderUkraine.ClientAgreement = supplierClientAgreement;

                            mergedService.SupplyOrderUkraine = supplyOrderUkraine;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            mergedService.SupplyOrder = supplyOrder;
                        }

                        mergedService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        mergedService.User = user;
                        mergedService.SupplyOrganization = supplyOrganization;

                        if (protocol != null) {
                            protocol.Organization = supplyOrganizationOrganization;
                            mergedService.DeliveryProductProtocol = protocol;
                        }

                        taskFromList.MergedServices.Add(mergedService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return mergedService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [MergedService] " +
                    "LEFT JOIN [User] AS [MergedServiceUser] " +
                    "ON [MergedServiceUser].ID = [MergedService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [MergedService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [MergedServiceSupplyOrganization] " +
                    "ON [MergedServiceSupplyOrganization].ID = [MergedService].SupplyOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [MergedService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].MergedServiceID = [MergedService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].MergedServiceID = [MergedService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [MergedService].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "LEFT JOIN [SupplyOrderUkraine] " +
                    "ON [MergedService].SupplyOrderUkraineID = [SupplyOrderUkraine].ID " +
                    "LEFT JOIN [User] AS [Responsible] " +
                    "ON [Responsible].ID = [SupplyOrderUkraine].ResponsibleID " +
                    "LEFT JOIN [views].[OrganizationView] AS [UkOrganization] " +
                    "ON [UkOrganization].ID = [SupplyOrderUkraine].OrganizationID " +
                    "AND [UkOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [Client] AS [Supplier] " +
                    "ON [Supplier].ID = [SupplyOrderUkraine].SupplierID " +
                    "LEFT JOIN [RegionCode] AS [SupplierRegionCode] " +
                    "ON [SupplierRegionCode].ID = [Supplier].RegionCodeID " +
                    "LEFT JOIN [ClientAgreement] AS [UkClientAgreement] " +
                    "ON [UkClientAgreement].ID = [SupplyOrderUkraine].ClientAgreementID " +
                    "LEFT JOIN [Agreement] AS [UkClientAgreementAgreement] " +
                    "ON [UkClientAgreementAgreement].ID = [UkClientAgreement].AgreementID " +
                    "LEFT JOIN [views].[OrganizationView] AS [UkClientAgreementAgreementOrganization] " +
                    "ON [UkClientAgreementAgreementOrganization].ID = [UkClientAgreementAgreement].OrganizationID " +
                    "AND [UkClientAgreementAgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [UkClientAgreementAgreementCurrency] " +
                    "ON [UkClientAgreementAgreementCurrency].ID = [UkClientAgreementAgreement].CurrencyID " +
                    "AND [UkClientAgreementAgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [DeliveryProductProtocol] " +
                    "ON [DeliveryProductProtocol].[ID] = [MergedService].[DeliveryProductProtocolID] " +
                    "LEFT JOIN [ConsumableProduct] " +
                    "ON [ConsumableProduct].[ID] = [MergedService].[ConsumableProductID] " +
                    "LEFT JOIN [ActProvidingService] " +
                    "ON [MergedService].[ActProvidingServiceID] = [ActProvidingService].[ID] " +
                    "WHERE [MergedService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.MergedService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.SupplyOrderUkrainePaymentDeliveryProtocol))) {
                Type[] includesTypes = new[] {
                    typeof(SupplyOrderUkrainePaymentDeliveryProtocol),
                    typeof(SupplyOrderUkrainePaymentDeliveryProtocolKey),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(User),
                    typeof(SupplyOrderUkraine),
                    typeof(User),
                    typeof(Organization),
                    typeof(Client),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(Currency)
                };

                Func<object[], SupplyOrderUkrainePaymentDeliveryProtocol> includesMapper = objects => {
                    SupplyOrderUkrainePaymentDeliveryProtocol protocol = (SupplyOrderUkrainePaymentDeliveryProtocol)objects[0];
                    SupplyOrderUkrainePaymentDeliveryProtocolKey protocolKey = (SupplyOrderUkrainePaymentDeliveryProtocolKey)objects[1];
                    User protocolUser = (User)objects[2];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[3];
                    User supplyPaymentTaskUser = (User)objects[4];
                    SupplyOrderUkraine supplyOrderUkraine = (SupplyOrderUkraine)objects[5];
                    User responsible = (User)objects[6];
                    Organization organization = (Organization)objects[7];
                    Client supplier = (Client)objects[8];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[9];
                    Agreement agreement = (Agreement)objects[10];
                    Currency currency = (Currency)objects[11];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    supplyPaymentTask.User = supplyPaymentTaskUser;

                    agreement.Currency = currency;

                    clientAgreement.Agreement = agreement;

                    supplyOrderUkraine.Supplier = supplier;
                    supplyOrderUkraine.Responsible = responsible;
                    supplyOrderUkraine.Organization = organization;
                    supplyOrderUkraine.ClientAgreement = clientAgreement;

                    protocol.User = protocolUser;
                    protocol.SupplyPaymentTask = supplyPaymentTask;
                    protocol.SupplyOrderUkraine = supplyOrderUkraine;
                    protocol.SupplyOrderUkrainePaymentDeliveryProtocolKey = protocolKey;

                    decimal exchangeRateAmount = 1;

                    if (currency != null) {
                        if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                            } else {
                                groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                    Currency = currency,
                                    TotalPrice = taskFromList.GrossPrice
                                });
                            }
                        }
                    }

                    if (exchangeRateAmount < decimal.Zero) {
                        exchangeRateAmount = 0 - exchangeRateAmount;

                        taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                        taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                    } else {
                        taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                        taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                    }

                    if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                        groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                        groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                    }

                    taskFromList.SupplyOrderUkrainePaymentDeliveryProtocols.Add(protocol);

                    return protocol;
                };

                _connection.Query(
                    ";WITH [TOTAL_CTE] AS ( " +
                    "SELECT " +
                    "[SupplyOrderUkrainePaymentDeliveryProtocol].[ID] " +
                    ", SUM([SupplyOrderUkraineItem].[Qty] * [SupplyOrderUkraineItem].[UnitPriceLocal]) AS [TotalNetPriceLocal] " +
                    ", SUM([SupplyOrderUkraineItem].[VatAmountLocal]) AS [TotalVatAmount] " +
                    "FROM [SupplyOrderUkrainePaymentDeliveryProtocol] " +
                    "LEFT JOIN [SupplyOrderUkraine] " +
                    "ON [SupplyOrderUkraine].[ID] = [SupplyOrderUkrainePaymentDeliveryProtocol].[SupplyOrderUkraineID] " +
                    "LEFT JOIN [SupplyOrderUkraineItem] " +
                    "ON [SupplyOrderUkraineItem].[SupplyOrderUkraineID] = [SupplyOrderUkraine].[ID] " +
                    "AND [SupplyOrderUkraineItem].[Deleted] = 0 " +
                    "WHERE [SupplyOrderUkrainePaymentDeliveryProtocol].ID IN @Ids " +
                    "AND [SupplyOrderUkrainePaymentDeliveryProtocol].[Deleted] = 0 " +
                    "GROUP BY [SupplyOrderUkrainePaymentDeliveryProtocol].[ID] " +
                    ") " +
                    "SELECT " +
                    "[SupplyOrderUkrainePaymentDeliveryProtocol].* " +
                    ", [SupplyOrderUkrainePaymentDeliveryProtocolKey].* " +
                    ", [ProtocolUser].* " +
                    ", [SupplyPaymentTask].* " +
                    ", [User].* " +
                    ", [SupplyOrderUkraine].* " +
                    ", [TOTAL_CTE].[TotalNetPriceLocal] " +
                    ", [TOTAL_CTE].[TotalVatAmount] " +
                    ", [Responsible].* " +
                    ", [Organization].* " +
                    ", [Supplier].* " +
                    ", [ClientAgreement].* " +
                    ", [Agreement].* " +
                    ", [Currency].* " +
                    "FROM [SupplyOrderUkrainePaymentDeliveryProtocol] " +
                    "LEFT JOIN [SupplyOrderUkrainePaymentDeliveryProtocolKey] " +
                    "ON [SupplyOrderUkrainePaymentDeliveryProtocolKey].ID = [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyOrderUkrainePaymentDeliveryProtocolKeyID " +
                    "LEFT JOIN [User] AS [ProtocolUser] " +
                    "ON [ProtocolUser].ID = [SupplyOrderUkrainePaymentDeliveryProtocol].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyPaymentTaskID " +
                    "LEFT JOIN [User] " +
                    "ON [User].ID = [SupplyPaymentTask].UserID " +
                    "LEFT JOIN [SupplyOrderUkraine] " +
                    "ON [SupplyOrderUkraine].ID = [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyOrderUkraineID " +
                    "LEFT JOIN [User] AS [Responsible] " +
                    "ON [Responsible].ID = [SupplyOrderUkraine].ResponsibleID " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrderUkraine].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [Client] AS [Supplier] " +
                    "ON [Supplier].ID = [SupplyOrderUkraine].SupplierID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrderUkraine].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [ClientAgreement].AgreementID = [Agreement].ID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [Agreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [TOTAL_CTE] " +
                    "ON [TOTAL_CTE].[ID] = [SupplyOrderUkrainePaymentDeliveryProtocol].[ID] " +
                    "WHERE [SupplyOrderUkrainePaymentDeliveryProtocol].[ID] IN ( " +
                    "SELECT [TOTAL_CTE].[ID] " +
                    "FROM [TOTAL_CTE] " +
                    ") ",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.SupplyOrderUkrainePaymentDeliveryProtocol)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingContainerService))) {
                Type[] includesTypes = new[] {
                    typeof(ContainerService),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(BillOfLadingDocument),
                    typeof(User),
                    typeof(InvoiceDocument),
                    typeof(SupplyOrderContainerService),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], ContainerService> includesMapper = objects => {
                    ContainerService containerService = (ContainerService)objects[0];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[1];
                    SupplyOrganization containerOrganization = (SupplyOrganization)objects[2];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[3];
                    Currency currency = (Currency)objects[4];
                    BillOfLadingDocument billOfLadingDocument = (BillOfLadingDocument)objects[5];
                    User user = (User)objects[6];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[7];
                    SupplyOrderContainerService supplyOrderContainerService = (SupplyOrderContainerService)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.ContainerServices.Any()) {
                        if (taskFromList.ContainerServices.Any(s => s.Id.Equals(containerService.Id))) {
                            ContainerService serviceFromList = taskFromList.ContainerServices.First(s => s.Id.Equals(containerService.Id));

                            if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                            if (supplyOrderContainerService != null && !serviceFromList.SupplyOrderContainerServices.Any(s => s.Id.Equals(supplyOrderContainerService.Id))) {
                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyOrderContainerService.SupplyOrder = supplyOrder;

                                serviceFromList.SupplyOrderContainerServices.Add(supplyOrderContainerService);
                            }
                        } else {
                            if (invoiceDocument != null) containerService.InvoiceDocuments.Add(invoiceDocument);

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            if (supplyOrderContainerService != null) {
                                if (client != null) {
                                    if (clientBankDetails != null) {
                                        if (clientBankDetailAccountNumber != null) {
                                            clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                            clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                        }

                                        if (clientBankDetailIbanNo != null) {
                                            clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                            clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                        }
                                    }

                                    if (clientAgreement != null) {
                                        if (providerPricing != null) {
                                            if (pricing != null) pricing.PriceType = priceType;

                                            providerPricing.Currency = providerPricingCurrency;
                                            providerPricing.Pricing = pricing;
                                        }

                                        agreement.Organization = agreementOrganization;
                                        agreement.Currency = agreementCurrency;
                                        agreement.ProviderPricing = providerPricing;

                                        clientAgreement.Agreement = agreement;

                                        client.ClientAgreements.Add(clientAgreement);
                                    }

                                    client.Region = region;
                                    client.RegionCode = regionCode;
                                    client.Country = country;
                                    client.ClientBankDetails = clientBankDetails;
                                    client.TermsOfDelivery = termsOfDelivery;
                                    client.PackingMarking = packingMarking;
                                    client.PackingMarkingPayment = packingMarkingPayment;
                                }

                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyOrderContainerService.SupplyOrder = supplyOrder;

                                containerService.SupplyOrderContainerServices.Add(supplyOrderContainerService);
                            }

                            containerService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            containerService.ContainerOrganization = containerOrganization;
                            containerService.BillOfLadingDocument = billOfLadingDocument;
                            containerService.User = user;

                            taskFromList.ContainerServices.Add(containerService);

                            decimal exchangeRateAmount = 1;

                            if (currency != null) {
                                if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                                if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                    if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                        PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                    } else {
                                        groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                            Currency = currency,
                                            TotalPrice = taskFromList.GrossPrice
                                        });
                                    }
                                }
                            }

                            if (exchangeRateAmount < decimal.Zero) {
                                exchangeRateAmount = 0 - exchangeRateAmount;

                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                            } else {
                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                            }

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                                groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                            }
                        }
                    } else {
                        if (invoiceDocument != null) containerService.InvoiceDocuments.Add(invoiceDocument);

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;
                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrderContainerService != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            supplyOrderContainerService.SupplyOrder = supplyOrder;

                            containerService.SupplyOrderContainerServices.Add(supplyOrderContainerService);
                        }

                        containerService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        containerService.ContainerOrganization = containerOrganization;
                        containerService.BillOfLadingDocument = billOfLadingDocument;
                        containerService.User = user;

                        taskFromList.ContainerServices.Add(containerService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return containerService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [ContainerService] " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [ContainerService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [ContainerOrganization] " +
                    "ON [ContainerOrganization].ID = [ContainerService].ContainerOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [ContainerService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [BillOfLadingDocument] " +
                    "ON [BillOfLadingDocument].ID = [ContainerService].BillOfLadingDocumentID " +
                    "LEFT JOIN [User] AS [ContainerServiceUser] " +
                    "ON [ContainerServiceUser].ID = [ContainerService].UserID " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].ContainerServiceID = [ContainerService].ID " +
                    "LEFT JOIN [SupplyOrderContainerService] " +
                    "ON [SupplyOrderContainerService].ContainerServiceID = [ContainerService].ID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [SupplyOrderContainerService].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [SupplyOrder].ClientID = [Client].ID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [ContainerService].ID IN @Ids " +
                    "AND [SupplyOrderContainerService].Deleted = 0 ",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingContainerService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingVehicleService))) {
                Type[] includesTypes = new[] {
                    typeof(VehicleService),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(BillOfLadingDocument),
                    typeof(User),
                    typeof(InvoiceDocument),
                    typeof(SupplyOrderVehicleService),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], VehicleService> includesMapper = objects => {
                    VehicleService vehicleService = (VehicleService)objects[0];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[1];
                    SupplyOrganization vehicleOrganization = (SupplyOrganization)objects[2];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[3];
                    Currency currency = (Currency)objects[4];
                    BillOfLadingDocument billOfLadingDocument = (BillOfLadingDocument)objects[5];
                    User user = (User)objects[6];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[7];
                    SupplyOrderVehicleService supplyOrderVehicleService = (SupplyOrderVehicleService)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.VehicleServices.Any()) {
                        if (taskFromList.VehicleServices.Any(s => s.Id.Equals(vehicleService.Id))) {
                            VehicleService serviceFromList = taskFromList.VehicleServices.First(s => s.Id.Equals(vehicleService.Id));

                            if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                            if (supplyOrderVehicleService != null && !serviceFromList.SupplyOrderVehicleServices.Any(s => s.Id.Equals(supplyOrderVehicleService.Id))) {
                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyOrderVehicleService.SupplyOrder = supplyOrder;

                                serviceFromList.SupplyOrderVehicleServices.Add(supplyOrderVehicleService);
                            }
                        } else {
                            if (invoiceDocument != null) vehicleService.InvoiceDocuments.Add(invoiceDocument);

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            if (supplyOrderVehicleService != null) {
                                if (client != null) {
                                    if (clientBankDetails != null) {
                                        if (clientBankDetailAccountNumber != null) {
                                            clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                            clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                        }

                                        if (clientBankDetailIbanNo != null) {
                                            clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                            clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                        }
                                    }

                                    if (clientAgreement != null) {
                                        if (providerPricing != null) {
                                            if (pricing != null) pricing.PriceType = priceType;

                                            providerPricing.Currency = providerPricingCurrency;
                                            providerPricing.Pricing = pricing;
                                        }

                                        agreement.Organization = agreementOrganization;
                                        agreement.Currency = agreementCurrency;
                                        agreement.ProviderPricing = providerPricing;

                                        clientAgreement.Agreement = agreement;

                                        client.ClientAgreements.Add(clientAgreement);
                                    }

                                    client.Region = region;
                                    client.RegionCode = regionCode;
                                    client.Country = country;
                                    client.ClientBankDetails = clientBankDetails;
                                    client.TermsOfDelivery = termsOfDelivery;
                                    client.PackingMarking = packingMarking;
                                    client.PackingMarkingPayment = packingMarkingPayment;
                                }

                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyOrderVehicleService.SupplyOrder = supplyOrder;

                                vehicleService.SupplyOrderVehicleServices.Add(supplyOrderVehicleService);
                            }

                            vehicleService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            vehicleService.VehicleOrganization = vehicleOrganization;
                            vehicleService.BillOfLadingDocument = billOfLadingDocument;
                            vehicleService.User = user;

                            taskFromList.VehicleServices.Add(vehicleService);

                            decimal exchangeRateAmount = 1;

                            if (currency != null) {
                                if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                                if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                    if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                        PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                    } else {
                                        groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                            Currency = currency,
                                            TotalPrice = taskFromList.GrossPrice
                                        });
                                    }
                                }
                            }

                            if (exchangeRateAmount < decimal.Zero) {
                                exchangeRateAmount = 0 - exchangeRateAmount;

                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                            } else {
                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                            }

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                                groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                            }
                        }
                    } else {
                        if (invoiceDocument != null) vehicleService.InvoiceDocuments.Add(invoiceDocument);

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrderVehicleService != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            supplyOrderVehicleService.SupplyOrder = supplyOrder;

                            vehicleService.SupplyOrderVehicleServices.Add(supplyOrderVehicleService);
                        }

                        vehicleService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        vehicleService.VehicleOrganization = vehicleOrganization;
                        vehicleService.BillOfLadingDocument = billOfLadingDocument;
                        vehicleService.User = user;

                        taskFromList.VehicleServices.Add(vehicleService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return vehicleService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [VehicleService] " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [VehicleService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [VehicleOrganization] " +
                    "ON [VehicleOrganization].ID = [VehicleService].VehicleOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [VehicleService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [BillOfLadingDocument] " +
                    "ON [BillOfLadingDocument].ID = [VehicleService].BillOfLadingDocumentID " +
                    "LEFT JOIN [User] AS [VehicleServiceUser] " +
                    "ON [VehicleServiceUser].ID = [VehicleService].UserID " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].VehicleServiceID = [VehicleService].ID " +
                    "LEFT JOIN [SupplyOrderVehicleService] " +
                    "ON [SupplyOrderVehicleService].VehicleServiceID = [VehicleService].ID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [SupplyOrderVehicleService].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [SupplyOrder].ClientID = [Client].ID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [VehicleService].ID IN @Ids " +
                    "AND [SupplyOrderVehicleService].Deleted = 0 ",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingVehicleService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingCustomService))) {
                Type[] includesTypes = new[] {
                    typeof(CustomService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency)
                };

                Func<object[], CustomService> includesMapper = objects => {
                    CustomService customService = (CustomService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization exciseDutyOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganization customOrganization = (SupplyOrganization)objects[4];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[5];
                    Client client = (Client)objects[6];
                    Region region = (Region)objects[7];
                    RegionCode regionCode = (RegionCode)objects[8];
                    Country country = (Country)objects[9];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[10];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[11];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[12];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[13];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[14];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[15];
                    PackingMarking packingMarking = (PackingMarking)objects[16];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[17];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[18];
                    Agreement agreement = (Agreement)objects[19];
                    ProviderPricing providerPricing = (ProviderPricing)objects[20];
                    Currency providerPricingCurrency = (Currency)objects[21];
                    Pricing pricing = (Pricing)objects[22];
                    PriceType priceType = (PriceType)objects[23];
                    Organization agreementOrganization = (Organization)objects[24];
                    Currency agreementCurrency = (Currency)objects[25];
                    Organization organization = (Organization)objects[26];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[27];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[28];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[29];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[30];
                    SupplyOrganizationAgreement exciseDutyOrganizationAgreement = (SupplyOrganizationAgreement)objects[31];
                    SupplyOrganizationAgreement customOrganizationAgreement = (SupplyOrganizationAgreement)objects[32];
                    Organization exciseDutyOrganizationOrganization = (Organization)objects[33];
                    Organization customSupplyOrganizationOrganization = (Organization)objects[34];
                    Currency currency = (Currency)objects[35];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.BrokerServices.Any()) {
                        CustomService serviceFromList = taskFromList.BrokerServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }
                    } else {
                        if (exciseDutyOrganization != null && exciseDutyOrganizationAgreement != null) {
                            if (!exciseDutyOrganization.SupplyOrganizationAgreements.Any(x => x.Id == exciseDutyOrganizationAgreement.Id))
                                exciseDutyOrganization.SupplyOrganizationAgreements.Add(exciseDutyOrganizationAgreement);
                            else
                                exciseDutyOrganizationAgreement = exciseDutyOrganization.SupplyOrganizationAgreements.First(x => x.Id == exciseDutyOrganizationAgreement.Id);

                            exciseDutyOrganizationAgreement.Organization = exciseDutyOrganizationOrganization;
                        }

                        if (invoiceDocument != null) customService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            customService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (customOrganizationAgreement != null) {
                            customOrganizationAgreement.Currency = currency;

                            customOrganizationAgreement.Organization = customSupplyOrganizationOrganization;
                        }

                        if (client != null) {
                            if (clientBankDetails != null) {
                                if (clientBankDetailAccountNumber != null) {
                                    clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                    clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                }

                                if (clientBankDetailIbanNo != null) {
                                    clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                    clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                }
                            }

                            if (clientAgreement != null) {
                                if (providerPricing != null) {
                                    if (pricing != null) pricing.PriceType = priceType;

                                    providerPricing.Currency = providerPricingCurrency;
                                    providerPricing.Pricing = pricing;
                                }

                                agreement.Organization = agreementOrganization;
                                agreement.Currency = agreementCurrency;
                                agreement.ProviderPricing = providerPricing;

                                clientAgreement.Agreement = agreement;

                                client.ClientAgreements.Add(clientAgreement);
                            }

                            client.Region = region;
                            client.RegionCode = regionCode;
                            client.Country = country;
                            client.ClientBankDetails = clientBankDetails;
                            client.TermsOfDelivery = termsOfDelivery;
                            client.PackingMarking = packingMarking;
                            client.PackingMarkingPayment = packingMarkingPayment;
                        }

                        supplyOrder.Client = client;
                        supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                        supplyOrder.Organization = organization;

                        customService.SupplyOrganizationAgreement = customOrganizationAgreement;
                        customService.SupplyOrder = supplyOrder;
                        customService.User = user;
                        customService.ExciseDutyOrganization = exciseDutyOrganization;
                        customService.CustomOrganization = customOrganization;

                        taskFromList.BrokerServices.Add(customService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return customService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [CustomService] " +
                    "LEFT JOIN [User] AS [CustomServiceUser] " +
                    "ON [CustomServiceUser].ID = [CustomService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [CustomService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [ExciseDutyOrganization] " +
                    "ON [ExciseDutyOrganization].ID = [CustomService].ExciseDutyOrganizationID " +
                    "LEFT JOIN [SupplyOrganization] AS [CustomOrganization] " +
                    "ON [CustomOrganization].ID = [CustomService].CustomOrganizationID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [CustomService].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].CustomServiceID = [CustomService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].CustomServiceID = [CustomService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [ExciseDutyOrganization].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [CustomSupplyOrganizationOrganization] " +
                    "ON [CustomSupplyOrganizationOrganization].ID = [CustomOrganization].OrganizationID " +
                    "AND [CustomSupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] AS [ExciseDutyOrganizationAgreement] " +
                    "ON [ExciseDutyOrganizationAgreement].SupplyOrganizationID = [ExciseDutyOrganization].ID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [CustomService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [ExciseDutyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [CustomSupplyOrganizationOrganization] " +
                    "ON [CustomSupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [CustomSupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "WHERE [CustomService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingCustomService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingPortWorkService))) {
                Type[] includesTypes = new[] {
                    typeof(PortWorkService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], PortWorkService> includesMapper = objects => {
                    PortWorkService portWorkService = (PortWorkService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization portWorkOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.PortWorkServices.Any()) {
                        if (taskFromList.PortWorkServices.Any(s => s.Id.Equals(portWorkService.Id))) {
                            PortWorkService serviceFromList = taskFromList.PortWorkServices.First();

                            if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                            if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                                serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                                serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                            }

                            if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                                supplyOrder.Client = client;
                                supplyOrder.Organization = organization;

                                serviceFromList.SupplyOrders.Add(supplyOrder);
                            }
                        } else {
                            if (invoiceDocument != null) portWorkService.InvoiceDocuments.Add(invoiceDocument);

                            if (serviceDetailItem != null) {
                                serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                                portWorkService.ServiceDetailItems.Add(serviceDetailItem);
                            }

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            if (supplyOrder != null) {
                                if (client != null) {
                                    if (clientBankDetails != null) {
                                        if (clientBankDetailAccountNumber != null) {
                                            clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                            clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                        }

                                        if (clientBankDetailIbanNo != null) {
                                            clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                            clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                        }
                                    }

                                    if (clientAgreement != null) {
                                        if (providerPricing != null) {
                                            if (pricing != null) pricing.PriceType = priceType;

                                            providerPricing.Currency = providerPricingCurrency;
                                            providerPricing.Pricing = pricing;
                                        }

                                        agreement.Organization = agreementOrganization;
                                        agreement.Currency = agreementCurrency;
                                        agreement.ProviderPricing = providerPricing;

                                        clientAgreement.Agreement = agreement;

                                        client.ClientAgreements.Add(clientAgreement);
                                    }

                                    client.Region = region;
                                    client.RegionCode = regionCode;
                                    client.Country = country;
                                    client.ClientBankDetails = clientBankDetails;
                                    client.TermsOfDelivery = termsOfDelivery;
                                    client.PackingMarking = packingMarking;
                                    client.PackingMarkingPayment = packingMarkingPayment;
                                }

                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                portWorkService.SupplyOrders.Add(supplyOrder);
                            }

                            portWorkService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            portWorkService.User = user;
                            portWorkService.PortWorkOrganization = portWorkOrganization;

                            taskFromList.PortWorkServices.Add(portWorkService);

                            decimal exchangeRateAmount = 1;

                            if (currency != null) {
                                if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                                if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                    if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                        PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                    } else {
                                        groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                            Currency = currency,
                                            TotalPrice = taskFromList.GrossPrice
                                        });
                                    }
                                }
                            }

                            if (exchangeRateAmount < decimal.Zero) {
                                exchangeRateAmount = 0 - exchangeRateAmount;

                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                            } else {
                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                            }

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                                groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                            }
                        }
                    } else {
                        if (invoiceDocument != null) portWorkService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            portWorkService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            portWorkService.SupplyOrders.Add(supplyOrder);
                        }

                        portWorkService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        portWorkService.User = user;
                        portWorkService.PortWorkOrganization = portWorkOrganization;

                        taskFromList.PortWorkServices.Add(portWorkService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return portWorkService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [PortWorkService] " +
                    "LEFT JOIN [User] AS [PortWorkServiceUser] " +
                    "ON [PortWorkServiceUser].ID = [PortWorkService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [PortWorkService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [PortWorkOrganization] " +
                    "ON [PortWorkOrganization].ID = [PortWorkService].PortWorkOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [PortWorkService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].PortWorkServiceID = [PortWorkService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].PortWorkServiceID = [PortWorkService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].PortWorkServiceID = [PortWorkService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [PortWorkService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingPortWorkService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingTransportationService))) {
                Type[] includesTypes = new[] {
                    typeof(TransportationService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], TransportationService> includesMapper = objects => {
                    TransportationService transportationService = (TransportationService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization transportationOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.TransportationServices.Any()) {
                        TransportationService serviceFromList = taskFromList.TransportationServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) transportationService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            transportationService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            transportationService.SupplyOrders.Add(supplyOrder);
                        }

                        transportationService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        transportationService.User = user;
                        transportationService.TransportationOrganization = transportationOrganization;

                        taskFromList.TransportationServices.Add(transportationService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return transportationService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [TransportationService] " +
                    "LEFT JOIN [User] AS [TransportationServiceUser] " +
                    "ON [TransportationServiceUser].ID = [TransportationService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [TransportationService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [TransportationOrganization] " +
                    "ON [TransportationOrganization].ID = [TransportationService].TransportationOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [TransportationService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].TransportationServiceID = [TransportationService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].TransportationServiceID = [TransportationService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].TransportationServiceID = [TransportationService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [TransportationService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingTransportationService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingPortCustomAgencyService))) {
                Type[] includesTypes = new[] {
                    typeof(PortCustomAgencyService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], PortCustomAgencyService> includesMapper = objects => {
                    PortCustomAgencyService portCustomAgencyService = (PortCustomAgencyService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization portCustomAgencyOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.PortCustomAgencyServices.Any()) {
                        PortCustomAgencyService serviceFromList = taskFromList.PortCustomAgencyServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) portCustomAgencyService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            portCustomAgencyService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            portCustomAgencyService.SupplyOrders.Add(supplyOrder);
                        }

                        portCustomAgencyService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        portCustomAgencyService.User = user;
                        portCustomAgencyService.PortCustomAgencyOrganization = portCustomAgencyOrganization;

                        taskFromList.PortCustomAgencyServices.Add(portCustomAgencyService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return portCustomAgencyService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [PortCustomAgencyService] " +
                    "LEFT JOIN [User] AS [PortCustomAgencyServiceUser] " +
                    "ON [PortCustomAgencyServiceUser].ID = [PortCustomAgencyService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [PortCustomAgencyService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [PortCustomAgencyOrganization] " +
                    "ON [PortCustomAgencyOrganization].ID = [PortCustomAgencyService].PortCustomAgencyOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [PortCustomAgencyService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].PortCustomAgencyServiceID = [PortCustomAgencyService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].PortCustomAgencyServiceID = [PortCustomAgencyService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].PortCustomAgencyServiceID = [PortCustomAgencyService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [PortCustomAgencyService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingPortCustomAgencyService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingCustomAgencyService))) {
                Type[] includesTypes = new[] {
                    typeof(CustomAgencyService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], CustomAgencyService> includesMapper = objects => {
                    CustomAgencyService customAgencyService = (CustomAgencyService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization customAgencyOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.CustomAgencyServices.Any()) {
                        CustomAgencyService serviceFromList = taskFromList.CustomAgencyServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) customAgencyService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            customAgencyService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            customAgencyService.SupplyOrders.Add(supplyOrder);
                        }

                        customAgencyService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        customAgencyService.User = user;
                        customAgencyService.CustomAgencyOrganization = customAgencyOrganization;

                        taskFromList.CustomAgencyServices.Add(customAgencyService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return customAgencyService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [CustomAgencyService] " +
                    "LEFT JOIN [User] AS [CustomAgencyServiceUser] " +
                    "ON [CustomAgencyServiceUser].ID = [CustomAgencyService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [CustomAgencyService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [CustomAgencyOrganization] " +
                    "ON [CustomAgencyOrganization].ID = [CustomAgencyService].CustomAgencyOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [CustomAgencyService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].CustomAgencyServiceID = [CustomAgencyService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].CustomAgencyServiceID = [CustomAgencyService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].CustomAgencyServiceID = [CustomAgencyService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [CustomAgencyService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingCustomAgencyService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingPlaneDeliveryService))) {
                Type[] includesTypes = new[] {
                    typeof(PlaneDeliveryService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], PlaneDeliveryService> includesMapper = objects => {
                    PlaneDeliveryService planeDeliveryService = (PlaneDeliveryService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization planeDeliveryOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.PlaneDeliveryServices.Any()) {
                        PlaneDeliveryService serviceFromList = taskFromList.PlaneDeliveryServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) planeDeliveryService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            planeDeliveryService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            planeDeliveryService.SupplyOrders.Add(supplyOrder);
                        }

                        planeDeliveryService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        planeDeliveryService.User = user;
                        planeDeliveryService.PlaneDeliveryOrganization = planeDeliveryOrganization;

                        taskFromList.PlaneDeliveryServices.Add(planeDeliveryService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return planeDeliveryService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [PlaneDeliveryService] " +
                    "LEFT JOIN [User] AS [PlaneDeliveryServiceUser] " +
                    "ON [PlaneDeliveryServiceUser].ID = [PlaneDeliveryService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [PlaneDeliveryService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [PlaneDeliveryOrganization] " +
                    "ON [PlaneDeliveryOrganization].ID = [PlaneDeliveryService].PlaneDeliveryOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [PlaneDeliveryService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].PlaneDeliveryServiceID = [PlaneDeliveryService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].PlaneDeliveryServiceID = [PlaneDeliveryService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].PlaneDeliveryServiceID = [PlaneDeliveryService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [PlaneDeliveryService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingPlaneDeliveryService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingVehicleDeliveryService))) {
                Type[] includesTypes = new[] {
                    typeof(VehicleDeliveryService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], VehicleDeliveryService> includesMapper = objects => {
                    VehicleDeliveryService vehicleDeliveryService = (VehicleDeliveryService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization vehicleDeliveryOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.VehicleDeliveryServices.Any()) {
                        VehicleDeliveryService serviceFromList = taskFromList.VehicleDeliveryServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) vehicleDeliveryService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            vehicleDeliveryService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            vehicleDeliveryService.SupplyOrders.Add(supplyOrder);
                        }

                        vehicleDeliveryService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        vehicleDeliveryService.User = user;
                        vehicleDeliveryService.VehicleDeliveryOrganization = vehicleDeliveryOrganization;

                        taskFromList.VehicleDeliveryServices.Add(vehicleDeliveryService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return vehicleDeliveryService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [VehicleDeliveryService] " +
                    "LEFT JOIN [User] AS [VehicleDeliveryServiceUser] " +
                    "ON [VehicleDeliveryServiceUser].ID = [VehicleDeliveryService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [VehicleDeliveryService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [VehicleDeliveryOrganization] " +
                    "ON [VehicleDeliveryOrganization].ID = [VehicleDeliveryService].VehicleDeliveryOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [VehicleDeliveryService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].VehicleDeliveryServiceID = [VehicleDeliveryService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].VehicleDeliveryServiceID = [VehicleDeliveryService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].VehicleDeliveryServiceID = [VehicleDeliveryService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [VehicleDeliveryService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingVehicleDeliveryService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingMergedService))) {
                Type[] includesTypes = {
                    typeof(MergedService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber),
                    typeof(SupplyOrderUkraine),
                    typeof(User),
                    typeof(Organization),
                    typeof(Client),
                    typeof(RegionCode),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(DeliveryProductProtocol),
                    typeof(ConsumableProduct),
                    typeof(ActProvidingService)
                };

                Func<object[], MergedService> includesMapper = objects => {
                    MergedService mergedService = (MergedService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization supplyOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];
                    SupplyOrderUkraine supplyOrderUkraine = (SupplyOrderUkraine)objects[33];
                    User responsible = (User)objects[34];
                    Organization ukOrganization = (Organization)objects[35];
                    Client supplier = (Client)objects[36];
                    RegionCode supplierRegionCode = (RegionCode)objects[37];
                    ClientAgreement supplierClientAgreement = (ClientAgreement)objects[38];
                    Agreement supplierAgreement = (Agreement)objects[39];
                    Organization supplierAgreementOrganization = (Organization)objects[40];
                    Currency supplierAgreementCurrency = (Currency)objects[41];
                    DeliveryProductProtocol protocol = (DeliveryProductProtocol)objects[42];
                    ConsumableProduct consumableProduct = (ConsumableProduct)objects[43];
                    ActProvidingService actProvidingService = (ActProvidingService)objects[44];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.MergedServices.Any()) {
                        MergedService serviceFromList = taskFromList.MergedServices.First();

                        serviceFromList.ConsumableProduct = consumableProduct;
                        serviceFromList.AccountingActProvidingService = actProvidingService;
                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }
                    } else {
                        mergedService.ConsumableProduct = consumableProduct;
                        mergedService.AccountingActProvidingService = actProvidingService;

                        if (invoiceDocument != null) mergedService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            mergedService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrderUkraine != null) {
                            supplierAgreement.Organization = supplierAgreementOrganization;
                            supplierAgreement.Currency = supplierAgreementCurrency;

                            supplierClientAgreement.Agreement = supplierAgreement;

                            supplier.RegionCode = supplierRegionCode;

                            supplyOrderUkraine.Supplier = supplier;
                            supplyOrderUkraine.Responsible = responsible;
                            supplyOrderUkraine.Organization = ukOrganization;
                            supplyOrderUkraine.ClientAgreement = supplierClientAgreement;

                            mergedService.SupplyOrderUkraine = supplyOrderUkraine;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            mergedService.SupplyOrder = supplyOrder;
                        }

                        mergedService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        mergedService.User = user;
                        mergedService.SupplyOrganization = supplyOrganization;

                        if (protocol != null) {
                            protocol.Organization = supplyOrganizationOrganization;
                            mergedService.DeliveryProductProtocol = protocol;
                        }

                        taskFromList.MergedServices.Add(mergedService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return mergedService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [MergedService] " +
                    "LEFT JOIN [User] AS [MergedServiceUser] " +
                    "ON [MergedServiceUser].ID = [MergedService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [MergedService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [MergedServiceSupplyOrganization] " +
                    "ON [MergedServiceSupplyOrganization].ID = [MergedService].SupplyOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [MergedService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].MergedServiceID = [MergedService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].MergedServiceID = [MergedService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [MergedService].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "LEFT JOIN [SupplyOrderUkraine] " +
                    "ON [MergedService].SupplyOrderUkraineID = [SupplyOrderUkraine].ID " +
                    "LEFT JOIN [User] AS [Responsible] " +
                    "ON [Responsible].ID = [SupplyOrderUkraine].ResponsibleID " +
                    "LEFT JOIN [views].[OrganizationView] AS [UkOrganization] " +
                    "ON [UkOrganization].ID = [SupplyOrderUkraine].OrganizationID " +
                    "AND [UkOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [Client] AS [Supplier] " +
                    "ON [Supplier].ID = [SupplyOrderUkraine].SupplierID " +
                    "LEFT JOIN [RegionCode] AS [SupplierRegionCode] " +
                    "ON [SupplierRegionCode].ID = [Supplier].RegionCodeID " +
                    "LEFT JOIN [ClientAgreement] AS [UkClientAgreement] " +
                    "ON [UkClientAgreement].ID = [SupplyOrderUkraine].ClientAgreementID " +
                    "LEFT JOIN [Agreement] AS [UkClientAgreementAgreement] " +
                    "ON [UkClientAgreementAgreement].ID = [UkClientAgreement].AgreementID " +
                    "LEFT JOIN [views].[OrganizationView] AS [UkClientAgreementAgreementOrganization] " +
                    "ON [UkClientAgreementAgreementOrganization].ID = [UkClientAgreementAgreement].OrganizationID " +
                    "AND [UkClientAgreementAgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [UkClientAgreementAgreementCurrency] " +
                    "ON [UkClientAgreementAgreementCurrency].ID = [UkClientAgreementAgreement].CurrencyID " +
                    "AND [UkClientAgreementAgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [DeliveryProductProtocol] " +
                    "ON [DeliveryProductProtocol].[ID] = [MergedService].[DeliveryProductProtocolID] " +
                    "LEFT JOIN [ConsumableProduct] " +
                    "ON [ConsumableProduct].[ID] = [MergedService].[ConsumableProductID] " +
                    "LEFT JOIN [ActProvidingService] " +
                    "ON [ActProvidingService].[ID] = [MergedService].[AccountingActProvidingServiceID] " +
                    "WHERE [MergedService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingMergedService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.BillOfLadingService))) {
                Type[] includesTypes = new[] {
                    typeof(BillOfLadingService),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(BillOfLadingDocument),
                    typeof(User),
                    typeof(SupplyInvoiceBillOfLadingService),
                    typeof(SupplyInvoice),
                    typeof(InvoiceDocument),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber),
                    typeof(DeliveryProductProtocol)
                };

                Func<object[], BillOfLadingService> includesMapper = objects => {
                    BillOfLadingService billOfLadingService = (BillOfLadingService)objects[0];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[1];
                    SupplyOrganization supplyOrganization = (SupplyOrganization)objects[2];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[3];
                    Currency currency = (Currency)objects[4];
                    BillOfLadingDocument billOfLadingDocument = (BillOfLadingDocument)objects[5];
                    User user = (User)objects[6];
                    SupplyInvoiceBillOfLadingService supplyInvoiceBillOfLadingService = (SupplyInvoiceBillOfLadingService)objects[7];
                    SupplyInvoice supplyInvoice = (SupplyInvoice)objects[8];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[9];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[10];
                    Client client = (Client)objects[11];
                    Region region = (Region)objects[12];
                    RegionCode regionCode = (RegionCode)objects[13];
                    Country country = (Country)objects[14];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[15];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[16];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[17];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[18];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[19];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[20];
                    PackingMarking packingMarking = (PackingMarking)objects[21];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[22];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[23];
                    Agreement agreement = (Agreement)objects[24];
                    ProviderPricing providerPricing = (ProviderPricing)objects[25];
                    Currency providerPricingCurrency = (Currency)objects[26];
                    Pricing pricing = (Pricing)objects[27];
                    PriceType priceType = (PriceType)objects[28];
                    Organization agreementOrganization = (Organization)objects[29];
                    Currency agreementCurrency = (Currency)objects[30];
                    Organization organization = (Organization)objects[31];
                    Organization supplyOrganizationOrganization = (Organization)objects[32];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[33];
                    DeliveryProductProtocol protocol = (DeliveryProductProtocol)objects[34];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.BillOfLadingServices.Any()) {
                        if (taskFromList.BillOfLadingServices.Any(s => s.Id.Equals(billOfLadingService.Id))) {
                            BillOfLadingService serviceFromList = taskFromList.BillOfLadingServices.First(s => s.Id.Equals(billOfLadingService.Id));

                            if (billOfLadingDocument != null && !serviceFromList.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                                serviceFromList.BillOfLadingDocuments.Add(billOfLadingDocument);

                            if (supplyInvoiceBillOfLadingService != null &&
                                !serviceFromList.SupplyInvoiceBillOfLadingServices.Any(s => s.Id.Equals(supplyInvoiceBillOfLadingService.Id))) {
                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyInvoice.SupplyOrder = supplyOrder;

                                supplyInvoiceBillOfLadingService.SupplyInvoice = supplyInvoice;

                                if (invoiceDocument != null && !supplyInvoice.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                    supplyInvoice.InvoiceDocuments.Add(invoiceDocument);

                                serviceFromList.SupplyInvoiceBillOfLadingServices.Add(supplyInvoiceBillOfLadingService);
                            }
                        } else {
                            if (billOfLadingDocument != null && !billOfLadingService.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                                billOfLadingService.BillOfLadingDocuments.Add(billOfLadingDocument);

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            if (supplyInvoiceBillOfLadingService != null) {
                                if (client != null) {
                                    if (clientBankDetails != null) {
                                        if (clientBankDetailAccountNumber != null) {
                                            clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                            clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                        }

                                        if (clientBankDetailIbanNo != null) {
                                            clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                            clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                        }
                                    }

                                    if (clientAgreement != null) {
                                        if (providerPricing != null) {
                                            if (pricing != null) pricing.PriceType = priceType;

                                            providerPricing.Currency = providerPricingCurrency;
                                            providerPricing.Pricing = pricing;
                                        }

                                        agreement.Organization = agreementOrganization;
                                        agreement.Currency = agreementCurrency;
                                        agreement.ProviderPricing = providerPricing;

                                        clientAgreement.Agreement = agreement;

                                        client.ClientAgreements.Add(clientAgreement);
                                    }

                                    client.Region = region;
                                    client.RegionCode = regionCode;
                                    client.Country = country;
                                    client.ClientBankDetails = clientBankDetails;
                                    client.TermsOfDelivery = termsOfDelivery;
                                    client.PackingMarking = packingMarking;
                                    client.PackingMarkingPayment = packingMarkingPayment;
                                }

                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyInvoice.SupplyOrder = supplyOrder;

                                supplyInvoiceBillOfLadingService.SupplyInvoice = supplyInvoice;

                                billOfLadingService.SupplyInvoiceBillOfLadingServices.Add(supplyInvoiceBillOfLadingService);
                            }

                            billOfLadingService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            billOfLadingService.SupplyOrganization = supplyOrganization;

                            protocol.Organization = supplyOrganizationOrganization;
                            billOfLadingService.DeliveryProductProtocol = protocol;

                            if (billOfLadingDocument != null && !billOfLadingService.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                                billOfLadingService.BillOfLadingDocuments.Add(billOfLadingDocument);

                            billOfLadingService.User = user;

                            taskFromList.BillOfLadingServices.Add(billOfLadingService);

                            decimal exchangeRateAmount = 1;

                            if (currency != null) {
                                if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                                if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                    if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                        PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                    } else {
                                        groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                            Currency = currency,
                                            TotalPrice = taskFromList.GrossPrice
                                        });
                                    }
                                }
                            }

                            if (exchangeRateAmount < decimal.Zero) {
                                exchangeRateAmount = 0 - exchangeRateAmount;

                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                            } else {
                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                            }

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                                groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                            }
                        }
                    } else {
                        if (billOfLadingDocument != null && !billOfLadingService.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                            billOfLadingService.BillOfLadingDocuments.Add(billOfLadingDocument);

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyInvoiceBillOfLadingService != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            supplyInvoice.SupplyOrder = supplyOrder;

                            supplyInvoiceBillOfLadingService.SupplyInvoice = supplyInvoice;

                            billOfLadingService.SupplyInvoiceBillOfLadingServices.Add(supplyInvoiceBillOfLadingService);
                        }

                        billOfLadingService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        billOfLadingService.SupplyOrganization = supplyOrganization;

                        protocol.Organization = supplyOrganizationOrganization;
                        billOfLadingService.DeliveryProductProtocol = protocol;

                        if (billOfLadingDocument != null && !billOfLadingService.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                            billOfLadingService.BillOfLadingDocuments.Add(billOfLadingDocument);

                        billOfLadingService.User = user;

                        taskFromList.BillOfLadingServices.Add(billOfLadingService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return billOfLadingService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [BillOfLadingService] " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [BillOfLadingService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] " +
                    "ON [SupplyOrganization].ID = [BillOfLadingService].SupplyOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [BillOfLadingService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [BillOfLadingDocument] " +
                    "ON [BillOfLadingDocument].[BillOfLadingServiceID] = [BillOfLadingService].[ID] " +
                    "AND [BillOfLadingDocument].[Deleted] = 0 " +
                    "LEFT JOIN [User] AS [BillOfLadingServiceUser] " +
                    "ON [BillOfLadingServiceUser].ID = [BillOfLadingService].UserID " +
                    "LEFT JOIN [SupplyInvoiceBillOfLadingService] " +
                    "ON [SupplyInvoiceBillOfLadingService].[BillOfLadingServiceID] = [BillOfLadingService].[ID] " +
                    "LEFT JOIN [SupplyInvoice] " +
                    "ON [SupplyInvoice].[ID] = [SupplyInvoiceBillOfLadingService].[SupplyInvoiceID] " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].[SupplyInvoiceID] = [SupplyInvoice].[ID] " +
                    "AND [InvoiceDocument].[Deleted] = 0 " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [SupplyInvoice].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [SupplyOrder].ClientID = [Client].ID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "LEFT JOIN [DeliveryProductProtocol] " +
                    "ON [DeliveryProductProtocol].ID = [BillOfLadingService].DeliveryProductProtocolID " +
                    "WHERE [BillOfLadingService].ID IN @Ids ",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.BillOfLadingService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingBillOfLadingService))) {
                Type[] includesTypes = {
                    typeof(BillOfLadingService),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(BillOfLadingDocument),
                    typeof(User),
                    typeof(SupplyInvoiceBillOfLadingService),
                    typeof(SupplyInvoice),
                    typeof(InvoiceDocument),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber),
                    typeof(DeliveryProductProtocol)
                };

                Func<object[], BillOfLadingService> includesMapper = objects => {
                    BillOfLadingService billOfLadingService = (BillOfLadingService)objects[0];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[1];
                    SupplyOrganization supplyOrganization = (SupplyOrganization)objects[2];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[3];
                    Currency currency = (Currency)objects[4];
                    BillOfLadingDocument billOfLadingDocument = (BillOfLadingDocument)objects[5];
                    User user = (User)objects[6];
                    SupplyInvoiceBillOfLadingService supplyInvoiceBillOfLadingService = (SupplyInvoiceBillOfLadingService)objects[7];
                    SupplyInvoice supplyInvoice = (SupplyInvoice)objects[8];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[9];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[10];
                    Client client = (Client)objects[11];
                    Region region = (Region)objects[12];
                    RegionCode regionCode = (RegionCode)objects[13];
                    Country country = (Country)objects[14];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[15];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[16];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[17];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[18];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[19];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[20];
                    PackingMarking packingMarking = (PackingMarking)objects[21];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[22];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[23];
                    Agreement agreement = (Agreement)objects[24];
                    ProviderPricing providerPricing = (ProviderPricing)objects[25];
                    Currency providerPricingCurrency = (Currency)objects[26];
                    Pricing pricing = (Pricing)objects[27];
                    PriceType priceType = (PriceType)objects[28];
                    Organization agreementOrganization = (Organization)objects[29];
                    Currency agreementCurrency = (Currency)objects[30];
                    Organization organization = (Organization)objects[31];
                    Organization supplyOrganizationOrganization = (Organization)objects[32];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[33];
                    DeliveryProductProtocol protocol = (DeliveryProductProtocol)objects[34];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.BillOfLadingServices.Any()) {
                        if (taskFromList.BillOfLadingServices.Any(s => s.Id.Equals(billOfLadingService.Id))) {
                            BillOfLadingService serviceFromList = taskFromList.BillOfLadingServices.First(s => s.Id.Equals(billOfLadingService.Id));

                            if (billOfLadingDocument != null && !serviceFromList.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                                serviceFromList.BillOfLadingDocuments.Add(billOfLadingDocument);

                            if (supplyInvoiceBillOfLadingService != null &&
                                !serviceFromList.SupplyInvoiceBillOfLadingServices.Any(s => s.Id.Equals(supplyInvoiceBillOfLadingService.Id))) {
                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyInvoice.SupplyOrder = supplyOrder;

                                supplyInvoiceBillOfLadingService.SupplyInvoice = supplyInvoice;

                                if (invoiceDocument != null && !supplyInvoice.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                    supplyInvoice.InvoiceDocuments.Add(invoiceDocument);

                                serviceFromList.SupplyInvoiceBillOfLadingServices.Add(supplyInvoiceBillOfLadingService);
                            }
                        } else {
                            if (billOfLadingDocument != null && !billOfLadingService.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                                billOfLadingService.BillOfLadingDocuments.Add(billOfLadingDocument);

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            if (supplyInvoiceBillOfLadingService != null) {
                                if (client != null) {
                                    if (clientBankDetails != null) {
                                        if (clientBankDetailAccountNumber != null) {
                                            clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                            clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                        }

                                        if (clientBankDetailIbanNo != null) {
                                            clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                            clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                        }
                                    }

                                    if (clientAgreement != null) {
                                        if (providerPricing != null) {
                                            if (pricing != null) pricing.PriceType = priceType;

                                            providerPricing.Currency = providerPricingCurrency;
                                            providerPricing.Pricing = pricing;
                                        }

                                        agreement.Organization = agreementOrganization;
                                        agreement.Currency = agreementCurrency;
                                        agreement.ProviderPricing = providerPricing;

                                        clientAgreement.Agreement = agreement;

                                        client.ClientAgreements.Add(clientAgreement);
                                    }

                                    client.Region = region;
                                    client.RegionCode = regionCode;
                                    client.Country = country;
                                    client.ClientBankDetails = clientBankDetails;
                                    client.TermsOfDelivery = termsOfDelivery;
                                    client.PackingMarking = packingMarking;
                                    client.PackingMarkingPayment = packingMarkingPayment;
                                }

                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyInvoice.SupplyOrder = supplyOrder;

                                supplyInvoiceBillOfLadingService.SupplyInvoice = supplyInvoice;

                                billOfLadingService.SupplyInvoiceBillOfLadingServices.Add(supplyInvoiceBillOfLadingService);
                            }

                            billOfLadingService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            billOfLadingService.SupplyOrganization = supplyOrganization;

                            protocol.Organization = organization;
                            billOfLadingService.DeliveryProductProtocol = protocol;

                            if (billOfLadingDocument != null && !billOfLadingService.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                                billOfLadingService.BillOfLadingDocuments.Add(billOfLadingDocument);

                            billOfLadingService.User = user;

                            taskFromList.BillOfLadingServices.Add(billOfLadingService);

                            decimal exchangeRateAmount = 1;

                            if (currency != null) {
                                if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                                if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                    if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                        PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                    } else {
                                        groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                            Currency = currency,
                                            TotalPrice = taskFromList.GrossPrice
                                        });
                                    }
                                }
                            }

                            if (exchangeRateAmount < decimal.Zero) {
                                exchangeRateAmount = 0 - exchangeRateAmount;

                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                            } else {
                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                            }

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                                groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                            }
                        }
                    } else {
                        if (billOfLadingDocument != null && !billOfLadingService.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                            billOfLadingService.BillOfLadingDocuments.Add(billOfLadingDocument);

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyInvoiceBillOfLadingService != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            supplyInvoice.SupplyOrder = supplyOrder;

                            supplyInvoiceBillOfLadingService.SupplyInvoice = supplyInvoice;

                            billOfLadingService.SupplyInvoiceBillOfLadingServices.Add(supplyInvoiceBillOfLadingService);
                        }

                        billOfLadingService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        billOfLadingService.SupplyOrganization = supplyOrganization;

                        protocol.Organization = supplyOrganizationOrganization;
                        billOfLadingService.DeliveryProductProtocol = protocol;

                        if (billOfLadingDocument != null && !billOfLadingService.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                            billOfLadingService.BillOfLadingDocuments.Add(billOfLadingDocument);

                        billOfLadingService.User = user;

                        taskFromList.BillOfLadingServices.Add(billOfLadingService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return billOfLadingService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [BillOfLadingService] " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [BillOfLadingService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] " +
                    "ON [SupplyOrganization].ID = [BillOfLadingService].SupplyOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [BillOfLadingService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [BillOfLadingDocument] " +
                    "ON [BillOfLadingDocument].[BillOfLadingServiceID] = [BillOfLadingService].[ID] " +
                    "AND [BillOfLadingDocument].[Deleted] = 0 " +
                    "LEFT JOIN [User] AS [BillOfLadingServiceUser] " +
                    "ON [BillOfLadingServiceUser].ID = [BillOfLadingService].UserID " +
                    "LEFT JOIN [SupplyInvoiceBillOfLadingService] " +
                    "ON [SupplyInvoiceBillOfLadingService].[BillOfLadingServiceID] = [BillOfLadingService].[ID] " +
                    "LEFT JOIN [SupplyInvoice] " +
                    "ON [SupplyInvoice].[ID] = [SupplyInvoiceBillOfLadingService].[SupplyInvoiceID] " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].[SupplyInvoiceID] = [SupplyInvoice].[ID] " +
                    "AND [InvoiceDocument].[Deleted] = 0 " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [SupplyInvoice].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [SupplyOrder].ClientID = [Client].ID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "LEFT JOIN [DeliveryProductProtocol] " +
                    "ON [DeliveryProductProtocol].ID = [BillOfLadingService].DeliveryProductProtocolID " +
                    "WHERE [BillOfLadingService].ID IN @Ids ",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingBillOfLadingService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }
        }

        return groupedPaymentTaskWithTotals;
    }

    public GroupedPaymentTaskWithTotals GetAvailableForPaymentGroupedPaymentTasksFiltered(DateTime from, DateTime to, Guid? organizationNetId, long limit, long offset) {
        GroupedPaymentTaskWithTotals groupedPaymentTaskWithTotals = new();

        string totalsSqlExpression =
            ";WITH [GroupedTaskPriceWithCurrency_CTE] " +
            "AS " +
            "( " +
            "SELECT [SupplyPaymentTask].ID " +
            ",ROUND(" +
            "[SupplyPaymentTask].GrossPrice " +
            "- " +
            "(" +
            "SELECT ISNULL(SUM([OutcomePaymentOrderSupplyPaymentTask].Amount), 0) " +
            "FROM [OutcomePaymentOrderSupplyPaymentTask] " +
            "WHERE [OutcomePaymentOrderSupplyPaymentTask].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "AND [OutcomePaymentOrderSupplyPaymentTask].Deleted = 0" +
            ")" +
            ", 2) AS [GrossPrice] " +
            ",( " +
            "CASE " +
            "WHEN [SupplyOrderPolandPaymentDeliveryProtocol].ID IS NOT NULL " +
            "THEN (SELECT [Currency].ID FROM [Currency] WHERE [Currency].Deleted = 0 AND [Currency].Code = N'pln') " +
            "WHEN [SupplyOrderPaymentDeliveryProtocol].ID IS NOT NULL " +
            "THEN [Agreement].CurrencyID " +
            "WHEN [ContainerService].ID IS NOT NULL " +
            "THEN [ContainerAgreement].CurrencyID " +
            "WHEN [VehicleService].ID IS NOT NULL " +
            "THEN [VehicleAgreement].CurrencyID " +
            "WHEN [CustomService].ID IS NOT NULL " +
            "THEN [CustomAgreement].CurrencyID " +
            "WHEN [PortWorkService].ID IS NOT NULL " +
            "THEN [PortWorkAgreement].CurrencyID " +
            "WHEN [TransportationService].ID IS NOT NULL " +
            "THEN [TransportationAgreement].CurrencyID " +
            "WHEN [PortCustomAgencyService].ID IS NOT NULL " +
            "THEN [PortCustomAgencyAgreement].CurrencyID " +
            "WHEN [CustomAgencyService].ID IS NOT NULL " +
            "THEN [CustomAgencyAgreement].CurrencyID " +
            "WHEN [PlaneDeliveryService].ID IS NOT NULL " +
            "THEN [PlaneDeliveryAgreement].CurrencyID " +
            "WHEN [VehicleDeliveryService].ID IS NOT NULL " +
            "THEN [VehicleDeliveryAgreement].CurrencyID " +
            "WHEN [ConsumablesOrder].ID IS NOT NULL " +
            "THEN [ConsumablesAgreement].CurrencyID " +
            "WHEN [MergedService].ID IS NOT NULL " +
            "THEN [MergedAgreement].CurrencyID " +
            "WHEN [BillOfLadingService].ID IS NOT NULL " +
            "THEN [BillOfLadingServiceAgreement].CurrencyID " +
            "WHEN [SupplyOrderUkrainePaymentDeliveryProtocol].ID IS NOT NULL " +
            "THEN [SupplyOrderUkraineAgreement].CurrencyID " +
            "END " +
            ") AS [CurrencyID] " +
            "FROM [SupplyPaymentTask] " +
            "LEFT JOIN [User] " +
            "ON [User].ID = [SupplyPaymentTask].UserID " +
            "LEFT JOIN [SupplyOrderPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyInvoice] " +
            "ON [SupplyInvoice].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyInvoiceID " +
            "LEFT JOIN [SupplyProForm] " +
            "ON [SupplyProForm].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyProFormID " +
            "LEFT JOIN [SupplyOrderPolandPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPolandPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrder] " +
            "ON ( " +
            "( " +
            "[SupplyInvoice].ID IS NOT NULL " +
            "AND " +
            "[SupplyOrder].ID = [SupplyInvoice].SupplyOrderID " +
            ") " +
            "OR " +
            "( " +
            "[SupplyProForm].ID IS NOT NULL " +
            "AND " +
            "[SupplyProForm].ID = [SupplyOrder].SupplyProFormID " +
            ") " +
            "OR " +
            "( " +
            "[SupplyOrderPolandPaymentDeliveryProtocol].ID IS NOT NULL " +
            "AND " +
            "[SupplyOrder].ID = [SupplyOrderPolandPaymentDeliveryProtocol].SupplyOrderID " +
            ") " +
            ") " +
            "LEFT JOIN [Client] " +
            "ON [Client].ID = [SupplyOrder].ClientID " +
            "LEFT JOIN [ClientAgreement] " +
            "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
            "LEFT JOIN [Agreement] " +
            "ON [Agreement].ID = [ClientAgreement].AgreementID " +
            "LEFT JOIN [Organization] AS [AgreementOrganization] " +
            "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
            "LEFT JOIN [ContainerService] " +
            "ON [ContainerService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [ContainerService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [ContainerOrganization] " +
            "ON [ContainerService].ContainerOrganizationID = [ContainerOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [ContainerAgreement] " +
            "ON [ContainerAgreement].ID = [ContainerService].SupplyOrganizationAgreementID " +
            "LEFT JOIN [Organization] AS [ContainerOrganizationOrganization] " +
            "ON [ContainerOrganizationOrganization].ID = [ContainerAgreement].OrganizationID " +
            "LEFT JOIN [VehicleService] " +
            "ON [VehicleService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [VehicleService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [VehicleOrganization] " +
            "ON [VehicleService].VehicleOrganizationID = [VehicleOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleAgreement] " +
            "ON [VehicleAgreement].ID = [VehicleService].SupplyOrganizationAgreementID " +
            "LEFT JOIN [Organization] AS [VehicleOrganizationOrganization] " +
            "ON [VehicleOrganizationOrganization].ID = [VehicleAgreement].OrganizationID " +
            "LEFT JOIN [CustomService] " +
            "ON [CustomService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [CustomService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [CustomOrganization] " +
            "ON [CustomService].CustomOrganizationID = [CustomOrganization].ID " +
            "OR [CustomService].ExciseDutyOrganizationID = [CustomOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomAgreement] " +
            "ON [CustomAgreement].ID = [CustomService].SupplyOrganizationAgreementID " +
            "LEFT JOIN [Organization] AS [CustomOrganizationOrganization] " +
            "ON [CustomOrganizationOrganization].ID = [CustomAgreement].OrganizationID " +
            "LEFT JOIN [PortWorkService] " +
            "ON [PortWorkService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [PortWorkService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [PortWorkOrganization] " +
            "ON [PortWorkService].PortWorkOrganizationID = [PortWorkOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [PortWorkAgreement] " +
            "ON [PortWorkAgreement].ID = [PortWorkService].SupplyOrganizationAgreementID " +
            "LEFT JOIN [Organization] AS [PortWorkOrganizationOrganization] " +
            "ON [PortWorkOrganizationOrganization].ID = [PortWorkAgreement].OrganizationID " +
            "LEFT JOIN [TransportationService] " +
            "ON [TransportationService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [TransportationService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [TransportationOrganization] " +
            "ON [TransportationService].TransportationOrganizationID = [TransportationOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [TransportationAgreement] " +
            "ON [TransportationAgreement].ID = [TransportationService].SupplyOrganizationAgreementID " +
            "LEFT JOIN [Organization] AS [TransportationOrganizationOrganization] " +
            "ON [TransportationOrganizationOrganization].ID = [TransportationAgreement].OrganizationID " +
            "LEFT JOIN [PortCustomAgencyService] " +
            "ON [PortCustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [PortCustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [PortCustomAgencyOrganization] " +
            "ON [PortCustomAgencyService].PortCustomAgencyOrganizationID = [PortCustomAgencyOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [PortCustomAgencyAgreement] " +
            "ON [PortCustomAgencyAgreement].ID = [PortCustomAgencyService].SupplyOrganizationAgreementID " +
            "LEFT JOIN [Organization] AS [PortCustomAgencyOrganizationOrganization] " +
            "ON [PortCustomAgencyOrganizationOrganization].ID = [PortCustomAgencyAgreement].OrganizationID " +
            "LEFT JOIN [CustomAgencyService] " +
            "ON [CustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [CustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [CustomAgencyOrganization] " +
            "ON [CustomAgencyService].CustomAgencyOrganizationID = [CustomAgencyOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomAgencyAgreement] " +
            "ON [CustomAgencyAgreement].ID = [CustomAgencyService].SupplyOrganizationAgreementID " +
            "LEFT JOIN [Organization] AS [CustomAgencyOrganizationOrganization] " +
            "ON [CustomAgencyOrganizationOrganization].ID = [CustomAgencyAgreement].OrganizationID " +
            "LEFT JOIN [PlaneDeliveryService] " +
            "ON [PlaneDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [PlaneDeliveryService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [PlaneDeliveryOrganization] " +
            "ON [PlaneDeliveryService].PlaneDeliveryOrganizationID = [PlaneDeliveryOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [PlaneDeliveryAgreement] " +
            "ON [PlaneDeliveryAgreement].ID = [PlaneDeliveryService].SupplyOrganizationAgreementID " +
            "LEFT JOIN [Organization] AS [PlaneDeliveryOrganizationOrganization] " +
            "ON [PlaneDeliveryOrganizationOrganization].ID = [PlaneDeliveryAgreement].OrganizationID " +
            "LEFT JOIN [VehicleDeliveryService] " +
            "ON [VehicleDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [VehicleDeliveryService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [VehicleDeliveryOrganization] " +
            "ON [VehicleDeliveryService].VehicleDeliveryOrganizationID = [VehicleDeliveryOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleDeliveryAgreement] " +
            "ON [VehicleDeliveryAgreement].ID = [VehicleDeliveryService].SupplyOrganizationAgreementID " +
            "LEFT JOIN [Organization] AS [VehicleDeliveryOrganizationOrganization] " +
            "ON [VehicleDeliveryOrganizationOrganization].ID = [VehicleDeliveryAgreement].OrganizationID " +
            "LEFT JOIN [ConsumablesOrder] " +
            "ON [ConsumablesOrder].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [ConsumablesOrderItem] " +
            "ON [ConsumablesOrderItem].ConsumablesOrderID = [ConsumablesOrder].ID " +
            "LEFT JOIN [SupplyOrganization] AS [ConsumableProductOrganization] " +
            "ON [ConsumablesOrderItem].ConsumableProductOrganizationID = [ConsumableProductOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [ConsumablesAgreement] " +
            "ON [ConsumablesAgreement].ID = [ConsumablesOrderItem].SupplyOrganizationAgreementID " +
            "LEFT JOIN [Organization] AS [ConsumableProductOrganizationOrganization] " +
            "ON [ConsumableProductOrganizationOrganization].ID = [ConsumablesAgreement].OrganizationID " +
            "LEFT JOIN [MergedService] " +
            "ON [MergedService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [MergedService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [MergedSupplyOrganization] " +
            "ON [MergedSupplyOrganization].ID = [MergedService].SupplyOrganizationID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [MergedAgreement] " +
            "ON [MergedAgreement].ID = [MergedService].SupplyOrganizationAgreementID " +
            "LEFT JOIN [Organization] AS [MergedOrganizationOrganization] " +
            "ON [MergedOrganizationOrganization].ID = [MergedAgreement].OrganizationID " +
            "LEFT JOIN [BillOfLadingService] " +
            "ON [BillOfLadingService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [BillOfLadingService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] " +
            "ON [SupplyOrganization].ID = [BillOfLadingService].SupplyOrganizationID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [BillOfLadingServiceAgreement] " +
            "ON [BillOfLadingServiceAgreement].ID = [BillOfLadingService].SupplyOrganizationAgreementID " +
            "LEFT JOIN [Organization] AS [BillOfLadingServiceOrganizationOrganization] " +
            "ON [BillOfLadingServiceOrganizationOrganization].ID = [BillOfLadingServiceAgreement].OrganizationID " +
            "LEFT JOIN [SupplyOrderUkrainePaymentDeliveryProtocol] " +
            "ON [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrderUkraine] " +
            "ON [SupplyOrderUkraine].ID = [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyOrderUkraineID " +
            "LEFT JOIN [ClientAgreement] AS [SupplyOrderUkraineClientAgreement] " +
            "ON [SupplyOrderUkraineClientAgreement].ID = [SupplyOrderUkraine].ClientAgreementID " +
            "LEFT JOIN [Agreement] AS [SupplyOrderUkraineAgreement] " +
            "ON [SupplyOrderUkraineAgreement].ID = [SupplyOrderUkraineClientAgreement].AgreementID " +
            "LEFT JOIN [Organization] AS [SupplyOrderUkraineAgreementOrganization]" +
            "ON [SupplyOrderUkraineAgreementOrganization].ID = [SupplyOrderUkraineAgreement].OrganizationID " +
            "WHERE [SupplyPaymentTask].[Deleted] = 0 " +
            "AND [SupplyPaymentTask].TaskStatus <> 1 " +
            "AND [SupplyPaymentTask].[PayToDate] >= @From " +
            "AND [SupplyPaymentTask].[PayToDate] <= @To " +
            "AND [SupplyPaymentTask].[IsImportedFromOneC] = 0 " +
            "AND (" +
            "[SupplyPaymentTask].GrossPrice " +
            "- " +
            "(" +
            "SELECT ISNULL(SUM([OutcomePaymentOrderSupplyPaymentTask].Amount), 0) " +
            "FROM [OutcomePaymentOrderSupplyPaymentTask] " +
            "WHERE [OutcomePaymentOrderSupplyPaymentTask].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "AND [OutcomePaymentOrderSupplyPaymentTask].Deleted = 0" +
            ")" +
            ") > 0 ";

        if (organizationNetId.HasValue)
            totalsSqlExpression +=
                "AND ( " +
                "([AgreementOrganization].NetUID = @OrganizationNetId AND [AgreementOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([ContainerOrganizationOrganization].NetUID = @OrganizationNetId AND [ContainerOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([VehicleOrganizationOrganization].NetUID = @OrganizationNetId AND [VehicleOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([CustomOrganizationOrganization].NetUID = @OrganizationNetId AND [CustomOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PortWorkOrganizationOrganization].NetUID = @OrganizationNetId AND [PortWorkOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([TransportationOrganizationOrganization].NetUID = @OrganizationNetId AND [TransportationOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PortCustomAgencyOrganizationOrganization].NetUID = @OrganizationNetId AND [PortCustomAgencyOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([CustomAgencyOrganizationOrganization].NetUID = @OrganizationNetId AND [CustomAgencyOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PlaneDeliveryOrganizationOrganization].NetUID = @OrganizationNetId AND [PlaneDeliveryOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([VehicleDeliveryOrganizationOrganization].NetUID = @OrganizationNetId AND [VehicleDeliveryOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([ConsumableProductOrganizationOrganization].NetUID = @OrganizationNetId AND [ConsumableProductOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([MergedOrganizationOrganization].NetUID = @OrganizationNetId AND [MergedOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([BillOfLadingServiceOrganizationOrganization].NetUID = @OrganizationNetId AND [BillOfLadingServiceOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([SupplyOrderUkraineAgreementOrganization].NetUID = @OrganizationNetId AND [SupplyOrderUkraineAgreementOrganization].NetUID IS NOT NULL) " +
                ") ";

        totalsSqlExpression +=
            "GROUP BY [SupplyPaymentTask].ID " +
            ",[SupplyPaymentTask].GrossPrice " +
            ",[SupplyOrderPolandPaymentDeliveryProtocol].ID " +
            ",[SupplyOrderPaymentDeliveryProtocol].ID " +
            ",[ContainerService].ID " +
            ",[VehicleService].ID " +
            ",[CustomService].ID " +
            ",[PortWorkService].ID " +
            ",[TransportationService].ID " +
            ",[PortCustomAgencyService].ID " +
            ",[CustomAgencyService].ID " +
            ",[PlaneDeliveryService].ID " +
            ",[VehicleDeliveryService].ID " +
            ",[ConsumablesOrder].ID " +
            ",[MergedService].ID " +
            ",[BillOfLadingService].ID " +
            ",[SupplyOrderUkrainePaymentDeliveryProtocol].ID " +
            ",[Agreement].CurrencyID " +
            ",[ContainerAgreement].CurrencyID " +
            ",[VehicleAgreement].CurrencyID " +
            ",[CustomAgreement].CurrencyID " +
            ",[PortWorkAgreement].CurrencyID " +
            ",[TransportationAgreement].CurrencyID " +
            ",[PortCustomAgencyAgreement].CurrencyID " +
            ",[CustomAgencyAgreement].CurrencyID " +
            ",[PlaneDeliveryAgreement].CurrencyID " +
            ",[VehicleDeliveryAgreement].CurrencyID " +
            ",[ConsumablesAgreement].CurrencyID " +
            ",[MergedAgreement].CurrencyID " +
            ",[BillOfLadingServiceAgreement].CurrencyID " +
            ",[SupplyOrderUkraineAgreement].CurrencyID " +
            ") " +
            "SELECT [Currency].* " +
            ",[GroupedTaskPriceWithCurrency_CTE].GrossPrice " +
            "FROM [GroupedTaskPriceWithCurrency_CTE] " +
            "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
            "ON [Currency].ID = [GroupedTaskPriceWithCurrency_CTE].CurrencyID " +
            "AND [Currency].CultureCode = @Culture ";

        _connection.Query<Currency, decimal, Currency>(
            totalsSqlExpression,
            (currency, grossAmount) => {
                if (currency == null || currency.IsNew()) currency = GetEUR();

                if (currency.Code.ToLower().Equals("eur")) {
                    groupedPaymentTaskWithTotals.TotalGrossPrice = Math.Round(groupedPaymentTaskWithTotals.TotalGrossPrice + grossAmount, 2);

                    if (groupedPaymentTaskWithTotals.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                        PriceTotal totalFromList = groupedPaymentTaskWithTotals.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + grossAmount, 2);
                    } else {
                        groupedPaymentTaskWithTotals.PriceTotals.Add(new PriceTotal {
                            Currency = currency,
                            TotalPrice = Math.Round(grossAmount, 2)
                        });
                    }
                } else {
                    decimal exchangeRateAmount = 1;

                    exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                    if (exchangeRateAmount < decimal.Zero) {
                        exchangeRateAmount = 0 - exchangeRateAmount;

                        groupedPaymentTaskWithTotals.TotalGrossPrice = Math.Round(groupedPaymentTaskWithTotals.TotalGrossPrice + grossAmount / exchangeRateAmount, 2);
                    } else {
                        groupedPaymentTaskWithTotals.TotalGrossPrice = Math.Round(groupedPaymentTaskWithTotals.TotalGrossPrice + grossAmount * exchangeRateAmount, 2);
                    }

                    if (groupedPaymentTaskWithTotals.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                        PriceTotal totalFromList = groupedPaymentTaskWithTotals.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + grossAmount, 2);
                    } else {
                        groupedPaymentTaskWithTotals.PriceTotals.Add(new PriceTotal {
                            Currency = currency,
                            TotalPrice = Math.Round(grossAmount, 2)
                        });
                    }
                }

                return currency;
            },
            new { From = from, To = to, OrganizationNetId = organizationNetId ?? Guid.Empty, Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName },
            splitOn: "ID,GrossPrice"
        );

        List<JoinService> joinServices = new();

        string groupedTasksSqlExpression =
            ";WITH [Search_CTE] " +
            "AS " +
            "( " +
            "SELECT ROW_NUMBER() OVER (ORDER BY [PayToDate]) AS RowNumber " +
            ",CONVERT(date, [PayToDate]) [PayToDate] " +
            "FROM " +
            "( " +
            "SELECT DISTINCT CONVERT(date, [SupplyPaymentTask].PayToDate) [PayToDate] " +
            "FROM [SupplyPaymentTask] " +
            "LEFT JOIN [SupplyOrderPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyInvoice] " +
            "ON [SupplyInvoice].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyInvoiceID " +
            "LEFT JOIN [SupplyProForm] " +
            "ON [SupplyProForm].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyProFormID " +
            "LEFT JOIN [SupplyOrderPolandPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPolandPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrder] " +
            "ON ( " +
            "( " +
            "[SupplyInvoice].ID IS NOT NULL " +
            "AND " +
            "[SupplyOrder].ID = [SupplyInvoice].SupplyOrderID " +
            ") " +
            "OR " +
            "( " +
            "[SupplyProForm].ID IS NOT NULL " +
            "AND " +
            "[SupplyProForm].ID = [SupplyOrder].SupplyProFormID " +
            ") " +
            "OR " +
            "( " +
            "[SupplyOrderPolandPaymentDeliveryProtocol].ID IS NOT NULL " +
            "AND " +
            "[SupplyOrder].ID = [SupplyOrderPolandPaymentDeliveryProtocol].SupplyOrderID " +
            ") " +
            ") " +
            "LEFT JOIN [Client] " +
            "ON [Client].ID = [SupplyOrder].ClientID " +
            "LEFT JOIN [ClientAgreement] " +
            "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
            "LEFT JOIN [Agreement] " +
            "ON [Agreement].ID = [ClientAgreement].AgreementID " +
            "LEFT JOIN [Organization] AS [AgreementOrganization] " +
            "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
            "LEFT JOIN [ContainerService] " +
            "ON [ContainerService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [ContainerService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [ContainerOrganization] " +
            "ON [ContainerService].ContainerOrganizationID = [ContainerOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [ContainerOrganizationAgreement] " +
            "ON [ContainerService].SupplyOrganizationAgreementID = [ContainerOrganizationAgreement].ID " +
            "LEFT JOIN [Organization] AS [ContainerOrganizationOrganization] " +
            "ON [ContainerOrganizationOrganization].ID = [ContainerOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [VehicleService] " +
            "ON [VehicleService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [VehicleService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [VehicleOrganization] " +
            "ON [VehicleService].VehicleOrganizationID = [VehicleOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleOrganizationAgreement] " +
            "ON [VehicleService].SupplyOrganizationAgreementID = [VehicleOrganizationAgreement].ID " +
            "LEFT JOIN [Organization] AS [VehicleOrganizationOrganization] " +
            "ON [VehicleOrganizationOrganization].ID = [VehicleOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [CustomService] " +
            "ON [CustomService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [CustomService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [CustomOrganization] " +
            "ON [CustomService].CustomOrganizationID = [CustomOrganization].ID " +
            "OR [CustomService].ExciseDutyOrganizationID = [CustomOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomOrganizationAgreement] " +
            "ON [CustomService].SupplyOrganizationAgreementID = [CustomOrganizationAgreement].ID " +
            "LEFT JOIN [Organization] AS [CustomOrganizationOrganization] " +
            "ON [CustomOrganizationOrganization].ID = [CustomOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [PortWorkService] " +
            "ON [PortWorkService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [PortWorkService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [PortWorkOrganization] " +
            "ON [PortWorkService].PortWorkOrganizationID = [PortWorkOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [PortWorkOrganizationAgreement] " +
            "ON [PortWorkService].SupplyOrganizationAgreementID = [PortWorkOrganizationAgreement].ID " +
            "LEFT JOIN [Organization] AS [PortWorkOrganizationOrganization] " +
            "ON [PortWorkOrganizationOrganization].ID = [PortWorkOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [TransportationService] " +
            "ON [TransportationService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [TransportationService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [TransportationOrganization] " +
            "ON [TransportationService].TransportationOrganizationID = [TransportationOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [TransportationOrganizationAgreement] " +
            "ON [TransportationService].SupplyOrganizationAgreementID = [TransportationOrganizationAgreement].ID " +
            "LEFT JOIN [Organization] AS [TransportationOrganizationOrganization] " +
            "ON [TransportationOrganizationOrganization].ID = [TransportationOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [PortCustomAgencyService] " +
            "ON [PortCustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [PortCustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [PortCustomAgencyOrganization] " +
            "ON [PortCustomAgencyService].PortCustomAgencyOrganizationID = [PortCustomAgencyOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [PortCustomAgencyOrganizationAgreement] " +
            "ON [PortCustomAgencyService].SupplyOrganizationAgreementID = [PortCustomAgencyOrganizationAgreement].ID " +
            "LEFT JOIN [Organization] AS [PortCustomAgencyOrganizationOrganization] " +
            "ON [PortCustomAgencyOrganizationOrganization].ID = [PortCustomAgencyOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [CustomAgencyService] " +
            "ON [CustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [CustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [CustomAgencyOrganization] " +
            "ON [CustomAgencyService].CustomAgencyOrganizationID = [CustomAgencyOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomAgencyOrganizationAgreement] " +
            "ON [CustomAgencyService].SupplyOrganizationAgreementID = [CustomAgencyOrganizationAgreement].ID " +
            "LEFT JOIN [Organization] AS [CustomAgencyOrganizationOrganization] " +
            "ON [CustomAgencyOrganizationOrganization].ID = [CustomAgencyOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [PlaneDeliveryService] " +
            "ON [PlaneDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [PlaneDeliveryService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [PlaneDeliveryOrganization] " +
            "ON [PlaneDeliveryService].PlaneDeliveryOrganizationID = [PlaneDeliveryOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [PlaneDeliveryOrganizationAgreement] " +
            "ON [PlaneDeliveryService].SupplyOrganizationAgreementID = [PlaneDeliveryOrganizationAgreement].ID " +
            "LEFT JOIN [Organization] AS [PlaneDeliveryOrganizationOrganization] " +
            "ON [PlaneDeliveryOrganizationOrganization].ID = [PlaneDeliveryOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [VehicleDeliveryService] " +
            "ON [VehicleDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [VehicleDeliveryService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [VehicleDeliveryOrganization] " +
            "ON [VehicleDeliveryService].VehicleDeliveryOrganizationID = [VehicleDeliveryOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleDeliveryOrganizationAgreement] " +
            "ON [VehicleDeliveryService].SupplyOrganizationAgreementID = [VehicleDeliveryOrganizationAgreement].ID " +
            "LEFT JOIN [Organization] AS [VehicleDeliveryOrganizationOrganization] " +
            "ON [VehicleDeliveryOrganizationOrganization].ID = [VehicleDeliveryOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [ConsumablesOrder] " +
            "ON [ConsumablesOrder].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [ConsumablesOrderItem] " +
            "ON [ConsumablesOrderItem].ConsumablesOrderID = [ConsumablesOrder].ID " +
            "LEFT JOIN [SupplyOrganization] AS [ConsumableProductOrganization] " +
            "ON [ConsumablesOrderItem].ConsumableProductOrganizationID = [ConsumableProductOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [ConsumablesOrganizationAgreement] " +
            "ON [ConsumablesOrderItem].SupplyOrganizationAgreementID = [ConsumablesOrganizationAgreement].ID " +
            "LEFT JOIN [Organization] AS [ConsumableProductOrganizationOrganization] " +
            "ON [ConsumableProductOrganizationOrganization].ID = [ConsumablesOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [MergedService] " +
            "ON [MergedService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [MergedService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [MergedSupplyOrganization] " +
            "ON [MergedSupplyOrganization].ID = [MergedService].SupplyOrganizationID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [MergedOrganizationAgreement] " +
            "ON [MergedService].SupplyOrganizationAgreementID = [MergedOrganizationAgreement].ID " +
            "LEFT JOIN [Organization] AS [MergedOrganizationOrganization] " +
            "ON [MergedOrganizationOrganization].ID = [MergedOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [BillOfLadingService] " +
            "ON [BillOfLadingService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [BillOfLadingService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] " +
            "ON [SupplyOrganization].ID = [BillOfLadingService].SupplyOrganizationID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [BillOfLadingOrganizationAgreement] " +
            "ON [BillOfLadingService].SupplyOrganizationAgreementID = [BillOfLadingOrganizationAgreement].ID " +
            "LEFT JOIN [Organization] AS [BillOfLadingServiceOrganizationOrganization] " +
            "ON [BillOfLadingServiceOrganizationOrganization].ID = [BillOfLadingOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [SupplyOrderUkrainePaymentDeliveryProtocol] " +
            "ON [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrderUkraine] " +
            "ON [SupplyOrderUkraine].ID = [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyOrderUkraineID " +
            "LEFT JOIN [ClientAgreement] AS [SupplyOrderUkraineClientAgreement] " +
            "ON [SupplyOrderUkraineClientAgreement].ID = [SupplyOrderUkraine].ClientAgreementID " +
            "LEFT JOIN [Agreement] AS [SupplyOrderUkraineAgreement] " +
            "ON [SupplyOrderUkraineAgreement].ID = [SupplyOrderUkraineClientAgreement].AgreementID " +
            "LEFT JOIN [Organization] AS [SupplyOrderUkraineAgreementOrganization]" +
            "ON [SupplyOrderUkraineAgreementOrganization].ID = [SupplyOrderUkraineAgreement].OrganizationID " +
            "WHERE [SupplyPaymentTask].[Deleted] = 0 " +
            "AND [SupplyPaymentTask].TaskStatus <> 1 " +
            "AND [SupplyPaymentTask].IsAvailableForPayment = 1 " +
            "AND [SupplyPaymentTask].[PayToDate] >= @From " +
            "AND [SupplyPaymentTask].[IsImportedFromOneC] = 0 " +
            "AND [SupplyPaymentTask].[PayToDate] <= @To ";

        if (organizationNetId.HasValue)
            groupedTasksSqlExpression +=
                "AND ( " +
                "([AgreementOrganization].NetUID = @OrganizationNetId AND [AgreementOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([ContainerOrganizationOrganization].NetUID = @OrganizationNetId AND [ContainerOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([VehicleOrganizationOrganization].NetUID = @OrganizationNetId AND [VehicleOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([CustomOrganizationOrganization].NetUID = @OrganizationNetId AND [CustomOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PortWorkOrganizationOrganization].NetUID = @OrganizationNetId AND [PortWorkOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([TransportationOrganizationOrganization].NetUID = @OrganizationNetId AND [TransportationOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PortCustomAgencyOrganizationOrganization].NetUID = @OrganizationNetId AND [PortCustomAgencyOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([CustomAgencyOrganizationOrganization].NetUID = @OrganizationNetId AND [CustomAgencyOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PlaneDeliveryOrganizationOrganization].NetUID = @OrganizationNetId AND [PlaneDeliveryOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([VehicleDeliveryOrganizationOrganization].NetUID = @OrganizationNetId AND [VehicleDeliveryOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([ConsumableProductOrganizationOrganization].NetUID = @OrganizationNetId AND [ConsumableProductOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([MergedOrganizationOrganization].NetUID = @OrganizationNetId AND [MergedOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([BillOfLadingServiceOrganizationOrganization].NetUID = @OrganizationNetId AND [BillOfLadingServiceOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([SupplyOrderUkraineAgreementOrganization].NetUID = @OrganizationNetId AND [SupplyOrderUkraineAgreementOrganization].NetUID IS NOT NULL) " +
                ") ";

        groupedTasksSqlExpression +=
            ") [Distincts] " +
            ") " +
            "SELECT CONVERT(date, [Search_CTE].[PayToDate]) [PayToDate] " +
            ",1 AS [TaskStatus] " +
            "FROM [Search_CTE] " +
            "WHERE [Search_CTE].RowNumber > @Offset " +
            "AND [Search_CTE].RowNumber <= @Limit + @Offset ";

        groupedPaymentTaskWithTotals.GroupedPaymentTasks =
            _connection.Query<GroupedPaymentTask>(
                groupedTasksSqlExpression,
                new {
                    From = from,
                    To = to,
                    OrganizationNetId = organizationNetId ?? Guid.Empty,
                    Limit = limit,
                    Offset = offset
                }).ToList();

        Type[] types = new[] {
            typeof(SupplyPaymentTask),
            typeof(User),
            typeof(SupplyOrderPaymentDeliveryProtocol),
            typeof(SupplyOrderPolandPaymentDeliveryProtocol),
            typeof(ContainerService),
            typeof(VehicleService),
            typeof(CustomService),
            typeof(PortWorkService),
            typeof(TransportationService),
            typeof(PortCustomAgencyService),
            typeof(CustomAgencyService),
            typeof(PlaneDeliveryService),
            typeof(VehicleDeliveryService),
            typeof(ConsumablesOrder),
            typeof(SupplyPaymentTaskDocument),
            typeof(OutcomePaymentOrderSupplyPaymentTask),
            typeof(OutcomePaymentOrder),
            typeof(User),
            typeof(Organization),
            typeof(PaymentCurrencyRegister),
            typeof(PaymentRegister),
            typeof(Currency),
            typeof(PaymentMovementOperation),
            typeof(PaymentMovement),
            typeof(MergedService),
            typeof(BillOfLadingService),
            typeof(SupplyOrderUkrainePaymentDeliveryProtocol)
        };

        Func<object[], SupplyPaymentTask> mapper = objects => {
            SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[0];
            User user = (User)objects[1];
            SupplyOrderPaymentDeliveryProtocol supplyOrderPaymentDeliveryProtocol = (SupplyOrderPaymentDeliveryProtocol)objects[2];
            SupplyOrderPolandPaymentDeliveryProtocol supplyOrderPolandPaymentDeliveryProtocol = (SupplyOrderPolandPaymentDeliveryProtocol)objects[3];
            ContainerService containerService = (ContainerService)objects[4];
            VehicleService vehicleService = (VehicleService)objects[5];
            CustomService customService = (CustomService)objects[6];
            PortWorkService portWorkService = (PortWorkService)objects[7];
            TransportationService transportationService = (TransportationService)objects[8];
            PortCustomAgencyService portCustomAgencyService = (PortCustomAgencyService)objects[9];
            CustomAgencyService customAgencyService = (CustomAgencyService)objects[10];
            PlaneDeliveryService planeDeliveryService = (PlaneDeliveryService)objects[11];
            VehicleDeliveryService vehicleDeliveryService = (VehicleDeliveryService)objects[12];
            ConsumablesOrder consumablesOrder = (ConsumablesOrder)objects[13];
            SupplyPaymentTaskDocument document = (SupplyPaymentTaskDocument)objects[14];
            OutcomePaymentOrderSupplyPaymentTask junctionTask = (OutcomePaymentOrderSupplyPaymentTask)objects[15];
            OutcomePaymentOrder outcome = (OutcomePaymentOrder)objects[16];
            User outcomeUser = (User)objects[17];
            Organization organization = (Organization)objects[18];
            PaymentCurrencyRegister paymentCurrencyRegister = (PaymentCurrencyRegister)objects[19];
            PaymentRegister paymentRegister = (PaymentRegister)objects[20];
            Currency currency = (Currency)objects[21];
            PaymentMovementOperation paymentMovementOperation = (PaymentMovementOperation)objects[22];
            PaymentMovement paymentMovement = (PaymentMovement)objects[23];
            MergedService mergedService = (MergedService)objects[24];
            BillOfLadingService billOfLadingService = (BillOfLadingService)objects[25];
            SupplyOrderUkrainePaymentDeliveryProtocol protocol = (SupplyOrderUkrainePaymentDeliveryProtocol)objects[26];

            GroupedPaymentTask groupedTaskFromList = groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

            if (!groupedTaskFromList.SupplyPaymentTasks.Any(t => t.Id.Equals(supplyPaymentTask.Id))) {
                if (supplyOrderPaymentDeliveryProtocol != null)
                    joinServices.Add(new JoinService(supplyOrderPaymentDeliveryProtocol.Id, JoinServiceType.SupplyOrderPaymentDeliveryProtocol));

                if (supplyOrderPolandPaymentDeliveryProtocol != null)
                    joinServices.Add(new JoinService(supplyOrderPolandPaymentDeliveryProtocol.Id, JoinServiceType.SupplyOrderPolandPaymentDeliveryProtocol));

                if (containerService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(containerService.Id, JoinServiceType.AccountingContainerService));
                    else
                        joinServices.Add(new JoinService(containerService.Id, JoinServiceType.ContainerService));
                }

                if (vehicleService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(vehicleService.Id, JoinServiceType.AccountingVehicleService));
                    else
                        joinServices.Add(new JoinService(vehicleService.Id, JoinServiceType.VehicleService));
                }

                if (customService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(customService.Id, JoinServiceType.AccountingCustomService));
                    else
                        joinServices.Add(new JoinService(customService.Id, JoinServiceType.CustomService));
                }

                if (portWorkService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(portWorkService.Id, JoinServiceType.AccountingPortWorkService));
                    else
                        joinServices.Add(new JoinService(portWorkService.Id, JoinServiceType.PortWorkService));
                }

                if (transportationService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(transportationService.Id, JoinServiceType.AccountingTransportationService));
                    else
                        joinServices.Add(new JoinService(transportationService.Id, JoinServiceType.TransportationService));
                }

                if (portCustomAgencyService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(portCustomAgencyService.Id, JoinServiceType.AccountingPortCustomAgencyService));
                    else
                        joinServices.Add(new JoinService(portCustomAgencyService.Id, JoinServiceType.PortCustomAgencyService));
                }

                if (customAgencyService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(customAgencyService.Id, JoinServiceType.AccountingCustomAgencyService));
                    else
                        joinServices.Add(new JoinService(customAgencyService.Id, JoinServiceType.CustomAgencyService));
                }

                if (planeDeliveryService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(planeDeliveryService.Id, JoinServiceType.AccountingPlaneDeliveryService));
                    else
                        joinServices.Add(new JoinService(planeDeliveryService.Id, JoinServiceType.PlaneDeliveryService));
                }

                if (vehicleDeliveryService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(vehicleDeliveryService.Id, JoinServiceType.AccountingVehicleDeliveryService));
                    else
                        joinServices.Add(new JoinService(vehicleDeliveryService.Id, JoinServiceType.VehicleDeliveryService));
                }

                if (consumablesOrder != null) joinServices.Add(new JoinService(consumablesOrder.Id, JoinServiceType.ConsumablesOrder));

                if (mergedService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(mergedService.Id, JoinServiceType.AccountingMergedService));
                    else
                        joinServices.Add(new JoinService(mergedService.Id, JoinServiceType.MergedService));
                }

                if (billOfLadingService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(billOfLadingService.Id, JoinServiceType.AccountingBillOfLadingService));
                    else
                        joinServices.Add(new JoinService(billOfLadingService.Id, JoinServiceType.BillOfLadingService));
                }

                if (protocol != null) joinServices.Add(new JoinService(protocol.Id, JoinServiceType.SupplyOrderUkrainePaymentDeliveryProtocol));

                supplyPaymentTask.User = user;

                if (!supplyPaymentTask.TaskStatus.Equals(TaskStatus.Done)) groupedTaskFromList.TaskStatus = TaskStatus.NotDone;

                if (junctionTask != null) {
                    if (paymentMovementOperation != null) paymentMovementOperation.PaymentMovement = paymentMovement;

                    paymentCurrencyRegister.PaymentRegister = paymentRegister;
                    paymentCurrencyRegister.Currency = currency;

                    outcome.User = outcomeUser;
                    outcome.PaymentCurrencyRegister = paymentCurrencyRegister;
                    outcome.PaymentMovementOperation = paymentMovementOperation;

                    junctionTask.OutcomePaymentOrder = outcome;

                    supplyPaymentTask.OutcomePaymentOrderSupplyPaymentTasks.Add(junctionTask);
                }

                groupedTaskFromList.SupplyPaymentTasks.Add(supplyPaymentTask);
            } else {
                if (containerService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(containerService.Id, JoinServiceType.AccountingContainerService));
                    else
                        joinServices.Add(new JoinService(containerService.Id, JoinServiceType.ContainerService));
                }

                if (vehicleService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(vehicleService.Id, JoinServiceType.AccountingVehicleService));
                    else
                        joinServices.Add(new JoinService(vehicleService.Id, JoinServiceType.VehicleService));
                }

                if (portWorkService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(portWorkService.Id, JoinServiceType.AccountingPortWorkService));
                    else
                        joinServices.Add(new JoinService(portWorkService.Id, JoinServiceType.PortWorkService));
                }

                if (billOfLadingService != null) {
                    if (supplyPaymentTask.IsAccounting)
                        joinServices.Add(new JoinService(billOfLadingService.Id, JoinServiceType.AccountingBillOfLadingService));
                    else
                        joinServices.Add(new JoinService(billOfLadingService.Id, JoinServiceType.BillOfLadingService));
                }

                SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                if (document != null && !taskFromList.SupplyPaymentTaskDocuments.Any(d => d.Id.Equals(document.Id))) taskFromList.SupplyPaymentTaskDocuments.Add(document);

                if (junctionTask != null && !taskFromList.OutcomePaymentOrderSupplyPaymentTasks.Any(o => o.Id.Equals(junctionTask.Id))) {
                    if (paymentMovementOperation != null) paymentMovementOperation.PaymentMovement = paymentMovement;

                    paymentCurrencyRegister.PaymentRegister = paymentRegister;
                    paymentCurrencyRegister.Currency = currency;

                    outcome.User = outcomeUser;
                    outcome.PaymentCurrencyRegister = paymentCurrencyRegister;
                    outcome.PaymentMovementOperation = paymentMovementOperation;

                    junctionTask.OutcomePaymentOrder = outcome;

                    taskFromList.OutcomePaymentOrderSupplyPaymentTasks.Add(junctionTask);
                }
            }

            return supplyPaymentTask;
        };

        string tasksSqlExpression =
            "SELECT [SupplyPaymentTask].[ID] " +
            ",[SupplyPaymentTask].[Created] " +
            ",[SupplyPaymentTask].[Deleted] " +
            ",[SupplyPaymentTask].[NetUID] " +
            ",[SupplyPaymentTask].[Updated] " +
            ",[SupplyPaymentTask].[Comment] " +
            ",[SupplyPaymentTask].[IsAccounting] " +
            ",[SupplyPaymentTask].[UserID] " +
            ",CONVERT(date, [SupplyPaymentTask].[PayToDate]) AS [PayToDate] " +
            ",[SupplyPaymentTask].[TaskAssignedTo] " +
            ",[SupplyPaymentTask].[IsAvailableForPayment] " +
            ",[SupplyPaymentTask].[TaskStatus] " +
            ",[SupplyPaymentTask].[TaskStatusUpdated] " +
            ",( " +
            "CASE " +
            "WHEN [SupplyPaymentTask].TaskStatus = 1 " +
            "THEN [SupplyPaymentTask].[GrossPrice] " +
            "ELSE " +
            "( " +
            "[SupplyPaymentTask].[GrossPrice] " +
            "- " +
            "( " +
            "SELECT ISNULL(SUM([OutcomePaymentOrderSupplyPaymentTask].Amount), 0) " +
            "FROM [OutcomePaymentOrderSupplyPaymentTask] " +
            "WHERE [OutcomePaymentOrderSupplyPaymentTask].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            ") " +
            ") " +
            "END " +
            ") AS [GrossPrice] " +
            ",[SupplyPaymentTask].[NetPrice] " +
            ",[User].* " +
            ",[SupplyOrderPaymentDeliveryProtocol].* " +
            ",[SupplyOrderPolandPaymentDeliveryProtocol].* " +
            ",[ContainerService].* " +
            ",[VehicleService].* " +
            ",[CustomService].* " +
            ",[PortWorkService].* " +
            ",[TransportationService].* " +
            ",[PortCustomAgencyService].* " +
            ",[CustomAgencyService].* " +
            ",[PlaneDeliveryService].* " +
            ",[VehicleDeliveryService].* " +
            ",[ConsumablesOrder].* " +
            ",[SupplyPaymentTaskDocument].* " +
            ",[OutcomePaymentOrderSupplyPaymentTask].* " +
            ",[OutcomePaymentOrder].* " +
            ",[OutcomeUser].* " +
            ",[Organization].* " +
            ",[PaymentCurrencyRegister].* " +
            ",[PaymentRegister].* " +
            ",[Currency].* " +
            ",[PaymentMovementOperation].* " +
            ",[PaymentMovement].* " +
            ",[MergedService].* " +
            ",[BillOfLadingService].* " +
            ",[SupplyOrderUkrainePaymentDeliveryProtocol].* " +
            "FROM [SupplyPaymentTask] " +
            "LEFT JOIN [User] " +
            "ON [User].ID = [SupplyPaymentTask].UserID " +
            "LEFT JOIN [SupplyOrderPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyInvoice] " +
            "ON [SupplyInvoice].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyInvoiceID " +
            "LEFT JOIN [SupplyProForm] " +
            "ON [SupplyProForm].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyProFormID " +
            "LEFT JOIN [SupplyOrderPolandPaymentDeliveryProtocol] " +
            "ON [SupplyOrderPolandPaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrder] " +
            "ON ( " +
            "( " +
            "[SupplyInvoice].ID IS NOT NULL " +
            "AND " +
            "[SupplyOrder].ID = [SupplyInvoice].SupplyOrderID " +
            ") " +
            "OR " +
            "( " +
            "[SupplyProForm].ID IS NOT NULL " +
            "AND " +
            "[SupplyProForm].ID = [SupplyOrder].SupplyProFormID " +
            ") " +
            "OR " +
            "( " +
            "[SupplyOrderPolandPaymentDeliveryProtocol].ID IS NOT NULL " +
            "AND " +
            "[SupplyOrder].ID = [SupplyOrderPolandPaymentDeliveryProtocol].SupplyOrderID " +
            ") " +
            ") " +
            "LEFT JOIN [Client] " +
            "ON [Client].ID = [SupplyOrder].ClientID " +
            "LEFT JOIN [ClientAgreement] " +
            "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
            "LEFT JOIN [Agreement] " +
            "ON [Agreement].ID = [ClientAgreement].AgreementID " +
            "LEFT JOIN [Organization] AS [AgreementOrganization] " +
            "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
            "LEFT JOIN [ContainerService] " +
            "ON [ContainerService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [ContainerService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [ContainerOrganization] " +
            "ON [ContainerService].ContainerOrganizationID = [ContainerOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [ContainerOrganizationAgreement] " +
            "ON [ContainerOrganizationAgreement].[ID] = [ContainerService].[SupplyOrganizationAgreementID] " +
            "LEFT JOIN [Organization] AS [ContainerOrganizationOrganization] " +
            "ON [ContainerOrganizationOrganization].ID = [ContainerOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [VehicleService] " +
            "ON [VehicleService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [VehicleService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [VehicleOrganization] " +
            "ON [VehicleService].VehicleOrganizationID = [VehicleOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleOrganizationAgreement] " +
            "ON [VehicleOrganizationAgreement].[ID] = [VehicleService].[SupplyOrganizationAgreementID] " +
            "LEFT JOIN [Organization] AS [VehicleOrganizationOrganization] " +
            "ON [VehicleOrganizationOrganization].ID = [VehicleOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [CustomService] " +
            "ON [CustomService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [CustomService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [CustomOrganization] " +
            "ON [CustomService].CustomOrganizationID = [CustomOrganization].ID " +
            "OR [CustomService].ExciseDutyOrganizationID = [CustomOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomOrganizationAgreement] " +
            "ON [CustomOrganizationAgreement].[ID] = [CustomService].[SupplyOrganizationAgreementID] " +
            "LEFT JOIN [Organization] AS [CustomOrganizationOrganization] " +
            "ON [CustomOrganizationOrganization].ID = [CustomOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [PortWorkService] " +
            "ON [PortWorkService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [PortWorkService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [PortWorkOrganization] " +
            "ON [PortWorkService].PortWorkOrganizationID = [PortWorkOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [PortWorkOrganizationAgreement] " +
            "ON [PortWorkOrganizationAgreement].[ID] = [PortWorkService].[SupplyOrganizationAgreementID] " +
            "LEFT JOIN [Organization] AS [PortWorkOrganizationOrganization] " +
            "ON [PortWorkOrganizationOrganization].ID = [PortWorkOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [TransportationService] " +
            "ON [TransportationService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [TransportationService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [TransportationOrganization] " +
            "ON [TransportationService].TransportationOrganizationID = [TransportationOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [TransportationOrganizationAgreement] " +
            "ON [TransportationOrganizationAgreement].[ID] = [TransportationService].[SupplyOrganizationAgreementID] " +
            "LEFT JOIN [Organization] AS [TransportationOrganizationOrganization] " +
            "ON [TransportationOrganizationOrganization].ID = [TransportationOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [PortCustomAgencyService] " +
            "ON [PortCustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [PortCustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [PortCustomAgencyOrganization] " +
            "ON [PortCustomAgencyService].PortCustomAgencyOrganizationID = [PortCustomAgencyOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [PortCustomAgencyOrganizationAgreement] " +
            "ON [PortCustomAgencyOrganizationAgreement].[ID] = [PortCustomAgencyService].[SupplyOrganizationAgreementID] " +
            "LEFT JOIN [Organization] AS [PortCustomAgencyOrganizationOrganization] " +
            "ON [PortCustomAgencyOrganizationOrganization].ID = [PortCustomAgencyOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [CustomAgencyService] " +
            "ON [CustomAgencyService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [CustomAgencyService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [CustomAgencyOrganization] " +
            "ON [CustomAgencyService].CustomAgencyOrganizationID = [CustomAgencyOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [CustomAgencyOrganizationAgreement] " +
            "ON [CustomAgencyOrganizationAgreement].[ID] = [CustomAgencyService].[SupplyOrganizationAgreementID] " +
            "LEFT JOIN [Organization] AS [CustomAgencyOrganizationOrganization] " +
            "ON [CustomAgencyOrganizationOrganization].ID = [CustomAgencyOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [PlaneDeliveryService] " +
            "ON [PlaneDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [PlaneDeliveryService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [PlaneDeliveryOrganization] " +
            "ON [PlaneDeliveryService].PlaneDeliveryOrganizationID = [PlaneDeliveryOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [PlaneDeliveryOrganizationAgreement] " +
            "ON [PlaneDeliveryOrganizationAgreement].[ID] = [PlaneDeliveryService].[SupplyOrganizationAgreementID] " +
            "LEFT JOIN [Organization] AS [PlaneDeliveryOrganizationOrganization] " +
            "ON [PlaneDeliveryOrganizationOrganization].ID = [PlaneDeliveryOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [VehicleDeliveryService] " +
            "ON [VehicleDeliveryService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [VehicleDeliveryService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [VehicleDeliveryOrganization] " +
            "ON [VehicleDeliveryService].VehicleDeliveryOrganizationID = [VehicleDeliveryOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [VehicleDeliveryOrganizationAgreement] " +
            "ON [VehicleDeliveryOrganizationAgreement].[ID] = [VehicleDeliveryService].[SupplyOrganizationAgreementID] " +
            "LEFT JOIN [Organization] AS [VehicleDeliveryOrganizationOrganization] " +
            "ON [VehicleDeliveryOrganizationOrganization].ID = [VehicleDeliveryOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [ConsumablesOrder] " +
            "ON [ConsumablesOrder].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [ConsumablesOrderItem] " +
            "ON [ConsumablesOrderItem].ConsumablesOrderID = [ConsumablesOrder].ID " +
            "LEFT JOIN [SupplyOrganization] AS [ConsumableProductOrganization] " +
            "ON [ConsumablesOrderItem].ConsumableProductOrganizationID = [ConsumableProductOrganization].ID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [ConsumablesOrganizationAgreement] " +
            "ON [ConsumablesOrganizationAgreement].[ID] = [ConsumablesOrderItem].[SupplyOrganizationAgreementID] " +
            "LEFT JOIN [Organization] AS [ConsumableProductOrganizationOrganization] " +
            "ON [ConsumableProductOrganizationOrganization].ID = [ConsumablesOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [SupplyPaymentTaskDocument] " +
            "ON [SupplyPaymentTaskDocument].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [OutcomePaymentOrderSupplyPaymentTask] " +
            "ON [OutcomePaymentOrderSupplyPaymentTask].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [OutcomePaymentOrder] " +
            "ON [OutcomePaymentOrder].ID = [OutcomePaymentOrderSupplyPaymentTask].OutcomePaymentOrderID " +
            "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
            "ON [Organization].ID = [OutcomePaymentOrder].OrganizationID " +
            "AND [Organization].CultureCode = @Culture " +
            "LEFT JOIN [User] AS [OutcomeUser] " +
            "ON [OutcomeUser].ID = [OutcomePaymentOrder].UserID " +
            "LEFT JOIN [PaymentMovementOperation] " +
            "ON [OutcomePaymentOrder].ID = [PaymentMovementOperation].OutcomePaymentOrderID " +
            "LEFT JOIN (" +
            "SELECT [PaymentMovement].ID " +
            ", [PaymentMovement].[Created] " +
            ", [PaymentMovement].[Deleted] " +
            ", [PaymentMovement].[NetUID] " +
            ", (CASE WHEN [PaymentMovementTranslation].[Name] IS NOT NULL THEN [PaymentMovementTranslation].[Name] ELSE [PaymentMovement].[OperationName] END) AS [OperationName] " +
            ", [PaymentMovement].[Updated] " +
            "FROM [PaymentMovement] " +
            "LEFT JOIN [PaymentMovementTranslation] " +
            "ON [PaymentMovementTranslation].PaymentMovementID = [PaymentMovement].ID " +
            "AND [PaymentMovementTranslation].CultureCode = @Culture " +
            ") AS [PaymentMovement] " +
            "ON [PaymentMovement].ID = [PaymentMovementOperation].PaymentMovementID " +
            "LEFT JOIN [PaymentCurrencyRegister] " +
            "ON [PaymentCurrencyRegister].ID = [OutcomePaymentOrder].PaymentCurrencyRegisterID " +
            "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
            "ON [Currency].ID = [PaymentCurrencyRegister].CurrencyID " +
            "AND [Currency].CultureCode = @Culture " +
            "LEFT JOIN [PaymentRegister] " +
            "ON [PaymentRegister].ID = [PaymentCurrencyRegister].PaymentRegisterID " +
            "LEFT JOIN [MergedService] " +
            "ON [MergedService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [MergedService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] AS [MergedSupplyOrganization] " +
            "ON [MergedSupplyOrganization].ID = [MergedService].SupplyOrganizationID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [MergedOrganizationAgreement] " +
            "ON [MergedOrganizationAgreement].[ID] = [MergedService].[SupplyOrganizationAgreementID] " +
            "LEFT JOIN [Organization] AS [MergedOrganizationOrganization] " +
            "ON [MergedOrganizationOrganization].ID = [MergedOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [BillOfLadingService] " +
            "ON [BillOfLadingService].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "OR [BillOfLadingService].AccountingPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrganization] " +
            "ON [SupplyOrganization].ID = [BillOfLadingService].SupplyOrganizationID " +
            "LEFT JOIN [SupplyOrganizationAgreement] AS [BillOfLadingOrganizationAgreement] " +
            "ON [BillOfLadingOrganizationAgreement].[ID] = [BillOfLadingService].[SupplyOrganizationAgreementID] " +
            "LEFT JOIN [Organization] AS [BillOfLadingServiceOrganizationOrganization] " +
            "ON [BillOfLadingServiceOrganizationOrganization].ID = [BillOfLadingOrganizationAgreement].OrganizationID " +
            "LEFT JOIN [SupplyOrderUkrainePaymentDeliveryProtocol] " +
            "ON [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyPaymentTaskID = [SupplyPaymentTask].ID " +
            "LEFT JOIN [SupplyOrderUkraine] " +
            "ON [SupplyOrderUkraine].ID = [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyOrderUkraineID " +
            "LEFT JOIN [ClientAgreement] AS [SupplyOrderUkraineClientAgreement] " +
            "ON [SupplyOrderUkraineClientAgreement].ID = [SupplyOrderUkraine].ClientAgreementID " +
            "LEFT JOIN [Agreement] AS [SupplyOrderUkraineAgreement] " +
            "ON [SupplyOrderUkraineAgreement].ID = [SupplyOrderUkraineClientAgreement].AgreementID " +
            "LEFT JOIN [Organization] AS [SupplyOrderUkraineAgreementOrganization]" +
            "ON [SupplyOrderUkraineAgreementOrganization].ID = [SupplyOrderUkraineAgreement].OrganizationID " +
            "WHERE [SupplyPaymentTask].[Deleted] = 0 " +
            "AND [SupplyPaymentTask].TaskStatus <> 1 " +
            "AND [SupplyPaymentTask].[IsImportedFromOneC] = 0 " +
            "AND CONVERT(date, [SupplyPaymentTask].[PayToDate]) IN @Dates ";

        if (organizationNetId.HasValue)
            tasksSqlExpression +=
                "AND ( " +
                "([AgreementOrganization].NetUID = @OrganizationNetId AND [AgreementOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([ContainerOrganizationOrganization].NetUID = @OrganizationNetId AND [ContainerOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([VehicleOrganizationOrganization].NetUID = @OrganizationNetId AND [VehicleOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([CustomOrganizationOrganization].NetUID = @OrganizationNetId AND [CustomOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PortWorkOrganizationOrganization].NetUID = @OrganizationNetId AND [PortWorkOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([TransportationOrganizationOrganization].NetUID = @OrganizationNetId AND [TransportationOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PortCustomAgencyOrganizationOrganization].NetUID = @OrganizationNetId AND [PortCustomAgencyOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([CustomAgencyOrganizationOrganization].NetUID = @OrganizationNetId AND [CustomAgencyOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([PlaneDeliveryOrganizationOrganization].NetUID = @OrganizationNetId AND [PlaneDeliveryOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([VehicleDeliveryOrganizationOrganization].NetUID = @OrganizationNetId AND [VehicleDeliveryOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([ConsumableProductOrganizationOrganization].NetUID = @OrganizationNetId AND [ConsumableProductOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([MergedOrganizationOrganization].NetUID = @OrganizationNetId AND [MergedOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([BillOfLadingServiceOrganizationOrganization].NetUID = @OrganizationNetId AND [BillOfLadingServiceOrganizationOrganization].NetUID IS NOT NULL) " +
                "OR " +
                "([SupplyOrderUkraineAgreementOrganization].NetUID = @OrganizationNetId AND [SupplyOrderUkraineAgreementOrganization].NetUID IS NOT NULL) " +
                ") ";

        tasksSqlExpression += "ORDER BY [SupplyPaymentTask].[PayToDate]";

        _connection.Query(
            tasksSqlExpression,
            types,
            mapper,
            new {
                Dates = groupedPaymentTaskWithTotals.GroupedPaymentTasks.Select(t => t.PayToDate),
                OrganizationNetId = organizationNetId ?? Guid.Empty,
                Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
            }
        );

        if (joinServices.Any()) {
            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.SupplyOrderPaymentDeliveryProtocol))) {
                Type[] includesTypes = new[] {
                    typeof(SupplyOrderPaymentDeliveryProtocol),
                    typeof(SupplyOrderPaymentDeliveryProtocolKey),
                    typeof(SupplyPaymentTask),
                    typeof(User),
                    typeof(SupplyInvoice),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(InvoiceDocument),
                    typeof(SupplyInformationDeliveryProtocol),
                    typeof(SupplyInformationDeliveryProtocolKey),
                    typeof(SupplyProForm),
                    typeof(ProFormDocument),
                    typeof(SupplyInformationDeliveryProtocol),
                    typeof(SupplyInformationDeliveryProtocolKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(SupplyOrderNumber),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], SupplyOrderPaymentDeliveryProtocol> includesMapper = objects => {
                    SupplyOrderPaymentDeliveryProtocol supplyOrderPaymentDeliveryProtocol = (SupplyOrderPaymentDeliveryProtocol)objects[0];
                    SupplyOrderPaymentDeliveryProtocolKey supplyOrderPaymentDeliveryProtocolKey = (SupplyOrderPaymentDeliveryProtocolKey)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    User user = (User)objects[3];
                    SupplyInvoice supplyInvoice = (SupplyInvoice)objects[4];
                    SupplyOrder invoiceSupplyOrder = (SupplyOrder)objects[5];
                    Client invoiceClient = (Client)objects[6];
                    Region invoiceClientRegion = (Region)objects[7];
                    RegionCode invoiceClientRegionCode = (RegionCode)objects[8];
                    Country invoiceClientCountry = (Country)objects[9];
                    ClientBankDetails invoiceClientBankDetails = (ClientBankDetails)objects[10];
                    ClientBankDetailAccountNumber invoiceClientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[11];
                    Currency invoiceClientBankDetailAccountNumberCurrency = (Currency)objects[12];
                    ClientBankDetailIbanNo invoiceClientClientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[13];
                    Currency invoiceClientClientBankDetailIbanNoCurrency = (Currency)objects[14];
                    TermsOfDelivery invoiceClientTermsOfDelivery = (TermsOfDelivery)objects[15];
                    PackingMarking invoiceClientPackingMarking = (PackingMarking)objects[16];
                    PackingMarkingPayment invoiceClientPackingMarkingPayment = (PackingMarkingPayment)objects[17];
                    ClientAgreement invoiceClientClientAgreement = (ClientAgreement)objects[18];
                    Agreement invoiceClientAgreement = (Agreement)objects[19];
                    ProviderPricing invoiceClientProviderPricing = (ProviderPricing)objects[20];
                    Currency invoiceClientProviderPricingCurrency = (Currency)objects[21];
                    Pricing invoiceClientPricing = (Pricing)objects[22];
                    PriceType invoiceClientPricingPriceType = (PriceType)objects[23];
                    Organization invoiceClientAgreementOrganization = (Organization)objects[24];
                    Currency invoiceClientAgreementCurrency = (Currency)objects[25];
                    Organization invoiceOrganization = (Organization)objects[26];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[27];
                    SupplyInformationDeliveryProtocol invoiceInformationProtocol = (SupplyInformationDeliveryProtocol)objects[28];
                    SupplyInformationDeliveryProtocolKey invoiceInformationProtocolKey = (SupplyInformationDeliveryProtocolKey)objects[29];
                    SupplyProForm supplyProForm = (SupplyProForm)objects[30];
                    ProFormDocument proFormDocument = (ProFormDocument)objects[31];
                    SupplyInformationDeliveryProtocol proFormInformationProtocol = (SupplyInformationDeliveryProtocol)objects[32];
                    SupplyInformationDeliveryProtocolKey proFormInformationProtocolKey = (SupplyInformationDeliveryProtocolKey)objects[33];
                    SupplyOrder proFormSupplyOrder = (SupplyOrder)objects[34];
                    Client proFormClient = (Client)objects[35];
                    Region proFormClientRegion = (Region)objects[36];
                    RegionCode proFormClientRegionCode = (RegionCode)objects[37];
                    Country proFormClientCountry = (Country)objects[38];
                    ClientBankDetails proFormClientBankDetails = (ClientBankDetails)objects[39];
                    ClientBankDetailAccountNumber proFormClientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[40];
                    Currency proFormClientBankDetailAccountNumberCurrency = (Currency)objects[41];
                    ClientBankDetailIbanNo proFormClientClientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[42];
                    Currency proFormClientClientBankDetailIbanNoCurrency = (Currency)objects[43];
                    TermsOfDelivery proFormClientTermsOfDelivery = (TermsOfDelivery)objects[44];
                    PackingMarking proFormClientPackingMarking = (PackingMarking)objects[45];
                    PackingMarkingPayment proFormClientPackingMarkingPayment = (PackingMarkingPayment)objects[46];
                    ClientAgreement proFormClientClientAgreement = (ClientAgreement)objects[47];
                    Agreement proFormClientAgreement = (Agreement)objects[48];
                    ProviderPricing proFormClientProviderPricing = (ProviderPricing)objects[49];
                    Currency proFormClientProviderPricingCurrency = (Currency)objects[50];
                    Pricing proFormClientPricing = (Pricing)objects[51];
                    PriceType proFormClientPricingPriceType = (PriceType)objects[52];
                    Organization proFormClientAgreementOrganization = (Organization)objects[53];
                    Currency proFormClientAgreementCurrency = (Currency)objects[54];
                    Organization proFormOrganization = (Organization)objects[55];
                    SupplyOrderNumber invoiceSupplyOrderNumber = (SupplyOrderNumber)objects[56];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[57];

                    if (!supplyPaymentTask.PayToDate.HasValue)
                        return supplyOrderPaymentDeliveryProtocol;

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.PaymentDeliveryProtocols.Any()) {
                        SupplyOrderPaymentDeliveryProtocol protocolFromList = taskFromList.PaymentDeliveryProtocols.First();

                        if (supplyInvoice != null) {
                            if (invoiceDocument != null && !protocolFromList.SupplyInvoice.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                protocolFromList.SupplyInvoice.InvoiceDocuments.Add(invoiceDocument);

                            if (invoiceInformationProtocol != null &&
                                !protocolFromList.SupplyInvoice.InformationDeliveryProtocols.Any(p => p.Id.Equals(invoiceInformationProtocol.Id))) {
                                invoiceInformationProtocol.SupplyInformationDeliveryProtocolKey = invoiceInformationProtocolKey;

                                protocolFromList.SupplyInvoice.InformationDeliveryProtocols.Add(invoiceInformationProtocol);
                            }
                        }

                        if (supplyProForm == null) return supplyOrderPaymentDeliveryProtocol;

                        if (proFormDocument != null && !protocolFromList.SupplyProForm.ProFormDocuments.Any(d => d.Id.Equals(proFormDocument.Id)))
                            protocolFromList.SupplyProForm.ProFormDocuments.Add(proFormDocument);

                        if (proFormInformationProtocol != null &&
                            !protocolFromList.SupplyProForm.InformationDeliveryProtocols.Any(p => p.Id.Equals(proFormInformationProtocol.Id))) {
                            proFormInformationProtocol.SupplyInformationDeliveryProtocolKey = proFormInformationProtocolKey;

                            protocolFromList.SupplyProForm.InformationDeliveryProtocols.Add(proFormInformationProtocol);
                        }

                        if (proFormSupplyOrder == null || protocolFromList.SupplyProForm.SupplyOrders.Any(o => o.Id.Equals(proFormSupplyOrder.Id)))
                            return supplyOrderPaymentDeliveryProtocol;

                        proFormSupplyOrder.Client = proFormClient;
                        proFormSupplyOrder.SupplyOrderNumber = supplyOrderNumber;
                        proFormSupplyOrder.Organization = proFormOrganization;

                        protocolFromList.SupplyProForm.SupplyOrders.Add(proFormSupplyOrder);
                    } else {
                        if (supplyInvoice != null) {
                            if (invoiceDocument != null) supplyInvoice.InvoiceDocuments.Add(invoiceDocument);

                            if (invoiceInformationProtocol != null) {
                                invoiceInformationProtocol.SupplyInformationDeliveryProtocolKey = invoiceInformationProtocolKey;

                                supplyInvoice.InformationDeliveryProtocols.Add(invoiceInformationProtocol);
                            }

                            if (invoiceClient != null) {
                                if (invoiceClientBankDetails != null) {
                                    if (invoiceClientBankDetailAccountNumber != null) {
                                        invoiceClientBankDetailAccountNumber.Currency = invoiceClientBankDetailAccountNumberCurrency;

                                        invoiceClientBankDetails.AccountNumber = invoiceClientBankDetailAccountNumber;
                                    }

                                    if (invoiceClientClientBankDetailIbanNo != null) {
                                        invoiceClientClientBankDetailIbanNo.Currency = invoiceClientClientBankDetailIbanNoCurrency;

                                        invoiceClientBankDetails.ClientBankDetailIbanNo = invoiceClientClientBankDetailIbanNo;
                                    }
                                }

                                if (invoiceClientClientAgreement != null) {
                                    if (invoiceClientProviderPricing != null) {
                                        if (invoiceClientPricing != null) invoiceClientPricing.PriceType = invoiceClientPricingPriceType;

                                        invoiceClientProviderPricing.Currency = invoiceClientProviderPricingCurrency;
                                        invoiceClientProviderPricing.Pricing = invoiceClientPricing;
                                    }

                                    invoiceClientAgreement.Organization = invoiceClientAgreementOrganization;
                                    invoiceClientAgreement.Currency = invoiceClientAgreementCurrency;
                                    invoiceClientAgreement.ProviderPricing = invoiceClientProviderPricing;

                                    invoiceClientClientAgreement.Agreement = invoiceClientAgreement;

                                    invoiceClient.ClientAgreements.Add(invoiceClientClientAgreement);
                                }

                                invoiceClient.Region = invoiceClientRegion;
                                invoiceClient.RegionCode = invoiceClientRegionCode;
                                invoiceClient.Country = invoiceClientCountry;
                                invoiceClient.ClientBankDetails = invoiceClientBankDetails;
                                invoiceClient.TermsOfDelivery = invoiceClientTermsOfDelivery;
                                invoiceClient.PackingMarking = invoiceClientPackingMarking;
                                invoiceClient.PackingMarkingPayment = invoiceClientPackingMarkingPayment;
                            }

                            invoiceSupplyOrder.Client = invoiceClient;
                            invoiceSupplyOrder.ClientAgreement = invoiceClientClientAgreement;
                            invoiceSupplyOrder.SupplyOrderNumber = invoiceSupplyOrderNumber;
                            invoiceSupplyOrder.Organization = invoiceOrganization;

                            supplyInvoice.SupplyOrder = invoiceSupplyOrder;
                        }

                        if (supplyProForm != null) {
                            if (proFormDocument != null) supplyProForm.ProFormDocuments.Add(proFormDocument);

                            if (proFormInformationProtocol != null) {
                                proFormInformationProtocol.SupplyInformationDeliveryProtocolKey = proFormInformationProtocolKey;

                                supplyProForm.InformationDeliveryProtocols.Add(proFormInformationProtocol);
                            }

                            if (proFormSupplyOrder != null) {
                                if (proFormClient != null) {
                                    if (proFormClientBankDetails != null) {
                                        if (proFormClientBankDetailAccountNumber != null) {
                                            proFormClientBankDetailAccountNumber.Currency = proFormClientBankDetailAccountNumberCurrency;

                                            proFormClientBankDetails.AccountNumber = proFormClientBankDetailAccountNumber;
                                        }

                                        if (proFormClientClientBankDetailIbanNo != null) {
                                            proFormClientClientBankDetailIbanNo.Currency = proFormClientClientBankDetailIbanNoCurrency;

                                            proFormClientBankDetails.ClientBankDetailIbanNo = proFormClientClientBankDetailIbanNo;
                                        }
                                    }

                                    if (proFormClientClientAgreement != null) {
                                        if (proFormClientProviderPricing != null) {
                                            if (proFormClientPricing != null) proFormClientPricing.PriceType = proFormClientPricingPriceType;

                                            proFormClientProviderPricing.Currency = proFormClientProviderPricingCurrency;
                                            proFormClientProviderPricing.Pricing = proFormClientPricing;
                                        }

                                        proFormClientAgreement.Organization = proFormClientAgreementOrganization;
                                        proFormClientAgreement.Currency = proFormClientAgreementCurrency;
                                        proFormClientAgreement.ProviderPricing = proFormClientProviderPricing;

                                        proFormClientClientAgreement.Agreement = proFormClientAgreement;

                                        proFormClient.ClientAgreements.Add(proFormClientClientAgreement);
                                    }

                                    proFormClient.Region = proFormClientRegion;
                                    proFormClient.RegionCode = proFormClientRegionCode;
                                    proFormClient.Country = proFormClientCountry;
                                    proFormClient.ClientBankDetails = proFormClientBankDetails;
                                    proFormClient.TermsOfDelivery = proFormClientTermsOfDelivery;
                                    proFormClient.PackingMarking = proFormClientPackingMarking;
                                    proFormClient.PackingMarkingPayment = proFormClientPackingMarkingPayment;
                                }

                                proFormSupplyOrder.Client = proFormClient;
                                proFormSupplyOrder.ClientAgreement = proFormClientClientAgreement;
                                proFormSupplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                proFormSupplyOrder.Organization = proFormOrganization;

                                supplyProForm.SupplyOrders.Add(proFormSupplyOrder);
                            }
                        }

                        supplyOrderPaymentDeliveryProtocol.SupplyOrderPaymentDeliveryProtocolKey = supplyOrderPaymentDeliveryProtocolKey;
                        supplyOrderPaymentDeliveryProtocol.User = user;
                        supplyOrderPaymentDeliveryProtocol.SupplyInvoice = supplyInvoice;
                        supplyOrderPaymentDeliveryProtocol.SupplyProForm = supplyProForm;

                        taskFromList.PaymentDeliveryProtocols.Add(supplyOrderPaymentDeliveryProtocol);

                        decimal exchangeRateAmount = 1;

                        if (proFormClientAgreementCurrency != null) {
                            if (!proFormClientAgreementCurrency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(proFormClientAgreementCurrency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(proFormClientAgreementCurrency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(proFormClientAgreementCurrency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = proFormClientAgreementCurrency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        } else if (invoiceClientAgreementCurrency != null) {
                            if (!invoiceClientAgreementCurrency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(invoiceClientAgreementCurrency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(invoiceClientAgreementCurrency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(invoiceClientAgreementCurrency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = invoiceClientAgreementCurrency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        }

                        if (taskFromList.TaskStatus.Equals(TaskStatus.Done)) return supplyOrderPaymentDeliveryProtocol;

                        groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                        groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                    }

                    return supplyOrderPaymentDeliveryProtocol;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [SupplyOrderPaymentDeliveryProtocol] " +
                    "LEFT JOIN [SupplyOrderPaymentDeliveryProtocolKey] " +
                    "ON [SupplyOrderPaymentDeliveryProtocolKey].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyOrderPaymentDeliveryProtocolKeyID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyPaymentTaskID " +
                    "LEFT JOIN [User] AS [SupplyOrderPaymentDeliveryProtocolUser] " +
                    "ON [SupplyOrderPaymentDeliveryProtocolUser].ID = [SupplyOrderPaymentDeliveryProtocol].UserID " +
                    "LEFT JOIN [SupplyInvoice] " +
                    "ON [SupplyInvoice].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyInvoiceID " +
                    "LEFT JOIN [SupplyOrder] AS [InvoiceSupplyOrder] " +
                    "ON [InvoiceSupplyOrder].ID = [SupplyInvoice].SupplyOrderID " +
                    "LEFT JOIN [Client] AS [InvoiceSupplyOrderClient] " +
                    "ON [InvoiceSupplyOrder].ClientID = [InvoiceSupplyOrderClient].ID " +
                    "LEFT JOIN [Region] AS [InvoiceSupplyOrderClientRegion] " +
                    "ON [InvoiceSupplyOrderClientRegion].ID = [InvoiceSupplyOrderClient].RegionID " +
                    "LEFT JOIN [RegionCode] AS [InvoiceSupplyOrderClientRegionCode] " +
                    "ON [InvoiceSupplyOrderClientRegionCode].ID = [InvoiceSupplyOrderClient].RegionCodeID " +
                    "LEFT JOIN [Country] AS [InvoiceSupplyOrderClientCountry] " +
                    "ON [InvoiceSupplyOrderClientCountry].ID = [InvoiceSupplyOrderClient].CountryID " +
                    "LEFT JOIN [ClientBankDetails] AS [InvoiceSupplyOrderClientBankDetails] " +
                    "ON [InvoiceSupplyOrderClientBankDetails].ID = [InvoiceSupplyOrderClient].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] AS [InvoiceSupplyOrderClientBankDetailsAccountNumber] " +
                    "ON [InvoiceSupplyOrderClientBankDetailsAccountNumber].ID = [InvoiceSupplyOrderClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [InvoiceSupplyOrderClientBankDetailsAccountNumberCurrency] " +
                    "ON [InvoiceSupplyOrderClientBankDetailsAccountNumberCurrency].ID = [InvoiceSupplyOrderClientBankDetailsAccountNumber].CurrencyID " +
                    "AND [InvoiceSupplyOrderClientBankDetailsAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] AS [InvoiceSupplyOrderClientBankDetailsIbanNo] " +
                    "ON [InvoiceSupplyOrderClientBankDetailsIbanNo].ID = [InvoiceSupplyOrderClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [InvoiceSupplyOrderClientBankDetailsIbanNoCurrency] " +
                    "ON [InvoiceSupplyOrderClientBankDetailsIbanNoCurrency].ID = [InvoiceSupplyOrderClientBankDetailsIbanNo].CurrencyID " +
                    "AND [InvoiceSupplyOrderClientBankDetailsIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] AS [InvoiceSupplyOrderClientTermsOfDelivery] " +
                    "ON [InvoiceSupplyOrderClientTermsOfDelivery].ID = [InvoiceSupplyOrderClient].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] AS [InvoiceSupplyOrderClientPackingMarking] " +
                    "ON [InvoiceSupplyOrderClientPackingMarking].ID = [InvoiceSupplyOrderClient].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] AS [InvoiceSupplyOrderClientPackingMarkingPayment] " +
                    "ON [InvoiceSupplyOrderClientPackingMarkingPayment].ID = [InvoiceSupplyOrderClient].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] AS [InvoiceSupplyOrderClientClientAgreement] " +
                    "ON [InvoiceSupplyOrderClientClientAgreement].ID = [InvoiceSupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] AS [InvoiceSupplyOrderClientAgreement] " +
                    "ON [InvoiceSupplyOrderClientAgreement].ID = [InvoiceSupplyOrderClientClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] AS [InvoiceSupplyOrderClientAgreementProviderPricing] " +
                    "ON [InvoiceSupplyOrderClientAgreementProviderPricing].ID = [InvoiceSupplyOrderClientAgreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [InvoiceSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [InvoiceSupplyOrderClientAgreementProviderPricingCurrency].ID = [InvoiceSupplyOrderClientAgreementProviderPricing].CurrencyID " +
                    "AND [InvoiceSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] AS [InvoiceSupplyOrderClientAgreementPricing] " +
                    "ON [InvoiceSupplyOrderClientAgreementProviderPricing].BasePricingID = [InvoiceSupplyOrderClientAgreementPricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [InvoiceSupplyOrderClientAgreementPricingPriceType] " +
                    "ON [InvoiceSupplyOrderClientAgreementPricing].PriceTypeID = [InvoiceSupplyOrderClientAgreementPricingPriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [InvoiceSupplyOrderClientAgreementOrganization] " +
                    "ON [InvoiceSupplyOrderClientAgreementOrganization].ID = [InvoiceSupplyOrderClientAgreement].OrganizationID " +
                    "AND [InvoiceSupplyOrderClientAgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [InvoiceSupplyOrderClientAgreementCurrency] " +
                    "ON [InvoiceSupplyOrderClientAgreementCurrency].ID = [InvoiceSupplyOrderClientAgreement].CurrencyID " +
                    "AND [InvoiceSupplyOrderClientAgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [InvoiceSupplyOrderOrganization] " +
                    "ON [InvoiceSupplyOrderOrganization].ID = [InvoiceSupplyOrder].OrganizationID " +
                    "AND [InvoiceSupplyOrderOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].SupplyInvoiceID = [SupplyInvoice].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [SupplyInformationDeliveryProtocol] AS [InvoiceSupplyInformationDeliveryProtocol] " +
                    "ON [InvoiceSupplyInformationDeliveryProtocol].SupplyInvoiceID = [SupplyInvoice].ID " +
                    "AND [InvoiceSupplyInformationDeliveryProtocol].Deleted = 0 " +
                    "LEFT JOIN [views].[SupplyInformationDeliveryProtocolKeyView] AS [InvoiceSupplyInformationDeliveryProtocolKey] " +
                    "ON [InvoiceSupplyInformationDeliveryProtocolKey].ID = [InvoiceSupplyInformationDeliveryProtocol].SupplyInformationDeliveryProtocolKeyID " +
                    "AND [InvoiceSupplyInformationDeliveryProtocolKey].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyProForm] " +
                    "ON [SupplyProForm].ID = [SupplyOrderPaymentDeliveryProtocol].SupplyProFormID " +
                    "LEFT JOIN [ProFormDocument] " +
                    "ON [ProFormDocument].SupplyProFormID = [SupplyProForm].ID " +
                    "AND [ProFormDocument].Deleted = 0 " +
                    "LEFT JOIN [SupplyInformationDeliveryProtocol] AS [ProFormSupplyInformationDeliveryProtocol] " +
                    "ON [ProFormSupplyInformationDeliveryProtocol].SupplyProFormID = [SupplyProForm].ID " +
                    "AND [ProFormSupplyInformationDeliveryProtocol].Deleted = 0 " +
                    "LEFT JOIN [views].[SupplyInformationDeliveryProtocolKeyView] AS [ProFormSupplyInformationDeliveryProtocolKey] " +
                    "ON [ProFormSupplyInformationDeliveryProtocolKey].ID = [ProFormSupplyInformationDeliveryProtocol].SupplyInformationDeliveryProtocolKeyID " +
                    "AND [ProFormSupplyInformationDeliveryProtocolKey].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrder] AS [ProFormSupplyOrder] " +
                    "ON [ProFormSupplyOrder].SupplyProFormID = [SupplyProForm].ID " +
                    "LEFT JOIN [Client] AS [ProFormSupplyOrderClient] " +
                    "ON [ProFormSupplyOrder].ClientID = [ProFormSupplyOrderClient].ID " +
                    "LEFT JOIN [Region] AS [ProFormSupplyOrderClientRegion] " +
                    "ON [ProFormSupplyOrderClientRegion].ID = [ProFormSupplyOrderClient].RegionID " +
                    "LEFT JOIN [RegionCode] AS [ProFormSupplyOrderClientRegionCode] " +
                    "ON [ProFormSupplyOrderClientRegionCode].ID = [ProFormSupplyOrderClient].RegionCodeID " +
                    "LEFT JOIN [Country] AS [ProFormSupplyOrderClientCountry] " +
                    "ON [ProFormSupplyOrderClientCountry].ID = [ProFormSupplyOrderClient].CountryID " +
                    "LEFT JOIN [ClientBankDetails] AS [ProFormSupplyOrderClientBankDetails] " +
                    "ON [ProFormSupplyOrderClientBankDetails].ID = [ProFormSupplyOrderClient].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] AS [ProFormSupplyOrderClientBankDetailsAccountNumber] " +
                    "ON [ProFormSupplyOrderClientBankDetailsAccountNumber].ID = [ProFormSupplyOrderClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientBankDetailsAccountNumberCurrency] " +
                    "ON [ProFormSupplyOrderClientBankDetailsAccountNumberCurrency].ID = [ProFormSupplyOrderClientBankDetailsAccountNumber].CurrencyID " +
                    "AND [ProFormSupplyOrderClientBankDetailsAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] AS [ProFormSupplyOrderClientBankDetailsIbanNo] " +
                    "ON [ProFormSupplyOrderClientBankDetailsIbanNo].ID = [ProFormSupplyOrderClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientBankDetailsIbanNoCurrency] " +
                    "ON [ProFormSupplyOrderClientBankDetailsIbanNoCurrency].ID = [ProFormSupplyOrderClientBankDetailsIbanNo].CurrencyID " +
                    "AND [ProFormSupplyOrderClientBankDetailsIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] AS [ProFormSupplyOrderClientTermsOfDelivery] " +
                    "ON [ProFormSupplyOrderClientTermsOfDelivery].ID = [ProFormSupplyOrderClient].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] AS [ProFormSupplyOrderClientPackingMarking] " +
                    "ON [ProFormSupplyOrderClientPackingMarking].ID = [ProFormSupplyOrderClient].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] AS [ProFormSupplyOrderClientPackingMarkingPayment] " +
                    "ON [ProFormSupplyOrderClientPackingMarkingPayment].ID = [ProFormSupplyOrderClient].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] AS [ProFormSupplyOrderClientClientAgreement] " +
                    "ON [ProFormSupplyOrderClientClientAgreement].ID = [ProFormSupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] AS [ProFormSupplyOrderClientAgreement] " +
                    "ON [ProFormSupplyOrderClientAgreement].ID = [ProFormSupplyOrderClientClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] AS [ProFormSupplyOrderClientAgreementProviderPricing] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricing].ID = [ProFormSupplyOrderClientAgreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProFormSupplyOrderClientAgreementProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] AS [ProFormSupplyOrderClientAgreementPricing] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricing].BasePricingID = [ProFormSupplyOrderClientAgreementPricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [ProFormSupplyOrderClientAgreementPricingPriceType] " +
                    "ON [ProFormSupplyOrderClientAgreementPricing].PriceTypeID = [ProFormSupplyOrderClientAgreementPricingPriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [ProFormSupplyOrderClientAgreementOrganization] " +
                    "ON [ProFormSupplyOrderClientAgreementOrganization].ID = [ProFormSupplyOrderClientAgreement].OrganizationID " +
                    "AND [ProFormSupplyOrderClientAgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementCurrency].ID = [ProFormSupplyOrderClientAgreement].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [ProFormSupplyOrderOrganization] " +
                    "ON [ProFormSupplyOrderOrganization].ID = [ProFormSupplyOrder].OrganizationID " +
                    "AND [ProFormSupplyOrderOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] AS [InvoiceSupplyOrderNumber] " +
                    "ON [InvoiceSupplyOrderNumber].ID = [InvoiceSupplyOrder].SupplyOrderNumberID " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [ProFormSupplyOrder].SupplyOrderNumberID = [SupplyOrderNumber].ID " +
                    "WHERE [SupplyOrderPaymentDeliveryProtocol].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.SupplyOrderPaymentDeliveryProtocol)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.SupplyOrderPolandPaymentDeliveryProtocol))) {
                Type[] includesTypes = new[] {
                    typeof(SupplyOrderPolandPaymentDeliveryProtocol),
                    typeof(SupplyOrderPaymentDeliveryProtocolKey),
                    typeof(SupplyPaymentTask),
                    typeof(User),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(InvoiceDocument),
                    typeof(SupplyOrderNumber)
                };

                Currency pln = GetPLN();

                Func<object[], SupplyOrderPolandPaymentDeliveryProtocol> includesMapper = objects => {
                    SupplyOrderPolandPaymentDeliveryProtocol supplyOrderPolandPaymentDeliveryProtocol = (SupplyOrderPolandPaymentDeliveryProtocol)objects[0];
                    SupplyOrderPaymentDeliveryProtocolKey supplyOrderPaymentDeliveryProtocolKey = (SupplyOrderPaymentDeliveryProtocolKey)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    User user = (User)objects[3];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[4];
                    Client client = (Client)objects[5];
                    Region region = (Region)objects[6];
                    RegionCode regionCode = (RegionCode)objects[7];
                    Country country = (Country)objects[8];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[9];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[10];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[11];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[12];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[13];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[14];
                    PackingMarking packingMarking = (PackingMarking)objects[15];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[16];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[17];
                    Agreement agreement = (Agreement)objects[18];
                    ProviderPricing providerPricing = (ProviderPricing)objects[19];
                    Currency providerPricingCurrency = (Currency)objects[20];
                    Pricing pricing = (Pricing)objects[21];
                    PriceType priceType = (PriceType)objects[22];
                    Organization agreementOrganization = (Organization)objects[23];
                    Currency agreementCurrency = (Currency)objects[24];
                    Organization organization = (Organization)objects[25];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[26];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[27];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.SupplyOrderPolandPaymentDeliveryProtocols.Any()) {
                        SupplyOrderPolandPaymentDeliveryProtocol protocolFromList = taskFromList.SupplyOrderPolandPaymentDeliveryProtocols.First();

                        if (invoiceDocument != null && !protocolFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            protocolFromList.InvoiceDocuments.Add(invoiceDocument);
                    } else {
                        if (invoiceDocument != null) supplyOrderPolandPaymentDeliveryProtocol.InvoiceDocuments.Add(invoiceDocument);

                        if (client != null) {
                            if (clientBankDetails != null) {
                                if (clientBankDetailAccountNumber != null) {
                                    clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                    clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                }

                                if (clientBankDetailIbanNo != null) {
                                    clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                    clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                }
                            }

                            if (clientAgreement != null) {
                                if (providerPricing != null) {
                                    if (pricing != null) pricing.PriceType = priceType;

                                    providerPricing.Currency = providerPricingCurrency;
                                    providerPricing.Pricing = pricing;
                                }

                                agreement.Organization = agreementOrganization;
                                agreement.Currency = agreementCurrency;
                                agreement.ProviderPricing = providerPricing;

                                clientAgreement.Agreement = agreement;

                                client.ClientAgreements.Add(clientAgreement);
                            }

                            client.Region = region;
                            client.RegionCode = regionCode;
                            client.Country = country;
                            client.ClientBankDetails = clientBankDetails;
                            client.TermsOfDelivery = termsOfDelivery;
                            client.PackingMarking = packingMarking;
                            client.PackingMarkingPayment = packingMarkingPayment;
                        }

                        supplyOrder.Client = client;
                        supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                        supplyOrder.Organization = organization;

                        supplyOrderPolandPaymentDeliveryProtocol.SupplyOrderPaymentDeliveryProtocolKey = supplyOrderPaymentDeliveryProtocolKey;
                        supplyOrderPolandPaymentDeliveryProtocol.User = user;
                        supplyOrderPolandPaymentDeliveryProtocol.SupplyOrder = supplyOrder;

                        taskFromList.SupplyOrderPolandPaymentDeliveryProtocols.Add(supplyOrderPolandPaymentDeliveryProtocol);

                        decimal exchangeRateAmount = GetGovExchangeRateToEuroCurrency(pln);

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(pln.Id))) {
                                PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(pln.Id));

                                totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                            } else {
                                groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                    Currency = pln,
                                    TotalPrice = taskFromList.GrossPrice
                                });
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return supplyOrderPolandPaymentDeliveryProtocol;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [SupplyOrderPolandPaymentDeliveryProtocol] " +
                    "LEFT JOIN [SupplyOrderPaymentDeliveryProtocolKey] " +
                    "ON [SupplyOrderPaymentDeliveryProtocolKey].ID = [SupplyOrderPolandPaymentDeliveryProtocol].SupplyOrderPaymentDeliveryProtocolKeyID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [SupplyOrderPolandPaymentDeliveryProtocol].SupplyPaymentTaskID " +
                    "LEFT JOIN [User] AS [SupplyOrderPolandPaymentDeliveryProtocolUser] " +
                    "ON [SupplyOrderPolandPaymentDeliveryProtocolUser].ID = [SupplyOrderPolandPaymentDeliveryProtocol].UserID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [SupplyOrderPolandPaymentDeliveryProtocol].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [SupplyOrder].ClientID = [Client].ID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].SupplyOrderPolandPaymentDeliveryProtocolID = [SupplyOrderPolandPaymentDeliveryProtocol].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [SupplyOrderPolandPaymentDeliveryProtocol].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.SupplyOrderPolandPaymentDeliveryProtocol)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.ContainerService))) {
                Type[] includesTypes = new[] {
                    typeof(ContainerService),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(BillOfLadingDocument),
                    typeof(User),
                    typeof(InvoiceDocument),
                    typeof(SupplyOrderContainerService),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], ContainerService> includesMapper = objects => {
                    ContainerService containerService = (ContainerService)objects[0];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[1];
                    SupplyOrganization containerOrganization = (SupplyOrganization)objects[2];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[3];
                    Currency currency = (Currency)objects[4];
                    BillOfLadingDocument billOfLadingDocument = (BillOfLadingDocument)objects[5];
                    User user = (User)objects[6];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[7];
                    SupplyOrderContainerService supplyOrderContainerService = (SupplyOrderContainerService)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.ContainerServices.Any()) {
                        if (taskFromList.ContainerServices.Any(s => s.Id.Equals(containerService.Id))) {
                            ContainerService serviceFromList = taskFromList.ContainerServices.First(s => s.Id.Equals(containerService.Id));

                            if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                            if (supplyOrderContainerService != null && !serviceFromList.SupplyOrderContainerServices.Any(s => s.Id.Equals(supplyOrderContainerService.Id))) {
                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyOrderContainerService.SupplyOrder = supplyOrder;

                                serviceFromList.SupplyOrderContainerServices.Add(supplyOrderContainerService);
                            }
                        } else {
                            if (invoiceDocument != null) containerService.InvoiceDocuments.Add(invoiceDocument);

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            if (supplyOrderContainerService != null) {
                                if (client != null) {
                                    if (clientBankDetails != null) {
                                        if (clientBankDetailAccountNumber != null) {
                                            clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                            clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                        }

                                        if (clientBankDetailIbanNo != null) {
                                            clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                            clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                        }
                                    }

                                    if (clientAgreement != null) {
                                        if (providerPricing != null) {
                                            if (pricing != null) pricing.PriceType = priceType;

                                            providerPricing.Currency = providerPricingCurrency;
                                            providerPricing.Pricing = pricing;
                                        }

                                        agreement.Organization = agreementOrganization;
                                        agreement.Currency = agreementCurrency;
                                        agreement.ProviderPricing = providerPricing;

                                        clientAgreement.Agreement = agreement;

                                        client.ClientAgreements.Add(clientAgreement);
                                    }

                                    client.Region = region;
                                    client.RegionCode = regionCode;
                                    client.Country = country;
                                    client.ClientBankDetails = clientBankDetails;
                                    client.TermsOfDelivery = termsOfDelivery;
                                    client.PackingMarking = packingMarking;
                                    client.PackingMarkingPayment = packingMarkingPayment;
                                }

                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyOrderContainerService.SupplyOrder = supplyOrder;

                                containerService.SupplyOrderContainerServices.Add(supplyOrderContainerService);
                            }

                            containerService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            containerService.ContainerOrganization = containerOrganization;
                            containerService.BillOfLadingDocument = billOfLadingDocument;
                            containerService.User = user;

                            taskFromList.ContainerServices.Add(containerService);

                            decimal exchangeRateAmount = 1;

                            if (currency != null) {
                                if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                                if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                    if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                        PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                    } else {
                                        groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                            Currency = currency,
                                            TotalPrice = taskFromList.GrossPrice
                                        });
                                    }
                                }
                            }

                            if (exchangeRateAmount < decimal.Zero) {
                                exchangeRateAmount = 0 - exchangeRateAmount;

                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                            } else {
                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                            }

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                                groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                            }
                        }
                    } else {
                        if (invoiceDocument != null) containerService.InvoiceDocuments.Add(invoiceDocument);

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrderContainerService != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            supplyOrderContainerService.SupplyOrder = supplyOrder;

                            containerService.SupplyOrderContainerServices.Add(supplyOrderContainerService);
                        }

                        containerService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        containerService.ContainerOrganization = containerOrganization;
                        containerService.BillOfLadingDocument = billOfLadingDocument;
                        containerService.User = user;

                        taskFromList.ContainerServices.Add(containerService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return containerService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [ContainerService] " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [ContainerService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [ContainerOrganization] " +
                    "ON [ContainerOrganization].ID = [ContainerService].ContainerOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [ContainerService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [BillOfLadingDocument] " +
                    "ON [BillOfLadingDocument].ID = [ContainerService].BillOfLadingDocumentID " +
                    "LEFT JOIN [User] AS [ContainerServiceUser] " +
                    "ON [ContainerServiceUser].ID = [ContainerService].UserID " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].ContainerServiceID = [ContainerService].ID " +
                    "LEFT JOIN [SupplyOrderContainerService] " +
                    "ON [SupplyOrderContainerService].ContainerServiceID = [ContainerService].ID " +
                    "AND [SupplyOrderContainerService].Deleted = 0 " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [SupplyOrderContainerService].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [SupplyOrder].ClientID = [Client].ID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [ContainerService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.ContainerService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.VehicleService))) {
                Type[] includesTypes = new[] {
                    typeof(VehicleService),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(BillOfLadingDocument),
                    typeof(User),
                    typeof(InvoiceDocument),
                    typeof(SupplyOrderVehicleService),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], VehicleService> includesMapper = objects => {
                    VehicleService vehicleService = (VehicleService)objects[0];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[1];
                    SupplyOrganization vehicleOrganization = (SupplyOrganization)objects[2];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[3];
                    Currency currency = (Currency)objects[4];
                    BillOfLadingDocument billOfLadingDocument = (BillOfLadingDocument)objects[5];
                    User user = (User)objects[6];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[7];
                    SupplyOrderVehicleService supplyOrderVehicleService = (SupplyOrderVehicleService)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.VehicleServices.Any()) {
                        if (taskFromList.VehicleServices.Any(s => s.Id.Equals(vehicleService.Id))) {
                            VehicleService serviceFromList = taskFromList.VehicleServices.First(s => s.Id.Equals(vehicleService.Id));

                            if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                            if (supplyOrderVehicleService != null && !serviceFromList.SupplyOrderVehicleServices.Any(s => s.Id.Equals(supplyOrderVehicleService.Id))) {
                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyOrderVehicleService.SupplyOrder = supplyOrder;

                                serviceFromList.SupplyOrderVehicleServices.Add(supplyOrderVehicleService);
                            }
                        } else {
                            if (invoiceDocument != null) vehicleService.InvoiceDocuments.Add(invoiceDocument);

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            if (supplyOrderVehicleService != null) {
                                if (client != null) {
                                    if (clientBankDetails != null) {
                                        if (clientBankDetailAccountNumber != null) {
                                            clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                            clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                        }

                                        if (clientBankDetailIbanNo != null) {
                                            clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                            clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                        }
                                    }

                                    if (clientAgreement != null) {
                                        if (providerPricing != null) {
                                            if (pricing != null) pricing.PriceType = priceType;

                                            providerPricing.Currency = providerPricingCurrency;
                                            providerPricing.Pricing = pricing;
                                        }

                                        agreement.Organization = agreementOrganization;
                                        agreement.Currency = agreementCurrency;
                                        agreement.ProviderPricing = providerPricing;

                                        clientAgreement.Agreement = agreement;

                                        client.ClientAgreements.Add(clientAgreement);
                                    }

                                    client.Region = region;
                                    client.RegionCode = regionCode;
                                    client.Country = country;
                                    client.ClientBankDetails = clientBankDetails;
                                    client.TermsOfDelivery = termsOfDelivery;
                                    client.PackingMarking = packingMarking;
                                    client.PackingMarkingPayment = packingMarkingPayment;
                                }

                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyOrderVehicleService.SupplyOrder = supplyOrder;

                                vehicleService.SupplyOrderVehicleServices.Add(supplyOrderVehicleService);
                            }

                            vehicleService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            vehicleService.VehicleOrganization = vehicleOrganization;
                            vehicleService.BillOfLadingDocument = billOfLadingDocument;
                            vehicleService.User = user;

                            taskFromList.VehicleServices.Add(vehicleService);

                            decimal exchangeRateAmount = 1;

                            if (currency != null) {
                                if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                                if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                    if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                        PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                    } else {
                                        groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                            Currency = currency,
                                            TotalPrice = taskFromList.GrossPrice
                                        });
                                    }
                                }
                            }

                            if (exchangeRateAmount < decimal.Zero) {
                                exchangeRateAmount = 0 - exchangeRateAmount;

                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                            } else {
                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                            }

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                                groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                            }
                        }
                    } else {
                        if (invoiceDocument != null) vehicleService.InvoiceDocuments.Add(invoiceDocument);

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrderVehicleService != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            supplyOrderVehicleService.SupplyOrder = supplyOrder;

                            vehicleService.SupplyOrderVehicleServices.Add(supplyOrderVehicleService);
                        }

                        vehicleService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        vehicleService.VehicleOrganization = vehicleOrganization;
                        vehicleService.BillOfLadingDocument = billOfLadingDocument;
                        vehicleService.User = user;

                        taskFromList.VehicleServices.Add(vehicleService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return vehicleService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [VehicleService] " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [VehicleService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [VehicleOrganization] " +
                    "ON [VehicleOrganization].ID = [VehicleService].VehicleOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [VehicleService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [BillOfLadingDocument] " +
                    "ON [BillOfLadingDocument].ID = [VehicleService].BillOfLadingDocumentID " +
                    "LEFT JOIN [User] AS [VehicleServiceUser] " +
                    "ON [VehicleServiceUser].ID = [VehicleService].UserID " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].VehicleServiceID = [VehicleService].ID " +
                    "LEFT JOIN [SupplyOrderVehicleService] " +
                    "ON [SupplyOrderVehicleService].VehicleServiceID = [VehicleService].ID " +
                    "AND [SupplyOrderVehicleService].Deleted = 0 " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [SupplyOrderVehicleService].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [SupplyOrder].ClientID = [Client].ID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [VehicleService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.VehicleService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.CustomService))) {
                Type[] includesTypes = new[] {
                    typeof(CustomService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrderNumber),
                    typeof(SupplyOrganizationAgreement),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(Currency)
                };

                Func<object[], CustomService> includesMapper = objects => {
                    CustomService customService = (CustomService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization exciseDutyOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganization customOrganization = (SupplyOrganization)objects[4];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[5];
                    Client client = (Client)objects[6];
                    Region region = (Region)objects[7];
                    RegionCode regionCode = (RegionCode)objects[8];
                    Country country = (Country)objects[9];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[10];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[11];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[12];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[13];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[14];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[15];
                    PackingMarking packingMarking = (PackingMarking)objects[16];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[17];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[18];
                    Agreement agreement = (Agreement)objects[19];
                    ProviderPricing providerPricing = (ProviderPricing)objects[20];
                    Currency providerPricingCurrency = (Currency)objects[21];
                    Pricing pricing = (Pricing)objects[22];
                    PriceType priceType = (PriceType)objects[23];
                    Organization agreementOrganization = (Organization)objects[24];
                    Currency agreementCurrency = (Currency)objects[25];
                    Organization organization = (Organization)objects[26];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[27];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[28];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[29];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[30];
                    SupplyOrganizationAgreement exciseOrganizationAgreement = (SupplyOrganizationAgreement)objects[31];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[32];
                    Organization exciseOrganizationOrganization = (Organization)objects[33];
                    Organization customSupplyOrganizationOrganization = (Organization)objects[34];
                    Currency currency = (Currency)objects[35];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.BrokerServices.Any()) {
                        CustomService serviceFromList = taskFromList.BrokerServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }
                    } else {
                        if (exciseDutyOrganization != null && exciseOrganizationAgreement != null) {
                            if (!exciseDutyOrganization.SupplyOrganizationAgreements.Any(x => x.Id == exciseOrganizationAgreement.Id))
                                exciseDutyOrganization.SupplyOrganizationAgreements.Add(exciseOrganizationAgreement);
                            else
                                exciseOrganizationAgreement = exciseDutyOrganization.SupplyOrganizationAgreements.First(x => x.Id == exciseOrganizationAgreement.Id);

                            exciseOrganizationAgreement.Organization = exciseOrganizationOrganization;
                        }

                        if (invoiceDocument != null) customService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            customService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = customSupplyOrganizationOrganization;
                        }

                        if (client != null) {
                            if (clientBankDetails != null) {
                                if (clientBankDetailAccountNumber != null) {
                                    clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                    clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                }

                                if (clientBankDetailIbanNo != null) {
                                    clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                    clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                }
                            }

                            if (clientAgreement != null) {
                                if (providerPricing != null) {
                                    if (pricing != null) pricing.PriceType = priceType;

                                    providerPricing.Currency = providerPricingCurrency;
                                    providerPricing.Pricing = pricing;
                                }

                                agreement.Organization = agreementOrganization;
                                agreement.Currency = agreementCurrency;
                                agreement.ProviderPricing = providerPricing;

                                clientAgreement.Agreement = agreement;

                                client.ClientAgreements.Add(clientAgreement);
                            }

                            client.Region = region;
                            client.RegionCode = regionCode;
                            client.Country = country;
                            client.ClientBankDetails = clientBankDetails;
                            client.TermsOfDelivery = termsOfDelivery;
                            client.PackingMarking = packingMarking;
                            client.PackingMarkingPayment = packingMarkingPayment;
                        }

                        supplyOrder.Client = client;
                        supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                        supplyOrder.Organization = organization;

                        customService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        customService.SupplyOrder = supplyOrder;
                        customService.User = user;
                        customService.ExciseDutyOrganization = exciseDutyOrganization;
                        customService.CustomOrganization = customOrganization;

                        taskFromList.BrokerServices.Add(customService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return customService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [CustomService] " +
                    "LEFT JOIN [User] AS [CustomServiceUser] " +
                    "ON [CustomServiceUser].ID = [CustomService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [CustomService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [ExciseDutyOrganization] " +
                    "ON [ExciseDutyOrganization].ID = [CustomService].ExciseDutyOrganizationID " +
                    "LEFT JOIN [SupplyOrganization] AS [CustomOrganization] " +
                    "ON [CustomOrganization].ID = [CustomService].CustomOrganizationID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [CustomService].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].CustomServiceID = [CustomService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].CustomServiceID = [CustomService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] AS [ExciseDutyOrganizationAgreement] " +
                    "ON [ExciseDutyOrganizationAgreement].SupplyOrganizationID = [ExciseDutyOrganization].ID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [CustomService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [ExciseDutyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [CustomSupplyOrganizationOrganization] " +
                    "ON [CustomSupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [CustomSupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "WHERE [CustomService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.CustomService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.PortWorkService))) {
                Type[] includesTypes = new[] {
                    typeof(PortWorkService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], PortWorkService> includesMapper = objects => {
                    PortWorkService portWorkService = (PortWorkService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization portWorkOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.PortWorkServices.Any()) {
                        if (taskFromList.PortWorkServices.Any(s => s.Id.Equals(portWorkService.Id))) {
                            PortWorkService serviceFromList = taskFromList.PortWorkServices.First();

                            if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                            if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                                serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                                serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                            }

                            if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                                supplyOrder.Client = client;
                                supplyOrder.Organization = organization;

                                serviceFromList.SupplyOrders.Add(supplyOrder);
                            }
                        } else {
                            if (invoiceDocument != null) portWorkService.InvoiceDocuments.Add(invoiceDocument);

                            if (serviceDetailItem != null) {
                                serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                                portWorkService.ServiceDetailItems.Add(serviceDetailItem);
                            }

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            if (supplyOrder != null) {
                                if (client != null) {
                                    if (clientBankDetails != null) {
                                        if (clientBankDetailAccountNumber != null) {
                                            clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                            clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                        }

                                        if (clientBankDetailIbanNo != null) {
                                            clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                            clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                        }
                                    }

                                    if (clientAgreement != null) {
                                        if (providerPricing != null) {
                                            if (pricing != null) pricing.PriceType = priceType;

                                            providerPricing.Currency = providerPricingCurrency;
                                            providerPricing.Pricing = pricing;
                                        }

                                        agreement.Organization = agreementOrganization;
                                        agreement.Currency = agreementCurrency;
                                        agreement.ProviderPricing = providerPricing;

                                        clientAgreement.Agreement = agreement;

                                        client.ClientAgreements.Add(clientAgreement);
                                    }

                                    client.Region = region;
                                    client.RegionCode = regionCode;
                                    client.Country = country;
                                    client.ClientBankDetails = clientBankDetails;
                                    client.TermsOfDelivery = termsOfDelivery;
                                    client.PackingMarking = packingMarking;
                                    client.PackingMarkingPayment = packingMarkingPayment;
                                }

                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                portWorkService.SupplyOrders.Add(supplyOrder);
                            }

                            portWorkService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            portWorkService.User = user;
                            portWorkService.PortWorkOrganization = portWorkOrganization;

                            taskFromList.PortWorkServices.Add(portWorkService);

                            decimal exchangeRateAmount = 1;

                            if (currency != null) {
                                if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                                if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                    if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                        PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                    } else {
                                        groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                            Currency = currency,
                                            TotalPrice = taskFromList.GrossPrice
                                        });
                                    }
                                }
                            }

                            if (exchangeRateAmount < decimal.Zero) {
                                exchangeRateAmount = 0 - exchangeRateAmount;

                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                            } else {
                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                            }

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                                groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                            }
                        }
                    } else {
                        if (invoiceDocument != null) portWorkService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            portWorkService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            portWorkService.SupplyOrders.Add(supplyOrder);
                        }

                        portWorkService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        portWorkService.User = user;
                        portWorkService.PortWorkOrganization = portWorkOrganization;

                        taskFromList.PortWorkServices.Add(portWorkService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return portWorkService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [PortWorkService] " +
                    "LEFT JOIN [User] AS [PortWorkServiceUser] " +
                    "ON [PortWorkServiceUser].ID = [PortWorkService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [PortWorkService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [PortWorkOrganization] " +
                    "ON [PortWorkOrganization].ID = [PortWorkService].PortWorkOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [PortWorkService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].PortWorkServiceID = [PortWorkService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].PortWorkServiceID = [PortWorkService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].PortWorkServiceID = [PortWorkService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [PortWorkService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.PortWorkService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.TransportationService))) {
                Type[] includesTypes = new[] {
                    typeof(TransportationService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], TransportationService> includesMapper = objects => {
                    TransportationService transportationService = (TransportationService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization transportationOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.TransportationServices.Any()) {
                        TransportationService serviceFromList = taskFromList.TransportationServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) transportationService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            transportationService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            transportationService.SupplyOrders.Add(supplyOrder);
                        }

                        transportationService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        transportationService.User = user;
                        transportationService.TransportationOrganization = transportationOrganization;

                        taskFromList.TransportationServices.Add(transportationService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return transportationService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [TransportationService] " +
                    "LEFT JOIN [User] AS [TransportationServiceUser] " +
                    "ON [TransportationServiceUser].ID = [TransportationService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [TransportationService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [TransportationOrganization] " +
                    "ON [TransportationOrganization].ID = [TransportationService].TransportationOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [TransportationService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].TransportationServiceID = [TransportationService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].TransportationServiceID = [TransportationService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].TransportationServiceID = [TransportationService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [TransportationService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.TransportationService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.PortCustomAgencyService))) {
                Type[] includesTypes = new[] {
                    typeof(PortCustomAgencyService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], PortCustomAgencyService> includesMapper = objects => {
                    PortCustomAgencyService portCustomAgencyService = (PortCustomAgencyService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization portCustomAgencyOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.PortCustomAgencyServices.Any()) {
                        PortCustomAgencyService serviceFromList = taskFromList.PortCustomAgencyServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) portCustomAgencyService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            portCustomAgencyService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            portCustomAgencyService.SupplyOrders.Add(supplyOrder);
                        }

                        portCustomAgencyService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        portCustomAgencyService.User = user;
                        portCustomAgencyService.PortCustomAgencyOrganization = portCustomAgencyOrganization;

                        taskFromList.PortCustomAgencyServices.Add(portCustomAgencyService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return portCustomAgencyService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [PortCustomAgencyService] " +
                    "LEFT JOIN [User] AS [PortCustomAgencyServiceUser] " +
                    "ON [PortCustomAgencyServiceUser].ID = [PortCustomAgencyService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [PortCustomAgencyService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [PortCustomAgencyOrganization] " +
                    "ON [PortCustomAgencyOrganization].ID = [PortCustomAgencyService].PortCustomAgencyOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [PortCustomAgencyService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].PortCustomAgencyServiceID = [PortCustomAgencyService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].PortCustomAgencyServiceID = [PortCustomAgencyService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].PortCustomAgencyServiceID = [PortCustomAgencyService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [PortCustomAgencyService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.PortCustomAgencyService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.CustomAgencyService))) {
                Type[] includesTypes = new[] {
                    typeof(CustomAgencyService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], CustomAgencyService> includesMapper = objects => {
                    CustomAgencyService customAgencyService = (CustomAgencyService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization customAgencyOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.CustomAgencyServices.Any()) {
                        CustomAgencyService serviceFromList = taskFromList.CustomAgencyServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) customAgencyService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            customAgencyService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            customAgencyService.SupplyOrders.Add(supplyOrder);
                        }

                        customAgencyService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        customAgencyService.User = user;
                        customAgencyService.CustomAgencyOrganization = customAgencyOrganization;

                        taskFromList.CustomAgencyServices.Add(customAgencyService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return customAgencyService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [CustomAgencyService] " +
                    "LEFT JOIN [User] AS [CustomAgencyServiceUser] " +
                    "ON [CustomAgencyServiceUser].ID = [CustomAgencyService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [CustomAgencyService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [CustomAgencyOrganization] " +
                    "ON [CustomAgencyOrganization].ID = [CustomAgencyService].CustomAgencyOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [CustomAgencyService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].CustomAgencyServiceID = [CustomAgencyService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].CustomAgencyServiceID = [CustomAgencyService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].CustomAgencyServiceID = [CustomAgencyService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [CustomAgencyService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.CustomAgencyService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.PlaneDeliveryService))) {
                Type[] includesTypes = new[] {
                    typeof(PlaneDeliveryService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], PlaneDeliveryService> includesMapper = objects => {
                    PlaneDeliveryService planeDeliveryService = (PlaneDeliveryService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization planeDeliveryOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.PlaneDeliveryServices.Any()) {
                        PlaneDeliveryService serviceFromList = taskFromList.PlaneDeliveryServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) planeDeliveryService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            planeDeliveryService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            planeDeliveryService.SupplyOrders.Add(supplyOrder);
                        }

                        planeDeliveryService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        planeDeliveryService.User = user;
                        planeDeliveryService.PlaneDeliveryOrganization = planeDeliveryOrganization;

                        taskFromList.PlaneDeliveryServices.Add(planeDeliveryService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return planeDeliveryService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [PlaneDeliveryService] " +
                    "LEFT JOIN [User] AS [PlaneDeliveryServiceUser] " +
                    "ON [PlaneDeliveryServiceUser].ID = [PlaneDeliveryService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [PlaneDeliveryService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [PlaneDeliveryOrganization] " +
                    "ON [PlaneDeliveryOrganization].ID = [PlaneDeliveryService].PlaneDeliveryOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [PlaneDeliveryService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].PlaneDeliveryServiceID = [PlaneDeliveryService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].PlaneDeliveryServiceID = [PlaneDeliveryService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].PlaneDeliveryServiceID = [PlaneDeliveryService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [PlaneDeliveryService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.PlaneDeliveryService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.VehicleDeliveryService))) {
                Type[] includesTypes = new[] {
                    typeof(VehicleDeliveryService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], VehicleDeliveryService> includesMapper = objects => {
                    VehicleDeliveryService vehicleDeliveryService = (VehicleDeliveryService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization vehicleDeliveryOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.VehicleDeliveryServices.Any()) {
                        VehicleDeliveryService serviceFromList = taskFromList.VehicleDeliveryServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) vehicleDeliveryService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            vehicleDeliveryService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            vehicleDeliveryService.SupplyOrders.Add(supplyOrder);
                        }

                        vehicleDeliveryService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        vehicleDeliveryService.User = user;
                        vehicleDeliveryService.VehicleDeliveryOrganization = vehicleDeliveryOrganization;

                        taskFromList.VehicleDeliveryServices.Add(vehicleDeliveryService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return vehicleDeliveryService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [VehicleDeliveryService] " +
                    "LEFT JOIN [User] AS [VehicleDeliveryServiceUser] " +
                    "ON [VehicleDeliveryServiceUser].ID = [VehicleDeliveryService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [VehicleDeliveryService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [VehicleDeliveryOrganization] " +
                    "ON [VehicleDeliveryOrganization].ID = [VehicleDeliveryService].VehicleDeliveryOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [VehicleDeliveryService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].VehicleDeliveryServiceID = [VehicleDeliveryService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].VehicleDeliveryServiceID = [VehicleDeliveryService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].VehicleDeliveryServiceID = [VehicleDeliveryService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [VehicleDeliveryService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.VehicleDeliveryService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.ConsumablesOrder))) {
                Type[] includesTypes = new[] {
                    typeof(ConsumablesOrder),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(ConsumablesOrderItem),
                    typeof(ConsumableProductCategory),
                    typeof(ConsumableProduct),
                    typeof(SupplyOrganization),
                    typeof(ConsumablesStorage),
                    typeof(PaymentCostMovementOperation),
                    typeof(PaymentCostMovement),
                    typeof(MeasureUnit),
                    typeof(ConsumablesOrderDocument),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Organization),
                    typeof(Currency)
                };

                Func<object[], ConsumablesOrder> includesMapper = objects => {
                    ConsumablesOrder consumablesOrder = (ConsumablesOrder)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    ConsumablesOrderItem consumablesOrderItem = (ConsumablesOrderItem)objects[3];
                    ConsumableProductCategory consumableProductCategory = (ConsumableProductCategory)objects[4];
                    ConsumableProduct consumableProduct = (ConsumableProduct)objects[5];
                    SupplyOrganization consumableProductOrganization = (SupplyOrganization)objects[6];
                    ConsumablesStorage consumablesStorage = (ConsumablesStorage)objects[7];
                    PaymentCostMovementOperation paymentCostMovementOperation = (PaymentCostMovementOperation)objects[8];
                    PaymentCostMovement paymentCostMovement = (PaymentCostMovement)objects[9];
                    MeasureUnit measureUnit = (MeasureUnit)objects[10];
                    ConsumablesOrderDocument consumablesOrderDocument = (ConsumablesOrderDocument)objects[11];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[12];
                    Organization supplyOrganizationOrganization = (Organization)objects[13];
                    Currency currency = (Currency)objects[14];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.ConsumablesOrder != null) {
                        if (consumablesOrderItem != null && !taskFromList.ConsumablesOrder.ConsumablesOrderItems.Any(i => i.Id.Equals(consumablesOrderItem.Id))) {
                            if (paymentCostMovementOperation != null) paymentCostMovementOperation.PaymentCostMovement = paymentCostMovement;

                            if (consumableProduct != null) consumableProduct.MeasureUnit = measureUnit;

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            consumablesOrderItem.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            consumablesOrderItem.ConsumableProductCategory = consumableProductCategory;
                            consumablesOrderItem.ConsumableProduct = consumableProduct;
                            consumablesOrderItem.ConsumableProductOrganization = consumableProductOrganization;
                            consumablesOrderItem.PaymentCostMovementOperation = paymentCostMovementOperation;

                            taskFromList.ConsumablesOrder.ConsumablesOrderItems.Add(consumablesOrderItem);

                            consumablesOrderItem.TotalPriceWithVAT = Math.Round(consumablesOrderItem.TotalPrice + consumablesOrderItem.VAT, 2);

                            taskFromList.ConsumablesOrder.TotalAmount =
                                Math.Round(taskFromList.ConsumablesOrder.TotalAmount + consumablesOrderItem.TotalPrice + consumablesOrderItem.VAT, 2);

                            taskFromList.ConsumablesOrder.TotalAmountWithoutVAT =
                                Math.Round(taskFromList.ConsumablesOrder.TotalAmountWithoutVAT + consumablesOrderItem.TotalPrice, 2);

                            decimal exchangeRateAmount = 1;

                            if (currency != null && !currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (exchangeRateAmount < decimal.Zero) {
                                    exchangeRateAmount = 0 - exchangeRateAmount;

                                    taskFromList.EuroNetPrice = Math.Round(taskFromList.EuroNetPrice + consumablesOrderItem.TotalPrice / exchangeRateAmount, 2);
                                    taskFromList.EuroGrossPrice =
                                        Math.Round(taskFromList.EuroGrossPrice + consumablesOrderItem.TotalPrice + consumablesOrderItem.VAT / exchangeRateAmount, 2);

                                    groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + consumablesOrderItem.TotalPrice, 2);
                                    groupedTaskFromList.TotalGrossAmount =
                                        Math.Round(groupedTaskFromList.TotalGrossAmount + consumablesOrderItem.TotalPrice + consumablesOrderItem.VAT, 2);
                                } else {
                                    taskFromList.EuroNetPrice = Math.Round(taskFromList.EuroNetPrice + consumablesOrderItem.TotalPrice / exchangeRateAmount, 2);
                                    taskFromList.EuroGrossPrice =
                                        Math.Round(taskFromList.EuroGrossPrice + consumablesOrderItem.TotalPrice + consumablesOrderItem.VAT / exchangeRateAmount, 2);

                                    groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + consumablesOrderItem.TotalPrice, 2);
                                    groupedTaskFromList.TotalGrossAmount =
                                        Math.Round(groupedTaskFromList.TotalGrossAmount + consumablesOrderItem.TotalPrice + consumablesOrderItem.VAT, 2);
                                }
                            }
                        }

                        if (consumablesOrderDocument != null && !taskFromList.ConsumablesOrder.ConsumablesOrderDocuments.Any(d => d.Id.Equals(consumablesOrderDocument.Id)))
                            taskFromList.ConsumablesOrder.ConsumablesOrderDocuments.Add(consumablesOrderDocument);
                    } else {
                        if (consumablesOrderItem != null) {
                            if (paymentCostMovementOperation != null) paymentCostMovementOperation.PaymentCostMovement = paymentCostMovement;

                            if (consumableProduct != null) consumableProduct.MeasureUnit = measureUnit;

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            consumablesOrderItem.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            consumablesOrderItem.ConsumableProductCategory = consumableProductCategory;
                            consumablesOrderItem.ConsumableProduct = consumableProduct;
                            consumablesOrderItem.ConsumableProductOrganization = consumableProductOrganization;
                            consumablesOrderItem.PaymentCostMovementOperation = paymentCostMovementOperation;

                            consumablesOrderItem.TotalPriceWithVAT = Math.Round(consumablesOrderItem.TotalPrice + consumablesOrderItem.VAT, 2);

                            consumablesOrder.ConsumablesOrderItems.Add(consumablesOrderItem);

                            consumablesOrder.TotalAmount = Math.Round(consumablesOrder.TotalAmount + consumablesOrderItem.TotalPrice + consumablesOrderItem.VAT, 2);

                            consumablesOrder.TotalAmountWithoutVAT = Math.Round(consumablesOrder.TotalAmountWithoutVAT + consumablesOrderItem.TotalPrice, 2);
                        }

                        if (consumablesOrderDocument != null) consumablesOrder.ConsumablesOrderDocuments.Add(consumablesOrderDocument);

                        consumablesOrder.User = user;
                        consumablesOrder.SupplyPaymentTask = supplyPaymentTask;
                        consumablesOrder.ConsumablesStorage = consumablesStorage;
                        consumablesOrder.ConsumableProductOrganization = consumableProductOrganization;
                        consumablesOrder.SupplyOrganizationAgreement = supplyOrganizationAgreement;

                        taskFromList.ConsumablesOrder = consumablesOrder;

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return consumablesOrder;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [ConsumablesOrder] " +
                    "LEFT JOIN [User] " +
                    "ON [User].ID = [ConsumablesOrder].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [ConsumablesOrder].SupplyPaymentTaskID " +
                    "LEFT JOIN [ConsumablesOrderItem] " +
                    "ON [ConsumablesOrderItem].ConsumablesOrderID = [ConsumablesOrder].ID " +
                    "AND [ConsumablesOrderItem].Deleted = 0 " +
                    "LEFT JOIN (" +
                    "SELECT [ConsumableProductCategory].ID " +
                    ", [ConsumableProductCategory].[Created] " +
                    ", [ConsumableProductCategory].[Deleted] " +
                    ", [ConsumableProductCategory].[NetUID] " +
                    ", (CASE WHEN [ConsumableProductCategoryTranslation].Name IS NOT NULL THEN [ConsumableProductCategoryTranslation].Name ELSE [ConsumableProductCategory].Name END) AS [Name] " +
                    ", (CASE WHEN [ConsumableProductCategoryTranslation].Description IS NOT NULL THEN [ConsumableProductCategoryTranslation].Description ELSE [ConsumableProductCategory].Description END) AS [Description] " +
                    ", [ConsumableProductCategory].[Updated] " +
                    "FROM [ConsumableProductCategory] " +
                    "LEFT JOIN [ConsumableProductCategoryTranslation] " +
                    "ON [ConsumableProductCategoryTranslation].ConsumableProductCategoryID = [ConsumableProductCategory].ID " +
                    "AND [ConsumableProductCategoryTranslation].CultureCode = @Culture" +
                    ") AS [ConsumableProductCategory] " +
                    "ON [ConsumableProductCategory].ID = [ConsumablesOrderItem].ConsumableProductCategoryID " +
                    "LEFT JOIN (" +
                    "SELECT [ConsumableProduct].ID " +
                    ", [ConsumableProduct].[ConsumableProductCategoryID] " +
                    ", [ConsumableProduct].[Created] " +
                    ", [ConsumableProduct].[VendorCode] " +
                    ", [ConsumableProduct].[Deleted] " +
                    ", (CASE WHEN [ConsumableProductTranslation].Name IS NOT NULL THEN [ConsumableProductTranslation].Name ELSE [ConsumableProduct].Name END) AS [Name] " +
                    ", [ConsumableProduct].[NetUID] " +
                    ", [ConsumableProduct].[MeasureUnitID] " +
                    ", [ConsumableProduct].[Updated] " +
                    "FROM [ConsumableProduct] " +
                    "LEFT JOIN [ConsumableProductTranslation] " +
                    "ON [ConsumableProductTranslation].ConsumableProductID = [ConsumableProduct].ID " +
                    "AND [ConsumableProductTranslation].CultureCode = @Culture" +
                    ") AS [ConsumableProduct] " +
                    "ON [ConsumableProduct].ID = [ConsumablesOrderItem].ConsumableProductID " +
                    "LEFT JOIN [SupplyOrganization] AS [ConsumableProductOrganization] " +
                    "ON [ConsumableProductOrganization].ID = [ConsumablesOrderItem].ConsumableProductOrganizationID " +
                    "LEFT JOIN [ConsumablesStorage] " +
                    "ON [ConsumablesStorage].ID = [ConsumablesOrder].ConsumablesStorageID " +
                    "LEFT JOIN [PaymentCostMovementOperation] " +
                    "ON [PaymentCostMovementOperation].ConsumablesOrderItemID = [ConsumablesOrderItem].ID " +
                    "LEFT JOIN (" +
                    "SELECT [PaymentCostMovement].ID " +
                    ", [PaymentCostMovement].[Created] " +
                    ", [PaymentCostMovement].[Deleted] " +
                    ", [PaymentCostMovement].[NetUID] " +
                    ", (CASE WHEN [PaymentCostMovementTranslation].[OperationName] IS NOT NULL THEN [PaymentCostMovementTranslation].[OperationName] ELSE [PaymentCostMovement].[OperationName] END) AS [OperationName] " +
                    ", [PaymentCostMovement].[Updated] " +
                    "FROM [PaymentCostMovement] " +
                    "LEFT JOIN [PaymentCostMovementTranslation] " +
                    "ON [PaymentCostMovementTranslation].PaymentCostMovementID = [PaymentCostMovement].ID " +
                    "AND [PaymentCostMovementTranslation].CultureCode = @Culture " +
                    ") AS [PaymentCostMovement] " +
                    "ON [PaymentCostMovement].ID = [PaymentCostMovementOperation].PaymentCostMovementID " +
                    "LEFT JOIN [views].[MeasureUnitView] AS [MeasureUnit] " +
                    "ON [MeasureUnit].ID = [ConsumableProduct].MeasureUnitID " +
                    "AND [MeasureUnit].CultureCode = @Culture " +
                    "LEFT JOIN [ConsumablesOrderDocument] " +
                    "ON [ConsumablesOrderDocument].ConsumablesOrderID = [ConsumablesOrder].ID " +
                    "AND [ConsumablesOrderDocument].Deleted = 0 " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [ConsumablesOrderItem].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "WHERE [ConsumablesOrder].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.ConsumablesOrder)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.MergedService))) {
                Type[] includesTypes = new[] {
                    typeof(MergedService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber),
                    typeof(SupplyOrderUkraine),
                    typeof(User),
                    typeof(Organization),
                    typeof(Client),
                    typeof(RegionCode),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(Organization),
                    typeof(Currency)
                };

                Func<object[], MergedService> includesMapper = objects => {
                    MergedService mergedService = (MergedService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization supplyOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];
                    SupplyOrderUkraine supplyOrderUkraine = (SupplyOrderUkraine)objects[33];
                    User responsible = (User)objects[34];
                    Organization ukOrganization = (Organization)objects[35];
                    Client supplier = (Client)objects[36];
                    RegionCode supplierRegionCode = (RegionCode)objects[37];
                    ClientAgreement supplierClientAgreement = (ClientAgreement)objects[38];
                    Agreement supplierAgreement = (Agreement)objects[39];
                    Organization supplierAgreementOrganization = (Organization)objects[40];
                    Currency supplierAgreementCurrency = (Currency)objects[41];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.MergedServices.Any()) {
                        MergedService serviceFromList = taskFromList.MergedServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }
                    } else {
                        if (invoiceDocument != null) mergedService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            mergedService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrderUkraine != null) {
                            supplierAgreement.Organization = supplierAgreementOrganization;
                            supplierAgreement.Currency = supplierAgreementCurrency;

                            supplierClientAgreement.Agreement = supplierAgreement;

                            supplier.RegionCode = supplierRegionCode;

                            supplyOrderUkraine.Supplier = supplier;
                            supplyOrderUkraine.Responsible = responsible;
                            supplyOrderUkraine.Organization = ukOrganization;
                            supplyOrderUkraine.ClientAgreement = supplierClientAgreement;

                            mergedService.SupplyOrderUkraine = supplyOrderUkraine;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            mergedService.SupplyOrder = supplyOrder;
                        }

                        mergedService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        mergedService.User = user;
                        mergedService.SupplyOrganization = supplyOrganization;

                        taskFromList.MergedServices.Add(mergedService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return mergedService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [MergedService] " +
                    "LEFT JOIN [User] AS [MergedServiceUser] " +
                    "ON [MergedServiceUser].ID = [MergedService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [MergedService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [MergedServiceSupplyOrganization] " +
                    "ON [MergedServiceSupplyOrganization].ID = [MergedService].SupplyOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [MergedService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].MergedServiceID = [MergedService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].MergedServiceID = [MergedService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [MergedService].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "LEFT JOIN [SupplyOrderUkraine] " +
                    "ON [MergedService].SupplyOrderUkraineID = [SupplyOrderUkraine].ID " +
                    "LEFT JOIN [User] AS [Responsible] " +
                    "ON [Responsible].ID = [SupplyOrderUkraine].ResponsibleID " +
                    "LEFT JOIN [views].[OrganizationView] AS [UkOrganization] " +
                    "ON [UkOrganization].ID = [SupplyOrderUkraine].OrganizationID " +
                    "AND [UkOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [Client] AS [Supplier] " +
                    "ON [Supplier].ID = [SupplyOrderUkraine].SupplierID " +
                    "LEFT JOIN [RegionCode] AS [SupplierRegionCode] " +
                    "ON [SupplierRegionCode].ID = [Supplier].RegionCodeID " +
                    "LEFT JOIN [ClientAgreement] AS [UkClientAgreement] " +
                    "ON [UkClientAgreement].ID = [SupplyOrderUkraine].ClientAgreementID " +
                    "LEFT JOIN [Agreement] AS [UkClientAgreementAgreement] " +
                    "ON [UkClientAgreementAgreement].ID = [UkClientAgreement].AgreementID " +
                    "LEFT JOIN [views].[OrganizationView] AS [UkClientAgreementAgreementOrganization] " +
                    "ON [UkClientAgreementAgreementOrganization].ID = [UkClientAgreementAgreement].OrganizationID " +
                    "AND [UkClientAgreementAgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [UkClientAgreementAgreementCurrency] " +
                    "ON [UkClientAgreementAgreementCurrency].ID = [UkClientAgreementAgreement].CurrencyID " +
                    "AND [UkClientAgreementAgreementCurrency].CultureCode = @Culture " +
                    "WHERE [MergedService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.MergedService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.SupplyOrderUkrainePaymentDeliveryProtocol))) {
                Type[] includesTypes = new[] {
                    typeof(SupplyOrderUkrainePaymentDeliveryProtocol),
                    typeof(SupplyOrderUkrainePaymentDeliveryProtocolKey),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(User),
                    typeof(SupplyOrderUkraine),
                    typeof(User),
                    typeof(Organization),
                    typeof(Client),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(Currency)
                };

                Func<object[], SupplyOrderUkrainePaymentDeliveryProtocol> includesMapper = objects => {
                    SupplyOrderUkrainePaymentDeliveryProtocol protocol = (SupplyOrderUkrainePaymentDeliveryProtocol)objects[0];
                    SupplyOrderUkrainePaymentDeliveryProtocolKey protocolKey = (SupplyOrderUkrainePaymentDeliveryProtocolKey)objects[1];
                    User protocolUser = (User)objects[2];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[3];
                    User supplyPaymentTaskUser = (User)objects[4];
                    SupplyOrderUkraine supplyOrderUkraine = (SupplyOrderUkraine)objects[5];
                    User responsible = (User)objects[6];
                    Organization organization = (Organization)objects[7];
                    Client supplier = (Client)objects[8];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[9];
                    Agreement agreement = (Agreement)objects[10];
                    Currency currency = (Currency)objects[11];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    supplyPaymentTask.User = supplyPaymentTaskUser;

                    agreement.Currency = currency;

                    clientAgreement.Agreement = agreement;

                    supplyOrderUkraine.Supplier = supplier;
                    supplyOrderUkraine.Responsible = responsible;
                    supplyOrderUkraine.Organization = organization;
                    supplyOrderUkraine.ClientAgreement = clientAgreement;

                    protocol.User = protocolUser;
                    protocol.SupplyPaymentTask = supplyPaymentTask;
                    protocol.SupplyOrderUkraine = supplyOrderUkraine;
                    protocol.SupplyOrderUkrainePaymentDeliveryProtocolKey = protocolKey;

                    decimal exchangeRateAmount = 1;

                    if (currency != null) {
                        if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                            } else {
                                groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                    Currency = currency,
                                    TotalPrice = taskFromList.GrossPrice
                                });
                            }
                        }
                    }

                    if (exchangeRateAmount < decimal.Zero) {
                        exchangeRateAmount = 0 - exchangeRateAmount;

                        taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                        taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                    } else {
                        taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                        taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                    }

                    if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                        groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                        groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                    }

                    taskFromList.SupplyOrderUkrainePaymentDeliveryProtocols.Add(protocol);

                    return protocol;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [SupplyOrderUkrainePaymentDeliveryProtocol] " +
                    "LEFT JOIN [SupplyOrderUkrainePaymentDeliveryProtocolKey] " +
                    "ON [SupplyOrderUkrainePaymentDeliveryProtocolKey].ID = [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyOrderUkrainePaymentDeliveryProtocolKeyID " +
                    "LEFT JOIN [User] AS [ProtocolUser] " +
                    "ON [ProtocolUser].ID = [SupplyOrderUkrainePaymentDeliveryProtocol].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyPaymentTaskID " +
                    "LEFT JOIN [User] " +
                    "ON [User].ID = [SupplyPaymentTask].UserID " +
                    "LEFT JOIN [SupplyOrderUkraine] " +
                    "ON [SupplyOrderUkraine].ID = [SupplyOrderUkrainePaymentDeliveryProtocol].SupplyOrderUkraineID " +
                    "LEFT JOIN [User] AS [Responsible] " +
                    "ON [Responsible].ID = [SupplyOrderUkraine].ResponsibleID " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrderUkraine].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [Client] AS [Supplier] " +
                    "ON [Supplier].ID = [SupplyOrderUkraine].SupplierID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrderUkraine].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [ClientAgreement].AgreementID = [Agreement].ID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [Agreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "WHERE [SupplyOrderUkrainePaymentDeliveryProtocol].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.SupplyOrderUkrainePaymentDeliveryProtocol)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingContainerService))) {
                Type[] includesTypes = new[] {
                    typeof(ContainerService),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(BillOfLadingDocument),
                    typeof(User),
                    typeof(InvoiceDocument),
                    typeof(SupplyOrderContainerService),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], ContainerService> includesMapper = objects => {
                    ContainerService containerService = (ContainerService)objects[0];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[1];
                    SupplyOrganization containerOrganization = (SupplyOrganization)objects[2];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[3];
                    Currency currency = (Currency)objects[4];
                    BillOfLadingDocument billOfLadingDocument = (BillOfLadingDocument)objects[5];
                    User user = (User)objects[6];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[7];
                    SupplyOrderContainerService supplyOrderContainerService = (SupplyOrderContainerService)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.ContainerServices.Any()) {
                        if (taskFromList.ContainerServices.Any(s => s.Id.Equals(containerService.Id))) {
                            ContainerService serviceFromList = taskFromList.ContainerServices.First(s => s.Id.Equals(containerService.Id));

                            if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                            if (supplyOrderContainerService != null && !serviceFromList.SupplyOrderContainerServices.Any(s => s.Id.Equals(supplyOrderContainerService.Id))) {
                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyOrderContainerService.SupplyOrder = supplyOrder;

                                serviceFromList.SupplyOrderContainerServices.Add(supplyOrderContainerService);
                            }
                        } else {
                            if (invoiceDocument != null) containerService.InvoiceDocuments.Add(invoiceDocument);

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            if (supplyOrderContainerService != null) {
                                if (client != null) {
                                    if (clientBankDetails != null) {
                                        if (clientBankDetailAccountNumber != null) {
                                            clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                            clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                        }

                                        if (clientBankDetailIbanNo != null) {
                                            clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                            clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                        }
                                    }

                                    if (clientAgreement != null) {
                                        if (providerPricing != null) {
                                            if (pricing != null) pricing.PriceType = priceType;

                                            providerPricing.Currency = providerPricingCurrency;
                                            providerPricing.Pricing = pricing;
                                        }

                                        agreement.Organization = agreementOrganization;
                                        agreement.Currency = agreementCurrency;
                                        agreement.ProviderPricing = providerPricing;

                                        clientAgreement.Agreement = agreement;

                                        client.ClientAgreements.Add(clientAgreement);
                                    }

                                    client.Region = region;
                                    client.RegionCode = regionCode;
                                    client.Country = country;
                                    client.ClientBankDetails = clientBankDetails;
                                    client.TermsOfDelivery = termsOfDelivery;
                                    client.PackingMarking = packingMarking;
                                    client.PackingMarkingPayment = packingMarkingPayment;
                                }

                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyOrderContainerService.SupplyOrder = supplyOrder;

                                containerService.SupplyOrderContainerServices.Add(supplyOrderContainerService);
                            }

                            containerService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            containerService.ContainerOrganization = containerOrganization;
                            containerService.BillOfLadingDocument = billOfLadingDocument;
                            containerService.User = user;

                            taskFromList.ContainerServices.Add(containerService);

                            decimal exchangeRateAmount = 1;

                            if (currency != null) {
                                if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                                if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                    if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                        PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                    } else {
                                        groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                            Currency = currency,
                                            TotalPrice = taskFromList.GrossPrice
                                        });
                                    }
                                }
                            }

                            if (exchangeRateAmount < decimal.Zero) {
                                exchangeRateAmount = 0 - exchangeRateAmount;

                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                            } else {
                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                            }

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                                groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                            }
                        }
                    } else {
                        if (invoiceDocument != null) containerService.InvoiceDocuments.Add(invoiceDocument);

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrderContainerService != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            supplyOrderContainerService.SupplyOrder = supplyOrder;

                            containerService.SupplyOrderContainerServices.Add(supplyOrderContainerService);
                        }

                        containerService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        containerService.ContainerOrganization = containerOrganization;
                        containerService.BillOfLadingDocument = billOfLadingDocument;
                        containerService.User = user;

                        taskFromList.ContainerServices.Add(containerService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return containerService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [ContainerService] " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [ContainerService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [ContainerOrganization] " +
                    "ON [ContainerOrganization].ID = [ContainerService].ContainerOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [ContainerService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [BillOfLadingDocument] " +
                    "ON [BillOfLadingDocument].ID = [ContainerService].BillOfLadingDocumentID " +
                    "LEFT JOIN [User] AS [ContainerServiceUser] " +
                    "ON [ContainerServiceUser].ID = [ContainerService].UserID " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].ContainerServiceID = [ContainerService].ID " +
                    "LEFT JOIN [SupplyOrderContainerService] " +
                    "ON [SupplyOrderContainerService].ContainerServiceID = [ContainerService].ID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [SupplyOrderContainerService].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [SupplyOrder].ClientID = [Client].ID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [ContainerService].ID IN @Ids " +
                    "AND [SupplyOrderContainerService].Deleted = 0 ",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingContainerService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingVehicleService))) {
                Type[] includesTypes = new[] {
                    typeof(VehicleService),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(BillOfLadingDocument),
                    typeof(User),
                    typeof(InvoiceDocument),
                    typeof(SupplyOrderVehicleService),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], VehicleService> includesMapper = objects => {
                    VehicleService vehicleService = (VehicleService)objects[0];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[1];
                    SupplyOrganization vehicleOrganization = (SupplyOrganization)objects[2];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[3];
                    Currency currency = (Currency)objects[4];
                    BillOfLadingDocument billOfLadingDocument = (BillOfLadingDocument)objects[5];
                    User user = (User)objects[6];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[7];
                    SupplyOrderVehicleService supplyOrderVehicleService = (SupplyOrderVehicleService)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.VehicleServices.Any()) {
                        if (taskFromList.VehicleServices.Any(s => s.Id.Equals(vehicleService.Id))) {
                            VehicleService serviceFromList = taskFromList.VehicleServices.First(s => s.Id.Equals(vehicleService.Id));

                            if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                            if (supplyOrderVehicleService != null && !serviceFromList.SupplyOrderVehicleServices.Any(s => s.Id.Equals(supplyOrderVehicleService.Id))) {
                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyOrderVehicleService.SupplyOrder = supplyOrder;

                                serviceFromList.SupplyOrderVehicleServices.Add(supplyOrderVehicleService);
                            }
                        } else {
                            if (vehicleOrganization != null) { }

                            if (invoiceDocument != null) vehicleService.InvoiceDocuments.Add(invoiceDocument);

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            if (supplyOrderVehicleService != null) {
                                if (client != null) {
                                    if (clientBankDetails != null) {
                                        if (clientBankDetailAccountNumber != null) {
                                            clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                            clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                        }

                                        if (clientBankDetailIbanNo != null) {
                                            clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                            clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                        }
                                    }

                                    if (clientAgreement != null) {
                                        if (providerPricing != null) {
                                            if (pricing != null) pricing.PriceType = priceType;

                                            providerPricing.Currency = providerPricingCurrency;
                                            providerPricing.Pricing = pricing;
                                        }

                                        agreement.Organization = agreementOrganization;
                                        agreement.Currency = agreementCurrency;
                                        agreement.ProviderPricing = providerPricing;

                                        clientAgreement.Agreement = agreement;

                                        client.ClientAgreements.Add(clientAgreement);
                                    }

                                    client.Region = region;
                                    client.RegionCode = regionCode;
                                    client.Country = country;
                                    client.ClientBankDetails = clientBankDetails;
                                    client.TermsOfDelivery = termsOfDelivery;
                                    client.PackingMarking = packingMarking;
                                    client.PackingMarkingPayment = packingMarkingPayment;
                                }

                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyOrderVehicleService.SupplyOrder = supplyOrder;

                                vehicleService.SupplyOrderVehicleServices.Add(supplyOrderVehicleService);
                            }

                            vehicleService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            vehicleService.VehicleOrganization = vehicleOrganization;
                            vehicleService.BillOfLadingDocument = billOfLadingDocument;
                            vehicleService.User = user;

                            taskFromList.VehicleServices.Add(vehicleService);

                            decimal exchangeRateAmount = 1;

                            if (currency != null) {
                                if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                                if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                    if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                        PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                    } else {
                                        groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                            Currency = currency,
                                            TotalPrice = taskFromList.GrossPrice
                                        });
                                    }
                                }
                            }

                            if (exchangeRateAmount < decimal.Zero) {
                                exchangeRateAmount = 0 - exchangeRateAmount;

                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                            } else {
                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                            }

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                                groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                            }
                        }
                    } else {
                        if (invoiceDocument != null) vehicleService.InvoiceDocuments.Add(invoiceDocument);

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrderVehicleService != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            supplyOrderVehicleService.SupplyOrder = supplyOrder;

                            vehicleService.SupplyOrderVehicleServices.Add(supplyOrderVehicleService);
                        }

                        vehicleService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        vehicleService.VehicleOrganization = vehicleOrganization;
                        vehicleService.BillOfLadingDocument = billOfLadingDocument;
                        vehicleService.User = user;

                        taskFromList.VehicleServices.Add(vehicleService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return vehicleService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [VehicleService] " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [VehicleService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [VehicleOrganization] " +
                    "ON [VehicleOrganization].ID = [VehicleService].VehicleOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [VehicleService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [BillOfLadingDocument] " +
                    "ON [BillOfLadingDocument].ID = [VehicleService].BillOfLadingDocumentID " +
                    "LEFT JOIN [User] AS [VehicleServiceUser] " +
                    "ON [VehicleServiceUser].ID = [VehicleService].UserID " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].VehicleServiceID = [VehicleService].ID " +
                    "LEFT JOIN [SupplyOrderVehicleService] " +
                    "ON [SupplyOrderVehicleService].VehicleServiceID = [VehicleService].ID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [SupplyOrderVehicleService].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [SupplyOrder].ClientID = [Client].ID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [VehicleService].ID IN @Ids " +
                    "AND [SupplyOrderVehicleService].Deleted = 0 ",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingVehicleService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingCustomService))) {
                Type[] includesTypes = new[] {
                    typeof(CustomService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrderNumber),
                    typeof(SupplyOrganizationAgreement),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(Currency)
                };

                Func<object[], CustomService> includesMapper = objects => {
                    CustomService customService = (CustomService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization exciseDutyOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganization customOrganization = (SupplyOrganization)objects[4];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[5];
                    Client client = (Client)objects[6];
                    Region region = (Region)objects[7];
                    RegionCode regionCode = (RegionCode)objects[8];
                    Country country = (Country)objects[9];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[10];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[11];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[12];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[13];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[14];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[15];
                    PackingMarking packingMarking = (PackingMarking)objects[16];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[17];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[18];
                    Agreement agreement = (Agreement)objects[19];
                    ProviderPricing providerPricing = (ProviderPricing)objects[20];
                    Currency providerPricingCurrency = (Currency)objects[21];
                    Pricing pricing = (Pricing)objects[22];
                    PriceType priceType = (PriceType)objects[23];
                    Organization agreementOrganization = (Organization)objects[24];
                    Currency agreementCurrency = (Currency)objects[25];
                    Organization organization = (Organization)objects[26];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[27];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[28];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[29];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[30];
                    SupplyOrganizationAgreement exciseOrganizationAgreement = (SupplyOrganizationAgreement)objects[31];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[32];
                    Organization exciseOrganizationOrganization = (Organization)objects[33];
                    Organization customSupplyOrganizationOrganization = (Organization)objects[34];
                    Currency currency = (Currency)objects[35];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.BrokerServices.Any()) {
                        CustomService serviceFromList = taskFromList.BrokerServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }
                    } else {
                        if (exciseDutyOrganization != null && exciseOrganizationAgreement != null) {
                            if (!exciseDutyOrganization.SupplyOrganizationAgreements.Any(x => x.Id == exciseOrganizationAgreement.Id))
                                exciseDutyOrganization.SupplyOrganizationAgreements.Add(exciseOrganizationAgreement);
                            else
                                exciseOrganizationAgreement = exciseDutyOrganization.SupplyOrganizationAgreements.First(x => x.Id == exciseOrganizationAgreement.Id);

                            exciseOrganizationAgreement.Organization = exciseOrganizationOrganization;
                        }

                        if (customOrganization != null) { }

                        if (invoiceDocument != null) customService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            customService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = customSupplyOrganizationOrganization;
                        }

                        if (client != null) {
                            if (clientBankDetails != null) {
                                if (clientBankDetailAccountNumber != null) {
                                    clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                    clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                }

                                if (clientBankDetailIbanNo != null) {
                                    clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                    clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                }
                            }

                            if (clientAgreement != null) {
                                if (providerPricing != null) {
                                    if (pricing != null) pricing.PriceType = priceType;

                                    providerPricing.Currency = providerPricingCurrency;
                                    providerPricing.Pricing = pricing;
                                }

                                agreement.Organization = agreementOrganization;
                                agreement.Currency = agreementCurrency;
                                agreement.ProviderPricing = providerPricing;

                                clientAgreement.Agreement = agreement;

                                client.ClientAgreements.Add(clientAgreement);
                            }

                            client.Region = region;
                            client.RegionCode = regionCode;
                            client.Country = country;
                            client.ClientBankDetails = clientBankDetails;
                            client.TermsOfDelivery = termsOfDelivery;
                            client.PackingMarking = packingMarking;
                            client.PackingMarkingPayment = packingMarkingPayment;
                        }

                        supplyOrder.Client = client;
                        supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                        supplyOrder.Organization = organization;

                        customService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        customService.SupplyOrder = supplyOrder;
                        customService.User = user;
                        customService.ExciseDutyOrganization = exciseDutyOrganization;
                        customService.CustomOrganization = customOrganization;

                        taskFromList.BrokerServices.Add(customService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return customService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [CustomService] " +
                    "LEFT JOIN [User] AS [CustomServiceUser] " +
                    "ON [CustomServiceUser].ID = [CustomService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [CustomService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [ExciseDutyOrganization] " +
                    "ON [ExciseDutyOrganization].ID = [CustomService].ExciseDutyOrganizationID " +
                    "LEFT JOIN [SupplyOrganization] AS [CustomOrganization] " +
                    "ON [CustomOrganization].ID = [CustomService].CustomOrganizationID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [CustomService].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].CustomServiceID = [CustomService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].CustomServiceID = [CustomService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] AS [ExciseDutyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].SupplyOrganizationID = [ExciseDutyOrganization].ID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [CustomService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [ExciseDutyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [CustomSupplyOrganizationOrganization] " +
                    "ON [CustomSupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [CustomSupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "WHERE [CustomService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingCustomService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingPortWorkService))) {
                Type[] includesTypes = new[] {
                    typeof(PortWorkService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], PortWorkService> includesMapper = objects => {
                    PortWorkService portWorkService = (PortWorkService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization portWorkOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.PortWorkServices.Any()) {
                        if (taskFromList.PortWorkServices.Any(s => s.Id.Equals(portWorkService.Id))) {
                            PortWorkService serviceFromList = taskFromList.PortWorkServices.First();

                            if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                            if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                                serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                                serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                            }

                            if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                                supplyOrder.Client = client;
                                supplyOrder.Organization = organization;

                                serviceFromList.SupplyOrders.Add(supplyOrder);
                            }
                        } else {
                            if (invoiceDocument != null) portWorkService.InvoiceDocuments.Add(invoiceDocument);

                            if (serviceDetailItem != null) {
                                serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                                portWorkService.ServiceDetailItems.Add(serviceDetailItem);
                            }

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            if (supplyOrder != null) {
                                if (client != null) {
                                    if (clientBankDetails != null) {
                                        if (clientBankDetailAccountNumber != null) {
                                            clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                            clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                        }

                                        if (clientBankDetailIbanNo != null) {
                                            clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                            clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                        }
                                    }

                                    if (clientAgreement != null) {
                                        if (providerPricing != null) {
                                            if (pricing != null) pricing.PriceType = priceType;

                                            providerPricing.Currency = providerPricingCurrency;
                                            providerPricing.Pricing = pricing;
                                        }

                                        agreement.Organization = agreementOrganization;
                                        agreement.Currency = agreementCurrency;
                                        agreement.ProviderPricing = providerPricing;

                                        clientAgreement.Agreement = agreement;

                                        client.ClientAgreements.Add(clientAgreement);
                                    }

                                    client.Region = region;
                                    client.RegionCode = regionCode;
                                    client.Country = country;
                                    client.ClientBankDetails = clientBankDetails;
                                    client.TermsOfDelivery = termsOfDelivery;
                                    client.PackingMarking = packingMarking;
                                    client.PackingMarkingPayment = packingMarkingPayment;
                                }

                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                portWorkService.SupplyOrders.Add(supplyOrder);
                            }

                            portWorkService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            portWorkService.User = user;
                            portWorkService.PortWorkOrganization = portWorkOrganization;

                            taskFromList.PortWorkServices.Add(portWorkService);

                            decimal exchangeRateAmount = 1;

                            if (currency != null) {
                                if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                                if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                    if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                        PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                    } else {
                                        groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                            Currency = currency,
                                            TotalPrice = taskFromList.GrossPrice
                                        });
                                    }
                                }
                            }

                            if (exchangeRateAmount < decimal.Zero) {
                                exchangeRateAmount = 0 - exchangeRateAmount;

                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                            } else {
                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                            }

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                                groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                            }
                        }
                    } else {
                        if (invoiceDocument != null) portWorkService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            portWorkService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            portWorkService.SupplyOrders.Add(supplyOrder);
                        }

                        portWorkService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        portWorkService.User = user;
                        portWorkService.PortWorkOrganization = portWorkOrganization;

                        taskFromList.PortWorkServices.Add(portWorkService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return portWorkService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [PortWorkService] " +
                    "LEFT JOIN [User] AS [PortWorkServiceUser] " +
                    "ON [PortWorkServiceUser].ID = [PortWorkService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [PortWorkService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [PortWorkOrganization] " +
                    "ON [PortWorkOrganization].ID = [PortWorkService].PortWorkOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [PortWorkService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].PortWorkServiceID = [PortWorkService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].PortWorkServiceID = [PortWorkService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].PortWorkServiceID = [PortWorkService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [PortWorkService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingPortWorkService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingTransportationService))) {
                Type[] includesTypes = new[] {
                    typeof(TransportationService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], TransportationService> includesMapper = objects => {
                    TransportationService transportationService = (TransportationService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization transportationOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.TransportationServices.Any()) {
                        TransportationService serviceFromList = taskFromList.TransportationServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) transportationService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            transportationService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            transportationService.SupplyOrders.Add(supplyOrder);
                        }

                        transportationService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        transportationService.User = user;
                        transportationService.TransportationOrganization = transportationOrganization;

                        taskFromList.TransportationServices.Add(transportationService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return transportationService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [TransportationService] " +
                    "LEFT JOIN [User] AS [TransportationServiceUser] " +
                    "ON [TransportationServiceUser].ID = [TransportationService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [TransportationService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [TransportationOrganization] " +
                    "ON [TransportationOrganization].ID = [TransportationService].TransportationOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [TransportationService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].TransportationServiceID = [TransportationService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].TransportationServiceID = [TransportationService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].TransportationServiceID = [TransportationService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [TransportationService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingTransportationService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingPortCustomAgencyService))) {
                Type[] includesTypes = new[] {
                    typeof(PortCustomAgencyService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], PortCustomAgencyService> includesMapper = objects => {
                    PortCustomAgencyService portCustomAgencyService = (PortCustomAgencyService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization portCustomAgencyOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.PortCustomAgencyServices.Any()) {
                        PortCustomAgencyService serviceFromList = taskFromList.PortCustomAgencyServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) portCustomAgencyService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            portCustomAgencyService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            portCustomAgencyService.SupplyOrders.Add(supplyOrder);
                        }

                        portCustomAgencyService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        portCustomAgencyService.User = user;
                        portCustomAgencyService.PortCustomAgencyOrganization = portCustomAgencyOrganization;

                        taskFromList.PortCustomAgencyServices.Add(portCustomAgencyService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return portCustomAgencyService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [PortCustomAgencyService] " +
                    "LEFT JOIN [User] AS [PortCustomAgencyServiceUser] " +
                    "ON [PortCustomAgencyServiceUser].ID = [PortCustomAgencyService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [PortCustomAgencyService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [PortCustomAgencyOrganization] " +
                    "ON [PortCustomAgencyOrganization].ID = [PortCustomAgencyService].PortCustomAgencyOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [PortCustomAgencyService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].PortCustomAgencyServiceID = [PortCustomAgencyService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].PortCustomAgencyServiceID = [PortCustomAgencyService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].PortCustomAgencyServiceID = [PortCustomAgencyService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [PortCustomAgencyService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingPortCustomAgencyService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingCustomAgencyService))) {
                Type[] includesTypes = new[] {
                    typeof(CustomAgencyService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], CustomAgencyService> includesMapper = objects => {
                    CustomAgencyService customAgencyService = (CustomAgencyService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization customAgencyOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.CustomAgencyServices.Any()) {
                        CustomAgencyService serviceFromList = taskFromList.CustomAgencyServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) customAgencyService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            customAgencyService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            customAgencyService.SupplyOrders.Add(supplyOrder);
                        }

                        customAgencyService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        customAgencyService.User = user;
                        customAgencyService.CustomAgencyOrganization = customAgencyOrganization;

                        taskFromList.CustomAgencyServices.Add(customAgencyService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return customAgencyService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [CustomAgencyService] " +
                    "LEFT JOIN [User] AS [CustomAgencyServiceUser] " +
                    "ON [CustomAgencyServiceUser].ID = [CustomAgencyService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [CustomAgencyService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [CustomAgencyOrganization] " +
                    "ON [CustomAgencyOrganization].ID = [CustomAgencyService].CustomAgencyOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [CustomAgencyService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].CustomAgencyServiceID = [CustomAgencyService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].CustomAgencyServiceID = [CustomAgencyService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].CustomAgencyServiceID = [CustomAgencyService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [CustomAgencyService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingCustomAgencyService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingPlaneDeliveryService))) {
                Type[] includesTypes = new[] {
                    typeof(PlaneDeliveryService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], PlaneDeliveryService> includesMapper = objects => {
                    PlaneDeliveryService planeDeliveryService = (PlaneDeliveryService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization planeDeliveryOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.PlaneDeliveryServices.Any()) {
                        PlaneDeliveryService serviceFromList = taskFromList.PlaneDeliveryServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) planeDeliveryService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            planeDeliveryService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            planeDeliveryService.SupplyOrders.Add(supplyOrder);
                        }

                        planeDeliveryService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        planeDeliveryService.User = user;
                        planeDeliveryService.PlaneDeliveryOrganization = planeDeliveryOrganization;

                        taskFromList.PlaneDeliveryServices.Add(planeDeliveryService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return planeDeliveryService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [PlaneDeliveryService] " +
                    "LEFT JOIN [User] AS [PlaneDeliveryServiceUser] " +
                    "ON [PlaneDeliveryServiceUser].ID = [PlaneDeliveryService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [PlaneDeliveryService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [PlaneDeliveryOrganization] " +
                    "ON [PlaneDeliveryOrganization].ID = [PlaneDeliveryService].PlaneDeliveryOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [PlaneDeliveryService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].PlaneDeliveryServiceID = [PlaneDeliveryService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].PlaneDeliveryServiceID = [PlaneDeliveryService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].PlaneDeliveryServiceID = [PlaneDeliveryService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [PlaneDeliveryService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingPlaneDeliveryService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingVehicleDeliveryService))) {
                Type[] includesTypes = new[] {
                    typeof(VehicleDeliveryService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber)
                };

                Func<object[], VehicleDeliveryService> includesMapper = objects => {
                    VehicleDeliveryService vehicleDeliveryService = (VehicleDeliveryService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization vehicleDeliveryOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.VehicleDeliveryServices.Any()) {
                        VehicleDeliveryService serviceFromList = taskFromList.VehicleDeliveryServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrder != null && !serviceFromList.SupplyOrders.Any(o => o.Id.Equals(supplyOrder.Id))) {
                            supplyOrder.Client = client;
                            supplyOrder.Organization = organization;

                            serviceFromList.SupplyOrders.Add(supplyOrder);
                        }
                    } else {
                        if (invoiceDocument != null) vehicleDeliveryService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            vehicleDeliveryService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            vehicleDeliveryService.SupplyOrders.Add(supplyOrder);
                        }

                        vehicleDeliveryService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        vehicleDeliveryService.User = user;
                        vehicleDeliveryService.VehicleDeliveryOrganization = vehicleDeliveryOrganization;

                        taskFromList.VehicleDeliveryServices.Add(vehicleDeliveryService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return vehicleDeliveryService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [VehicleDeliveryService] " +
                    "LEFT JOIN [User] AS [VehicleDeliveryServiceUser] " +
                    "ON [VehicleDeliveryServiceUser].ID = [VehicleDeliveryService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [VehicleDeliveryService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [VehicleDeliveryOrganization] " +
                    "ON [VehicleDeliveryOrganization].ID = [VehicleDeliveryService].VehicleDeliveryOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [VehicleDeliveryService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].VehicleDeliveryServiceID = [VehicleDeliveryService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].VehicleDeliveryServiceID = [VehicleDeliveryService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].VehicleDeliveryServiceID = [VehicleDeliveryService].ID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "WHERE [VehicleDeliveryService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingVehicleDeliveryService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingMergedService))) {
                Type[] includesTypes = new[] {
                    typeof(MergedService),
                    typeof(User),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(InvoiceDocument),
                    typeof(ServiceDetailItem),
                    typeof(ServiceDetailItemKey),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber),
                    typeof(SupplyOrderUkraine),
                    typeof(User),
                    typeof(Organization),
                    typeof(Client),
                    typeof(RegionCode),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(Organization),
                    typeof(Currency)
                };

                Func<object[], MergedService> includesMapper = objects => {
                    MergedService mergedService = (MergedService)objects[0];
                    User user = (User)objects[1];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[2];
                    SupplyOrganization supplyOrganization = (SupplyOrganization)objects[3];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[4];
                    Currency currency = (Currency)objects[5];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[6];
                    ServiceDetailItem serviceDetailItem = (ServiceDetailItem)objects[7];
                    ServiceDetailItemKey serviceDetailItemKey = (ServiceDetailItemKey)objects[8];

                    SupplyOrder supplyOrder = (SupplyOrder)objects[9];
                    Client client = (Client)objects[10];
                    Region region = (Region)objects[11];
                    RegionCode regionCode = (RegionCode)objects[12];
                    Country country = (Country)objects[13];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[14];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[15];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[16];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[17];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[18];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[19];
                    PackingMarking packingMarking = (PackingMarking)objects[20];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[21];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[22];
                    Agreement agreement = (Agreement)objects[23];
                    ProviderPricing providerPricing = (ProviderPricing)objects[24];
                    Currency providerPricingCurrency = (Currency)objects[25];
                    Pricing pricing = (Pricing)objects[26];
                    PriceType priceType = (PriceType)objects[27];
                    Organization agreementOrganization = (Organization)objects[28];
                    Currency agreementCurrency = (Currency)objects[29];
                    Organization organization = (Organization)objects[30];
                    Organization supplyOrganizationOrganization = (Organization)objects[31];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[32];

                    SupplyOrderUkraine supplyOrderUkraine = (SupplyOrderUkraine)objects[33];
                    User responsible = (User)objects[34];
                    Organization ukOrganization = (Organization)objects[35];
                    Client supplier = (Client)objects[36];
                    RegionCode supplierRegionCode = (RegionCode)objects[37];
                    ClientAgreement supplierClientAgreement = (ClientAgreement)objects[38];
                    Agreement supplierAgreement = (Agreement)objects[39];
                    Organization supplierAgreementOrganization = (Organization)objects[40];
                    Currency supplierAgreementCurrency = (Currency)objects[41];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.MergedServices.Any()) {
                        MergedService serviceFromList = taskFromList.MergedServices.First();

                        if (invoiceDocument != null && !serviceFromList.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                            serviceFromList.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null && !serviceFromList.ServiceDetailItems.Any(i => i.Id.Equals(serviceDetailItem.Id))) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            serviceFromList.ServiceDetailItems.Add(serviceDetailItem);
                        }
                    } else {
                        if (invoiceDocument != null) mergedService.InvoiceDocuments.Add(invoiceDocument);

                        if (serviceDetailItem != null) {
                            serviceDetailItem.ServiceDetailItemKey = serviceDetailItemKey;

                            mergedService.ServiceDetailItems.Add(serviceDetailItem);
                        }

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyOrderUkraine != null) {
                            supplierAgreement.Organization = supplierAgreementOrganization;
                            supplierAgreement.Currency = supplierAgreementCurrency;

                            supplierClientAgreement.Agreement = supplierAgreement;

                            supplier.RegionCode = supplierRegionCode;

                            supplyOrderUkraine.Supplier = supplier;
                            supplyOrderUkraine.Responsible = responsible;
                            supplyOrderUkraine.Organization = ukOrganization;
                            supplyOrderUkraine.ClientAgreement = supplierClientAgreement;

                            mergedService.SupplyOrderUkraine = supplyOrderUkraine;
                        }

                        if (supplyOrder != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            mergedService.SupplyOrder = supplyOrder;
                        }

                        mergedService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        mergedService.User = user;
                        mergedService.SupplyOrganization = supplyOrganization;

                        taskFromList.MergedServices.Add(mergedService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return mergedService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [MergedService] " +
                    "LEFT JOIN [User] AS [MergedServiceUser] " +
                    "ON [MergedServiceUser].ID = [MergedService].UserID " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [MergedService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] AS [MergedServiceSupplyOrganization] " +
                    "ON [MergedServiceSupplyOrganization].ID = [MergedService].SupplyOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [MergedService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].MergedServiceID = [MergedService].ID " +
                    "AND [InvoiceDocument].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItem] " +
                    "ON [ServiceDetailItem].MergedServiceID = [MergedService].ID " +
                    "AND [ServiceDetailItem].Deleted = 0 " +
                    "LEFT JOIN [ServiceDetailItemKey] " +
                    "ON [ServiceDetailItemKey].ID = [ServiceDetailItem].ServiceDetailItemKeyID " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [MergedService].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [Client].ID = [SupplyOrder].ClientID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "LEFT JOIN [SupplyOrderUkraine] " +
                    "ON [MergedService].SupplyOrderUkraineID = [SupplyOrderUkraine].ID " +
                    "LEFT JOIN [User] AS [Responsible] " +
                    "ON [Responsible].ID = [SupplyOrderUkraine].ResponsibleID " +
                    "LEFT JOIN [views].[OrganizationView] AS [UkOrganization] " +
                    "ON [UkOrganization].ID = [SupplyOrderUkraine].OrganizationID " +
                    "AND [UkOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [Client] AS [Supplier] " +
                    "ON [Supplier].ID = [SupplyOrderUkraine].SupplierID " +
                    "LEFT JOIN [RegionCode] AS [SupplierRegionCode] " +
                    "ON [SupplierRegionCode].ID = [Supplier].RegionCodeID " +
                    "LEFT JOIN [ClientAgreement] AS [UkClientAgreement] " +
                    "ON [UkClientAgreement].ID = [SupplyOrderUkraine].ClientAgreementID " +
                    "LEFT JOIN [Agreement] AS [UkClientAgreementAgreement] " +
                    "ON [UkClientAgreementAgreement].ID = [UkClientAgreement].AgreementID " +
                    "LEFT JOIN [views].[OrganizationView] AS [UkClientAgreementAgreementOrganization] " +
                    "ON [UkClientAgreementAgreementOrganization].ID = [UkClientAgreementAgreement].OrganizationID " +
                    "AND [UkClientAgreementAgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [UkClientAgreementAgreementCurrency] " +
                    "ON [UkClientAgreementAgreementCurrency].ID = [UkClientAgreementAgreement].CurrencyID " +
                    "AND [UkClientAgreementAgreementCurrency].CultureCode = @Culture " +
                    "WHERE [MergedService].ID IN @Ids",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingMergedService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.BillOfLadingService))) {
                Type[] includesTypes = {
                    typeof(BillOfLadingService),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(BillOfLadingDocument),
                    typeof(User),
                    typeof(SupplyInvoiceBillOfLadingService),
                    typeof(SupplyInvoice),
                    typeof(InvoiceDocument),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber),
                    typeof(DeliveryProductProtocol),
                    typeof(DeliveryProductProtocolNumber)
                };

                Func<object[], BillOfLadingService> includesMapper = objects => {
                    BillOfLadingService billOfLadingService = (BillOfLadingService)objects[0];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[1];
                    SupplyOrganization supplyOrganization = (SupplyOrganization)objects[2];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[3];
                    Currency currency = (Currency)objects[4];
                    BillOfLadingDocument billOfLadingDocument = (BillOfLadingDocument)objects[5];
                    User user = (User)objects[6];
                    SupplyInvoiceBillOfLadingService supplyInvoiceBillOfLadingService = (SupplyInvoiceBillOfLadingService)objects[7];
                    SupplyInvoice supplyInvoice = (SupplyInvoice)objects[8];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[9];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[10];
                    Client client = (Client)objects[11];
                    Region region = (Region)objects[12];
                    RegionCode regionCode = (RegionCode)objects[13];
                    Country country = (Country)objects[14];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[15];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[16];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[17];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[18];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[19];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[20];
                    PackingMarking packingMarking = (PackingMarking)objects[21];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[22];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[23];
                    Agreement agreement = (Agreement)objects[24];
                    ProviderPricing providerPricing = (ProviderPricing)objects[25];
                    Currency providerPricingCurrency = (Currency)objects[26];
                    Pricing pricing = (Pricing)objects[27];
                    PriceType priceType = (PriceType)objects[28];
                    Organization agreementOrganization = (Organization)objects[29];
                    Currency agreementCurrency = (Currency)objects[30];
                    Organization organization = (Organization)objects[31];
                    Organization supplyOrganizationOrganization = (Organization)objects[32];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[33];
                    DeliveryProductProtocol protocol = (DeliveryProductProtocol)objects[34];
                    DeliveryProductProtocolNumber protocolNumber = (DeliveryProductProtocolNumber)objects[35];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.BillOfLadingServices.Any()) {
                        if (taskFromList.BillOfLadingServices.Any(s => s.Id.Equals(billOfLadingService.Id))) {
                            BillOfLadingService serviceFromList = taskFromList.BillOfLadingServices.First(s => s.Id.Equals(billOfLadingService.Id));

                            if (billOfLadingDocument != null && !serviceFromList.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                                serviceFromList.BillOfLadingDocuments.Add(billOfLadingDocument);

                            if (supplyInvoiceBillOfLadingService != null &&
                                !serviceFromList.SupplyInvoiceBillOfLadingServices.Any(s => s.Id.Equals(supplyInvoiceBillOfLadingService.Id))) {
                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyInvoice.SupplyOrder = supplyOrder;

                                supplyInvoiceBillOfLadingService.SupplyInvoice = supplyInvoice;

                                if (invoiceDocument != null && !supplyInvoice.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                    supplyInvoice.InvoiceDocuments.Add(invoiceDocument);

                                serviceFromList.SupplyInvoiceBillOfLadingServices.Add(supplyInvoiceBillOfLadingService);
                            }
                        } else {
                            if (billOfLadingDocument != null && !billOfLadingService.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                                billOfLadingService.BillOfLadingDocuments.Add(billOfLadingDocument);

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            if (supplyInvoiceBillOfLadingService != null) {
                                if (client != null) {
                                    if (clientBankDetails != null) {
                                        if (clientBankDetailAccountNumber != null) {
                                            clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                            clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                        }

                                        if (clientBankDetailIbanNo != null) {
                                            clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                            clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                        }
                                    }

                                    if (clientAgreement != null) {
                                        if (providerPricing != null) {
                                            if (pricing != null) pricing.PriceType = priceType;

                                            providerPricing.Currency = providerPricingCurrency;
                                            providerPricing.Pricing = pricing;
                                        }

                                        agreement.Organization = agreementOrganization;
                                        agreement.Currency = agreementCurrency;
                                        agreement.ProviderPricing = providerPricing;

                                        clientAgreement.Agreement = agreement;

                                        client.ClientAgreements.Add(clientAgreement);
                                    }

                                    client.Region = region;
                                    client.RegionCode = regionCode;
                                    client.Country = country;
                                    client.ClientBankDetails = clientBankDetails;
                                    client.TermsOfDelivery = termsOfDelivery;
                                    client.PackingMarking = packingMarking;
                                    client.PackingMarkingPayment = packingMarkingPayment;
                                }

                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyInvoice.SupplyOrder = supplyOrder;

                                supplyInvoiceBillOfLadingService.SupplyInvoice = supplyInvoice;

                                billOfLadingService.SupplyInvoiceBillOfLadingServices.Add(supplyInvoiceBillOfLadingService);
                            }

                            billOfLadingService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            billOfLadingService.SupplyOrganization = supplyOrganization;

                            protocol.DeliveryProductProtocolNumber = protocolNumber;

                            billOfLadingService.DeliveryProductProtocol = protocol;

                            if (billOfLadingDocument != null && !billOfLadingService.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                                billOfLadingService.BillOfLadingDocuments.Add(billOfLadingDocument);

                            billOfLadingService.User = user;

                            taskFromList.BillOfLadingServices.Add(billOfLadingService);

                            decimal exchangeRateAmount = 1;

                            if (currency != null) {
                                if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                                if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                    if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                        PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                    } else {
                                        groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                            Currency = currency,
                                            TotalPrice = taskFromList.GrossPrice
                                        });
                                    }
                                }
                            }

                            if (exchangeRateAmount < decimal.Zero) {
                                exchangeRateAmount = 0 - exchangeRateAmount;

                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                            } else {
                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                            }

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                                groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                            }
                        }
                    } else {
                        if (billOfLadingDocument != null && !billOfLadingService.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                            billOfLadingService.BillOfLadingDocuments.Add(billOfLadingDocument);

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyInvoiceBillOfLadingService != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            supplyInvoice.SupplyOrder = supplyOrder;

                            supplyInvoiceBillOfLadingService.SupplyInvoice = supplyInvoice;

                            billOfLadingService.SupplyInvoiceBillOfLadingServices.Add(supplyInvoiceBillOfLadingService);
                        }

                        billOfLadingService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        billOfLadingService.SupplyOrganization = supplyOrganization;

                        protocol.DeliveryProductProtocolNumber = protocolNumber;

                        billOfLadingService.DeliveryProductProtocol = protocol;

                        if (billOfLadingDocument != null && !billOfLadingService.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                            billOfLadingService.BillOfLadingDocuments.Add(billOfLadingDocument);

                        billOfLadingService.User = user;

                        taskFromList.BillOfLadingServices.Add(billOfLadingService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return billOfLadingService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [BillOfLadingService] " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [BillOfLadingService].SupplyPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] " +
                    "ON [SupplyOrganization].ID = [BillOfLadingService].SupplyOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [BillOfLadingService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [BillOfLadingDocument] " +
                    "ON [BillOfLadingDocument].[BillOfLadingServiceID] = [BillOfLadingService].[ID] " +
                    "AND [BillOfLadingDocument].[Deleted] = 0 " +
                    "LEFT JOIN [User] AS [BillOfLadingServiceUser] " +
                    "ON [BillOfLadingServiceUser].ID = [BillOfLadingService].UserID " +
                    "LEFT JOIN [SupplyInvoiceBillOfLadingService] " +
                    "ON [SupplyInvoiceBillOfLadingService].[BillOfLadingServiceID] = [BillOfLadingService].[ID] " +
                    "LEFT JOIN [SupplyInvoice] " +
                    "ON [SupplyInvoice].[ID] = [SupplyInvoiceBillOfLadingService].[SupplyInvoiceID] " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].[SupplyInvoiceID] = [SupplyInvoice].[ID] " +
                    "AND [InvoiceDocument].[Deleted] = 0 " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [SupplyInvoice].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [SupplyOrder].ClientID = [Client].ID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "LEFT JOIN [DeliveryProductProtocol] " +
                    "ON [DeliveryProductProtocol].[ID] = [BillOfLadingService].[DeliveryProductProtocolID] " +
                    "LEFT JOIN [DeliveryProductProtocolNumber] " +
                    "ON [DeliveryProductProtocolNumber].[ID] = [DeliveryProductProtocol].[DeliveryProductProtocolNumberID] " +
                    "WHERE [BillOfLadingService].ID IN @Ids ",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.BillOfLadingService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }

            if (joinServices.Any(s => s.Type.Equals(JoinServiceType.AccountingBillOfLadingService))) {
                Type[] includesTypes = {
                    typeof(BillOfLadingService),
                    typeof(SupplyPaymentTask),
                    typeof(SupplyOrganization),
                    typeof(SupplyOrganizationAgreement),
                    typeof(Currency),
                    typeof(BillOfLadingDocument),
                    typeof(User),
                    typeof(SupplyInvoiceBillOfLadingService),
                    typeof(SupplyInvoice),
                    typeof(InvoiceDocument),
                    typeof(SupplyOrder),
                    typeof(Client),
                    typeof(Region),
                    typeof(RegionCode),
                    typeof(Country),
                    typeof(ClientBankDetails),
                    typeof(ClientBankDetailAccountNumber),
                    typeof(Currency),
                    typeof(ClientBankDetailIbanNo),
                    typeof(Currency),
                    typeof(TermsOfDelivery),
                    typeof(PackingMarking),
                    typeof(PackingMarkingPayment),
                    typeof(ClientAgreement),
                    typeof(Agreement),
                    typeof(ProviderPricing),
                    typeof(Currency),
                    typeof(Pricing),
                    typeof(PriceType),
                    typeof(Organization),
                    typeof(Currency),
                    typeof(Organization),
                    typeof(Organization),
                    typeof(SupplyOrderNumber),
                    typeof(DeliveryProductProtocol),
                    typeof(DeliveryProductProtocolNumber)
                };

                Func<object[], BillOfLadingService> includesMapper = objects => {
                    BillOfLadingService billOfLadingService = (BillOfLadingService)objects[0];
                    SupplyPaymentTask supplyPaymentTask = (SupplyPaymentTask)objects[1];
                    SupplyOrganization supplyOrganization = (SupplyOrganization)objects[2];
                    SupplyOrganizationAgreement supplyOrganizationAgreement = (SupplyOrganizationAgreement)objects[3];
                    Currency currency = (Currency)objects[4];
                    BillOfLadingDocument billOfLadingDocument = (BillOfLadingDocument)objects[5];
                    User user = (User)objects[6];
                    SupplyInvoiceBillOfLadingService supplyInvoiceBillOfLadingService = (SupplyInvoiceBillOfLadingService)objects[7];
                    SupplyInvoice supplyInvoice = (SupplyInvoice)objects[8];
                    InvoiceDocument invoiceDocument = (InvoiceDocument)objects[9];
                    SupplyOrder supplyOrder = (SupplyOrder)objects[10];
                    Client client = (Client)objects[11];
                    Region region = (Region)objects[12];
                    RegionCode regionCode = (RegionCode)objects[13];
                    Country country = (Country)objects[14];
                    ClientBankDetails clientBankDetails = (ClientBankDetails)objects[15];
                    ClientBankDetailAccountNumber clientBankDetailAccountNumber = (ClientBankDetailAccountNumber)objects[16];
                    Currency clientBankDetailAccountNumberCurrency = (Currency)objects[17];
                    ClientBankDetailIbanNo clientBankDetailIbanNo = (ClientBankDetailIbanNo)objects[18];
                    Currency clientBankDetailIbanNoCurrency = (Currency)objects[19];
                    TermsOfDelivery termsOfDelivery = (TermsOfDelivery)objects[20];
                    PackingMarking packingMarking = (PackingMarking)objects[21];
                    PackingMarkingPayment packingMarkingPayment = (PackingMarkingPayment)objects[22];
                    ClientAgreement clientAgreement = (ClientAgreement)objects[23];
                    Agreement agreement = (Agreement)objects[24];
                    ProviderPricing providerPricing = (ProviderPricing)objects[25];
                    Currency providerPricingCurrency = (Currency)objects[26];
                    Pricing pricing = (Pricing)objects[27];
                    PriceType priceType = (PriceType)objects[28];
                    Organization agreementOrganization = (Organization)objects[29];
                    Currency agreementCurrency = (Currency)objects[30];
                    Organization organization = (Organization)objects[31];
                    Organization supplyOrganizationOrganization = (Organization)objects[32];
                    SupplyOrderNumber supplyOrderNumber = (SupplyOrderNumber)objects[33];
                    DeliveryProductProtocol protocol = (DeliveryProductProtocol)objects[34];
                    DeliveryProductProtocolNumber protocolNumber = (DeliveryProductProtocolNumber)objects[35];

                    GroupedPaymentTask groupedTaskFromList =
                        groupedPaymentTaskWithTotals.GroupedPaymentTasks.First(t => t.PayToDate.Equals(supplyPaymentTask.PayToDate.Value.Date));

                    SupplyPaymentTask taskFromList = groupedTaskFromList.SupplyPaymentTasks.First(t => t.Id.Equals(supplyPaymentTask.Id));

                    if (taskFromList.BillOfLadingServices.Any()) {
                        if (taskFromList.BillOfLadingServices.Any(s => s.Id.Equals(billOfLadingService.Id))) {
                            BillOfLadingService serviceFromList = taskFromList.BillOfLadingServices.First(s => s.Id.Equals(billOfLadingService.Id));

                            if (billOfLadingDocument != null && !serviceFromList.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                                serviceFromList.BillOfLadingDocuments.Add(billOfLadingDocument);

                            if (supplyInvoiceBillOfLadingService != null &&
                                !serviceFromList.SupplyInvoiceBillOfLadingServices.Any(s => s.Id.Equals(supplyInvoiceBillOfLadingService.Id))) {
                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyInvoice.SupplyOrder = supplyOrder;

                                supplyInvoiceBillOfLadingService.SupplyInvoice = supplyInvoice;

                                if (invoiceDocument != null && !supplyInvoice.InvoiceDocuments.Any(d => d.Id.Equals(invoiceDocument.Id)))
                                    supplyInvoice.InvoiceDocuments.Add(invoiceDocument);

                                serviceFromList.SupplyInvoiceBillOfLadingServices.Add(supplyInvoiceBillOfLadingService);
                            }
                        } else {
                            if (billOfLadingDocument != null && !billOfLadingService.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                                billOfLadingService.BillOfLadingDocuments.Add(billOfLadingDocument);

                            if (supplyOrganizationAgreement != null) {
                                supplyOrganizationAgreement.Currency = currency;

                                supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                            }

                            if (supplyInvoiceBillOfLadingService != null) {
                                if (client != null) {
                                    if (clientBankDetails != null) {
                                        if (clientBankDetailAccountNumber != null) {
                                            clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                            clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                        }

                                        if (clientBankDetailIbanNo != null) {
                                            clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                            clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                        }
                                    }

                                    if (clientAgreement != null) {
                                        if (providerPricing != null) {
                                            if (pricing != null) pricing.PriceType = priceType;

                                            providerPricing.Currency = providerPricingCurrency;
                                            providerPricing.Pricing = pricing;
                                        }

                                        agreement.Organization = agreementOrganization;
                                        agreement.Currency = agreementCurrency;
                                        agreement.ProviderPricing = providerPricing;

                                        clientAgreement.Agreement = agreement;

                                        client.ClientAgreements.Add(clientAgreement);
                                    }

                                    client.Region = region;
                                    client.RegionCode = regionCode;
                                    client.Country = country;
                                    client.ClientBankDetails = clientBankDetails;
                                    client.TermsOfDelivery = termsOfDelivery;
                                    client.PackingMarking = packingMarking;
                                    client.PackingMarkingPayment = packingMarkingPayment;
                                }

                                supplyOrder.Client = client;
                                supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                                supplyOrder.Organization = organization;

                                supplyInvoice.SupplyOrder = supplyOrder;

                                supplyInvoiceBillOfLadingService.SupplyInvoice = supplyInvoice;

                                billOfLadingService.SupplyInvoiceBillOfLadingServices.Add(supplyInvoiceBillOfLadingService);
                            }

                            billOfLadingService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                            billOfLadingService.SupplyOrganization = supplyOrganization;

                            protocol.DeliveryProductProtocolNumber = protocolNumber;

                            billOfLadingService.DeliveryProductProtocol = protocol;

                            if (billOfLadingDocument != null && !billOfLadingService.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                                billOfLadingService.BillOfLadingDocuments.Add(billOfLadingDocument);

                            billOfLadingService.User = user;

                            taskFromList.BillOfLadingServices.Add(billOfLadingService);

                            decimal exchangeRateAmount = 1;

                            if (currency != null) {
                                if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                                if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                    if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                        PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                        totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                    } else {
                                        groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                            Currency = currency,
                                            TotalPrice = taskFromList.GrossPrice
                                        });
                                    }
                                }
                            }

                            if (exchangeRateAmount < decimal.Zero) {
                                exchangeRateAmount = 0 - exchangeRateAmount;

                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                            } else {
                                taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                                taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                            }

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                                groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                            }
                        }
                    } else {
                        if (billOfLadingDocument != null && !billOfLadingService.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                            billOfLadingService.BillOfLadingDocuments.Add(billOfLadingDocument);

                        if (supplyOrganizationAgreement != null) {
                            supplyOrganizationAgreement.Currency = currency;

                            supplyOrganizationAgreement.Organization = supplyOrganizationOrganization;
                        }

                        if (supplyInvoiceBillOfLadingService != null) {
                            if (client != null) {
                                if (clientBankDetails != null) {
                                    if (clientBankDetailAccountNumber != null) {
                                        clientBankDetailAccountNumber.Currency = clientBankDetailAccountNumberCurrency;

                                        clientBankDetails.AccountNumber = clientBankDetailAccountNumber;
                                    }

                                    if (clientBankDetailIbanNo != null) {
                                        clientBankDetailIbanNo.Currency = clientBankDetailIbanNoCurrency;

                                        clientBankDetails.ClientBankDetailIbanNo = clientBankDetailIbanNo;
                                    }
                                }

                                if (clientAgreement != null) {
                                    if (providerPricing != null) {
                                        if (pricing != null) pricing.PriceType = priceType;

                                        providerPricing.Currency = providerPricingCurrency;
                                        providerPricing.Pricing = pricing;
                                    }

                                    agreement.Organization = agreementOrganization;
                                    agreement.Currency = agreementCurrency;
                                    agreement.ProviderPricing = providerPricing;

                                    clientAgreement.Agreement = agreement;

                                    client.ClientAgreements.Add(clientAgreement);
                                }

                                client.Region = region;
                                client.RegionCode = regionCode;
                                client.Country = country;
                                client.ClientBankDetails = clientBankDetails;
                                client.TermsOfDelivery = termsOfDelivery;
                                client.PackingMarking = packingMarking;
                                client.PackingMarkingPayment = packingMarkingPayment;
                            }

                            supplyOrder.Client = client;
                            supplyOrder.SupplyOrderNumber = supplyOrderNumber;
                            supplyOrder.Organization = organization;

                            supplyInvoice.SupplyOrder = supplyOrder;

                            supplyInvoiceBillOfLadingService.SupplyInvoice = supplyInvoice;

                            billOfLadingService.SupplyInvoiceBillOfLadingServices.Add(supplyInvoiceBillOfLadingService);
                        }

                        billOfLadingService.SupplyOrganizationAgreement = supplyOrganizationAgreement;
                        billOfLadingService.SupplyOrganization = supplyOrganization;

                        protocol.DeliveryProductProtocolNumber = protocolNumber;

                        billOfLadingService.DeliveryProductProtocol = protocol;

                        if (billOfLadingDocument != null && !billOfLadingService.BillOfLadingDocuments.Any(d => d.Id.Equals(billOfLadingDocument.Id)))
                            billOfLadingService.BillOfLadingDocuments.Add(billOfLadingDocument);

                        billOfLadingService.User = user;

                        taskFromList.BillOfLadingServices.Add(billOfLadingService);

                        decimal exchangeRateAmount = 1;

                        if (currency != null) {
                            if (!currency.Code.ToLower().Equals("eur")) exchangeRateAmount = GetGovExchangeRateToEuroCurrency(currency);

                            if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                                if (groupedTaskFromList.PriceTotals.Any(t => t.Currency.Id.Equals(currency.Id))) {
                                    PriceTotal totalFromList = groupedTaskFromList.PriceTotals.First(t => t.Currency.Id.Equals(currency.Id));

                                    totalFromList.TotalPrice = Math.Round(totalFromList.TotalPrice + taskFromList.GrossPrice, 2);
                                } else {
                                    groupedTaskFromList.PriceTotals.Add(new PriceTotal {
                                        Currency = currency,
                                        TotalPrice = taskFromList.GrossPrice
                                    });
                                }
                            }
                        }

                        if (exchangeRateAmount < decimal.Zero) {
                            exchangeRateAmount = 0 - exchangeRateAmount;

                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice / exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice / exchangeRateAmount, 2);
                        } else {
                            taskFromList.EuroNetPrice = Math.Round(taskFromList.NetPrice * exchangeRateAmount, 2);
                            taskFromList.EuroGrossPrice = Math.Round(taskFromList.GrossPrice * exchangeRateAmount, 2);
                        }

                        if (!taskFromList.TaskStatus.Equals(TaskStatus.Done)) {
                            groupedTaskFromList.TotalNetAmount = Math.Round(groupedTaskFromList.TotalNetAmount + taskFromList.EuroNetPrice, 2);
                            groupedTaskFromList.TotalGrossAmount = Math.Round(groupedTaskFromList.TotalGrossAmount + taskFromList.EuroGrossPrice, 2);
                        }
                    }

                    return billOfLadingService;
                };

                _connection.Query(
                    "SELECT * " +
                    "FROM [BillOfLadingService] " +
                    "LEFT JOIN [SupplyPaymentTask] " +
                    "ON [SupplyPaymentTask].ID = [BillOfLadingService].AccountingPaymentTaskID " +
                    "LEFT JOIN [SupplyOrganization] " +
                    "ON [SupplyOrganization].ID = [BillOfLadingService].SupplyOrganizationID " +
                    "LEFT JOIN [SupplyOrganizationAgreement] " +
                    "ON [SupplyOrganizationAgreement].ID = [BillOfLadingService].SupplyOrganizationAgreementID " +
                    "LEFT JOIN [views].[CurrencyView] AS [Currency] " +
                    "ON [Currency].ID = [SupplyOrganizationAgreement].CurrencyID " +
                    "AND [Currency].CultureCode = @Culture " +
                    "LEFT JOIN [BillOfLadingDocument] " +
                    "ON [BillOfLadingDocument].[BillOfLadingServiceID] = [BillOfLadingService].[ID] " +
                    "AND [BillOfLadingDocument].[Deleted] = 0 " +
                    "LEFT JOIN [User] AS [BillOfLadingServiceUser] " +
                    "ON [BillOfLadingServiceUser].ID = [BillOfLadingService].UserID " +
                    "LEFT JOIN [SupplyInvoiceBillOfLadingService] " +
                    "ON [SupplyInvoiceBillOfLadingService].[BillOfLadingServiceID] = [BillOfLadingService].[ID] " +
                    "LEFT JOIN [SupplyInvoice] " +
                    "ON [SupplyInvoice].[ID] = [SupplyInvoiceBillOfLadingService].[SupplyInvoiceID] " +
                    "LEFT JOIN [InvoiceDocument] " +
                    "ON [InvoiceDocument].[SupplyInvoiceID] = [SupplyInvoice].[ID] " +
                    "AND [InvoiceDocument].[Deleted] = 0 " +
                    "LEFT JOIN [SupplyOrder] " +
                    "ON [SupplyOrder].ID = [SupplyInvoice].SupplyOrderID " +
                    "LEFT JOIN [Client] " +
                    "ON [SupplyOrder].ClientID = [Client].ID " +
                    "LEFT JOIN [Region] " +
                    "ON [Region].ID = [Client].RegionID " +
                    "LEFT JOIN [RegionCode] " +
                    "ON [RegionCode].ID = [Client].RegionCodeID " +
                    "LEFT JOIN [Country] " +
                    "ON [Country].ID = [Client].CountryID " +
                    "LEFT JOIN [ClientBankDetails] " +
                    "ON [ClientBankDetails].ID = [Client].ClientBankDetailsID " +
                    "LEFT JOIN [ClientBankDetailAccountNumber] " +
                    "ON [ClientBankDetailAccountNumber].ID = [ClientBankDetails].AccountNumberID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailAccountNumberCurrency] " +
                    "ON [ClientBankDetailAccountNumberCurrency].ID = [ClientBankDetailAccountNumber].CurrencyID " +
                    "AND [ClientBankDetailAccountNumberCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [ClientBankDetailIbanNo] " +
                    "ON [ClientBankDetailIbanNo].ID = [ClientBankDetails].ClientBankDetailIbanNoID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ClientBankDetailIbanNoCurrency] " +
                    "ON [ClientBankDetailIbanNoCurrency].ID = [ClientBankDetailIbanNo].CurrencyID " +
                    "AND [ClientBankDetailIbanNoCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [TermsOfDelivery] " +
                    "ON [TermsOfDelivery].ID = [Client].TermsOfDeliveryID " +
                    "LEFT JOIN [PackingMarking] " +
                    "ON [PackingMarking].ID = [Client].PackingMarkingID " +
                    "LEFT JOIN [PackingMarkingPayment] " +
                    "ON [PackingMarkingPayment].ID = [Client].PackingMarkingPaymentID " +
                    "LEFT JOIN [ClientAgreement] " +
                    "ON [ClientAgreement].ID = [SupplyOrder].ClientAgreementID " +
                    "LEFT JOIN [Agreement] " +
                    "ON [Agreement].ID = [ClientAgreement].AgreementID " +
                    "LEFT JOIN [ProviderPricing] " +
                    "ON [ProviderPricing].ID = [Agreement].ProviderPricingID " +
                    "LEFT JOIN [views].[CurrencyView] AS [ProFormSupplyOrderClientAgreementProviderPricingCurrency] " +
                    "ON [ProFormSupplyOrderClientAgreementProviderPricingCurrency].ID = [ProviderPricing].CurrencyID " +
                    "AND [ProFormSupplyOrderClientAgreementProviderPricingCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [Pricing] " +
                    "ON [ProviderPricing].BasePricingID = [Pricing].ID " +
                    "LEFT JOIN ( " +
                    "SELECT [PriceType].ID " +
                    ",[PriceType].Created " +
                    ",[PriceType].Deleted " +
                    ",(CASE WHEN [PriceTypeTranslation].[Name] IS NOT NULL THEN [PriceTypeTranslation].[Name] ELSE [PriceType].[Name] END) AS [Name] " +
                    ",[PriceType].NetUID " +
                    ",[PriceType].Updated " +
                    "FROM [PriceType] " +
                    "LEFT JOIN [PriceTypeTranslation] " +
                    "ON [PriceTypeTranslation].PriceTypeID = [PriceType].ID " +
                    "AND [PriceTypeTranslation].CultureCode = @Culture " +
                    "AND [PriceTypeTranslation].Deleted = 0 " +
                    ") AS [PriceType] " +
                    "ON [Pricing].PriceTypeID = [PriceType].ID " +
                    "LEFT JOIN [views].[OrganizationView] AS [AgreementOrganization] " +
                    "ON [AgreementOrganization].ID = [Agreement].OrganizationID " +
                    "AND [AgreementOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[CurrencyView] AS [AgreementCurrency] " +
                    "ON [AgreementCurrency].ID = [Agreement].CurrencyID " +
                    "AND [AgreementCurrency].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [Organization] " +
                    "ON [Organization].ID = [SupplyOrder].OrganizationID " +
                    "AND [Organization].CultureCode = @Culture " +
                    "LEFT JOIN [views].[OrganizationView] AS [SupplyOrganizationOrganization] " +
                    "ON [SupplyOrganizationOrganization].ID = [SupplyOrganizationAgreement].OrganizationID " +
                    "AND [SupplyOrganizationOrganization].CultureCode = @Culture " +
                    "LEFT JOIN [SupplyOrderNumber] " +
                    "ON [SupplyOrderNumber].ID = [SupplyOrder].SupplyOrderNumberID " +
                    "LEFT JOIN [DeliveryProductProtocol] " +
                    "ON [DeliveryProductProtocol].[ID] = [BillOfLadingService].[DeliveryProductProtocolID] " +
                    "LEFT JOIN [DeliveryProductProtocolNumber] " +
                    "ON [DeliveryProductProtocolNumber].[ID] = [DeliveryProductProtocol].[DeliveryProductProtocolNumberID] " +
                    "WHERE [BillOfLadingService].ID IN @Ids ",
                    includesTypes,
                    includesMapper,
                    new {
                        Ids = joinServices.Where(s => s.Type.Equals(JoinServiceType.AccountingBillOfLadingService)).Select(s => s.Id),
                        Culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName
                    }
                );
            }
        }

        return groupedPaymentTaskWithTotals;
    }

    private Currency GetPLN() {
        return _currencyExchangeConnection.Query<Currency>(
                "SELECT TOP(1) * " +
                "FROM [Currency] " +
                "WHERE [Currency].Deleted = 0 " +
                "AND [Currency].Code = N'PLN'"
            )
            .Single();
    }

    private Currency GetEUR() {
        return _currencyExchangeConnection.Query<Currency>(
                "SELECT TOP(1) * " +
                "FROM [Currency] " +
                "WHERE [Currency].Deleted = 0 " +
                "AND [Currency].Code = 'EUR'"
            )
            .Single();
    }

    private decimal GetExchangeRateToEuroCurrency(Currency fromCurrency, bool fromPln = false) {
        decimal exchangeRateAmount;

        if (fromPln)
            fromCurrency = _currencyExchangeConnection.Query<Currency>(
                    "SELECT TOP(1) * " +
                    "FROM [Currency] " +
                    "WHERE [Currency].Deleted = 0 " +
                    "AND [Currency].Code = N'PLN'"
                )
                .Single();

        if (fromCurrency.Code.ToLower().Equals("uah") || fromCurrency.Code.ToLower().Equals("pln"))
            exchangeRateAmount = _currencyExchangeConnection.Query<decimal>(
                "DECLARE @ExchangeRate money; " +
                "SELECT @ExchangeRate = " +
                "( " +
                "SELECT (0 - [ExchangeRate].Amount) " +
                "FROM [ExchangeRate] " +
                "WHERE [ExchangeRate].CurrencyID = @FromCurrencyId " +
                "AND [ExchangeRate].Code = 'EUR' " +
                "AND [ExchangeRate].Deleted = 0 " +
                "); " +
                "SELECT " +
                "CASE " +
                "WHEN @ExchangeRate IS NOT NULL " +
                "THEN @ExchangeRate " +
                "ELSE 1 " +
                "END",
                new { FromCurrencyId = fromCurrency.Id }
            ).Single();
        else
            exchangeRateAmount = _currencyExchangeConnection.Query<decimal>(
                "DECLARE @EuroCurrencyId bigint; " +
                "DECLARE @CrossExchangeRate money; " +
                "DECLARE @InverseCrossExchangeRate money; " +
                "SELECT @EuroCurrencyId = (SELECT TOP(1) [Currency].ID FROM [Currency] WHERE [Currency].Deleted = 0 AND [Currency].Code = 'EUR'); " +
                "SELECT @CrossExchangeRate = " +
                "( " +
                "SELECT [CrossExchangeRate].Amount " +
                "FROM [CrossExchangeRate] " +
                "WHERE [CrossExchangeRate].CurrencyFromID = @FromCurrencyId " +
                "AND [CrossExchangeRate].CurrencyToID = @EuroCurrencyId " +
                "AND [CrossExchangeRate].Deleted = 0 " +
                "); " +
                "SELECT @InverseCrossExchangeRate = " +
                "( " +
                "SELECT (0 - [CrossExchangeRate].Amount) " +
                "FROM [CrossExchangeRate] " +
                "WHERE [CrossExchangeRate].CurrencyFromID = @EuroCurrencyId " +
                "AND [CrossExchangeRate].CurrencyToID = @FromCurrencyId " +
                "AND [CrossExchangeRate].Deleted = 0 " +
                "); " +
                "SELECT " +
                "CASE " +
                "WHEN @CrossExchangeRate IS NOT NULL " +
                "THEN @CrossExchangeRate " +
                "WHEN @InverseCrossExchangeRate IS NOT NULL " +
                "THEN @InverseCrossExchangeRate " +
                "ELSE 1 " +
                "END",
                new { FromCurrencyId = fromCurrency.Id }
            ).Single();

        return exchangeRateAmount;
    }

    private decimal GetGovExchangeRateToEuroCurrency(Currency fromCurrency, bool fromPln = false) {
        decimal exchangeRateAmount;

        if (fromPln)
            fromCurrency = _currencyExchangeConnection.Query<Currency>(
                    "SELECT TOP(1) * " +
                    "FROM [Currency] " +
                    "WHERE [Currency].Deleted = 0 " +
                    "AND [Currency].Code = N'PLN'"
                )
                .Single();

        if (fromCurrency.Code.ToLower().Equals("uah") || fromCurrency.Code.ToLower().Equals("pln"))
            exchangeRateAmount = _currencyExchangeConnection.Query<decimal>(
                "DECLARE @GovExchangeRate money; " +
                "SELECT @GovExchangeRate = " +
                "( " +
                "SELECT (0 - [GovExchangeRate].Amount) " +
                "FROM [GovExchangeRate] " +
                "WHERE [GovExchangeRate].CurrencyID = @FromCurrencyId " +
                "AND [GovExchangeRate].Code = 'EUR' " +
                "AND [GovExchangeRate].Deleted = 0 " +
                "); " +
                "SELECT " +
                "CASE " +
                "WHEN @GovExchangeRate IS NOT NULL " +
                "THEN @GovExchangeRate " +
                "ELSE 1 " +
                "END",
                new { FromCurrencyId = fromCurrency.Id }
            ).Single();
        else
            exchangeRateAmount = _currencyExchangeConnection.Query<decimal>(
                "DECLARE @EuroCurrencyId bigint; " +
                "DECLARE @CrossExchangeRate money; " +
                "DECLARE @InverseCrossExchangeRate money; " +
                "SELECT @EuroCurrencyId = (SELECT TOP(1) [Currency].ID FROM [Currency] WHERE [Currency].Deleted = 0 AND [Currency].Code = 'EUR'); " +
                "SELECT @CrossExchangeRate = " +
                "( " +
                "SELECT [GovCrossExchangeRate].Amount " +
                "FROM [GovCrossExchangeRate] " +
                "WHERE [GovCrossExchangeRate].CurrencyFromID = @FromCurrencyId " +
                "AND [GovCrossExchangeRate].CurrencyToID = @EuroCurrencyId " +
                "AND [GovCrossExchangeRate].Deleted = 0 " +
                "); " +
                "SELECT @InverseCrossExchangeRate = " +
                "( " +
                "SELECT (0 - [GovCrossExchangeRate].Amount) " +
                "FROM [GovCrossExchangeRate] " +
                "WHERE [GovCrossExchangeRate].CurrencyFromID = @EuroCurrencyId " +
                "AND [GovCrossExchangeRate].CurrencyToID = @FromCurrencyId " +
                "AND [GovCrossExchangeRate].Deleted = 0 " +
                "); " +
                "SELECT " +
                "CASE " +
                "WHEN @CrossExchangeRate IS NOT NULL " +
                "THEN @CrossExchangeRate " +
                "WHEN @InverseCrossExchangeRate IS NOT NULL " +
                "THEN @InverseCrossExchangeRate " +
                "ELSE 1 " +
                "END",
                new { FromCurrencyId = fromCurrency.Id }
            ).Single();

        return exchangeRateAmount;
    }
}